<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Ocean Pay ‚Äì Tu billetera universal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    :root {
      --bg: #0a0e1a;
      --card: #0f1624;
      --sidebar: #0b101e;
      --accent: #22d3ee;
      --text: #e0f2fe;
      --ok: #10b981;
      --err: #ef4444;
      --glass: rgba(255, 255, 255, .08);
      --glass-strong: rgba(255, 255, 255, .12);
      --purple: #a855f7;
      --orange: #f97316;
      --wild: #667eea;
      --gold: #ffd700;
      --gold: #ffd700;
      --shadow-accent: 0 0 40px rgba(34, 211, 238, .3);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, .4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 50%, #0f1624 100%);
      background-attachment: fixed;
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* Background Effects */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 50%, rgba(34, 211, 238, .1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(167, 85, 247, .1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* App Layout */
    .app-layout {
      display: flex;
      width: 100%;
      height: 100%;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: rgba(11, 16, 30, 0.8);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      padding: 2rem;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .brand {
      margin-bottom: 3rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .brand h1 {
      font-size: 1.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #22d3ee 0%, #67e8f9 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.02em;
    }

    .nav-menu {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
    }

    .nav-item {
      padding: 1rem;
      border-radius: 12px;
      background: transparent;
      border: none;
      color: #94a3b8;
      text-align: left;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s ease;
      font-size: 1rem;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }

    .nav-item.active {
      background: linear-gradient(90deg, rgba(34, 211, 238, 0.1) 0%, transparent 100%);
      color: var(--accent);
      border-left: 3px solid var(--accent);
    }

    .user-profile-mini {
      margin-top: auto;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #06b6d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #0a0e1a;
    }

    .user-info-text {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 700;
      font-size: 0.9rem;
    }

    .user-id {
      font-size: 0.75rem;
      color: #64748b;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 2rem 3rem;
      position: relative;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text);
    }

    /* Auth Overlay */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .auth-card {
      width: 100%;
      max-width: 450px;
      background: rgba(15, 22, 36, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(34, 211, 238, 0.2);
      border-radius: 2rem;
      padding: 3rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      text-align: center;
    }

    /* Forms */
    input {
      width: 100%;
      padding: 1rem 1.25rem;
      border-radius: .75rem;
      border: 2px solid rgba(34, 211, 238, .2);
      background: rgba(10, 14, 26, .6);
      color: var(--text);
      margin-bottom: 1.25rem;
      font-size: 1rem;
      transition: all .3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(10, 14, 26, .8);
    }

    button {
      cursor: pointer;
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: .75rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, #06b6d4 100%);
      color: #0a0e1a;
      transition: all .3s ease;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(34, 211, 238, .3);
    }

    button.secondary {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }

    button.secondary:hover {
      background: rgba(34, 211, 238, .1);
    }

    /* Balance Grid */
    .balance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }

    .currency-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, .05) 0%, rgba(255, 255, 255, .02) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 1.5rem;
      position: relative;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .currency-card:hover {
      transform: translateY(-5px);
      border-color: var(--accent);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .currency-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      background: transparent;
    }

    .currency-card .label {
      font-size: 0.8rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      display: block;
      margin-bottom: 0.5rem;
    }

    .currency-card .amount {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text);
      display: block;
    }

    .currency-card .app-info {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.8rem;
      color: #64748b;
    }

    /* Specific Card Styles */
    #aquabux-card .amount {
      color: var(--accent);
    }

    #aquabux-card:hover {
      border-color: var(--accent);
    }

    #ecoxionums-card .amount {
      color: var(--ok);
    }

    #ecoxionums-card:hover {
      border-color: var(--ok);
    }

    #ecobits-card .amount {
      color: #8b5cf6;
    }

    #ecobits-card:hover {
      border-color: #8b5cf6;
    }

    #wildcredits-card .amount {
      color: var(--wild);
    }

    #wildcredits-card:hover {
      border-color: var(--wild);
    }

    #wildgems-card .amount {
      color: var(--gold);
    }

    #wildgems-card:hover {
      border-color: var(--gold);
    }

    #appbux-card .amount {
      color: var(--orange);
    }

    #appbux-card:hover {
      border-color: var(--orange);
    }



    #ecobooks-card .amount {
      color: #10b981;
    }

    #ecobooks-card:hover {
      border-color: #10b981;
    }

    #ecobooks-card .currency-icon {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(34, 197, 94, 0.1));
    }

    #ecotokens-card .amount {
      color: #39b54a;
    }

    #ecotokens-card:hover {
      border-color: #39b54a;
    }

    .currency-canvas {
      width: 48px;
      height: 48px;
      display: block;
      flex-shrink: 0;
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .msg {
      font-size: 0.9rem;
      margin-top: 1rem;
    }

    .msg.error {
      color: var(--err);
    }

    .msg.success {
      color: var(--ok);
    }

    /* Mobile */
    @media (max-width: 768px) {
      .app-layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: 70px;
        padding: 0 1.5rem;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        position: sticky;
        top: 0;
        background: rgba(11, 16, 30, 0.95);
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        z-index: 1001;
      }

      .brand {
        margin-bottom: 0;
      }

      .nav-menu {
        display: flex;
        flex-direction: row;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 75px;
        background: rgba(11, 16, 30, 0.98);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0;
        gap: 0;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        border-right: none;
      }

      .nav-item {
        flex: 1;
        height: 100%;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 0.5rem 0;
        gap: 4px;
        font-size: 0.7rem;
        border-radius: 0;
        background: transparent !important;
        border-left: none !important;
        border-bottom: 3px solid transparent;
      }

      .nav-item.active {
        color: var(--accent);
        border-bottom: 3px solid var(--accent);
        background: rgba(34, 211, 238, 0.05) !important;
      }

      .nav-item span {
        font-size: 1.5rem;
        margin: 0;
      }

      .user-profile-mini {
        display: none;
      }

      .main-content {
        padding: 1.5rem 1rem 100px 1rem;
      }

      .page-title {
        font-size: 1.6rem;
      }

      .balance-grid {
        grid-template-columns: 1fr;
      }

      .cards-container {
        justify-content: center;
      }
    }

    /* Ocean Card Premium Styles */
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .ocean-card {
      width: 380px;
      height: 220px;
      border-radius: 20px;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      position: relative;
      padding: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
    }

    .ocean-card:hover {
      transform: translateY(-10px) rotateX(5deg) rotateY(5deg);
      box-shadow: 0 25px 50px rgba(34, 211, 238, 0.15);
      border-color: var(--accent);
    }

    .ocean-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(34, 211, 238, 0.05) 0%, transparent 70%);
      pointer-events: none;
    }

    .card-chip {
      width: 50px;
      height: 38px;
      background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
      border-radius: 8px;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .card-chip::after {
      content: '';
      position: absolute;
      inset: 5px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .card-number {
      font-size: 1.4rem;
      font-family: 'Courier New', Courier, monospace;
      letter-spacing: 4px;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      margin-bottom: 1.5rem;
      display: block;
    }

    .card-details {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .card-label {
      font-size: 0.65rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: block;
      margin-bottom: 2px;
    }

    .card-val {
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
    }

    .card-brand {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      text-align: right;
    }

    .card-brand span {
      font-weight: 900;
      font-style: italic;
      font-size: 1.2rem;
      color: var(--accent);
    }

    .card-status {
      position: absolute;
      bottom: 1.5rem;
      right: 1.5rem;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 800;
      text-transform: uppercase;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-expired {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .new-card-btn {
      width: 380px;
      height: 220px;
      border-radius: 20px;
      border: 2px dashed rgba(255, 255, 255, 0.1);
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      color: #94a3b8;
      transition: all 0.3s ease;
      text-transform: none;
      letter-spacing: normal;
    }

    .new-card-btn:hover {
      background: rgba(255, 255, 255, 0.02);
      border-color: var(--accent);
      color: var(--accent);
      transform: none;
      box-shadow: none;
    }

    .new-card-btn i {
      font-size: 2rem;
    }

    .checkout-overlay {
      position: fixed;
      inset: 0;
      background: rgba(4, 7, 13, 0.95);
      backdrop-filter: blur(12px);
      z-index: 5000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .checkout-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .checkout-card {
      background: #1a1f2e;
      width: 100%;
      max-width: 520px;
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
      box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.7);
      transform: scale(0.95) translateY(30px);
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      flex-direction: column;
    }

    .checkout-overlay.active .checkout-card {
      transform: scale(1) translateY(0);
    }

    .checkout-header {
      padding: 1.5rem 2rem;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .checkout-header img {
      width: 32px;
      filter: drop-shadow(0 0 8px var(--accent));
    }

    .checkout-body {
      padding: 2rem;
      flex: 1;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Product Preview Section */
    .product-preview {
      display: flex;
      gap: 1.5rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 1rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
      align-items: center;
    }

    .product-img {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      background: linear-gradient(135deg, #334155, #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .product-info h3 {
      font-size: 1.1rem;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .product-info p {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    /* Payment Method Tabs */
    .payment-tabs {
      display: flex;
      background: rgba(0, 0, 0, 0.3);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 2rem;
      gap: 4px;
    }

    .payment-tab {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      background: transparent;
      border: none;
    }

    .payment-tab.active {
      background: #2563eb;
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    /* Card Form Styles (Steam/Mercado Pago) */
    .card-form {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper label {
      display: block;
      font-size: 0.75rem;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .checkout-input {
      width: 100%;
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .checkout-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .card-selector-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .card-option {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card-option:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .card-option.selected {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.05);
      box-shadow: inset 0 0 15px rgba(37, 99, 235, 0.05);
    }

    .checkout-footer {
      padding: 2rem;
      background: rgba(0, 0, 0, 0.2);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .checkout-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .summary-label {
      font-size: 0.9rem;
      color: #94a3b8;
      font-weight: 600;
    }

    .summary-total {
      font-size: 1.8rem;
      font-weight: 900;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-total .currency {
      font-size: 0.9rem;
      opacity: 0.6;
    }

    .btn-checkout-confirm {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      font-weight: 800;
      font-size: 1.1rem;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
      transition: all 0.3s;
    }

    .btn-checkout-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(37, 99, 235, 0.3);
    }

    .btn-checkout-confirm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-checkout-cancel {
      width: 100%;
      margin-top: 1rem;
      background: transparent;
      color: #64748b;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-checkout-cancel:hover {
      color: #94a3b8;
    }

    /* --- Subscriptions Themes --- */
    .sub-dinopass-premium {
      border-color: #f59e0b !important;
      background: linear-gradient(145deg, #1e1b15, #0f172a) !important;
    }

    .sub-dinopass-elite {
      border-color: #ef4444 !important;
      background: linear-gradient(145deg, #1a1010, #0f111a) !important;
    }

    .sub-dinopass-premium .sub-icon {
      background: #f59e0b !important;
      color: black !important;
      box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
    }

    .sub-dinopass-elite .sub-icon {
      background: #ef4444 !important;
      color: white !important;
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
    }

    .sub-wildshorts-premium .sub-icon {
      background: linear-gradient(135deg, #ffd700, #b8860b) !important;
      color: black !important;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }

    .sub-wildshorts-premium {
      border-color: #ffd700 !important;
      background: linear-gradient(145deg, #2a2000, #0f111a) !important;
    }



    /* Notifications Styles */
    .notif-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 1.5rem;
      border-left: 4px solid #64748b;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .notif-card.success {
      border-left-color: #10b981;
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
    }

    .notif-card.error {
      border-left-color: #ef4444;
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
    }

    .notif-card.warning {
      border-left-color: #f59e0b;
      background: linear-gradient(90deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
    }

    .notif-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: #94a3b8;
    }

    .notif-title {
      color: white;
      font-weight: 700;
      font-size: 1rem;
    }

    .notif-msg {
      color: #cbd5e1;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    @media (max-width: 480px) {

      .ocean-card,
      .new-card-btn {
        width: 100%;
        height: 200px;
      }

      .card-number {
        font-size: 1.1rem;
        letter-spacing: 2px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <!-- Auth Overlay (Login/Register) -->
  <div id="auth-section" class="auth-overlay">
    <div class="auth-card">
      <div class="brand" style="justify-content: center; margin-bottom: 2rem;">
        <h1>üåä Ocean Pay</h1>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="form-box">
        <h2 style="margin-bottom: 1.5rem;">Iniciar Sesi√≥n</h2>
        <input type="text" id="logUser" required placeholder="Usuario" />
        <input type="password" id="logPass" required placeholder="Contrase√±a" />
        <button type="submit">Entrar</button>
        <p id="logMsg" class="msg"></p>
        <p style="margin-top: 1.5rem; font-size: 0.9rem; color: #94a3b8;">
          ¬øNo tienes cuenta? <a href="#" id="toRegister" style="color: var(--accent);">Reg√≠strate</a>
        </p>
      </form>

      <!-- Register Form -->
      <form id="regForm" class="form-box hidden">
        <h2 style="margin-bottom: 1.5rem;">Crear Cuenta</h2>
        <input type="text" id="regUser" required placeholder="Nuevo Usuario" />
        <input type="password" id="regPass" required placeholder="Contrase√±a" />
        <button type="submit">Crear Cuenta</button>
        <p id="regMsg" class="msg"></p>
        <p style="margin-top: 1.5rem; font-size: 0.9rem; color: #94a3b8;">
          ¬øYa tienes cuenta? <a href="#" id="toLogin" style="color: var(--accent);">Inicia Sesi√≥n</a>
        </p>
      </form>
    </div>
  </div>

  </div>

  <!-- CHECKOUT MODAL REDESIGN -->
  <div id="checkout-modal" class="checkout-overlay">
    <div class="checkout-card">
      <div class="checkout-header">
        <i class="fas fa-water" style="color:var(--accent); font-size:1.5rem;"></i>
        <h2 style="font-weight:900; font-size:1.2rem; letter-spacing:-0.5px;">Ocean Pay Checkout</h2>
      </div>

      <div class="checkout-body">
        <!-- Order Context -->
        <div class="product-preview">
          <div class="product-img">
            <canvas id="checkout-product-canvas" class="currency-canvas" data-currency="wildgems"></canvas>
          </div>
          <div class="product-info">
            <h3 id="checkout-concept-display">Suscripci√≥n Premium</h3>
            <p id="checkout-origin-display">WildShorts VIP</p>
          </div>
        </div>

        <!-- Method Selector -->
        <div class="payment-tabs">
          <button class="payment-tab active" id="tab-ocean" onclick="setPaymentMethod('ocean')">Ocean Card</button>
          <button class="payment-tab" id="tab-external" onclick="setPaymentMethod('external')">Otra Tarjeta</button>
        </div>

        <!-- Method: Ocean Card Selection -->
        <div id="method-ocean" class="method-section">
          <p style="margin-bottom:1rem; font-size:0.85rem; font-weight:700; color:#64748b; text-transform:uppercase;">
            Selecciona tu tarjeta Ocean</p>
          <div id="checkout-card-list" class="card-selector-list">
            <!-- Rendered by JS -->
          </div>
        </div>

        <!-- Method: External Card Form -->
        <div id="method-external" class="method-section hidden">
          <div class="card-form">
            <div class="input-wrapper">
              <label>N√∫mero de Tarjeta</label>
              <input type="text" id="ext-card-number" class="checkout-input" placeholder="0000 0000 0000 0000"
                maxlength="19">
            </div>
            <div class="input-wrapper">
              <label>Nombre del Titular</label>
              <input type="text" id="ext-card-name" class="checkout-input" placeholder="JUAN PEREZ">
            </div>
            <div class="form-row">
              <div class="input-wrapper">
                <label>Vencimiento (MM/AA)</label>
                <input type="text" id="ext-card-expiry" class="checkout-input" placeholder="MM/AA" maxlength="5">
              </div>
              <div class="input-wrapper">
                <label>CVV</label>
                <input type="password" id="ext-card-cvv" class="checkout-input" placeholder="***" maxlength="3">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="checkout-footer">
        <div class="checkout-summary">
          <span class="summary-label">Total a pagar:</span>
          <div class="summary-total">
            <span id="checkout-amount-val">0</span>
            <span class="currency" id="checkout-currency-val">WILDGEMS</span>
          </div>
        </div>

        <button id="checkout-confirm-btn" class="btn-checkout-confirm" onclick="confirmCheckout()">
          Confirmar y Pagar
        </button>
        <button class="btn-checkout-cancel" onclick="closeCheckout()">Cancelar transacci√≥n</button>
      </div>
    </div>
  </div>

  <!-- Main App Layout -->
  <div id="app-layout" class="app-layout hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <h1>üåä Ocean Pay</h1>
      </div>

      <nav class="nav-menu">
        <button class="nav-item active" onclick="showSection('wallet')">
          <span>üí≥</span> Billetera
        </button>
        <button class="nav-item" onclick="showSection('history')">
          <span>üìã</span> Historial
        </button>
        <button class="nav-item" onclick="showSection('pos')">
          <span>üèß</span> POS Virtual
        </button>
        <button class="nav-item" onclick="showSection('notifications')">
          <span>üîî</span> Notificaciones
        </button>

        <button class="nav-item" onclick="showSection('misc')">
          <span>üìä</span> Misc.
        </button>
        <button class="nav-item" onclick="showSection('settings')">
          <span>‚öôÔ∏è</span> Ajustes
        </button>
      </nav>

      <div class="user-profile-mini">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-info-text">
          <span class="user-name" id="userNameDisplay">Usuario</span>
          <span class="user-id" id="userIdDisplay">ID: 0</span>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">

      <!-- Wallet Section -->
      <section id="wallet-section">
        <div class="main-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2 class="page-title">Mi Billetera</h2>
          <div style="display:flex; gap:10px;">
            <!-- Removing Cargar Saldo to prevent infinite balance exploit -->
            <button class="secondary" style="width: auto; padding: 0.5rem 1rem;" onclick="refreshAllBalances()">
              <i class="fas fa-sync-alt"></i> Actualizar
            </button>
          </div>
        </div>

        <h3
          style="margin-bottom: 1.5rem; color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;">
          Mis Tarjetas Ocean Card
        </h3>

        <div id="cards-container" class="cards-container">
          <!-- Tarjetas se cargar√°n aqu√≠ -->
        </div>

        <h3
          style="margin-bottom: 1.5rem; color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;">
          Mis Divisas
        </h3>

        <div class="balance-grid">
          <!-- AquaBux -->
          <div class="currency-card" id="aquabux-card">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="bux"></canvas>
            </div>
            <span class="label">AquaBux</span>
            <span class="amount" id="bux">0</span>
            <div class="app-info">Ocean Cinemas</div>
          </div>

          <!-- Nexus Bits (NXB) -->
          <div class="currency-card" id="nxb-card" style="border-color: #f08a5d;">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="nxb"></canvas>
            </div>
            <span class="label">Nexus Bits</span>
            <span class="amount" id="nxb-balance" style="color: #f08a5d;">0</span>
            <div class="app-info">Primal Velocity Nexus</div>
          </div>



          <!-- WildCredits -->
          <div class="currency-card" id="wildcredits-card">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="wildcredits"></canvas>
            </div>
            <span class="label">WildCredits</span>
            <span class="amount" id="wildcredits">0</span>
            <div class="app-info">Wild Explorer</div>
          </div>

          <!-- WildGems -->
          <div class="currency-card" id="wildgems-card">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="wildgems"></canvas>
            </div>
            <span class="label">WildGems</span>
            <span class="amount" id="wildgems">0</span>
            <div class="app-info">WildShorts</div>
          </div>

          <!-- Ecoxionums -->
          <div class="currency-card" id="ecoxionums-card">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="ecoxionums"></canvas>
            </div>
            <span class="label">Ecoxionums</span>
            <span class="amount" id="ecoxionums">0</span>
            <div class="app-info">Ecoxion</div>
          </div>

          <!-- EcoCoreBits -->
          <div class="currency-card" id="ecobits-card">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="ecobits"></canvas>
            </div>
            <span class="label">EcoCoreBits</span>
            <span class="amount" id="ecobits">0</span>
            <div class="app-info">EcoConsole</div>
          </div>

          <!-- AppBux -->
          <div class="currency-card" id="appbux-card">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="appbux"></canvas>
            </div>
            <span class="label">AppBux</span>
            <span class="amount" id="appbux">0</span>
            <div class="app-info">AllApp</div>
          </div>

          <!-- EcoBooks (NEW) -->
          <div class="currency-card" id="ecobooks-card" onclick="loadEcoBooksBalance()" style="cursor:pointer;"
            title="Click para actualizar">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="ecobooks"></canvas>
            </div>
            <span class="label">EcoBooks</span>
            <span class="amount" id="ecobooks">0</span>
            <div class="app-info">Naturepedia <span style="font-size:10px;opacity:0.7;">üîÑ</span></div>
          </div>

          <!-- EcoTokens (Wild Savage) -->
          <div class="currency-card" id="ecotokens-card">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="ecotokens"></canvas>
            </div>
            <span class="label">EcoTokens</span>
            <span class="amount" id="ecotokens">0</span>
            <div class="app-info">No-Extinction - Wild Savage</div>
          </div>

          <!-- Amber (DinoBox) -->
          <div class="currency-card" id="amber-card" onclick="loadAmberBalance()" style="cursor:pointer;"
            title="Click para actualizar">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="amber"></canvas>
            </div>
            <span class="label">Amber</span>
            <span class="amount" id="amber" style="color: #f59e0b;">0</span>
            <div class="app-info">DinoBox</div>
          </div>

          <!-- VoltBits (Velocity Surge) -->
          <div class="currency-card" id="voltbits-card" onclick="refreshAllBalances()"
            style="border-color: #00e5ff; cursor:pointer;" title="Click para actualizar">
            <div class="currency-icon" style="background: transparent;">
              <canvas class="currency-canvas" data-currency="voltbit"></canvas>
            </div>
            <span class="label">VoltBits</span>
            <span class="amount" id="voltbit" style="color: #00e5ff;">0</span>
            <div class="app-info">Velocity Surge</div>
          </div>
        </div>

        <!-- EcoPower - Energ√≠a para EcoConsole -->
        <div
          style="background: linear-gradient(145deg, rgba(0, 255, 100, 0.08), rgba(0, 200, 80, 0.04)); padding: 1.5rem; border-radius: 1rem; margin-top: 2rem; border: 1px solid rgba(0, 255, 100, 0.2);">
          <h3
            style="margin-bottom: 1rem; font-size: 1rem; color: #00ff64; display: flex; align-items: center; gap: 8px;">
            ‚ö° EcoPower
            <span
              style="font-size: 0.7rem; background: rgba(0, 255, 100, 0.2); padding: 3px 8px; border-radius: 10px; color: #00dd55;">Energ√≠a
              de Consola</span>
          </h3>
          <div
            style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 0.5rem;">
            <span style="color: #a0a0a0;">Balance Actual</span>
            <span
              style="font-weight: bold; color: #00ff64; font-size: 1.5rem; text-shadow: 0 0 10px rgba(0, 255, 100, 0.5);"
              id="ecopower">100</span>
          </div>
          <p style="margin-top: 0.75rem; font-size: 0.8rem; color: #64748b;">Usa EcoPower para ejecutar comandos
            premium
            en EcoConsole. Se recarga diariamente.</p>
        </div>

        <!-- Subscriptions Section -->
        <h3
          style="margin-bottom: 1.5rem; margin-top: 2.5rem; color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;">
          Suscripciones Activas
        </h3>

        <div id="subs-container"
          style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
          <!-- Cargando... -->
          <div
            style="background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1); padding: 2rem; border-radius: 1rem; text-align: center; color: #64748b; grid-column: 1/-1;">
            No hay suscripciones activas vinculadas
          </div>
        </div>
      </section>

      <!-- History Section -->
      <section id="history-section" class="hidden">
        <div class="main-header">
          <h2 class="page-title">Historial de Transacciones</h2>
        </div>
        <div id="tx-history-list">
          <div id="txList"></div>
        </div>
      </section>

      <!-- Notifications Section -->
      <section id="notifications-section" class="hidden">
        <div class="main-header">
          <h2 class="page-title">Notificaciones</h2>
        </div>
        <div id="notifications-list" class="notif-container" style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Cargando... -->
        </div>
      </section>


      <!-- POS Section -->
      <!-- POS Section Redesigned & Enhanced -->
      <section id="pos-section" class="hidden">
        <style>
          /* POS Specific Styles */
          .pos-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            perspective: 1500px;
          }

          .virtual-pos-device {
            width: 400px;
            height: 750px;
            background: linear-gradient(160deg, #1e293b 0%, #0f172a 100%);
            border-radius: 45px;
            box-shadow:
              0 30px 60px rgba(0, 0, 0, 0.6),
              0 0 0 2px rgba(255, 255, 255, 0.08),
              inset 0 0 30px rgba(0, 0, 0, 0.8);
            padding: 25px;
            position: relative;
            display: flex;
            flex-direction: column;
            border: 10px solid #0f172a;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
          }

          .virtual-pos-device:hover {
            transform: rotateX(2deg) rotateY(2deg);
          }

          /* Glossy reflection */
          .virtual-pos-device::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 150px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, transparent 100%);
            border-radius: 30px;
            pointer-events: none;
            z-index: 5;
          }

          .pos-screen-frame {
            background: #000;
            border-radius: 30px;
            padding: 8px;
            flex: 1;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.9);
            overflow: hidden;
            position: relative;
            z-index: 2;
          }

          .pos-screen {
            background: #f8fafc;
            width: 100%;
            height: 100%;
            border-radius: 22px;
            position: relative;
            overflow: hidden;
            color: #1e293b;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
          }

          .pos-top-bar {
            background: #e2e8f0;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #475569;
            font-weight: bold;
            border-bottom: 1px solid #cbd5e1;
          }

          .pos-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 25px;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
            position: absolute;
            top: 35px;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f1f5f9;
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
            overflow-y: auto;
          }

          .pos-view.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
          }

          .pos-logo-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
          }

          .pos-logo-icon {
            font-size: 5rem;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 10px 10px rgba(6, 182, 212, 0.3));
          }

          .pos-home-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: auto;
            margin-bottom: 10px;
          }

          .pos-home-buttons-full {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
            margin-bottom: 10px;
          }

          .pos-big-btn {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 18px;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #334155;
            box-shadow: 0 4px 0 #94a3b8, 0 8px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.1s;
            cursor: pointer;
            height: 100%;
          }

          .pos-big-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #94a3b8;
          }

          .pos-big-btn i {
            font-size: 1.8rem;
            color: #0ea5e9;
          }

          .pos-big-btn span {
            font-weight: 700;
            font-size: 0.95rem;
          }

          .pos-header-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #cbd5e1;
          }

          .pos-back-btn {
            background: white !important;
            border: 1px solid #cbd5e1 !important;
            font-size: 1rem;
            color: #64748b;
            cursor: pointer;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            box-shadow: 0 2px 0 #94a3b8 !important;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .pos-back-btn:active {
            transform: translateY(2px) !important;
            box-shadow: none !important;
          }

          .pos-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: #0f172a;
          }

          /* Forms inside POS */
          .pos-field {
            margin-bottom: 20px;
          }

          .pos-field label {
            display: block;
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }

          .pos-input-group {
            background: #fff;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
          }

          .pos-input-group:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
          }

          .pos-input {
            width: 100%;
            border: none;
            padding: 15px 0;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f172a;
            outline: none;
            background: transparent;
          }

          .pos-input::placeholder {
            color: #cbd5e1;
          }

          .pos-select {
            width: 100%;
            border: none;
            padding: 15px 0;
            font-family: inherit;
            font-size: 1rem;
            color: #0f172a;
            outline: none;
            background: transparent;
            font-weight: 700;
            cursor: pointer;
          }

          .pos-visual-card {
            background: white;
            border-radius: 24px;
            padding: 25px;
            margin: 10px 0 25px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
          }

          .pos-currency-symbol {
            width: 90px;
            height: 90px;
            margin-bottom: 15px;
          }

          .pos-btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 800;
            box-shadow: 0 6px 0 #0369a1, 0 10px 20px rgba(14, 165, 233, 0.3);
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.1s;
          }

          .pos-btn-primary:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #0369a1;
          }

          .pos-btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid #cbd5e1;
            box-shadow: 0 4px 0 #94a3b8;
          }

          /* Code Display */
          .pos-code-container {
            background: #0f172a;
            color: #22d3ee;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            margin: 25px 0;
            border: 4px dashed #334155;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
          }

          .pos-generated-code {
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: 6px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.5);
          }

          .pos-printer-slit {
            height: 12px;
            background: #020617;
            border-radius: 6px;
            margin-top: 25px;
            position: relative;
            z-index: 10;
          }

          .pos-receipt {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -100%) scale(0.9);
            width: 85%;
            background: #fff;
            padding: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s;
            z-index: 1;
            /* Behind device frame, but visible coming out of slit? no needs to be carefully layered */
            opacity: 0;
            border-bottom: 5px jagged white;
            /* CSS jagged edge trick? simplified to just shadow for now */
          }

          /* Receipt animation: We need it to slide OUT of the slit. 
             Slit is at bottom of device. Receipt is behind device? 
             Let's make it float "above" functionality-wise but visually below the frame bottom lip.
          */

          .pos-receipt.printing {
            transform: translate(-50%, 150px) scale(1);
            /* Push it down */
            opacity: 1;
            z-index: 20;
          }

          .pos-numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
          }

          .pos-num-key {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 18px 0;
            text-align: center;
            font-weight: 800;
            font-size: 1.2rem;
            color: #1e293b;
            box-shadow: 0 3px 0 #cbd5e1;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
          }

          .pos-num-key:active {
            transform: translateY(3px);
            box-shadow: none;
          }
        </style>

        <div class="pos-wrapper">
          <div class="virtual-pos-device">
            <!-- Receipt animation element -->
            <div id="pos-printer-receipt" class="pos-receipt">
              <h3 style="margin-top:0;">üåä OceanPay</h3>
              <p style="font-size:0.7rem; color:#64748b;">COMPROBANTE DE TRANSACCI√ìN</p>
              <hr style="border-top:1px dashed #cbd5e1; margin: 10px 0;">
              <p style="margin:5px 0;">MONTO TRANSFERIDO</p>
              <p id="receipt-amount" style="font-size: 1.8rem; font-weight: 900; margin: 5px 0; color:#0f172a;"></p>
              <canvas id="receiptCanvas" class="currency-canvas" data-currency="bux"
                style="width: 50px; height: 50px; margin: 10px auto; display:block;"></canvas>
              <p id="receipt-id" style="font-size: 0.7rem; font-family:'Courier New'; margin-top:10px;"></p>
              <p style="margin-bottom:0;">Gracias por su preferencia</p>
              <div style="margin-top:10px; font-size:1.5rem;">barcode</div>
            </div>

            <div class="pos-screen-frame">
              <div class="pos-screen">
                <div class="pos-top-bar">
                  <span style="display:flex; gap:5px;"><i class="fas fa-signal"></i> 5G</span>
                  <span>14:02 PM</span>
                  <span style="display:flex; gap:5px;"><i class="fas fa-battery-full"></i> 100%</span>
                </div>

                <!-- VIEW: HOME -->
                <div id="pos-home" class="pos-view active">
                  <div class="pos-logo-area">
                    <i class="fas fa-water pos-logo-icon"></i>
                    <h2 style="margin:0; font-weight:900; font-size: 2rem; color:#0f172a; letter-spacing:-1px;">OceanPay
                    </h2>
                    <p style="margin:0; color:#64748b; font-size:0.9rem; font-weight:500;">Terminal Virtual Pro v2.1</p>
                  </div>

                  <div class="pos-home-buttons">
                    <button class="pos-big-btn" onclick="showPosView('pos-send')">
                      <i class="fas fa-paper-plane"></i>
                      <span>Enviar</span>
                    </button>
                    <button class="pos-big-btn" onclick="showPosView('pos-receive')">
                      <i class="fas fa-qrcode"></i>
                      <span>Cobrar</span>
                    </button>
                  </div>
                  <div class="pos-home-buttons-full">
                    <button class="pos-big-btn" style="flex-direction:row; height:auto; margin-bottom:10px;"
                      onclick="showPosView('pos-self')">
                      <i class="fas fa-exchange-alt" style="color:#8b5cf6;"></i>
                      <span>Transferencia Propia</span>
                    </button>
                    <button class="pos-big-btn"
                      style="flex-direction:row; height:auto; background: #faf5ff; border-color: #e9d5ff;"
                      onclick="showPendingSwaps()">
                      <i class="fas fa-sync-alt" style="color:#a855f7;"></i>
                      <span>Solicitudes de Intercambio</span>
                    </button>
                  </div>
                </div>

                <!-- VIEW: SEND (GENERATE) -->
                <div id="pos-send" class="pos-view">
                  <div class="pos-header-nav">
                    <button class="pos-back-btn" onclick="showPosView('pos-home')"><i
                        class="fas fa-arrow-left"></i></button>
                    <span class="pos-title">Enviar Dinero</span>
                  </div>

                  <div class="pos-field">
                    <label>Monto a enviar</label>
                    <div class="pos-input-group">
                      <span style="color:#64748b; font-weight:bold; font-size:1.2rem;">$</span>
                      <input type="number" id="pos-amount-input" class="pos-input" placeholder="0.00" min="0"
                        step="0.01">
                    </div>
                  </div>

                  <div class="pos-field">
                    <label>Divisa</label>
                    <div class="pos-input-group">
                      <select id="pos-currency-select" class="pos-select" onchange="updatePosSendVisual()">
                        <option value="aquabux">AquaBux</option>
                        <option value="ecoxionums">Ecoxionums</option>
                        <option value="ecorebits">EcoCoreBits</option>
                        <option value="wildcredits">WildCredits</option>
                        <option value="wildgems">WildGems</option>
                        <option value="appbux">AppBux</option>
                        <option value="ecobooks">EcoBooks</option>
                        <option value="ecotokens">EcoTokens</option>
                        <option value="amber">Amber</option>
                        <option value="nxb">Nexus Bits (NXB)</option>
                        <option value="voltbit">VoltBits</option>
                      </select>
                    </div>
                  </div>

                  <div class="pos-visual-card">
                    <canvas id="posSendCanvas" class="currency-canvas pos-currency-symbol"
                      data-currency="aquabux"></canvas>
                    <span style="font-size:0.8rem; color:#64748b; font-weight:600;">Seleccionado</span>
                  </div>

                  <div class="pos-field">
                    <label>Pagar desde</label>
                    <div class="pos-input-group">
                      <select id="pos-card-source" class="pos-select"></select>
                    </div>
                  </div>

                  <button class="pos-btn-primary" onclick="generatePOSCode()">Generar C√≥digo</button>
                </div>

                <!-- VIEW: SELF TRANSFER (NEW) -->
                <div id="pos-self" class="pos-view">
                  <div class="pos-header-nav">
                    <button class="pos-back-btn" onclick="showPosView('pos-home')"><i
                        class="fas fa-arrow-left"></i></button>
                    <span class="pos-title">Transferirse a s√≠ mismo</span>
                  </div>

                  <div class="pos-field">
                    <label>Monto</label>
                    <div class="pos-input-group">
                      <input type="number" id="self-amount-input" class="pos-input" placeholder="0.00" min="0"
                        step="0.01">
                    </div>
                  </div>

                  <div class="pos-field">
                    <label>Divisa</label>
                    <div class="pos-input-group">
                      <select id="self-currency-select" class="pos-select">
                        <option value="aquabux">AquaBux</option>
                        <option value="ecoxionums">Ecoxionums</option>
                        <option value="ecorebits">EcoCoreBits</option>
                        <option value="wildcredits">WildCredits</option>
                        <option value="wildgems">WildGems</option>
                        <option value="appbux">AppBux</option>
                        <option value="ecobooks">EcoBooks</option>
                        <option value="ecotokens">EcoTokens</option>
                        <option value="amber">Amber</option>
                        <option value="nxb">Nexus Bits (NXB)</option>
                        <option value="voltbit">VoltBits</option>
                      </select>
                    </div>
                  </div>

                  <div class="pos-field">
                    <label>Desde (Origen)</label>
                    <div class="pos-input-group">
                      <select id="self-card-source" class="pos-select"></select>
                    </div>
                  </div>

                  <div style="text-align:center; margin:-10px 0 10px 0;">
                    <i class="fas fa-arrow-down" style="color:#64748b;"></i>
                  </div>

                  <div class="pos-field">
                    <label>Hacia (Destino)</label>
                    <div class="pos-input-group">
                      <select id="self-card-dest" class="pos-select"></select>
                    </div>
                  </div>

                  <button class="pos-btn-primary"
                    style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); box-shadow: 0 6px 0 #5b21b6, 0 10px 20px rgba(139, 92, 246, 0.3);"
                    onclick="executeSelfTransfer()">Confirmar Transferencia</button>
                </div>

                <!-- VIEW: CODE RESULT -->
                <div id="pos-result" class="pos-view">
                  <div class="pos-header-nav">
                    <button class="pos-back-btn" onclick="showPosView('pos-send')"><i
                        class="fas fa-arrow-left"></i></button>
                    <span class="pos-title">C√≥digo Generado</span>
                  </div>

                  <div style="text-align:center; flex:1; display:flex; flex-direction:column; justify-content:center;">
                    <p style="color:#64748b; margin-bottom:10px; font-weight:600;">Muestra este c√≥digo al receptor</p>
                    <div class="pos-code-container">
                      <div id="pos-generated-code-display" class="pos-generated-code">------</div>
                    </div>
                    <p
                      style="color:#0ea5e9; font-weight:bold; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:10px;">
                      <i class="fas fa-spinner fa-spin"></i> Esperando cobro...
                    </p>
                  </div>
                  <button class="pos-btn-primary pos-btn-secondary" onclick="showPosView('pos-home')">Cancelar</button>
                </div>

                <!-- VIEW: RECEIVE (CLAIM) -->
                <div id="pos-receive" class="pos-view">
                  <div class="pos-header-nav">
                    <button class="pos-back-btn" onclick="showPosView('pos-home')"><i
                        class="fas fa-arrow-left"></i></button>
                    <span class="pos-title">Ingresar C√≥digo</span>
                  </div>

                  <div class="pos-field">
                    <label>C√≥digo POS</label>
                    <div class="pos-input-group">
                      <input type="text" id="pos-claim-input" class="pos-input" placeholder="------"
                        style="text-transform:uppercase; text-align:center; letter-spacing:4px; font-size:2rem; font-family:'Courier New'; font-weight:900;">
                    </div>
                  </div>

                  <!-- Numeric Pad Simulation -->
                  <div class="pos-numpad" id="pos-numpad">
                    <!-- JS will fill logic to append to input -->
                    <div class="pos-num-key" onclick="posType('1')">1</div>
                    <div class="pos-num-key" onclick="posType('2')">2</div>
                    <div class="pos-num-key" onclick="posType('3')">3</div>
                    <div class="pos-num-key" onclick="posType('4')">4</div>
                    <div class="pos-num-key" onclick="posType('5')">5</div>
                    <div class="pos-num-key" onclick="posType('6')">6</div>
                    <div class="pos-num-key" onclick="posType('7')">7</div>
                    <div class="pos-num-key" onclick="posType('8')">8</div>
                    <div class="pos-num-key" onclick="posType('9')">9</div>
                    <div class="pos-num-key" onclick="posType('C')" style="color:#ef4444; background:#fef2f2;">DEL</div>
                    <div class="pos-num-key" onclick="posType('0')">0</div>
                    <div class="pos-num-key" onclick="posType('OK')"
                      style="background:#0ea5e9; color:white; border-color:#0369a1; box-shadow:0 3px 0 #0369a1;">OK
                    </div>
                  </div>
                </div>

                <!-- VIEW: CONFIRM RECEIVE -->
                <div id="pos-confirm" class="pos-view">
                  <div class="pos-header-nav">
                    <button class="pos-back-btn" onclick="showPosView('pos-receive')"><i
                        class="fas fa-arrow-left"></i></button>
                    <span class="pos-title" id="pos-confirm-title">Confirmar Cobro</span>
                  </div>

                  <div
                    style="background:#fff; border-radius:24px; padding:30px 20px; box-shadow:0 10px 40px rgba(0,0,0,0.05); margin-bottom:25px; display:flex; flex-direction:column; align-items:center;">
                    <p style="color:#64748b; font-size:0.8rem; margin:0; font-weight:700; text-transform:uppercase;">Vas
                      a recibir</p>
                    <h2 id="pos-confirm-amount"
                      style="margin:10px 0; font-size:2.5rem; color:#0f172a; font-weight:900;">
                      0.00</h2>
                    <canvas id="posConfirmCanvas" class="currency-canvas" data-currency="aquabux"
                      style="width: 70px; height: 70px; margin: 10px 0;"></canvas>
                    <div
                      style="background:#f1f5f9; padding:5px 15px; border-radius:20px; color:#3b82f6; font-size:0.9rem; font-weight:700;">
                      <i class="fas fa-user-circle"></i> <span id="pos-confirm-sender">Usuario</span>
                    </div>
                  </div>

                  <div id="pos-swap-details" class="hidden" style="text-align:center; margin-bottom:20px;">
                    <i class="fas fa-arrow-down" style="color:#64748b; margin-bottom:10px;"></i>
                    <div
                      style="background:rgba(168, 85, 247, 0.1); padding:15px; border-radius:20px; border:1px solid rgba(168, 85, 247, 0.2);">
                      <p style="color:#7c3aed; font-size:0.75rem; font-weight:800; text-transform:uppercase; margin:0;">
                        Recibir√°s</p>
                      <h3 id="pos-swap-target-amount" style="margin:5px 0; color:#1e293b; font-weight:900;">0.00</h3>
                      <canvas id="posSwapTargetCanvas" class="currency-canvas" data-currency="wildgems"
                        style="width:50px; height:50px;"></canvas>
                    </div>
                  </div>

                  <div class="pos-field" id="pos-dest-card-field">
                    <label>Depositar en</label>
                    <div class="pos-input-group">
                      <select id="pos-card-dest" class="pos-select"></select>
                    </div>
                  </div>

                  <button class="pos-btn-primary" onclick="completePOS()" id="pos-confirm-btn">Aceptar
                    Transacci√≥n</button>
                </div>

                <!-- VIEW: PENDING SWAPS -->
                <div id="pos-swaps" class="pos-view">
                  <div class="pos-header-nav">
                    <button class="pos-back-btn" onclick="showPosView('pos-home')"><i
                        class="fas fa-arrow-left"></i></button>
                    <span class="pos-title">Intercambios Solicitados</span>
                  </div>
                  <div id="swaps-list"
                    style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px;">
                    <p style="text-align:center; color:#64748b; margin-top:20px;">Cargando solicitudes...</p>
                  </div>
                </div>

              </div>
            </div>

            <div class="pos-printer-slit"></div>
          </div>
        </div>
      </section>

      <!-- Notifications Section -->
      <section id="notifications-section" class="hidden">
        <div class="main-header" style="justify-content: space-between; display: flex;">
          <h2 class="page-title">Notificaciones</h2>
          <button class="secondary" style="width: auto; padding: 0.5rem 1rem;" onclick="loadNotifications()">
            <i class="fas fa-sync-alt"></i> Actualizar
          </button>
        </div>

        <div id="notifications-list">
          <p style="color: #64748b; text-align: center; margin-top: 2rem;">Cargando notificaciones...</p>
        </div>
      </section>

      <!-- Misc Section (Charts) -->
      <section id="misc-section" class="hidden">
        <div class="main-header">
          <h2 class="page-title">Estad√≠sticas y Gr√°ficas</h2>
          <button class="secondary" style="width: auto; padding: 0.5rem 1rem;" onclick="loadMiscStats()">
            <i class="fas fa-sync-alt"></i> Actualizar
          </button>
        </div>

        <div class="balance-grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
          <div
            style="background: var(--card); padding: 2rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
            <h3 style="margin-bottom: 20px; color: var(--ok); text-align:center;">üèÜ Ingresos (M√°s Usado)</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="chartIncomes"></canvas>
            </div>
          </div>

          <div
            style="background: var(--card); padding: 2rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
            <h3 style="margin-bottom: 20px; color: var(--err); text-align:center;">üí∏ Gastos (M√°s Usado)</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="chartExpenses"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings Section -->
      <section id="settings-section" class="hidden">
        <div class="main-header">
          <h2 class="page-title">Ajustes de Cuenta</h2>
        </div>
        <div style="max-width: 600px;">
          <div
            style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 1.5rem; border-radius: 1rem;">
            <h3 style="color: var(--err); margin-bottom: 1rem;">Zona de Peligro</h3>
            <p style="margin-bottom: 1rem; font-size: 0.9rem;">Eliminar tu cuenta es irreversible. Perder√°s todos tus
              fondos.</p>
            <button id="deleteAccountBtn" style="background: var(--err); color: white;">üóëÔ∏è Eliminar Cuenta
              Permanentemente</button>
          </div>
          <button id="logoutBtn" class="secondary" style="margin-top: 2rem;">Cerrar Sesi√≥n</button>
        </div>
      </section>

    </main>
  </div>

  <script>
    const API = 'https://owsdatabase.onrender.com';
    let token = '', userId = 0;
    let userCards = []; // Array de tarjetas con saldos
    let activeCardIndex = 0; // √çndice de la tarjeta activa
    let isRefreshingToken = false; // Prevent concurrent refresh attempts

    /* ---------- HELPERS ---------- */
    const qs = x => document.querySelector(x);
    const show = (sel, on = true) => {
      const el = typeof sel === 'string' ? qs(sel) : sel;
      if (el) el.classList.toggle('hidden', !on);
    };

    /* ---------- TOAST NOTIFICATION SYSTEM ---------- */
    function showToast(message, type = 'info', duration = 5000) {
      // Create toast container if not exists
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = `
  position: fixed; top: 20px; right: 20px; z-index: 999999;
  display: flex; flex-direction: column; gap: 10px;
  pointer-events: none; max-width: 420px;
  `;
        document.body.appendChild(container);
      }

      const toast = document.createElement('div');
      const colors = {
        info: { bg: 'rgba(34, 211, 238, 0.15)', border: 'rgba(34, 211, 238, 0.4)', icon: 'fa-info-circle', color: '#22d3ee' },
        success: {
          bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.4)', icon: 'fa-check-circle', color:
            '#10b981'
        },
        warning: {
          bg: 'rgba(251, 191, 36, 0.15)', border: 'rgba(251, 191, 36, 0.4)', icon: 'fa-exclamation-triangle', color:
            '#fbbf24'
        },
        error: { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.4)', icon: 'fa-times-circle', color: '#ef4444' }
      };
      const c = colors[type] || colors.info;
      toast.style.cssText = `
  background: ${c.bg}; backdrop-filter: blur(20px);
  border: 1px solid ${c.border}; border-radius: 16px;
  padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.75rem;
  color: white; font-family: 'Inter', sans-serif; font-size: 0.9rem;
  pointer-events: all; cursor: pointer; animation: toastSlideIn 0.4s ease-out;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  `;
      toast.innerHTML = `
  <i class="fas ${c.icon}" style="color: ${c.color}; font-size: 1.2rem; flex-shrink: 0;"></i>
  <span style="flex: 1; line-height: 1.4;">${message}</span>
  <i class="fas fa-times" style="opacity: 0.5; font-size: 0.8rem; flex-shrink: 0;"></i>
  `;
      toast.onclick = () => {
        toast.style.animation = 'toastSlideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      };

      container.appendChild(toast);

      // Auto-remove
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'toastSlideOut 0.3s ease-in forwards';
          setTimeout(() => toast.remove(), 300);
        }
      }, duration);
    }

    // Inject toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
  @keyframes toastSlideIn {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
  }
  @keyframes toastSlideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(120%); opacity: 0; }
  }
  `;
    document.head.appendChild(toastStyle);

    /* ---------- SMART API FETCH (Auto Token Refresh) ---------- */
    async function apiFetch(url, options = {}) {
      // Ensure Authorization header
      if (token && !options.skipAuth) {
        options.headers = { ...(options.headers || {}), 'Authorization': `Bearer ${token}` };
      }

      const res = await fetch(url, options);

      // If 401, attempt silent token refresh
      if (res.status === 401 && token && !options._isRetry) {
        console.warn('[apiFetch] Got 401, attempting token refresh...');
        const refreshed = await attemptTokenRefresh();
        if (refreshed) {
          // Retry the original request with new token
          options._isRetry = true;
          options.headers = { ...(options.headers || {}), 'Authorization': `Bearer ${token}` };
          return fetch(url, options);
        } else {
          // Refresh failed ‚Äî session truly expired
          handleExpiredToken();
        }
      }

      return res;
    }

    async function attemptTokenRefresh() {
      if (isRefreshingToken) return false;
      isRefreshingToken = true;

      try {
        const res = await fetch(`${API}/ocean-pay/refresh-token`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
          const data = await res.json();
          token = data.token;
          localStorage.setItem('opToken', token);

          // Update opUser with new token
          const opUser = JSON.parse(localStorage.getItem('opUser') || '{}');
          opUser.token = token;
          localStorage.setItem('opUser', JSON.stringify(opUser));

          showToast('Sesi√≥n renovada autom√°ticamente.', 'success', 3000);
          console.log('‚úÖ Token refreshed successfully');
          isRefreshingToken = false;
          return true;
        } else {
          console.warn('‚ùå Token refresh failed:', res.status);
          isRefreshingToken = false;
          return false;
        }
      } catch (e) {
        console.error('‚ùå Token refresh error:', e);
        isRefreshingToken = false;
        return false;
      }
    }

    // Obtener saldo de la tarjeta activa
    function getActiveCardBalance(currencyType) {
      if (!userCards[activeCardIndex]) return 0;
      return userCards[activeCardIndex].balances?.[currencyType] || 0;
    }

    /* ---------- CURRENCY ANIMATION SYSTEM ---------- */
    /* ---------- CURRENCY ANIMATION SYSTEM ---------- */
    function drawEcoTokenIcon(ctx, x, y, size) {
      ctx.save(); ctx.translate(x, y);
      ctx.shadowBlur = size * 0.4; ctx.shadowColor = "rgba(46, 204, 113, 0.6)";
      ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(0, 0, size * 0.5, 0, Math.PI * 2); ctx.fill();
      const grad = ctx.createLinearGradient(-size, -size, size, size);
      grad.addColorStop(0, "#2ecc71"); grad.addColorStop(1, "#27ae60");
      ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0, 0, size * 0.43, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.beginPath(); ctx.arc(-size * 0.1, -size * 0.1, size * 0.15, 0, Math.PI *
        2); ctx.fill();
      ctx.shadowBlur = 0; ctx.fillStyle = "#fff"; ctx.font = `bold ${size * 0.55}px sans-serif`;
      ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("E", 0, 0);
      ctx.restore();
    }

    function drawAquaBuxIcon(ctx, x, y, size, time) {
      ctx.save(); ctx.translate(x, y);

      // Outer Glow Pulse
      const pulse = Math.sin(time * 2) * 0.1 + 0.9;
      ctx.shadowBlur = size * 0.4 * pulse; ctx.shadowColor = "rgba(0, 191, 255, 0.5)";

      // 1. Outer Glassy Shell
      const shellGrad = ctx.createRadialGradient(-size * 0.2, -size * 0.3, 0, 0, 0, size * 0.6);
      shellGrad.addColorStop(0, "rgba(255, 255, 255, 0.3)");
      shellGrad.addColorStop(0.5, "rgba(0, 184, 212, 0.1)");
      shellGrad.addColorStop(1, "rgba(0, 96, 128, 0.4)");

      ctx.beginPath();
      ctx.moveTo(0, -size * 0.6);
      ctx.bezierCurveTo(size * 0.4, -size * 0.1, size * 0.5, size * 0.3, size * 0.5, size * 0.4);
      ctx.arc(0, size * 0.4, size * 0.5, 0, Math.PI);
      ctx.bezierCurveTo(-size * 0.5, size * 0.3, -size * 0.4, -size * 0.1, 0, -size * 0.6);
      ctx.fillStyle = shellGrad; ctx.fill();
      ctx.strokeStyle = "rgba(255, 255, 255, 0.5)"; ctx.lineWidth = 2; ctx.stroke();

      // 2. Inner Energy Core (Pulsating)
      ctx.save();
      const coreSize = size * (0.2 + Math.sin(time * 3) * 0.04);
      const coreGrad = ctx.createRadialGradient(0, size * 0.3, 0, 0, size * 0.3, coreSize * 1.5);
      coreGrad.addColorStop(0, "#ffffff");
      coreGrad.addColorStop(0.4, "#00e5ff");
      coreGrad.addColorStop(1, "transparent");

      ctx.fillStyle = coreGrad;
      ctx.beginPath(); ctx.arc(0, size * 0.3, coreSize, 0, Math.PI * 2); ctx.fill();
      ctx.restore();

      // 3. Swirling "Water" Currents
      ctx.strokeStyle = "rgba(255, 255, 255, 0.2)"; ctx.lineWidth = 2; ctx.lineCap = "round";
      for (let i = 0; i < 3; i++) {
        const angle = time + (i * Math.PI * 2 / 3); const sx = Math.cos(angle) * size * 0.2; const
          sy = size * 0.3 + Math.sin(angle) * size * 0.15; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(sx * 1.1, sy);
        ctx.stroke();
      } // 4. Surface Refraction (Top Shine) ctx.fillStyle="rgba(255, 255, 255, 0.5)" ; ctx.beginPath();
      ctx.ellipse(-size * 0.15, -size * 0.25, size * 0.1, size * 0.15, -0.5, 0, Math.PI * 2); ctx.fill(); ctx.restore();
    }
    function drawWildCreditsIcon(ctx, x, y, size) {
      ctx.save(); ctx.translate(x, y); ctx.shadowBlur = size * 0.4;
      ctx.shadowColor = "rgba(100, 255, 100, 0.5)"; // Leaf Shape ctx.beginPath(); ctx.moveTo(0, -size * 0.6);
      ctx.quadraticCurveTo(size * 0.6, -size * 0.5, size * 0.4, size * 0.4); ctx.quadraticCurveTo(0, size * 0.7, -size *
        0.4, size * 0.4); ctx.quadraticCurveTo(-size * 0.6, -size * 0.5, 0, -size * 0.6); const
          grad = ctx.createLinearGradient(0, -size * 0.6, 0, size * 0.7); grad.addColorStop(0, "#4ade80");
      grad.addColorStop(1, "#166534"); ctx.fillStyle = grad; ctx.fill(); // Glowing Veins
      ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = size * 0.05; ctx.beginPath(); ctx.moveTo(0, -size * 0.5);
      ctx.lineTo(0, size * 0.5); ctx.stroke(); ctx.lineWidth = size * 0.02;
      ctx.beginPath(); ctx.moveTo(0, -size * 0.2);
      ctx.lineTo(size * 0.3, -size * 0.4); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0, size * 0.1); ctx.lineTo(-size * 0.3, -size * 0.1); ctx.stroke();
      // Text over a chip 
      ctx.fillStyle = "rgba(0,0,0,0.4)";
      ctx.beginPath();
      ctx.arc(0, 0, size * 0.25, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = "#fff"; ctx.font = `bold ${size * 0.25}px sans-serif`;
      ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("WC", 0, 0); ctx.restore();
    } function
      drawWildGemsIcon(ctx, x, y, size) {
      ctx.save(); ctx.translate(x, y); ctx.shadowBlur = size * 0.5;
      ctx.shadowColor = "rgba(168, 85, 247, 0.6)"; ctx.beginPath(); for (let i = 0; i < 6; i++) {
        const angle = (i * Math.PI *
          2) / 6 - Math.PI / 2; const px = Math.cos(angle) * size * 0.5; const py = Math.sin(angle) * size * 0.5; if (i === 0)
          ctx.moveTo(px, py); else ctx.lineTo(px, py);
      } ctx.closePath(); const grad = ctx.createRadialGradient(0, 0, 0, 0, 0,
        size * 0.6); grad.addColorStop(0, "#d8b4fe"); grad.addColorStop(1, "#a855f7"); ctx.fillStyle = grad; ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 1; for (let i = 0; i < 6; i++) {
        const angle = (i * Math.PI * 2)
          / 6 - Math.PI / 2; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(Math.cos(angle) * size * 0.5, Math.sin(angle) *
            size * 0.5); ctx.stroke();
      } ctx.restore();
    } function drawEcoxionumsIcon(ctx, x, y, size) {
      ctx.save();
      ctx.translate(x, y); ctx.shadowBlur = size * 0.4; ctx.shadowColor = "rgba(34, 211, 238, 0.6)"; // Gradient Body const
      grad = ctx.createLinearGradient(-size / 2, -size / 2, size / 2, size / 2); grad.addColorStop(0, "#22d3ee");
      grad.addColorStop(1, "#0ea5e9"); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0, 0, size * 0.45, 0, Math.PI * 2);
      ctx.fill(); // Inner Ring ctx.strokeStyle="rgba(255,255,255,0.3)" ; ctx.lineWidth=size * 0.04; ctx.beginPath();
      ctx.arc(0, 0, size * 0.35, 0, Math.PI * 2); ctx.stroke(); // Cross Pattern ctx.strokeStyle="rgba(255,255,255,0.5)" ;
      ctx.lineWidth = size * 0.08; ctx.lineCap = "round"; // Vertical ctx.beginPath(); ctx.moveTo(0, -size * 0.25);
      ctx.lineTo(0, size * 0.25); ctx.stroke(); // Horizontal ctx.beginPath(); ctx.moveTo(-size * 0.25, 0);
      ctx.lineTo(size * 0.25, 0); ctx.stroke(); // Shine ctx.fillStyle="rgba(255,255,255,0.2)" ; ctx.beginPath();
      ctx.arc(0, 0, size * 0.15, 0, Math.PI * 2); ctx.fill(); ctx.restore();
    } function drawAmberIcon(ctx, x, y, size) {
      ctx.save(); ctx.translate(x, y); ctx.shadowBlur = size * 0.5; ctx.shadowColor = "rgba(245, 158, 11, 0.6)";
      // Outer Amber Gem (slightly irregular for organic look)
      const grad = ctx.createRadialGradient(-size * 0.1, -size * 0.1, size * 0.05, 0, 0, size * 0.5); grad.addColorStop(0, "#fbbf24"); grad.addColorStop(0.6, "#d97706");
      grad.addColorStop(1, "#92400e"); ctx.beginPath(); for (let i = 0; i < 8; i++) {
        const angle = (i * Math.PI * 2) / 8;
        const r = size * (0.4 + (i % 2 === 0 ? 0.05 : -0.02)); ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
      }
      ctx.closePath(); ctx.fillStyle = grad; ctx.fill();
      // Fossilized Footprint (Inside) 
      ctx.globalAlpha = 0.5;
      ctx.fillStyle = "rgba(69, 26, 3, 0.8)"; const fs = size * 0.1; const fy = size * 0.05;
      ctx.beginPath(); ctx.ellipse(0, fy + fs * 0.5, fs * 1.2, fs * 0.8, 0, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(-fs * 1.1, fy - fs * 0.2, fs * 0.5, fs * 0.8, -Math.PI / 6, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(0, fy - fs * 0.8, fs * 0.5, fs * 0.9, 0, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(fs * 1.1, fy - fs * 0.2, fs * 0.5, fs * 0.8, Math.PI / 6, 0, Math.PI * 2); ctx.fill();
      // Shines 
      ctx.globalAlpha = 1; ctx.beginPath();
      ctx.ellipse(-size * 0.15, -size * 0.15, size * 0.1, size * 0.05, Math.PI / 4, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(255, 255, 255, 0.4)"; ctx.fill(); ctx.restore();
    } function drawEcoCoreBitsIcon(ctx, x, y,
      size) {
      ctx.save(); ctx.translate(x, y); ctx.shadowBlur = size * 0.6; ctx.shadowColor = "rgba(168, 85, 247, 0.6)";
      // Isometric Cube Frame 
      const drawHex = (s, color) => {
        ctx.fillStyle = color;
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
          const a = (i * Math.PI * 2) / 6 - Math.PI / 2; ctx.lineTo(Math.cos(a) * s, Math.sin(a) *
            s);
        } ctx.closePath(); ctx.fill();
      }; drawHex(size * 0.5, "#7c3aed"); drawHex(size * 0.4, "#4c1d95");
      // Circuit Dot 
      ctx.fillStyle = "#a78bfa"; ctx.beginPath(); ctx.arc(0, 0, size * 0.15, 0, Math.PI * 2); ctx.fill();
      ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
      // Glowing border 
      ctx.strokeStyle = "rgba(255,255,255,0.5)";
      ctx.strokeRect(-size * 0.2, -size * 0.2, size * 0.4, size * 0.4); ctx.restore();
    } function drawAppBuxIcon(ctx,
      x, y, size) {
      ctx.save(); ctx.translate(x, y); ctx.shadowBlur = size * 0.5;
      ctx.shadowColor = "rgba(251, 146, 60, 0.6)";
      // Multi-layered Ring 
      const grad = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 0.6);
      grad.addColorStop(0, "#ffedd5"); grad.addColorStop(0.5, "#fb923c");
      grad.addColorStop(1, "#ea580c"); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0, 0, size * 0.55, 0, Math.PI * 2);
      ctx.fill();
      // Inner Tech Hole 
      ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(0, 0,
        size * 0.3, 0, Math.PI * 2); ctx.fill(); ctx.globalCompositeOperation = 'source-over';
      // Center Floating Symbol
      ctx.fillStyle = "#fff"; ctx.font = `bold ${size * 0.5}px sans-serif`; ctx.textAlign = "center";
      ctx.textBaseline = "middle"; ctx.fillText("+", 0, -size * 0.05);
      // Shine 
      ctx.beginPath();
      ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = size * 0.08; ctx.arc(0, 0, size * 0.45, -Math.PI * 0.4,
        -0.2); ctx.stroke(); ctx.restore();
    } function drawNXBIcon(ctx, x, y, size) {
      ctx.save(); ctx.translate(x, y);
      ctx.shadowBlur = size * 0.5; ctx.shadowColor = "rgba(240, 138, 93, 0.6)";
      // Hexagon base 
      ctx.beginPath(); for (let i = 0; i < 6; i++) {
        const angle = (i * Math.PI * 2) / 6; ctx.lineTo(Math.cos(angle) * size * 0.5, Math.sin(angle) *
          size * 0.5);
      } ctx.closePath(); const grad = ctx.createLinearGradient(-size, -size, size, size);
      grad.addColorStop(0, "#f08a5d"); grad.addColorStop(1, "#b83b5e"); ctx.fillStyle = grad; ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, -size * 0.3);
      ctx.lineTo(0, size * 0.3); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-size * 0.3, 0); ctx.lineTo(size * 0.3, 0);
      ctx.stroke(); ctx.fillStyle = "#fff"; ctx.font = `bold ${size * 0.3}px sans-serif`; ctx.textAlign = "center";
      ctx.textBaseline = "middle"; ctx.fillText("N", 0, 0); ctx.restore();
    }

    function drawVoltBitIcon(ctx, x, y, size) {
      ctx.save(); ctx.translate(x, y);
      const glow = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 0.5);
      glow.addColorStop(0, '#fff'); glow.addColorStop(0.5, '#00e5ff'); glow.addColorStop(1, 'transparent');
      ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(0, 0, size * 0.5, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = '#00e5ff'; ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const a = (Math.PI * 2 / 6) * i;
        ctx.lineTo(Math.cos(a) * size * 0.35, Math.sin(a) * size * 0.35);
      }
      ctx.closePath(); ctx.fill();
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
      // Rayo central 
      ctx.fillStyle = '#fff'; ctx.beginPath();
      ctx.moveTo(0, -size * 0.2); ctx.lineTo(-size * 0.1, size * 0.05); ctx.lineTo(size * 0.05, size * 0.05);
      ctx.lineTo(-size * 0.05, size * 0.2); ctx.lineTo(size * 0.1, -size * 0.05); ctx.lineTo(-size * 0.05, -size * 0.05);
      ctx.closePath(); ctx.fill(); ctx.restore();
    }

    function drawEcoBooksIcon(ctx, x, y, size) {
      ctx.save();
      ctx.translate(x, y); ctx.shadowBlur = size * 0.4; ctx.shadowColor = "rgba(6, 182, 212, 0.5)";
      // Book Body (Open 3D look)
      ctx.fillStyle = "#fff";
      // Left Page 
      ctx.beginPath(); ctx.moveTo(-size * 0.4, -size * 0.3);
      ctx.quadraticCurveTo(-size * 0.2, -size * 0.4, 0, -size * 0.3); ctx.lineTo(0, size * 0.3);
      ctx.quadraticCurveTo(-size * 0.2, size * 0.2, -size * 0.4, size * 0.3); ctx.closePath(); ctx.fill();
      // Right Page
      ctx.beginPath(); ctx.moveTo(size * 0.4, -size * 0.3); ctx.quadraticCurveTo(size * 0.2, -size * 0.4, 0, -size * 0.3);
      ctx.lineTo(0, size * 0.3); ctx.quadraticCurveTo(size * 0.2, size * 0.2, size * 0.4, size * 0.3);
      ctx.closePath(); ctx.fill();
      // Cover edges 
      ctx.strokeStyle = "#0891b2"; ctx.lineWidth = 2; ctx.beginPath();
      ctx.moveTo(-size * 0.4, -size * 0.3); ctx.lineTo(-size * 0.4, size * 0.3); ctx.stroke(); ctx.beginPath();
      ctx.moveTo(size * 0.4, -size * 0.3); ctx.lineTo(size * 0.4, size * 0.3); ctx.stroke();
      // Leaf Bookmark
      ctx.fillStyle = "#22c55e"; ctx.beginPath(); ctx.moveTo(-size * 0.1, -size * 0.3); ctx.quadraticCurveTo(0, -size * 0.1, size * 0.1, -size * 0.3);
      ctx.lineTo(0, size * 0.1); ctx.closePath(); ctx.fill(); ctx.restore();
    } function
      animateCurrencies() {
      const canvases = document.querySelectorAll('.currency-canvas'); const time = Date.now() * 0.002;
      canvases.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        const type = canvas.dataset.currency;
        const size = 128; // Higher res for crispness

        if (canvas.width !== size) {
          canvas.width = size;
          canvas.height = size;
        }

        ctx.clearRect(0, 0, size, size);

        // Floating motion
        const hover = Math.sin(time) * 3;
        const x = size / 2;
        const y = size / 2 + hover;

        switch (type) {
          case 'ecotokens': drawEcoTokenIcon(ctx, x, y, size * 0.8); break;
          case 'bux':
          case 'aquabux': drawAquaBuxIcon(ctx, x, y, size * 0.8, time); break;
          case 'wildcredits': drawWildCreditsIcon(ctx, x, y, size * 0.8); break;
          case 'wildgems': drawWildGemsIcon(ctx, x, y, size * 0.8); break;
          case 'ecoxionums': drawEcoxionumsIcon(ctx, x, y, size * 0.8); break;
          case 'ecobits':
          case 'ecorebits': drawEcoCoreBitsIcon(ctx, x, y, size * 0.8); break;
          case 'appbux': drawAppBuxIcon(ctx, x, y, size * 0.8); break;
          case 'ecobooks': drawEcoBooksIcon(ctx, x, y, size * 0.8); break;
          case 'amber': drawAmberIcon(ctx, x, y, size * 0.8); break;
          case 'nxb': drawNXBIcon(ctx, x, y, size * 0.8); break;
          case 'voltbit': drawVoltBitIcon(ctx, x, y, size * 0.8); break;
          default:
            ctx.fillStyle = "#fff"; ctx.font = "64px serif"; ctx.textAlign = "center";
            ctx.textBaseline = "middle"; ctx.fillText("üí∞", x, y);
        }
      });

      requestAnimationFrame(animateCurrencies);
    }

    // Start animation loop
    animateCurrencies();

    function updatePosSendVisual() {
      const select = qs('#pos-currency-select');
      const canvas = qs('#posSendCanvas');
      if (select && canvas) {
        canvas.dataset.currency = select.value;
      }
    }

    // Actualizar displays de saldos seg√∫n tarjeta activa
    function updateBalanceDisplays() {
      if (!userCards[activeCardIndex]) return;

      const balances = userCards[activeCardIndex].balances || {};

      qs('#bux').textContent = Math.round(balances.aquabux || 0).toLocaleString();
      qs('#ecoxionums').textContent = Math.round(balances.ecoxionums || 0).toLocaleString();
      qs('#ecobits').textContent = Math.round(balances.ecorebits || 0).toLocaleString();
      qs('#wildcredits').textContent = Math.round(balances.wildcredits || 0).toLocaleString();
      qs('#wildgems').textContent = Math.round(balances.wildgems || 0).toLocaleString();
      qs('#appbux').textContent = Math.round(balances.appbux || 0).toLocaleString();
      qs('#ecobooks').textContent = Math.round(balances.ecobooks || 0).toLocaleString();
      qs('#ecotokens').textContent = Math.round(balances.ecotokens || 0).toLocaleString();
      qs('#nxb-balance').textContent = Math.round(balances.nxb || 0).toLocaleString();
      qs('#voltbit').textContent = Math.round(balances.voltbit || 0).toLocaleString();
      qs('#ecopower').textContent = Math.round(balances.ecopower || 100);
    }

    /* ---------- POS LOGIC (VIRTUAL DEVICE) ---------- */

    // Navigation
    function showPosView(viewId) {
      document.querySelectorAll('.pos-view').forEach(el => {
        el.classList.remove('active');
        el.style.pointerEvents = 'none';
      });
      const target = document.getElementById(viewId);
      if (target) {
        target.classList.add('active');
        target.style.pointerEvents = 'auto';
      }
    }

    // Numpad Input
    function posType(key) {
      const input = qs('#pos-claim-input');
      if (key === 'C') {
        input.value = '';
      } else if (key === 'OK') {
        fetchPOSInfo();
      } else {
        if (input.value.length < 6) { input.value += key; }
      }
    }

    // Sender: Generate Code
    async function generatePOSCode() {
      const amount = parseFloat(qs('#pos-amount-input').value);
      const currency = qs('#pos-currency-select').value;
      const cardId = qs('#pos-card-source').value;
      if (!amount || amount <= 0) return alert('Ingresa un monto v√°lido');
      if (!cardId) return alert('Selecciona una tarjeta de origen');
      try {
        const res = await fetch(`${API}/pos/create`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
            userId, cardId,
            amount, currency
          })
        });
        const data = await res.json();
        if (data.success) {
          qs('#pos-generated-code-display').textContent = data.pos.code;
          showPosView('pos-result');
        } else {
          alert('Error: ' + data.error);
        }
      } catch (e) {
        alert('Error de conexi√≥n');
      }
    }

    // Receiver: Verify Code 
    async function fetchPOSInfo() {
      const code = qs('#pos-claim-input').value.trim();
      if (!code) return alert('Ingresa un c√≥digo');
      try {
        const res = await
          fetch(`${API}/pos/${code}`); const data = await res.json(); if (data.success) {
            const pos = data.pos; const
              isExchange = pos.is_exchange; qs('#pos-confirm-title').textContent = isExchange ? 'Confirmar Intercambio'
                : 'Confirmar Cobro'; qs('#pos-confirm-amount').textContent = `${pos.amount} ${pos.currency.toUpperCase()}`;
            qs('#pos-confirm-sender').textContent = isExchange ? `Tu Tarjeta (Intercambio)` : `De: ${pos.sender_name}`;
            show('#pos-swap-details', isExchange); show('#pos-dest-card-field', !isExchange); if (isExchange) {
              let rate = 1;
              if (pos.target_currency === 'wildgems') {
                const rates = {
                  'aquabux': 10, 'ecoxionums': 50, 'ecorebits':
                    100, 'wildcredits': 5, 'nxb': 2
                }; rate = rates[pos.currency.toLowerCase()] || 1;
              } else if
                (pos.target_currency === 'nxb') {
                const rates = {
                  'amber': 25, 'ecotokens': 5, 'appbux': 15, 'wildcredits':
                    10, 'aquabux': 5
                }; rate = rates[pos.currency.toLowerCase()] || 1;
              }
              qs('#pos-swap-target-amount').textContent = `${Math.floor(pos.amount * rate)}
        ${pos.target_currency.toUpperCase()}`; qs('#posSwapTargetCanvas').dataset.currency = pos.target_currency;
              qs('#pos-confirm-btn').textContent = 'Confirmar Intercambio';
            } else {
              qs('#pos-confirm-btn').textContent = 'Aceptar Transacci√≥n';
            } const confirmCanvas = qs('#posConfirmCanvas'); if
              (confirmCanvas) { confirmCanvas.dataset.currency = pos.currency; } // Store data for completion
            qs('#pos-confirm').dataset.code = code; showPosView('pos-confirm');
          } else { alert(data.error); }
      } catch (e) {
        alert('Error de conexi√≥n');
      }
    }

    // Receiver: Complete Transfer & Print Receipt
    async function completePOS() {
      const code = qs('#pos-confirm').dataset.code; const receiverCardId = qs('#pos-card-dest').value; const
        isExchange = qs('#pos-confirm-title').textContent === 'Confirmar Intercambio'; if (!isExchange && !receiverCardId)
        return alert('Selecciona una tarjeta de destino'); try {
          const res = await fetch(`${API}/pos/complete`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
              code, receiverId:
                userId, receiverCardId
            })
          }); const data = await res.json(); if (data.success) { // Print Receipt Animation const
            receipt = qs('#pos-printer-receipt'); qs('#receipt-amount').textContent = qs('#pos-confirm-amount').textContent;
            qs('#receipt-id').textContent = `TRX-${Date.now().toString().slice(-6)}`; const
              receiptCanvas = qs('#receiptCanvas'); const confirmCanvas = qs('#posConfirmCanvas'); if (receiptCanvas &&
                confirmCanvas) { receiptCanvas.dataset.currency = confirmCanvas.dataset.currency; }
            receipt.classList.add('printing'); setTimeout(() => {
              alert('¬°Transacci√≥n completada!');
              receipt.classList.remove('printing');
              qs('#pos-claim-input').value = '';
              refreshAllBalances();
              showPosView('pos-home');
            }, 2500);

          } else {
            alert('Error: ' + data.error);
          }
        } catch (e) {
          console.error(e);
          alert('Error al procesar el pago');
        }
    }

    // Mostrar solicitudes de intercambio pendientes
    async function showPendingSwaps() {
      showPosView('pos-swaps');
      const listEl = qs('#swaps-list');
      listEl.innerHTML = '<p style="text-align:center; color:#64748b; margin-top:20px;">Cargando...</p>';

      try {
        const res = await fetch(`${API}/pos/pending-swaps/${userId}`);
        const data = await res.json();

        if (data.success && data.swaps.length > 0) {
          const rates = { 'aquabux': 10, 'ecoxionums': 50, 'ecorebits': 100, 'wildcredits': 5, 'amber': 8 };
          listEl.innerHTML = data.swaps.map(swap => {
            let rate = 1;
            if (swap.target_currency === 'wildgems') {
              const rates = { 'aquabux': 10, 'ecoxionums': 50, 'ecorebits': 100, 'wildcredits': 5, 'nxb': 2 };
              rate = rates[swap.currency.toLowerCase()] || 1;
            } else if (swap.target_currency === 'nxb') {
              const rates = { 'amber': 25, 'ecotokens': 5, 'appbux': 15, 'wildcredits': 10, 'aquabux': 5 };
              rate = rates[swap.currency.toLowerCase()] || 1;
            }
            const targetAmount = Math.floor(swap.amount * rate);
            return `
        <div
          style="background:#fff; border-radius:20px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05); border:1px solid #e2e8f0;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
              <p style="margin:0; font-size:0.75rem; color:#64748b; font-weight:700; text-transform:uppercase;">Desde
              </p>
              <h3 style="margin:5px 0; color:#0f172a; font-weight:900;">${swap.amount} ${swap.currency.toUpperCase()}
              </h3>
              <p style="margin:0; font-size:0.8rem; color:#94a3b8;">${swap.card_name}</p>
            </div>
            <i class="fas fa-arrow-right" style="color:#a855f7; font-size:1.5rem;"></i>
            <div style="text-align:right;">
              <p style="margin:0; font-size:0.75rem; color:#7c3aed; font-weight:700; text-transform:uppercase;">A
                recibir</p>
              <h3 style="margin:5px 0; color:#7c3aed; font-weight:900;">${targetAmount}
                ${swap.target_currency.toUpperCase()}</h3>
            </div>
          </div>
          <button onclick="confirmSwap('${swap.code}')"
            style="width:100%; padding:12px; background:#a855f7; color:#fff; border:none; border-radius:12px; font-weight:800; cursor:pointer; font-size:0.9rem;">
            Confirmar Intercambio
          </button>
        </div>
        `;
          }).join('');
        } else {
          listEl.innerHTML = `
              <p style="text-align:center; color:#64748b; margin-top:40px;">
                <i class="fas fa-inbox" style="font-size:3rem; display:block; margin-bottom:10px; opacity:0.3;"></i>
                No tienes solicitudes pendientes
              </p>`;
        }
      } catch (e) {
        listEl.innerHTML = '<p style="text-align:center; color:#ef4444; margin-top:20px;">Error al cargar</p>';
      }
    }

    // Confirmar intercambio directamente
    async function confirmSwap(code) {
      if (!confirm('¬øConfirmar esta conversi√≥n de divisas?')) return;

      try {
        const res = await fetch(`${API}/pos/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, receiverId: userId, receiverCardId: 0 })
        });
        const data = await res.json();

        if (data.success) {
          alert('¬°Intercambio completado exitosamente!');
          refreshAllBalances();
          showPendingSwaps();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (e) {
        alert('Error de conexi√≥n al procesar el intercambio');
      }
    }

    // Actualizar selects de POS con las tarjetas del usuario
    function updatePOSCardSelects() {
      const senderSelect = qs('#pos-card-source');
      const receiverSelect = qs('#pos-card-dest');
      const selfSource = qs('#self-card-source');
      const selfDest = qs('#self-card-dest');

      if (!senderSelect) return;

      const options = userCards.map(card => {
        const name = card.card_name || (card.is_primary ? 'Tarjeta Principal' : 'Tarjeta Secundaria');
        return `<option value="${card.id}">${name} (**** ${card.card_number.slice(-4)})</option>`;
      }).join('');

      if (senderSelect) senderSelect.innerHTML = options;
      if (receiverSelect) receiverSelect.innerHTML = options;
      if (selfSource) selfSource.innerHTML = options;
      if (selfDest) selfDest.innerHTML = options;
    }

    // Cambiar tarjeta activa
    function setActiveCard(index) {
      activeCardIndex = index;
      updateBalanceDisplays();
      renderCards(userCards);

      // Guardar preferencia
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      user.activeCardIndex = index;
      localStorage.setItem('opUser', JSON.stringify(user));
    }

    /* ---------- NAVIGATION ---------- */
    function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
      qs(`#${id}-section`).classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
      const activeBtn = Array.from(document.querySelectorAll('.nav-item')).find(btn =>
        btn.getAttribute('onclick')?.includes(id));
      if (activeBtn) activeBtn.classList.add('active');

      if (id === 'pos') updatePOSCardSelects();
      if (id === 'history') renderTransacciones();
      if (id === 'history') renderTransacciones();
      if (id === 'misc') loadMiscStats();
      if (id === 'notifications') loadNotifications();
    }

    /* ---------- AUTH TOGGLE ---------- */
    qs('#toRegister').onclick = e => {
      e.preventDefault();
      show('#loginForm', false);
      show('#regForm', true);
    };
    qs('#toLogin').onclick = e => {
      e.preventDefault();
      show('#regForm', false);
      show('#loginForm', true);
    };

    /* ---------- REGISTER ---------- */
    qs('#regForm').onsubmit = async e => {
      e.preventDefault();
      const username = qs('#regUser').value;
      const password = qs('#regPass').value;
      if (password.length < 4) {
        qs('#regMsg').textContent = 'La contrase√±a debe tener al menos 4 caracteres.';
        qs('#regMsg').className = 'msg error'; return;
      } try {
        const res = await fetch(API + '/ocean-pay/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json().catch(() => { throw new Error('Error del servidor (respuesta no v√°lida)'); });

        if (!res.ok) {
          qs('#regMsg').textContent = data.error || `Error del servidor (${res.status})`;
          qs('#regMsg').className = 'msg error';
          return;
        }

        qs('#regMsg').className = 'msg success';
        qs('#regMsg').textContent = '¬°Cuenta creada! Bienvenido.';
        setTimeout(() => autoLogin(username, password), 1000);
      } catch (err) {
        console.error(err);
        qs('#regMsg').textContent = 'Error de conexi√≥n o del servidor.';
        qs('#regMsg').className = 'msg error';
      }
    };

    /* ---------- LOGIN ---------- */
    qs('#loginForm').onsubmit = async e => {
      e.preventDefault();
      await autoLogin(qs('#logUser').value, qs('#logPass').value);
    };

    async function autoLogin(username, password) {
      try {
        const res = await fetch(API + '/ocean-pay/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();
        if (!res.ok) {
          qs('#logMsg').textContent = data.error || 'Error al iniciar sesi√≥n';
          qs('#logMsg').className = 'msg error';
          return;
        }

        token = data.token;
        userId = data.user.id;

        // Save User Data
        localStorage.setItem('opToken', token);
        localStorage.setItem('opUser', JSON.stringify({ ...data.user, token }));

        // Update UI
        qs('#userNameDisplay').textContent = data.user.username;
        qs('#userIdDisplay').textContent = `ID: ${data.user.id}`;
        qs('#userAvatar').textContent = data.user.username.charAt(0).toUpperCase();

        // Switch to App Layout
        show('#auth-section', false);
        show('#app-layout', true);

        // Load Data
        refreshAllBalances();
        startBalanceRefresh();

        if (window.opener) {
          window.opener.postMessage({ type: 'ocean-pay-token', token: token, user: data.user }, '*');
        }
      } catch (err) {
        console.error(err);
        qs('#logMsg').textContent = 'Error de conexi√≥n';
      }
    }

    /* ---------- BALANCES ---------- */
    function handleExpiredToken() {
      console.warn('Session expired. Logging out...');

      // Show toast BEFORE clearing state so it's visible
      showToast('Tu sesi√≥n ha expirado. Redirigiendo al inicio de sesi√≥n...', 'warning', 6000);

      // Delay logout slightly so user sees the toast
      setTimeout(() => {
        localStorage.removeItem('opToken');
        localStorage.removeItem('opUser');
        token = '';
        userId = 0;
        show('#app-layout', false);
        show('#auth-section', true);
        show('#loginForm', true);
        qs('#logMsg').textContent = 'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n de nuevo.';
        qs('#logMsg').className = 'msg error';
        if (balanceRefreshInterval) clearInterval(balanceRefreshInterval);
      }, 1500);
    }



    async function loadAquaBuxBalance() {
      try {
        const res = await fetch(API + '/ocean-pay/me', { headers: { Authorization: 'Bearer ' + token } });
        if (res.ok) {
          const user = await res.json();
          let balance = user.aquabux || 0;

          // üîß DEV MODE: OceanandWild unlimited AquaBux
          const opUser = JSON.parse(localStorage.getItem('opUser') || '{}');
          if (opUser.username && opUser.username.toLowerCase() === 'oceanandwild') {
            balance = 999999999;
            console.log('üîß [DEV MODE] OceanandWild - AquaBux: 999999999');
          }

          qs('#bux').textContent = balance.toLocaleString();
        }
      } catch (err) { console.error(err); }
    }

    async function loadEcoxionumsBalance() {
      // Redundant: covered by loadOceanCards and updateBalanceDisplays
    }

    async function loadEcoCoreBitsBalance() {
      // Simplified for brevity, assuming token exists
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      if (!user.token) return;
      try {
        const res = await fetch(`${API}/api/ecorebits/user`, {
          headers: { 'Authorization': `Bearer ${user.token}` }
        });

        if (res.status === 401 || res.status === 403) {
          handleExpiredToken();
          return;
        }

        const data = await res.json();
        if (data.success) qs('#ecobits').textContent = Math.round(data.user?.ecorebits?.balance ||
          0).toLocaleString();
      } catch (e) { }
    }

    async function loadEcoPowerBalance() {
      // EcoPower is stored locally in EcoConsole
      // This just displays the last known value from localStorage
      try {
        const ecoPowerData = JSON.parse(localStorage.getItem('ecoConsoleEcoPower') || '{}');
        qs('#ecopower').textContent = Math.round(ecoPowerData.current || 100);
      } catch (e) {
        qs('#ecopower').textContent = '100';
      }
    }

    async function loadAppBuxBalance() {
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      if (!user.id) return;
      try {
        const res = await fetch(`${API}/ocean-pay/appbux/${user.id}`);
        const { appbux } = await res.json();
        qs('#appbux').textContent = Math.round(appbux || 0).toLocaleString();
      } catch (e) { }
    }

    async function loadWildCreditsBalance() {
      // Simplified fetch
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      if (!user.id) return;
      try {
        const res = await fetch(`${API}/ocean-pay/wildcredits/balance`, {
          headers: {
            'Authorization': `Bearer
          ${token}`
          }
        });
        if (res.ok) {
          const data = await res.json();
          qs('#wildcredits').textContent = parseInt(data.wildcredits || 0).toLocaleString();
        }
      } catch (e) { }
    }

    async function loadWildGemsBalance() {
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      if (!user.id) return;
      try {
        const res = await fetch(`${API}/wildshorts/wildgems/balance`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (res.ok) {
          const data = await res.json();
          qs('#wildgems').textContent = parseInt(data.wildgems || 0).toLocaleString();
        }
      } catch (e) { }
    }

    async function loadEcoBooksBalance() {
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      if (!user.id) {
        console.log('[EcoBooks] No user ID found');
        return;
      }

      const ecobooksEl = qs('#ecobooks');
      const originalText = ecobooksEl.textContent;
      ecobooksEl.textContent = '...';

      try {
        console.log('[EcoBooks] Fetching balance for user:', user.id);
        const res = await fetch(`${API}/naturepedia/ecobooks/balance`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('[EcoBooks] Response status:', res.status);

        if (res.ok) {
          const data = await res.json();
          console.log('[EcoBooks] Data received:', data);
          const balance = parseInt(data.ecobooks || 0);
          ecobooksEl.textContent = balance.toLocaleString();

          // Animaci√≥n de √©xito
          const card = qs('#ecobooks-card');
          card.style.borderColor = '#10b981';
          setTimeout(() => { card.style.borderColor = ''; }, 1000);
        } else {
          const errorData = await res.json().catch(() => ({}));
          console.error('[EcoBooks] Error response:', errorData);
          ecobooksEl.textContent = originalText || '0';
        }
      } catch (e) {
        console.error('[EcoBooks] Fetch error:', e);
        ecobooksEl.textContent = originalText || '0';
      }
    }




    async function loadEcoTokensBalance() {
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      if (!user.id) return;
      try {
        const res = await fetch(`${API}/wild-savage/ecotokens/balance`, {
          headers: {
            'Authorization': `Bearer
          ${token}`
          }
        });
        if (res.ok) {
          const data = await res.json();
          qs('#ecotokens').textContent = parseInt(data.ecotokens || 0).toLocaleString();
        }
      } catch (e) { console.error('Error loading EcoTokens:', e); }
    }

    async function loadAmberBalance() {
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      if (!user.id) return;
      try {
        const res = await fetch(`${API}/dinobox/amber/balance`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
          const data = await res.json();
          qs('#amber').textContent = parseInt(data.amber || 0).toLocaleString();
        }
      } catch (e) { }
    }

    async function loadOceanCards() {
      const userStr = localStorage.getItem('opUser');
      if (!userStr) return;

      try {
        // Usamos el token para obtener info actualizada, incluyendo tarjetas
        const resMe = await apiFetch(`${API}/ocean-pay/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (resMe.ok) {
          const data = await resMe.json();
          renderCards(data.cards || []);

          // Actualizar localStorage con las cards
          const currentUser = JSON.parse(localStorage.getItem('opUser') || '{}');
          currentUser.cards = data.cards;
          localStorage.setItem('opUser', JSON.stringify(currentUser));

          // Actualizar variable global
          userCards = data.cards;

          // Restaurar √≠ndice de tarjeta activa
          if (currentUser.activeCardIndex !== undefined && currentUser.activeCardIndex < userCards.length) {
            activeCardIndex = currentUser.activeCardIndex;
          } else { activeCardIndex = 0; } // Actualizar displays
          updateBalanceDisplays();
        }
      } catch (e) { console.error('Error loading cards:', e); }
    } function
      renderCards(cards) {
      const container = qs('#cards-container'); if (!container) return; let
        html = cards.map((card, index) => {
          const isExpired = checkExpiry(card.expiry_date);
          const formattedNumber = card.card_number.match(/.{1,4}/g).join(' ');
          const isActive = index === activeCardIndex;
          const cardName = card.card_name || (card.is_primary ? 'Tarjeta Principal' : 'Tarjeta Secundaria');

          return `
            <div class="ocean-card ${isActive ? 'card-selected' : ''}"
              onclick="${isExpired ? `renewCard('${card.card_number}')` : `setActiveCard(${index})`}"
              style="${isActive ? 'border: 2px solid var(--accent); box-shadow: 0 0 30px rgba(34, 211, 238, 0.3);' : ''}; position:relative;">
              <div class="card-brand"><span>OCEAN</span><br><small>PAY</small></div>
              ${isActive ? `<div style="position: absolute; top: 10px; left: 10px; background: var(--accent); color: #0a0e1a; padding: 3px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 800;">EN USO</div>` : ''}

              <div class="card-chip"></div>

              <button onclick="handleRenameCard(event, ${card.id}, '${cardName}')"
                style="position: absolute; top: 10px; right: 60px; background: rgba(255,255,255,0.1); color: white; border:none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 0.8rem;"
                title="Renombrar Tarjeta"><i class="fas fa-pencil-alt"></i></button>

              ${!card.is_primary ? `<button onclick="deleteCard(event, ${card.id})"
                style="position: absolute; top: 10px; right: 20px; background: rgba(239,68,68,0.2); color: #ef4444; border:none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 0.8rem;"
                title="Eliminar Tarjeta"><i class="fas fa-trash"></i></button>` : ''}

              <span class="card-number"
                onclick="event.stopPropagation(); navigator.clipboard.writeText('${card.card_number}'); alert('N√∫mero copiado')"
                style="cursor:pointer;" title="Clic para copiar">${formattedNumber}</span>
              <div class="card-details">
                <div>
                  <span class="card-label">${cardName}</span>
                  <span class="card-val">${JSON.parse(localStorage.getItem('opUser')).username}</span>
                </div>
                <div style="margin-left: auto; margin-right: 2rem;">
                  <span class="card-label">Expira</span>
                  <span class="card-val">${card.expiry_date}</span>
                </div>
                <div
                  onclick="event.stopPropagation(); navigator.clipboard.writeText('${card.cvv}'); alert('CVV Copiado')"
                  style="cursor:pointer;" title="Clic para copiar CVV">
                  <span class="card-label">CVV</span>
                  <span class="card-val">${card.cvv} <i class="fas fa-copy"
                      style="font-size:0.7rem; opacity:0.5;"></i></span>
                </div>
              </div>
              <div class="card-status">
                <span class="status-badge ${isExpired ? 'status-expired' : 'status-active'}">
                  ${isExpired ? 'Expirada - Clic para renovar' : (isActive ? '‚úì Seleccionada' : 'Clic para usar')}
                </span>
              </div>
            </div >
        `;
        }).join('');

      if (cards.length < 2) {
        html += ` < button class="new-card-btn" onclick = "createNewCard()" >
              <i class="fas fa-plus-circle"></i>
              <span>Solicitar Nueva Tarjeta</span>
              <small style="opacity:0.6;">M√°ximo 2 tarjetas</small>
              </button >
        `;
      }

      container.innerHTML = html;
    }

    function checkExpiry(expiry) {
      if (!expiry) return true;
      const [m, y] = expiry.split('/').map(Number);
      const now = new Date();
      const expYear = 2000 + y;
      const expMonth = m - 1; // 0-indexed

      // La tarjeta expira el √∫ltimo d√≠a del mes
      const expDate = new Date(expYear, expMonth + 1, 0);
      return now > expDate;
    }

    async function renewCard(cardNumber) {
      if (!confirm('¬øDeseas renovar esta tarjeta por 3 a√±os m√°s?')) return;

      try {
        const res = await fetch(`${API} /ocean-pay/cards / renew`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token} ` },
          body: JSON.stringify({ cardNumber })
        });

        if (res.ok) {
          alert('¬°Tarjeta renovada con √©xito!');
          loadOceanCards();
        }
      } catch (e) { alert('Error al renovar'); }
    }

    async function createNewCard() {
      if (!confirm('¬øSolicitar una segunda Ocean Card vinculada a tu cuenta?')) return;

      try {
        const res = await fetch(`${API} /ocean-pay/cards / create`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token} ` }
        });

        if (res.ok) {
          alert('¬°Nueva tarjeta generada!');
          loadOceanCards();
        } else {
          const data = await res.json();
          alert(data.error || 'Error al crear tarjeta');
        }
      } catch (e) { alert('Error de conexi√≥n'); }
    }

    async function refreshAllBalances() {
      // Cargar tarjetas (incluyen todos los saldos)
      await loadOceanCards();
      await loadAmberBalance();
    }

    let balanceRefreshInterval = null;
    function startBalanceRefresh() {
      if (balanceRefreshInterval) clearInterval(balanceRefreshInterval);
      balanceRefreshInterval = setInterval(refreshAllBalances, 30000);
    }

    /* ---------- LOGOUT & DELETE ---------- */
    qs('#logoutBtn').onclick = () => {
      localStorage.removeItem('opToken'); localStorage.removeItem('opUser');
      token = ''; userId = 0;
      show('#app-layout', false); show('#auth-section', true); show('#loginForm', true);
    };

    /* ---------- CHECKOUT INTEGRATION ---------- */
    window.triggerDeposit = function () {
      const amount = parseFloat(prompt('¬øQu√© cantidad deseas cargar?', '1000'));
      if (!amount || amount <= 0) return; openCheckout({
        type: 'income', amount: amount, currency: 'aquabux',
        concept: 'Carga de Saldo desde Tarjeta Externa', callback: async (cardId) => {
          const res = await fetch(`${API}/ocean-pay/api/deposit`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              cardId: cardId,
              amount: amount,
              currency: 'aquabux',
              concept: 'Carga de Saldo v√≠a Checkout'
            })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Error al procesar dep√≥sito');

          await refreshAllBalances();
          await renderTransacciones(); // Actualizar historial
        }
      });
    };

    qs('#deleteAccountBtn').onclick = async () => {
      if (!confirm('¬øEst√°s seguro de eliminar tu cuenta permanentemente?')) return;
      const user = JSON.parse(localStorage.getItem('opUser') || '{}');
      try {
        const res = await fetch(`${API}/ocean-pay/delete-account`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ userId: user.id, username: user.username })
        });
        if (res.ok) {
          alert('Cuenta eliminada');
          qs('#logoutBtn').click();
        }
      } catch (e) { alert('Error al eliminar'); }
    };

    /* ---------- TRANSACTIONS ---------- */
    /* ---------- NOTIFICATIONS LOGIC ---------- */
    async function loadNotifications() {
      const listEl = qs('#notifications-list');
      if (!listEl) return;
      listEl.innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 2rem;">Cargando notificaciones...</p>';

      try {
        const res = await apiFetch(API + '/ocean-pay/notifications/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const notifications = await res.json();

        if (!notifications || notifications.length === 0) {
          listEl.innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 2rem;">No tienes notificaciones recientes.</p>';
          return;
        }

        listEl.innerHTML = notifications.map(n => `
            <div class="notif-card ${n.type}" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 1rem; position: relative;">
              <div class="notif-header" style="display:flex; justify-content:space-between; font-size:0.75rem; color:#64748b; margin-bottom:0.5rem;">
                <span>${new Date(n.created_at).toLocaleString()}</span>
                <span class="status-badge" style="background: ${n.type === 'success' ? 'rgba(16,185,129,0.1)' : 'rgba(34,211,238,0.1)'}; color: ${n.type === 'success' ? '#10b981' : '#22d3ee'};">${n.type}</span>
              </div>
              <div class="notif-title" style="color:white; font-weight:700; font-size:1.1rem; margin-bottom:0.25rem;">${n.title}</div>
              <div class="notif-msg" style="color:#cbd5e1; font-size:0.9rem;">${n.message}</div>
            </div>`).join('');

      } catch (e) {
        console.error(e);
        listEl.innerHTML = '<p style="color: #ef4444; text-align: center; margin-top: 2rem;">Error al cargar notificaciones.</p>';
      }
    }



    async function renderTransacciones() {
      const container = qs('#txList');
      container.innerHTML = '<div style="color:#94a3b8">Cargando...</div>';
      try {
        const res = await fetch(`${API}/ocean-pay/txs/${userId}`, {
          headers: {
            Authorization: 'Bearer ' + token
          }
        });
        const txs = await res.json();
        if (txs.length === 0) {
          container.innerHTML = '<div style="color:#94a3b8">No hay transacciones</div>';
          return;
        }

        container.innerHTML = txs.map(tx => {
          const date = new Date(tx.created_at).toLocaleDateString();
          const isPos = tx.monto > 0;
          return `
        <div style="display:flex; justify-content:space-between; padding:1rem; border-bottom:1px solid rgba(255,255,255,0.05); align-items:center;">
                  <div>
                    <div style="font-weight:bold;">${tx.concepto || 'Transacci√≥n'}</div>
                    <div style="font-size:0.8rem; color:#64748b;">${date} ‚Ä¢ ${tx.origen || 'Sistema'}</div>
                  </div>
                  <div style="font-weight:bold; color:${isPos ? 'var(--ok)' : 'var(--err)'}">
                    ${isPos ? '+' : ''}${tx.monto} ${tx.moneda || ''}
                  </div>
                </div>`;
        }).join('');
      } catch (e) { container.innerHTML = '<div style="color:var(--err)">Error cargando historial</div>'; }
    }


    /* ---------- NEW FEATURES (Self Transfer, Delete, Misc) ---------- */

    async function deleteCard(e, cardId) {
      e.stopPropagation(); // Avoid selecting card
      if (!confirm('¬øEliminar esta tarjeta secundaria y todo su historial/saldo asociado? Esta acci√≥n no se puede deshacer.')) return;

      try {
        const res = await fetch(`${API}/ocean-pay/api/cards/${cardId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          alert('Tarjeta eliminada correctamente.');
          loadOceanCards();
        } else {
          const d = await res.json();
          alert(d.error || 'No se pudo eliminar');
        }
      } catch (err) { alert('Error de conexi√≥n'); }
    }

    async function handleRenameCard(e, cardId, currentName) {
      e.stopPropagation();
      const newName = prompt('Ingrese el nuevo nombre para la tarjeta:', currentName);
      if (!newName || newName.trim() === '' || newName === currentName) return;

      try {
        const res = await fetch(`${API} /ocean-pay/api / cards / ${cardId}/rename`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name: newName })
        });

        if (res.ok) {
          alert('¬°Tarjeta personalizada exitosamente!');
          loadOceanCards(); // Refresh to show new name
        } else {
          const d = await res.json();
          alert(d.error || 'No se pudo renombrar');
        }
      } catch (err) { alert('Error de conexi√≥n'); }
    }

    async function executeSelfTransfer() {
      const amount = parseFloat(qs('#self-amount-input').value);
      const currency = qs('#self-currency-select').value;
      const sourceCardId = qs('#self-card-source').value;
      const destCardId = qs('#self-card-dest').value;

      if (!amount || amount <= 0) return alert('Monto inv√°lido'); if (sourceCardId === destCardId) return
      alert('Selecciona tarjetas diferentes'); try {
        const res = await
          fetch(`${API}/ocean-pay/api/transfer-self`, {
            method: 'POST', headers: {
              'Content-Type'
                : 'application/json', 'Authorization': `Bearer ${token}`
            }, body: JSON.stringify({
              sourceCardId,
              destCardId, currency, amount
            })
          }); const data = await res.json(); if (data.success) {
            alert('¬°Transferencia Exitosa!');
            qs('#self-amount-input').value = '';
            loadOceanCards(); // Refresh balances
            showPosView('pos-home');
          } else {
          alert('Error: ' + data.error);
        }
      } catch (e) { alert(' Error de conexi√≥n'); }
    } let chartIncomesInstance = null; let chartExpensesInstance = null;
    async function loadMiscStats() {
      try {
        const res = await
          fetch(`${API}/ocean-pay/api/stats/transactions`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }); if (!res.ok) return; const data = await res.json(); updateChart('chartIncomes',
            data.incomes, 'Ingresos Totales', 'rgba(16, 185, 129, 0.7)'); updateChart('chartExpenses',
              data.expenses, 'Gastos Totales', 'rgba(239, 68, 68, 0.7)');
      } catch (e) {
        console.error('Error stats', e);
      } if (!ctx) return; if (!data || data.length === 0) return; const
        labels = data.map(d => d.currency.toUpperCase());
      const values = data.map(d => parseFloat(d.total));

      if (canvasId === 'chartIncomes') {
        if (chartIncomesInstance) chartIncomesInstance.destroy();
      } else {
        if (chartExpensesInstance) chartExpensesInstance.destroy();
      }

      const config = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: values,
            backgroundColor: color,
            borderColor: color.replace('0.7', '1'),
            borderWidth: 1,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#cbd5e1', font: { family: 'Inter' } } }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#94a3b8' }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#94a3b8' }
            }
          }
        }
      };

      const newChart = new Chart(ctx, config);

      if (canvasId === 'chartIncomes') chartIncomesInstance = newChart;
      else chartExpensesInstance = newChart;
    }
    let currentCheckout = null;

    window.openCheckout = function (details) {
      // details: { type: 'income'|'expense', amount: 0, currency: 'amber', concept: '', origin: '', callback: fn }
      currentCheckout = details;
      paymentMethod = 'ocean';

      const modal = qs('#checkout-modal');
      const conceptDisplay = qs('#checkout-concept-display');
      const originDisplay = qs('#checkout-origin-display');
      const amountVal = qs('#checkout-amount-val');
      const currencyVal = qs('#checkout-currency-val');
      const btn = qs('#checkout-confirm-btn');

      modal.classList.add('active');
      conceptDisplay.textContent = details.concept || 'Transacci√≥n';
      originDisplay.textContent = details.origin || 'Ocean Pay';
      amountVal.textContent = details.amount.toLocaleString();
      currencyVal.textContent = (details.currency || 'wildgems').toUpperCase();

      btn.textContent = details.type === 'income' ? 'Recibir Ingreso' : 'Confirmar y Pagar';

      setPaymentMethod('ocean');
      renderCheckoutCards();

      // Setup external card formatting
      setTimeout(() => {
        const numInput = qs('#ext-card-number');
        const expInput = qs('#ext-card-expiry');

        if (numInput) {
          numInput.oninput = (e) => {
            let val = e.target.value.replace(/\D/g, '');
            e.target.value = val.replace(/(.{4})/g, '$1 ').trim();
          };
        }

        if (expInput) {
          expInput.oninput = (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 2) val = val.substring(0, 2) + '/' + val.substring(2, 4);
            e.target.value = val;
          };
        }
      }, 100);
    };

    window.closeCheckout = function () {
      qs('#checkout-modal').classList.remove('active');
      currentCheckout = null;
    };

    window.setPaymentMethod = function (method) {
      paymentMethod = method;
      qs('#tab-ocean').classList.toggle('active', method === 'ocean');
      qs('#tab-external').classList.toggle('active', method === 'external');
      show('#method-ocean', method === 'ocean');
      show('#method-external', method === 'external');
    };

    function renderCheckoutCards() {
      const container = qs('#checkout-card-list');
      if (!container) return;
      container.innerHTML = userCards.map((card, idx) => {
        const isSelected = idx === activeCardIndex;
        return `
                  <div class="card-option ${isSelected ? 'selected' : ''}" onclick="selectCheckoutCard(${idx})">
                    <div
                      style="width: 45px; height: 30px; border-radius: 6px; background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center;">
                      <i class="fas fa-water" style="font-size:0.6rem; color:var(--accent); opacity:0.5;"></i>
                    </div>
                    <div class="card-option-info">
                      <span class="card-option-name" style="font-size:0.9rem; font-weight:800;">${card.card_name ||
          'Tarjeta Ocean'}</span>
                      <span class="card-option-number">**** ${card.card_number.slice(-4)}</span>
                    </div>
                    ${isSelected ? '<i class="fas fa-check-circle" style="color:#2563eb; font-size:1.2rem;"></i>' : ''}
                  </div>
                  `;
      }).join('');
    }

    window.selectCheckoutCard = function (idx) {
      setActiveCard(idx);
      renderCheckoutCards();
    };

    window.confirmCheckout = async function () {
      if (!currentCheckout) return;

      const btn = qs('#checkout-confirm-btn');
      const originalText = btn.textContent;

      // Verification logic if external
      if (paymentMethod === 'external') {
        const num = qs('#ext-card-number').value.replace(/\s/g, '');
        const name = qs('#ext-card-name').value;
        const exp = qs('#ext-card-expiry').value;
        const cvv = qs('#ext-card-cvv').value;

        if (num.length < 16 || !name || exp.length < 5 || cvv.length < 3) {
          alert('Por favor completa todos los campos de la tarjeta.');
          return;
        }

        // Simular verificaci√≥n de red bancaria (Mercado Pago Style)
        btn.textContent = 'Verificando red bancaria...';
        btn.disabled = true;
        await new Promise(r => setTimeout(r, 1500));
        btn.textContent = 'Autorizando compra...';
        await new Promise(r => setTimeout(r, 1000));
        btn.textContent = 'Autorizando compra...';
        await new Promise(r => setTimeout(r, 1000));
      }

      btn.textContent = 'Procesando pago...';
      btn.disabled = true;

      try {
        if (currentCheckout.callback) {
          await currentCheckout.callback(userCards[activeCardIndex].id, paymentMethod === 'external');
        } else {
          // Default checkout logic: Deduct via API
          const res = await fetch(`${API}/ocean-pay/currency/change`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              amount: -currentCheckout.amount,
              currency: currentCheckout.currency || 'wildgems',
              concepto: currentCheckout.concept || 'Gasto Checkout',
              origen: currentCheckout.origin || 'Ocean Pay',
              isExternal: paymentMethod === 'external'
            })
          });

          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.error || 'Error en el servidor');
          }
        }

        // Notify result to parent if iframe
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'OCEAN_PAY_RESULT', success: true }, '*');
        }

        alert('¬°Pago completado! Se ha procesado tu compra exitosamente.');
        closeCheckout();
        refreshAllBalances();
        renderTransacciones();
      } catch (e) {
        alert('Error al procesar: ' + e.message);
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'OCEAN_PAY_RESULT', success: false, error: e.message }, '*');
        }
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    };


    /* ---------- SUBSCRIPTIONS ---------- */
    async function renderSubscriptions() {
      const loadingHtml = '<p style="color: #64748b; text-align: center; grid-column: 1/-1;">Cargando...</p>';
      if (container) container.innerHTML = loadingHtml;

      try {
        const res = await apiFetch(`${API}/ocean-pay/subscriptions/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Error HTTP: ' + res.status);
        const subs = await res.json();

        if (!Array.isArray(subs) || subs.length === 0) {
          container.innerHTML = `
                    <div
                      style="background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1); padding: 2rem; border-radius: 1rem; text-align: center; color: #64748b; grid-column: 1/-1;">
                      No hay suscripciones activas vinculadas
                    </div>`;
          return;
        }

        container.innerHTML = subs
          .filter((s, index, self) => {
            const name = s.plan_name || s.sub_name || '';
            // Si es DinoPass Premium, ocultarlo si ya existe DinoPass Elite activado
            if (name.includes('DinoPass Premium')) {
              const hasElite = self.some(sub => (sub.plan_name || sub.sub_name || '').includes('DinoPass Elite')
                && sub.project_id === s.project_id);
              if (hasElite) return false;
            }
            return true;
          })
          .map(s => {
            const name = s.plan_name || s.sub_name || 'Plan';
            const expiry = s.end_date || s.next_payment;
            const pid = s.project_id || (name.includes('Nature') ? 'Naturepedia' : (name.includes('Dino') ?
              'DinoBox' : (name.includes('VIP') ? 'WildShorts' : 'Desconocido')));

            let themeClass = '';
            let icon = 'fas fa-bolt';
            if (name === 'Nature-Pass') { themeClass = 'sub-nature-pass'; icon = 'fas fa-leaf'; }
            else if (name.includes('DinoPass Premium')) { themeClass = 'sub-dinopass-premium'; icon = 'fas fa-dragon'; }
            else if (name.includes('DinoPass Elite')) { themeClass = 'sub-dinopass-elite'; icon = 'fas fa-crown'; }
            else if (name.includes('Premium VIP')) { themeClass = 'sub-wildshorts-premium'; icon = 'fas fa-crown'; }

            const nextDate = expiry ? new Date(expiry).toLocaleDateString() : 'N/A';

            // Formatear duraci√≥n: 30 d√≠as -> 1 Mes, o duraci√≥n de temporada
            let durationLabel = `${s.interval_days || 7} d√≠as`;
            if (name.includes('DinoPass')) {
              if (s.interval_days === 30) durationLabel = '1 Mes';
              else durationLabel = `Temporada (${s.interval_days || 30} d√≠as)`;
            }

            return `
                    <div class="subscription-card ${themeClass}"
                      style="background: ${themeClass ? '' : 'var(--card)'}; border: 1px solid ${themeClass ? '' : 'var(--border)'}; padding: 1.5rem; border-radius: 1.25rem; position: relative; overflow: hidden; box-shadow: var(--shadow-card);">
                      ${themeClass ? `<div
                        style="position:absolute; top:10px; right:10px; background:white; color:black; font-size:0.6rem; font-weight:900; padding:3px 8px; border-radius:10px; text-transform:uppercase;">
                        ${name.split(' ').pop()}</div>` : ''}
                      <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                        <div class="sub-icon"
                          style="width: 48px; height: 48px; border-radius: 12px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: black; font-size: 1.5rem;">
                          <i class="${icon}"></i>
                        </div>
                        <div>
                          <h4 style="color: white; font-weight: 800; font-size: 1.1rem;">${name}</h4>
                          <p style="font-size: 0.8rem; color: #94a3b8;">${pid}</p>
                        </div>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                          <p style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 4px;">
                            Vencimiento</p>
                          <p style="color: var(--accent); font-weight: 700;">${nextDate}</p>
                        </div>
                        <div style="text-align: right;">
                          <p style="font-size: 1.2rem; font-weight: 900; color: white;">${s.price || 0} <span
                              style="font-size:0.7rem; opacity:0.6;">${(s.currency || 'wildgems').toUpperCase()}</span>
                          </p>
                          <p style="font-size: 0.65rem; color: #64748b;">${durationLabel}</p>
                        </div>
                      </div>
                    </div>
                    `;
          }).join('');
      } catch (e) {
        console.error('Error in renderSubscriptions:', e);
        if (container) container.innerHTML = `<div
                      style="color:var(--err); text-align:center; padding:1rem;">Error al cargar suscripciones</div>`;
      }
    }

    /* ---------- INIT ---------- */
    window.addEventListener('DOMContentLoaded', async () => {
      const t = localStorage.getItem('opToken');
      if (t) {
        token = t;
        const user = JSON.parse(localStorage.getItem('opUser') || '{}');
        userId = user.id;

        qs('#userNameDisplay').textContent = user.username || 'Usuario';
        qs('#userIdDisplay').textContent = `ID: ${user.id}`;
        qs('#userAvatar').textContent = (user.username || 'U').charAt(0).toUpperCase();

        show('#auth-section', false);
        show('#app-layout', true);

        refreshAllBalances();
        loadAmberBalance();
        renderSubscriptions();
        startBalanceRefresh();

        // Notify Opener
        if (window.opener) {
          window.opener.postMessage({ type: 'ocean-pay-token', token: token, user: user }, '*');
        }

        // CHECKOUT MODE
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'checkout') {
          const details = {
            type: 'expense',
            amount: parseFloat(urlParams.get('amount') || 0),
            currency: urlParams.get('currency') || 'voltbit',
            concept: urlParams.get('concept') || 'Compra Externa',
            origin: urlParams.get('origin') || 'Aplicaci√≥n Externa'
          };
          // Show Pos Section to make it look contextual, or just wallet
          showSection('wallet');
          setTimeout(() => openCheckout(details), 500);
        }
      } else {
        show('#auth-section', true);
        show('#loginForm', true);
      }
    });
  </script>
</body>

</html>