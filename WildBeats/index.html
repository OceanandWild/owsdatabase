<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wild Beats Pro | Professional Audio-Visual Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #ff007a;
            --bg: #020305;
            --panel-bg: rgba(8, 9, 15, 0.95);
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --text-dim: #71717a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            display: flex;
        }

        /* --- VISUALIZER AREA --- */
        #visualizer-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
            transition: transform 0.1s linear;
        }

        #main-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Center Image */
        #center-img-wrapper {
            position: absolute;
            border-radius: 50%;
            overflow: hidden;
            display: none;
            z-index: 5;
            pointer-events: none;
        }

        #center-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Track Info Overlay */
        #track-info {
            position: absolute;
            bottom: 3rem;
            left: 3rem;
            z-index: 10;
            pointer-events: none;
        }

        #track-artist {
            font-size: 0.8rem;
            letter-spacing: 0.3em;
            color: var(--primary);
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 0.2rem;
        }

        #track-name {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.8rem;
            font-weight: 700;
            color: #fff;
            line-height: 1;
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        /* --- REDESIGNED SIDEBAR --- */
        #sidebar {
            width: 420px;
            background: var(--panel-bg);
            backdrop-filter: blur(40px);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.8);
        }

        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid var(--glass-border);
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.02), transparent);
        }

        .studio-logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .studio-logo span {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .version-badge {
            font-size: 0.6rem;
            background: var(--glass-border);
            padding: 2px 8px;
            border-radius: 20px;
            color: var(--text-dim);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .section-box {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .section-title {
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.15em;
            color: var(--text-dim);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--glass-border);
        }

        /* Input Controls */
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .upload-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .upload-card:hover {
            border-color: var(--primary);
            background: rgba(0, 242, 255, 0.03);
        }

        .upload-card svg {
            margin-bottom: 0.5rem;
            color: var(--text-dim);
        }

        .upload-card span {
            font-size: 0.75rem;
            font-weight: 600;
            display: block;
        }

        .upload-card input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .tmplt-btn {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px 5px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tmplt-btn.active {
            border-color: var(--primary);
            background: rgba(0, 242, 255, 0.1);
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
        }

        /* Biome Selector */
        .biome-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
        }

        .biome-dot {
            min-width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .biome-dot.active {
            border-color: #fff;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Sliders */
        .slider-group {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .slider-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .range-input {
            width: 100%;
            height: 4px;
            border-radius: 10px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        /* Main Actions */
        .sidebar-footer {
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .main-btn {
            width: 100%;
            padding: 1rem;
            border-radius: 12px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-play {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #fff;
        }

        .btn-play:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-export {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: #fff;
        }

        .btn-export:hover:not(:disabled) {
            background: #fff;
            color: #000;
        }

        /* --- EXPORT OVERLAY --- */
        #export-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
        }

        .export-content {
            text-align: center;
            max-width: 400px;
        }

        .export-loader {
            width: 80px;
            height: 80px;
            border: 4px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 10px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="export-modal">
        <div class="export-content">
            <div class="export-loader"></div>
            <h2 style="font-family: 'Space Grotesk'; font-size: 2rem; margin-bottom: 0.5rem;">Exportando Master</h2>
            <div id="export-time-display"
                style="font-family: 'JetBrains Mono'; font-size: 1.5rem; color: var(--primary); margin-bottom: 1.5rem;">
                00:00 / 00:00</div>
            <p style="color: var(--text-dim); font-size: 0.8rem; line-height: 1.6;">
                Grabando se√±al de video a 60FPS. <br>
                No cierres esta pesta√±a ni silencies el audio.
            </p>
            <button id="cancel-export" class="main-btn btn-export"
                style="margin-top: 2rem; border-color: rgba(255,0,0,0.3); color: #ff4444;">Abortar Proceso</button>
        </div>
    </div>

    <main id="visualizer-container">
        <canvas id="main-canvas"></canvas>
        <div id="center-img-wrapper"><img id="center-img" src="" alt="Studio Logo"></div>
        <div id="track-info">
            <div id="track-artist">WILD BEATS PRO v2.5</div>
            <div id="track-name">Listo para procesar</div>
        </div>
    </main>

    <aside id="sidebar">
        <header class="sidebar-header">
            <div class="studio-logo">WILD <span>BEATS</span>
                <div class="version-badge">STUDIO PRO</div>
            </div>
        </header>

        <div class="sidebar-content">
            <!-- 1. MEDIA ASSETS -->
            <section class="section-box">
                <div class="section-title">Archivos de Fuente</div>
                <div class="upload-grid">
                    <div class="upload-card">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 18V5l12-2v13" />
                            <circle cx="6" cy="21" r="3" />
                            <circle cx="18" cy="19" r="3" />
                        </svg>
                        <span id="audio-lbl">Subir Audio</span>
                        <input type="file" id="audio-input" accept="audio/*">
                    </div>
                    <div class="upload-card">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <polyline points="21 15 16 10 5 21" />
                        </svg>
                        <span id="logo-lbl">Subir Imagen</span>
                        <input type="file" id="logo-input" accept="image/*">
                    </div>
                </div>
            </section>

            <!-- 2. VISUAL ENGINE -->
            <section class="section-box">
                <div class="section-title">Motor Visual (Plantillas)</div>
                <div class="template-grid" id="tmplt-list">
                    <button class="tmplt-btn active" data-id="event-horizon">Gargantua</button>
                    <button class="tmplt-btn" data-id="pulse-radial">Pulse Circle</button>
                    <button class="tmplt-btn" data-id="cyber-horizon">Cyber Grid</button>
                    <button class="tmplt-btn" data-id="chrono-vortex">Chrono Vortex</button>
                    <button class="tmplt-btn" data-id="fractal-nebula">Fractal Nebula</button>
                    <button class="tmplt-btn" data-id="neural-synapse">Neural Web</button>
                    <button class="tmplt-btn" data-id="quantum-field">Quantum Field</button>
                    <button class="tmplt-btn" data-id="aurora-ribbon">Aurora Borealis</button>
                    <button class="tmplt-btn" data-id="nova-flash">Star Nova</button>
                    <button class="tmplt-btn" data-id="helix-dna">Biotech Helix</button>
                    <button class="tmplt-btn" data-id="geo-hex">Geo Pulse</button>
                    <button class="tmplt-btn" data-id="storm-lightning">Thunderbolt</button>
                    <button class="tmplt-btn" data-id="glitch-system">Glitch OS</button>
                    <button class="tmplt-btn" data-id="matrix-rain">Digital Rain</button>
                    <button class="tmplt-btn" data-id="spectrum-pro">Studio Bars</button>
                </div>
            </section>

            <!-- 3. BIOMES -->
            <section class="section-box">
                <div class="section-title">Atm√≥sfera (Biomas)</div>
                <div class="biome-row" id="biome-list">
                    <div class="biome-dot active" data-id="ocean" style="background: #00f2ff;" title="Ocean Blue">üåä
                    </div>
                    <div class="biome-dot" data-id="desert" style="background: #ffaa00;" title="Saharan Gold">üèúÔ∏è</div>
                    <div class="biome-dot" data-id="jungle" style="background: #22ff66;" title="Amazon Wild">üåø</div>
                    <div class="biome-dot" data-id="volcano" style="background: #ff3300;" title="Magma Core">üî•</div>
                    <div class="biome-dot" data-id="toxic" style="background: #9dff00;" title="Bio-Hazard">‚ò£Ô∏è</div>
                    <div class="biome-dot" data-id="void" style="background: #ffffff;" title="Monochrome">‚ö™</div>
                    <div class="biome-dot" data-id="cyber" style="background: #ff00ff;" title="Neon City">üåÉ</div>
                </div>
            </section>

            <!-- 4. DASHBOARD ADJUSTMENTS -->
            <section class="section-box">
                <div class="section-title">Panel de Calibraci√≥n</div>
                <div class="slider-group">
                    <div class="slider-info"><span>Respuesta (Sensibilidad)</span> <span id="sens-v">2.0</span></div>
                    <input type="range" id="sens-in" class="range-input" min="0.5" max="5" step="0.1" value="2.0">
                </div>
                <div class="slider-group">
                    <div class="slider-info"><span>Inercia (Suavizado)</span> <span id="smooth-v">0.85</span></div>
                    <input type="range" id="smooth-in" class="range-input" min="0.1" max="0.98" step="0.01"
                        value="0.85">
                </div>
            </section>
        </div>

        <footer class="sidebar-footer">
            <button id="play-btn" class="main-btn btn-play" disabled>Iniciar Preview</button>
            <button id="export-btn" class="main-btn btn-export" disabled>Exportar Master MP4</button>
        </footer>
    </aside>

    <script>
        /**
         * WILD BEATS STUDIO PRO v2.5
         * High Performance Audio Analysis & Render
         */

        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const audioInput = document.getElementById('audio-input');
        const logoInput = document.getElementById('logo-input');
        const playBtn = document.getElementById('play-btn');
        const exportBtn = document.getElementById('export-btn');

        const trackName = document.getElementById('track-name');
        const centerImgWrapper = document.getElementById('center-img-wrapper');
        const centerImg = document.getElementById('center-img');

        let audioCtx, analyser, dataArray, bufferLength, source;
        let isPlaying = false;
        let currentTmplt = 'event-horizon';
        let currentBiome = 'ocean';
        let audio = new Audio();
        let particles = [];
        let smoothedValues = [];
        let logoImage = new Image();
        let logoLoaded = false;
        let shake = 0, flash = 0;

        const BIOMS = {
            ocean: { c1: '#00f2ff', c2: '#7000ff', bg: '#020305', p: '#00ccff' },
            desert: { c1: '#ffcc33', c2: '#ff6600', bg: '#080502', p: '#ffaa00' },
            jungle: { c1: '#33ff66', c2: '#006633', bg: '#020603', p: '#33ff00' },
            volcano: { c1: '#ff3300', c2: '#660000', bg: '#060202', p: '#ff0000' },
            toxic: { c1: '#99ff00', c2: '#003300', bg: '#030502', p: '#66ff00' },
            void: { c1: '#ffffff', c2: '#333333', bg: '#000000', p: '#ffffff' },
            cyber: { c1: '#ff00ff', c2: '#00ffff', bg: '#050005', p: '#ff00ff' }
        };

        function resize() {
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            initParticles();
        }
        window.onresize = resize;
        resize();

        // UI Handlers
        document.querySelectorAll('.tmplt-btn').forEach(b => b.onclick = () => {
            document.querySelectorAll('.tmplt-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            currentTmplt = b.dataset.id;
        });

        document.querySelectorAll('.biome-dot').forEach(d => d.onclick = () => {
            document.querySelectorAll('.biome-dot').forEach(x => x.classList.remove('active'));
            d.classList.add('active');
            currentBiome = d.dataset.id;
            const b = BIOMS[currentBiome];
            document.documentElement.style.setProperty('--primary', b.c1);
            document.documentElement.style.setProperty('--secondary', b.c2);
            document.documentElement.style.setProperty('--bg', b.bg);
        });

        document.getElementById('sens-in').oninput = (e) => document.getElementById('sens-v').innerText = e.target.value;
        document.getElementById('smooth-in').oninput = (e) => {
            document.getElementById('smooth-v').innerText = e.target.value;
            if (analyser) analyser.smoothingTimeConstant = parseFloat(e.target.value);
        };

        audioInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                audio.src = URL.createObjectURL(e.target.files[0]);
                trackName.innerText = e.target.files[0].name.replace(/\.[^/.]+$/, "").toUpperCase();
                document.getElementById('audio-lbl').innerText = "AUDIO OK";
                playBtn.disabled = false; exportBtn.disabled = false;
            }
        };

        logoInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                const url = URL.createObjectURL(e.target.files[0]);
                centerImg.src = url; logoImage.src = url;
                logoImage.onload = () => logoLoaded = true;
                centerImgWrapper.style.display = 'block';
                document.getElementById('logo-lbl').innerText = "LOGO OK";
            }
        };

        playBtn.onclick = () => {
            if (!audioCtx) initAudio();
            (isPlaying) ? audio.pause() : audio.play();
            playBtn.innerText = isPlaying ? "Iniciar Preview" : "Pausar Preview";
            isPlaying = !isPlaying;
        };

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 1024;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            smoothedValues = new Array(bufferLength).fill(0);
            draw();
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < 150; i++) particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, s: Math.random() * 1.5 + 0.5, v: Math.random() * 0.4 + 0.1 });
        }

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            const w = canvas.width, h = canvas.height;
            const b = BIOMS[currentBiome];
            const sens = parseFloat(document.getElementById('sens-in').value);

            // Bass Analysis
            let bassSum = 0; for (let i = 0; i < 10; i++) bassSum += dataArray[i];
            const bass = (bassSum / 10 / 255) * sens;

            // Decay Effects
            shake *= 0.85; if (bass > 0.8) shake = bass * 6;
            flash *= 0.8; if (bass > 0.95) flash = 0.25;

            // Global Scaling
            const scale = 1 + (bass * 0.015);
            document.getElementById('visualizer-container').style.transform = `scale(${scale}) translate(${(Math.random() - 0.5) * shake}px, ${(Math.random() - 0.5) * shake}px)`;

            // Render Core
            ctx.fillStyle = b.bg;
            ctx.fillRect(0, 0, w, h);

            if (flash > 0) { ctx.fillStyle = b.c1; ctx.globalAlpha = flash; ctx.fillRect(0, 0, w, h); ctx.globalAlpha = 1; }

            // Atmosphere
            ctx.fillStyle = b.p;
            particles.forEach(p => {
                p.y -= p.v * (1 + bass * 15); if (p.y < 0) p.y = h;
                ctx.globalAlpha = 0.1 + bass * 0.4;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.s + bass * 3, 0, 7); ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Smooth Data
            const sm = parseFloat(document.getElementById('smooth-in').value);
            for (let i = 0; i < bufferLength; i++) smoothedValues[i] = smoothedValues[i] * sm + dataArray[i] * (1 - sm);

            ctx.save();
            renderTemplate(w, h, b, sens, bass);
            ctx.restore();

            // Render Logo Overlay (Canvas for Record)
            if (logoLoaded) {
                const lSize = 200 + bass * 80;
                const lx = (w - lSize) / 2, ly = (h - lSize) / 2;
                ctx.save();
                ctx.beginPath(); ctx.arc(w / 2, h / 2, lSize / 2, 0, 7); ctx.clip();
                ctx.drawImage(logoImage, lx, ly, lSize, lSize);
                ctx.restore();
                ctx.save();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(w / 2, h / 2, lSize / 2, 0, 7); ctx.stroke();
                ctx.restore();
                centerImgWrapper.style.opacity = '0'; // Hide HTML while rendering
            }
        }

        function renderTemplate(w, h, b, sens, bass) {
            const cx = w / 2, cy = h / 2;
            const time = Date.now() * 0.001;

            switch (currentTmplt) {
                case 'event-horizon':
                    // --- HYPER REALISTIC BLACK HOLE (Gargantua Style) ---
                    ctx.globalCompositeOperation = 'screen';
                    for (let j = 0; j < 12; j++) {
                        ctx.beginPath();
                        ctx.strokeStyle = j < 6 ? b.c1 : b.c2;
                        ctx.lineWidth = 15 - j;
                        ctx.globalAlpha = (0.3 - j * 0.02) + bass * 0.1;
                        for (let i = 0; i <= 40; i++) {
                            const step = (i / 40);
                            const angle = step * Math.PI * 2 + time * (0.2 + j * 0.02);
                            const r = 180 + j * 10 + (smoothedValues[Math.floor(i % bufferLength)] / 255) * 200 * sens;
                            const px = cx + Math.cos(angle) * r;
                            const py = cy + Math.sin(angle) * r * 0.25;
                            if (i === 0) ctx.moveTo(px, py); else ctx.quadraticCurveTo(cx + Math.cos(angle - 0.1) * r, cy, px, py);
                        }
                        ctx.stroke();
                    }
                    ctx.beginPath(); ctx.arc(cx, cy, 140 + bass * 50, 0, 7);
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.shadowBlur = 30; ctx.shadowColor = b.c1; ctx.stroke(); ctx.shadowBlur = 0;
                    break;

                case 'pulse-radial':
                    for (let i = 0; i < bufferLength / 2; i++) {
                        const a = (i / (bufferLength / 2)) * Math.PI * 2;
                        const v = (smoothedValues[i] / 255) * 250 * sens;
                        ctx.strokeStyle = i % 2 ? b.c1 : b.c2; ctx.lineWidth = 4; ctx.lineCap = 'round';
                        ctx.beginPath(); ctx.moveTo(cx + Math.cos(a) * 200, cy + Math.sin(a) * 200); ctx.lineTo(cx + Math.cos(a) * (200 + v), cy + Math.sin(a) * (200 + v)); ctx.stroke();
                    }
                    break;

                case 'cyber-horizon':
                    const floor = h * 0.75;
                    ctx.strokeStyle = b.c1; ctx.globalAlpha = 0.2;
                    for (let i = -20; i <= 20; i++) { ctx.beginPath(); ctx.moveTo(cx + i * 80, floor); ctx.lineTo(cx + i * 1500, h); ctx.stroke(); }
                    const bW = w / 64;
                    for (let i = 0; i < 64; i++) {
                        const v = (smoothedValues[i * 8 % bufferLength] / 255) * h * 0.4 * sens;
                        ctx.fillStyle = b.c1; ctx.globalAlpha = 0.6; ctx.fillRect(i * bW, floor - v, bW - 2, v);
                    }
                    break;

                case 'chrono-vortex':
                    // --- CHRONO VORTEX (High Complexity Spiral) ---
                    for (let j = 0; j < 8; j++) {
                        const rBase = 150 + j * 40;
                        const rot = time * (1 + j * 0.2);
                        ctx.strokeStyle = j % 2 ? b.c1 : b.c2;
                        ctx.lineWidth = 2; ctx.globalAlpha = 0.5 - j * 0.05;
                        ctx.beginPath();
                        for (let i = 0; i < bufferLength / 4; i++) {
                            const a = (i / (bufferLength / 4)) * Math.PI * 2 + rot;
                            const v = (smoothedValues[i * 2 % bufferLength] / 255) * 100 * sens;
                            const r = rBase + v;
                            const x = cx + Math.cos(a) * r, y = cy + Math.sin(a) * r;
                            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                            // Inner gear teeth
                            if (i % 8 === 0) {
                                ctx.lineTo(cx + Math.cos(a) * (r + 20), cy + Math.sin(a) * (r + 20));
                                ctx.lineTo(cx + Math.cos(a + 0.1) * r, cy + Math.sin(a + 0.1) * r);
                            }
                        }
                        ctx.closePath(); ctx.stroke();
                    }
                    ctx.globalAlpha = 1;
                    break;

                case 'fractal-nebula':
                    // --- FRACTAL NEBULA (Recursive Glow) ---
                    ctx.globalCompositeOperation = 'lighter';
                    for (let j = 0; j < 6; j++) {
                        const r = 200 + (smoothedValues[j * 5] / 255) * 200 * sens;
                        const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);
                        grad.addColorStop(0, b.c1 + '55');
                        grad.addColorStop(1, 'transparent');
                        ctx.fillStyle = grad;
                        for (let i = 0; i < 8; i++) {
                            const a = time * 0.5 + (i / 8) * Math.PI * 2;
                            ctx.beginPath();
                            ctx.arc(cx + Math.cos(a) * r * 0.5, cy + Math.sin(a) * r * 0.5, r * 0.4, 0, 7);
                            ctx.fill();
                        }
                    }
                    ctx.globalCompositeOperation = 'source-over';
                    break;

                case 'neural-synapse':
                    // --- NEURAL WEB (Dynamic Node Connections) ---
                    const nodes = 40;
                    const synapsePoints = [];
                    for (let i = 0; i < nodes; i++) {
                        const a = (i / nodes) * Math.PI * 2 + time * 0.2;
                        const r = 250 + (smoothedValues[i % 32] / 255) * 150 * sens;
                        synapsePoints.push({ x: cx + Math.cos(a) * r, y: cy + Math.sin(a) * r, v: smoothedValues[i % 32] });
                    }
                    ctx.lineWidth = 1;
                    for (let i = 0; i < nodes; i++) {
                        for (let j = i + 1; j < nodes; j++) {
                            const dist = Math.hypot(synapsePoints[i].x - synapsePoints[j].x, synapsePoints[i].y - synapsePoints[j].y);
                            if (dist < 300) {
                                ctx.strokeStyle = b.c1;
                                ctx.globalAlpha = (1 - dist / 300) * (synapsePoints[i].v / 255);
                                ctx.beginPath(); ctx.moveTo(synapsePoints[i].x, synapsePoints[i].y);
                                ctx.lineTo(synapsePoints[j].x, synapsePoints[j].y); ctx.stroke();
                            }
                        }
                        ctx.fillStyle = b.c2; ctx.globalAlpha = synapsePoints[i].v / 255;
                        ctx.beginPath(); ctx.arc(synapsePoints[i].x, synapsePoints[i].y, 4, 0, 7); ctx.fill();
                    }
                    ctx.globalAlpha = 1;
                    break;

                case 'quantum-field':
                    // --- QUANTUM VECTOR FIELD ---
                    const rows = 15, cols = 15;
                    const gateX = w / cols, gateY = h / rows;
                    ctx.strokeStyle = b.c1; ctx.lineWidth = 2;
                    for (let i = 0; i < cols; i++) {
                        for (let j = 0; j < rows; j++) {
                            const px = i * gateX + gateX / 2, py = j * gateY + gateY / 2;
                            const d = Math.hypot(px - cx, py - cy);
                            const audioIdx = Math.floor(d / 10) % bufferLength;
                            const val = (smoothedValues[audioIdx] / 255) * sens;
                            const a = Math.atan2(py - cy, px - cx) + val * Math.PI;
                            ctx.globalAlpha = val * 0.8;
                            ctx.beginPath(); ctx.moveTo(px, py);
                            ctx.lineTo(px + Math.cos(a) * 30, py + Math.sin(a) * 30); ctx.stroke();
                        }
                    }
                    ctx.globalAlpha = 1;
                    break;

                case 'aurora-ribbon':
                    // --- AURORA BOREALIS (Ribbon Trails) ---
                    ctx.globalCompositeOperation = 'lighter';
                    for (let j = 0; j < 5; j++) {
                        ctx.beginPath();
                        ctx.strokeStyle = j % 2 ? b.c1 : b.c2;
                        ctx.lineWidth = 20 + j * 10; ctx.globalAlpha = 0.1 + bass * 0.1;
                        for (let i = 0; i < 60; i++) {
                            const x = (i / 60) * w;
                            const noise = Math.sin(time + i * 0.1 + j) * 100;
                            const v = (smoothedValues[i % bufferLength] / 255) * 200 * sens;
                            const y = cy + noise + Math.cos(time * 0.5 + i * 0.05) * v;
                            if (i === 0) ctx.moveTo(x, y); else ctx.quadraticCurveTo(x - 10, y, x, y);
                        }
                        ctx.stroke();
                    }
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 1;
                    break;

                case 'nova-flash':
                    for (let i = 0; i < bufferLength; i += 16) {
                        const v = (smoothedValues[i] / 255) * h * 0.6 * sens;
                        const a = (i / bufferLength) * Math.PI * 2;
                        ctx.strokeStyle = b.c1; ctx.lineWidth = 2; ctx.globalAlpha = 0.2;
                        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx + Math.cos(a) * v, cy + Math.sin(a) * v); ctx.stroke();
                    }
                    break;

                case 'helix-dna':
                    for (let i = 0; i < bufferLength; i += 8) {
                        const x = (i / bufferLength) * w * 0.8 + w * 0.1;
                        const v = (smoothedValues[i] / 255) * 100 * sens;
                        const a = time * 2 + i * 0.2;
                        ctx.fillStyle = b.c1; ctx.beginPath(); ctx.arc(x, cy + Math.sin(a) * 80, 5 + v / 10, 0, 7); ctx.fill();
                        ctx.fillStyle = b.c2; ctx.beginPath(); ctx.arc(x, cy + Math.sin(a + Math.PI) * 80, 5 + v / 10, 0, 7); ctx.fill();
                    }
                    break;

                case 'geo-hex':
                    const sh = 6;
                    for (let j = 0; j < 4; j++) {
                        const r = 150 + j * 60;
                        const v = (smoothedValues[j * 10] / 255) * 40 * sens;
                        ctx.beginPath();
                        for (let i = 0; i <= sh; i++) {
                            const a = (i / sh) * Math.PI * 2 + time * 0.5;
                            const px = cx + Math.cos(a) * (r + v); const py = cy + Math.sin(a) * (r + v);
                            if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                        }
                        ctx.strokeStyle = b.c1; ctx.lineWidth = 2; ctx.stroke();
                    }
                    break;

                case 'storm-lightning':
                    if (bass > 0.85) {
                        ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.shadowBlur = 20; ctx.shadowColor = b.c1;
                        let lx = cx, ly = cy; const la = Math.random() * Math.PI * 2;
                        ctx.beginPath(); ctx.moveTo(lx, ly);
                        for (let i = 0; i < 8; i++) { lx += Math.cos(la) * 100 + (Math.random() - 0.5) * 150; ly += Math.sin(la) * 100 + (Math.random() - 0.5) * 150; ctx.lineTo(lx, ly); }
                        ctx.stroke(); ctx.shadowBlur = 0;
                    }
                    break;

                case 'glitch-system':
                    const gw = w / 32;
                    for (let i = 0; i < 32; i++) {
                        const v = (smoothedValues[i * 16 % bufferLength] / 255) * h * 0.7 * sens;
                        const offset = Math.random() > 0.97 ? (Math.random() - 0.5) * 40 : 0;
                        ctx.fillStyle = (i % 5 === 0) ? '#fff' : b.c1; ctx.fillRect(i * gw + offset, (h - v) / 2, gw - 4, v);
                    }
                    break;

                case 'matrix-rain':
                    ctx.font = '15px JetBrains Mono';
                    for (let i = 0; i < w / 25; i++) {
                        const v = (smoothedValues[i % 32] / 255);
                        ctx.fillStyle = b.c1; ctx.globalAlpha = v + 0.1;
                        ctx.fillText(Math.random() > 0.5 ? '1' : '0', i * 25, (time * 400 + i * 150) % h);
                    }
                    ctx.globalAlpha = 1;
                    break;

                case 'spectrum-pro':
                    const gap = w / 64;
                    for (let i = 0; i < 64; i++) {
                        const v = (smoothedValues[i * 8 % bufferLength] / 255) * h * 0.7 * sens;
                        const g = ctx.createLinearGradient(0, h, 0, h - v);
                        g.addColorStop(0, b.c2); g.addColorStop(1, b.c1);
                        ctx.fillStyle = g; ctx.fillRect(i * gap, h - v, gap - 2, v);
                    }
                    break;
            }
        }

        // Export System
        const exportModal = document.getElementById('export-modal');
        const exportTimer = document.getElementById('export-time-display');
        let recordedChunks = [];
        let mediaRecorder;

        document.getElementById('export-btn').onclick = () => {
            if (!audioCtx) initAudio();

            // Optimizaci√≥n: Capturar a 30 FPS es mucho m√°s estable para el codificador 
            // del navegador cuando hay alta complejidad visual.
            const stream = canvas.captureStream(30);
            const aStream = audio.captureStream ? audio.captureStream() : audio.mozCaptureStream();
            const combined = new MediaStream([...stream.getTracks(), ...aStream.getTracks()]);

            // Cambiamos a VP8 (m√°s ligero que VP9) y un bitrate de 8Mbps para fluidez total
            try {
                mediaRecorder = new MediaRecorder(combined, {
                    mimeType: 'video/webm;codecs=vp8',
                    videoBitsPerSecond: 8000000,
                    audioBitsPerSecond: 256000
                });
            } catch (e) {
                // Fallback si VP8 no es compatible
                mediaRecorder = new MediaRecorder(combined, {
                    mimeType: 'video/webm',
                    videoBitsPerSecond: 8000000
                });
            }
            recordedChunks = [];

            const formatTime = (s) => `${Math.floor(s / 60).toString().padStart(2, '0')}:${Math.floor(s % 60).toString().padStart(2, '0')}`;
            const tUpdate = setInterval(() => { exportTimer.innerText = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`; }, 500);

            document.getElementById('cancel-export').onclick = () => { mediaRecorder.stop(); audio.pause(); audio.currentTime = 0; clearInterval(tUpdate); exportModal.style.display = 'none'; recordedChunks = []; };

            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                clearInterval(tUpdate);
                if (recordedChunks.length === 0) return;
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `WILD_BEATS_STUDIO_${trackName.innerText}.webm`; a.click();
                exportModal.style.display = 'none';
            };

            exportModal.style.display = 'flex';
            audio.currentTime = 0; audio.play(); isPlaying = true;
            mediaRecorder.start();
        };

        audio.onended = () => { if (mediaRecorder && mediaRecorder.state === 'recording') { setTimeout(() => mediaRecorder.stop(), 2000); } };

    </script>
</body>

</html>