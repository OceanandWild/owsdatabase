name: Generate Android Signing Keystore

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: "Alias de la key (ej. ows_upload)"
        required: true
        default: "ows_upload"
        type: string
      key_validity_days:
        description: "Validez en dias"
        required: true
        default: "10000"
        type: string

permissions:
  contents: read

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Generate keystore and credentials
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p out
          KEYSTORE_FILE="ows-upload.jks"
          KEY_ALIAS="${{ inputs.key_alias }}"
          KEY_VALIDITY="${{ inputs.key_validity_days }}"

          # Random strong passwords (avoid printing them in logs)
          KEYSTORE_PASSWORD="$(openssl rand -base64 24 | tr -d '\n')"
          KEY_PASSWORD="$(openssl rand -base64 24 | tr -d '\n')"

          keytool -genkeypair -v \
            -keystore "$KEYSTORE_FILE" \
            -storepass "$KEYSTORE_PASSWORD" \
            -alias "$KEY_ALIAS" \
            -keypass "$KEY_PASSWORD" \
            -keyalg RSA \
            -keysize 2048 \
            -validity "$KEY_VALIDITY" \
            -dname "CN=Ocean and Wild Studios, OU=OWS, O=Ocean and Wild Studios, L=Unknown, ST=Unknown, C=US"

          # Base64 in one line for GitHub Secrets
          base64 -w 0 "$KEYSTORE_FILE" > out/ANDROID_SIGNING_KEY_BASE64.txt
          cp "$KEYSTORE_FILE" out/

          {
            echo "ANDROID_KEY_ALIAS=$KEY_ALIAS"
            echo "ANDROID_KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD"
            echo "ANDROID_KEY_PASSWORD=$KEY_PASSWORD"
          } > out/ANDROID_SECRETS_VALUES.txt

          cat <<'EOF' > out/README-FIRST.txt
          1) Descarga este artifact y guarda el archivo .jks en un lugar seguro (backup externo recomendado).
          2) Copia estos valores en GitHub -> Settings -> Secrets and variables -> Actions:
             - ANDROID_SIGNING_KEY_BASE64 (contenido de ANDROID_SIGNING_KEY_BASE64.txt)
             - ANDROID_KEY_ALIAS
             - ANDROID_KEYSTORE_PASSWORD
             - ANDROID_KEY_PASSWORD
          3) Usa SIEMPRE este mismo keystore para futuras updates Android del mismo package id.
          EOF

      - name: Upload keystore materials
        uses: actions/upload-artifact@v4
        with:
          name: android-signing-keystore-materials
          path: out/**/*
          if-no-files-found: error
