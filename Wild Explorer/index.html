<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wild Explorer - Navegador Web</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    @font-face {
      font-family: 'Outfit';
      src: url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
    }

    :root {
      --bg-dark: #070712;
      --card-glass: rgba(255, 255, 255, 0.04);
      --card-border: rgba(255, 255, 255, 0.08);
      --accent: #7c4dff;
      --accent-glow: rgba(124, 77, 255, 0.4);
      --neon-cyan: #00e5ff;
      --neon-pink: #ff007f;
      --text-main: #e2e8f0;
      --text-dim: #94a3b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Outfit', sans-serif;
    }

    body {
      background: var(--bg-dark);
      background-image:
        radial-gradient(circle at 10% 20%, rgba(124, 77, 255, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(0, 229, 255, 0.05) 0%, transparent 40%);
      min-height: 100vh;
      color: var(--text-main);
      overflow-x: hidden;
    }

    /* Decorative Nebula */
    .nebula {
      position: fixed;
      width: 50vw;
      height: 50vw;
      filter: blur(150px);
      z-index: -1;
      opacity: 0.15;
      pointer-events: none;
    }

    .nebula-1 {
      top: -20%;
      left: -10%;
      background: var(--accent);
    }

    .nebula-2 {
      bottom: -10%;
      right: -10%;
      background: var(--neon-cyan);
    }

    #mainHeader {
      background: rgba(7, 7, 18, 0.8);
      backdrop-filter: blur(15px);
      padding: 1.25rem 2.5rem;
      border-bottom: 1px solid var(--card-border);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .main-info {
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }

    #logoApp {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: -1px;
      background: linear-gradient(135deg, white 0%, var(--text-dim) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .beta-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .beta-label {
      background: var(--accent);
      color: white;
      padding: 0.35rem 0.75rem;
      border-radius: 8px;
      font-weight: 800;
      font-size: 0.65rem;
      letter-spacing: 2px;
      box-shadow: 0 0 15px var(--accent-glow);
    }

    .beta-message {
      color: var(--text-dim);
      font-size: 0.85rem;
      font-weight: 400;
      max-width: 200px;
    }

    #webitsBar {
      background: var(--card-glass);
      backdrop-filter: blur(10px);
      margin: 1.5rem 1.5rem 0 1.5rem;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-radius: 16px;
      border: 1px solid var(--card-border);
    }

    #balance {
      font-weight: 800;
      color: var(--neon-cyan);
      font-size: 0.9rem;
      padding: 0.5rem 1.25rem;
      background: rgba(0, 229, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(0, 229, 255, 0.2);
      margin-right: auto;
    }

    #webitsBar button {
      padding: 0.6rem 1rem;
      background: var(--card-glass);
      border: 1px solid var(--card-border);
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #webitsBar button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    #quickEarnBtn {
      background: linear-gradient(135deg, var(--accent) 0%, #5e35b1 100%) !important;
      border: none !important;
    }

    #quickEarnBtn:hover:not(:disabled) {
      box-shadow: 0 0 25px var(--accent-glow) !important;
    }

    #explorer {
      margin: 1.5rem;
      background: rgba(10, 10, 25, 0.5);
      backdrop-filter: blur(25px);
      border-radius: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
      min-height: calc(100vh - 250px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #tabsBar {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
      padding: 0.75rem 1rem;
      gap: 0.75rem;
      border-bottom: 1px solid var(--card-border);
    }

    #tabsContainer {
      display: flex;
      gap: 0.5rem;
      flex: 1;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      background: var(--card-glass);
      border-radius: 12px;
      border: 1px solid var(--card-border);
      cursor: pointer;
      min-width: 160px;
      max-width: 240px;
      color: var(--text-dim);
      transition: all 0.3s ease;
    }

    .tab.active {
      background: rgba(124, 77, 255, 0.1);
      border-color: var(--accent);
      color: white;
      box-shadow: 0 0 15px rgba(124, 77, 255, 0.15);
    }

    .tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }

    .tab-title {
      flex: 1;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tab-close {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      font-size: 0.7rem;
      transition: all 0.2s;
    }

    .tab-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    #newTabBtn {
      width: 36px;
      height: 36px;
      background: var(--card-glass);
      border: 1px solid var(--card-border);
      color: white;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: 0.3s;
    }

    #newTabBtn:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

    #urlBar {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid var(--card-border);
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 0.6rem 1.25rem;
      transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .input-wrapper:focus-within {
      background: rgba(124, 77, 255, 0.05);
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(124, 77, 255, 0.1);
    }

    #fakeBar {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: white;
      font-size: 0.95rem;
      padding: 0.2rem;
    }

    #urlBar button:not(#clearBtn, #refreshBtn, #goBtn) {
      width: 40px;
      height: 40px;
      background: var(--card-glass);
      border: 1px solid var(--card-border);
      color: var(--text-dim);
      border-radius: 12px;
      cursor: pointer;
      transition: 0.3s;
    }

    #urlBar button:not(#clearBtn, #refreshBtn, #goBtn):hover {
      color: white;
      background: rgba(255, 255, 255, 0.1);
    }

    #goBtn,
    #refreshBtn {
      padding: 0.7rem 1.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
    }

    #goBtn:hover {
      box-shadow: 0 0 20px var(--accent-glow);
      transform: translateY(-2px);
    }

    #siteViewer {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      overflow-y: auto;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--card-border) transparent;
    }

    .tab-content {
      animation: tabSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      padding: 2.5rem;
      color: var(--text-main);
    }

    @keyframes tabSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Site Styles */
    .site-content {
      max-width: 900px;
      margin: 0 auto;
    }

    .site-content h2 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, white 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .announcement-card {
      background: var(--card-glass);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      transition: 0.3s;
    }

    .announcement-card:hover {
      border-color: var(--accent);
      background: rgba(124, 77, 255, 0.05);
    }

    /* Modals Redesign */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(20px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal.hidden {
      display: none !important;
    }

    .hidden {
      display: none !important;
    }

    .modal-content {
      background: #0d0d1a !important;
      border: 1px solid var(--card-border) !important;
      border-radius: 28px !important;
      color: white !important;
      padding: 3rem !important;
      box-shadow: 0 30px 100px rgba(0, 0, 0, 0.8) !important;
    }

    .modal-content h2 {
      font-size: 2.2rem;
      font-weight: 800;
      color: white !important;
      margin-bottom: 2rem;
    }

    .site-card {
      background: var(--card-glass);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 1.5rem;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .site-card:hover {
      border-color: var(--accent);
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(124, 77, 255, 0.1);
    }

    .site-card.unlocked {
      background: rgba(124, 77, 255, 0.1);
      border-color: var(--accent);
    }

    /* Loader */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      gap: 1.5rem;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--card-border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-shadow: 0 0 20px rgba(124, 77, 255, 0.2);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Wild Search View */
    .search-result-item {
      background: var(--card-glass);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: 0.3s;
    }

    .search-result-item:hover {
      border-color: var(--accent);
      transform: translateX(10px);
    }

    .search-result-title {
      color: var(--accent) !important;
      font-weight: 700 !important;
    }

    /* Customs Buttons */
    button {
      outline: none;
    }

    .link-container {
      background: var(--card-glass);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      padding: 3rem;
    }

    input {
      background: rgba(0, 0, 0, 0.4) !important;
      border: 1px solid var(--card-border) !important;
      color: white !important;
      border-radius: 12px !important;
      padding: 0.8rem 1.2rem !important;
      outline: none !important;
    }

    input:focus {
      border-color: var(--accent) !important;
      box-shadow: 0 0 15px var(--accent-glow);
    }

    .modal-content button,
    .site-content button:not(.pos-big-btn) {
      padding: 0.8rem 1.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 1rem;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    .modal-content button:hover,
    .site-content button:not(.pos-big-btn):hover {
      box-shadow: 0 0 20px var(--accent-glow);
      transform: translateY(-2px);
    }

    .modal-content button#closeModal,
    .modal-content button#closeHistory,
    .modal-content button#closeCodeModal,
    .modal-content button#closeFavorites,
    .modal-content button#closeDownloads,
    .modal-content button#closeSiteInfo,
    .modal-content button#closeShare {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--card-border);
      color: var(--text-dim);
    }

    .modal-content button#closeModal:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-color: #ef4444;
    }

    /* Search Results Styles */
    .search-results {
      padding: 2rem;
      animation: fadeInUp 0.5s ease;
    }

    .search-header {
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--card-border);
      padding-bottom: 1.5rem;
    }

    .search-info {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .search-result-url {
      color: var(--neon-cyan);
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
      opacity: 0.7;
    }

    .search-result-description {
      color: var(--text-dim);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .search-result-badge {
      font-size: 0.65rem;
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      margin-left: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 800;
    }

    .badge-unlocked {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border: 1px solid #10b981;
    }

    .badge-locked {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid #ef4444;
    }

    /* Lists in Modals */
    #historyList,
    #favoritesList,
    #downloadsList {
      list-style: none;
      padding: 0;
    }

    #historyList li,
    .favorite-item,
    .download-item {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.3s;
    }

    #historyList li:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent);
    }

    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      #explorer {
        margin: 0;
        border-radius: 0;
        height: 100vh;
      }

      #mainHeader {
        padding: 1rem;
      }
    }

    .link-loader.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .success-animation {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      gap: 2rem;
    }

    .success-animation.active {
      display: flex;
    }

    .checkmark-container {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .checkmark-circle-fill {
      animation: circleFill 1.5s ease-out forwards;
    }

    @keyframes circleFill {
      to {
        stroke-dashoffset: 0;
      }
    }

    .checkmark-svg {
      width: 120px;
      height: 120px;
    }

    .checkmark-path {
      stroke: #10b981;
      stroke-width: 5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: checkmarkDraw 0.8s ease-out 1.5s forwards;
    }

    @keyframes checkmarkDraw {
      to {
        stroke-dashoffset: 0;
      }
    }

    .balance-display {
      text-align: center;
      margin-top: 1rem;
    }

    .balance-display h3 {
      color: #667eea;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .balance-amount {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: fadeInUp 0.5s ease-out 1.5s both;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .balance-breakdown {
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      text-align: center;
    }

    .balance-item {
      padding: 1rem;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 8px;
      animation: fadeInUp 0.5s ease-out forwards;
    }

    .balance-item:nth-child(1) {
      animation-delay: 1.8s;
    }

    .balance-item:nth-child(2) {
      animation-delay: 2s;
    }

    .balance-item:nth-child(3) {
      animation-delay: 2.2s;
    }

    .balance-item:nth-child(4) {
      animation-delay: 2.4s;
    }

    .balance-item:nth-child(5) {
      animation-delay: 2.6s;
    }

    .balance-item.opacity-0 {
      opacity: 0;
    }

    .balance-item-label {
      font-size: 0.85rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
    }

    .balance-item-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #667eea;
    }

    @media (max-width: 768px) {
      #explorer {
        margin: 0.5rem;
      }

      #mainHeader {
        padding: 1rem;
      }

      h1 {
        font-size: 1.4rem;
      }

      #tabsBar {
        flex-wrap: nowrap;
      }

      .tab {
        min-width: 120px;
        max-width: 180px;
      }

      #urlBar {
        flex-wrap: wrap;
      }

      #urlBar button {
        flex: 1;
        min-width: 80px;
      }
    }

    /* Premium Alert */
    #customAlert {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 1rem 2.5rem;
      border-radius: 16px;
      background: rgba(13, 13, 26, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      color: white;
      font-weight: 600;
      z-index: 9999;
      transition: 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      opacity: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #customAlert.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    #customAlert.success {
      border-color: #10b981;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
    }

    #customAlert.error {
      border-color: #ef4444;
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.2);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--card-border);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-dim);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
  </style>
</head>

<body>
  <div class="nebula nebula-1"></div>
  <div class="nebula nebula-2"></div>

  <header id="mainHeader">
    <div class="main-info">
      <img src="assets/Wild Explorer.png" alt="Logo de Wild Explorer" id="logoApp" />
      <h1>Wild Explorer</h1>
    </div>

    <div class="beta-info">
      <span class="beta-label">ALPHA V2</span>
      <span class="beta-message">Exploraci√≥n de ecosistemas habilitada.</span>
    </div>
  </header>

  <div id="webitsBar">
    <span id="balance"><canvas id="wcBalanceIcon" width="24" height="24"
        style="margin-right: 8px; vertical-align: middle;"></canvas>WildCredits: <span
        id="balanceAmount">0</span></span>
    <button id="quickEarnBtn"><i class="fas fa-bolt"></i> Ganar R√°pido</button>
    <button id="codeBtn"><i class="fas fa-ticket-alt"></i> C√≥digo</button>
    <button id="favoritesBtn"><i class="fas fa-star"></i></button>
    <button id="downloadsBtn"><i class="fas fa-download"></i></button>
    <button id="historyBtn"><i class="fas fa-history"></i></button>
    <button id="infoBtn"><i class="fas fa-info-circle"></i></button>
  </div>

  <div id="explorer">
    <div id="tabsBar">
      <div id="tabsContainer"></div>
      <button id="newTabBtn" title="Nueva pesta√±a"><i class="fas fa-plus"></i></button>
    </div>

    <div id="urlBar">
      <div class="input-wrapper">
        <i class="fas fa-globe" style="color: var(--text-dim); margin-right: 12px;"></i>
        <input type="text" id="fakeBar" placeholder="Explorar el ecosistema..." />
        <button id="clearBtn" class="hidden" title="Cerrar sitio"><i class="fas fa-times"></i></button>
      </div>
      <div style="display: flex; gap: 8px;">
        <button id="zoomOutBtn"><i class="fas fa-search-minus"></i></button>
        <button id="zoomInBtn"><i class="fas fa-search-plus"></i></button>
        <button id="addFavoriteBtn" class="hidden"><i class="fas fa-star"></i></button>
        <button id="goBtn">IR</button>
        <button id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
      </div>
    </div>

    <div id="siteViewer"></div>
  </div>

  <!-- Alert personalizado -->
  <div id="customAlert">Texto</div>

  <!-- Modal Info -->
  <div id="infoModal" class="hidden modal">
    <div class="modal-content">
      <h2>Informaci√≥n de Wild Explorer</h2>
      <p><strong>WildCredits diarios:</strong> M√°ximo 100 por d√≠a</p>
      <p><strong>Sitios desbloqueados:</strong> con c√≥digos o gastando WildCredits</p>
      <p><strong>Tiempo hasta pr√≥xima recompensa:</strong> <span id="rewardTimer">...</span></p>
      <p><strong>WildCredits actuales:</strong> <span id="modalBalance">0</span></p>
      <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e0e0e0;">
      <h3 style="color: #667eea; margin-top: 1rem;">üîç Wild Search</h3>
      <p>Usa la barra de b√∫squeda para encontrar sitios por nombre, tipo o contenido. Si no coincide con una URL, se
        realizar√° una b√∫squeda autom√°tica.</p>
      <button id="closeModal">Cerrar</button>
    </div>
  </div>

  <!-- Modal de Historial -->
  <div id="historyModal" class="hidden modal">
    <div class="modal-content">
      <h2>üìú Historial de Navegaci√≥n</h2>
      <ul id="historyList"></ul>
      <button id="closeHistory">Cerrar</button>
    </div>
  </div>

  <!-- Modal para canjear c√≥digos -->
  <div id="codeModal" class="hidden modal">
    <div class="modal-content">
      <h2>Canjear C√≥digo</h2>
      <input type="text" id="codeInput" placeholder="Introduce un c√≥digo">
      <button id="redeemCodeBtn">Canjear c√≥digo</button>
      <p id="codeStatus"></p>
      <button id="closeCodeModal">Cerrar</button>
    </div>
  </div>

  <!-- Modal de Favoritos -->
  <div id="favoritesModal" class="hidden modal">
    <div class="modal-content">
      <h2>‚≠ê Favoritos</h2>
      <div id="favoritesList" style="max-height: 400px; overflow-y: auto; margin: 1rem 0;"></div>
      <button id="closeFavorites">Cerrar</button>
    </div>
  </div>

  <!-- Modal de Descargas -->
  <div id="downloadsModal" class="hidden modal">
    <div class="modal-content">
      <h2>üì• Descargas</h2>
      <div id="downloadsList" style="max-height: 400px; overflow-y: auto; margin: 1rem 0;"></div>
      <button id="closeDownloads">Cerrar</button>
    </div>
  </div>

  <!-- Modal de Informaci√≥n del Sitio -->
  <div id="siteInfoModal" class="hidden modal">
    <div class="modal-content">
      <h2>‚ÑπÔ∏è Informaci√≥n del Sitio</h2>
      <div id="siteInfoContent"></div>
      <button id="closeSiteInfo">Cerrar</button>
    </div>
  </div>

  <!-- Modal de Compartir -->
  <div id="shareModal" class="hidden modal">
    <div class="modal-content">
      <h2>üì§ Compartir Sitio</h2>
      <div id="shareContent"></div>
      <button id="closeShare">Cerrar</button>
    </div>
  </div>

  <script>
    // Estado de la aplicaci√≥n
    let tabs = [];
    let activeTabId = null;
    let tabCounter = 0;
    let balance = parseInt(localStorage.getItem('wildCredits') || '0');
    let unlockedSites = JSON.parse(localStorage.getItem('unlockedSites') || '[]');
    let navigationHistory = JSON.parse(localStorage.getItem('navigationHistory') || '[]');
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let downloads = JSON.parse(localStorage.getItem('downloads') || '[]');
    let lastRewardTime = parseInt(localStorage.getItem('lastRewardTime') || '0');
    let dailyCredits = parseInt(localStorage.getItem('dailyCredits') || '0');
    let lastQuickEarnTime = parseInt(localStorage.getItem('lastQuickEarnTime') || '0');
    let currentZoom = parseFloat(localStorage.getItem('zoomLevel') || '1');
    let pageSearchResults = [];
    let currentSearchIndex = -1;
    const DAILY_LIMIT = 100;
    const QUICK_EARN_COOLDOWN = 2 * 60 * 1000; // 2 minutos
    const QUICK_EARN_AMOUNT = 15; // WildCredits por uso



    // Sitios disponibles
    const sites = [
      { id: 'jungla', name: 'La Jungla', url: 'oceanandwildstudios.com/jungla', cost: 0, default: true },
      { id: 'global-announcement', name: 'Anuncios Globales', url: 'oceanandwildstudios.com/global-announcement', cost: 0, default: true, special: true },
      { id: 'ocean-pay-link', name: 'Vincular Ocean Pay', url: 'oceanandwildstudios.com/ocean-pay-link', cost: 0, default: true, special: true },

      // Ecosistemas principales
      { id: 'oceano', name: 'El Oc√©ano', url: 'oceanandwildstudios.com/oceano', cost: 10 },
      { id: 'sabana', name: 'La Sabana', url: 'oceanandwildstudios.com/sabana', cost: 15 },
      { id: 'bosque', name: 'El Bosque', url: 'oceanandwildstudios.com/bosque', cost: 20 },
      { id: 'montana', name: 'La Monta√±a', url: 'oceanandwildstudios.com/montana', cost: 25 },
      { id: 'desierto', name: 'El Desierto', url: 'oceanandwildstudios.com/desierto', cost: 30 },
      { id: 'tundra', name: 'La Tundra', url: 'oceanandwildstudios.com/tundra', cost: 35 },
      { id: 'costa', name: 'La Costa', url: 'oceanandwildstudios.com/costa', cost: 40 },

      // Nuevos ecosistemas
      { id: 'arrecife', name: 'El Arrecife', url: 'oceanandwildstudios.com/arrecife', cost: 45 },
      { id: 'pantano', name: 'El Pantano', url: 'oceanandwildstudios.com/pantano', cost: 50 },
      { id: 'pradera', name: 'La Pradera', url: 'oceanandwildstudios.com/pradera', cost: 55 },
      { id: 'caverna', name: 'La Caverna', url: 'oceanandwildstudios.com/caverna', cost: 60 },
      { id: 'volcan', name: 'El Volc√°n', url: 'oceanandwildstudios.com/volcan', cost: 65 },
      { id: 'glaciar', name: 'El Glaciar', url: 'oceanandwildstudios.com/glaciar', cost: 70 },
      { id: 'isla', name: 'La Isla', url: 'oceanandwildstudios.com/isla', cost: 75 },
      { id: 'canyon', name: 'El Ca√±√≥n', url: 'oceanandwildstudios.com/canyon', cost: 80 },

      // Aplicaciones y servicios
      { id: 'ecoconsole', name: 'EcoConsole', url: 'oceanandwildstudios.com/ecoconsole', cost: 100 },
      { id: 'ecoxion', name: 'Ecoxion', url: 'oceanandwildstudios.com/ecoxion', cost: 100 },
      { id: 'naturepedia', name: 'Naturepedia', url: 'oceanandwildstudios.com/naturepedia', cost: 100 },
      { id: 'currency-playground', name: 'Currency Playground', url: 'oceanandwildstudios.com/currency-playground', cost: 100 },
      { id: 'natmarket', name: 'NatMarket', url: 'oceanandwildstudios.com/natmarket', cost: 50 },
      { id: 'ocean-pay', name: 'Ocean Pay', url: 'oceanandwildstudios.com/ocean-pay', cost: 0, default: true },
      { id: 'wild-explorer', name: 'Wild Explorer', url: 'oceanandwildstudios.com/wild-explorer', cost: 0, default: true },

      // Lugares especiales
      { id: 'santuario', name: 'El Santuario', url: 'oceanandwildstudios.com/santuario', cost: 120 },
      { id: 'templo', name: 'El Templo', url: 'oceanandwildstudios.com/templo', cost: 130 },
      { id: 'ruinas', name: 'Las Ruinas', url: 'oceanandwildstudios.com/ruinas', cost: 140 },
      { id: 'ciudad-perdida', name: 'La Ciudad Perdida', url: 'oceanandwildstudios.com/ciudad-perdida', cost: 150 },
      { id: 'laberinto', name: 'El Laberinto', url: 'oceanandwildstudios.com/laberinto', cost: 160 },
      { id: 'torre', name: 'La Torre', url: 'oceanandwildstudios.com/torre', cost: 170 },
      { id: 'castillo', name: 'El Castillo', url: 'oceanandwildstudios.com/castillo', cost: 180 },
      { id: 'palacio', name: 'El Palacio', url: 'oceanandwildstudios.com/palacio', cost: 200 },

      // Zonas m√≠sticas
      { id: 'bosque-encantado', name: 'Bosque Encantado', url: 'oceanandwildstudios.com/bosque-encantado', cost: 90 },
      { id: 'lago-mistico', name: 'Lago M√≠stico', url: 'oceanandwildstudios.com/lago-mistico', cost: 95 },
      { id: 'cueva-cristal', name: 'Cueva de Cristal', url: 'oceanandwildstudios.com/cueva-cristal', cost: 110 },
      { id: 'jardin-flotante', name: 'Jard√≠n Flotante', url: 'oceanandwildstudios.com/jardin-flotante', cost: 125 },
      { id: 'portal', name: 'El Portal', url: 'oceanandwildstudios.com/portal', cost: 250 },

      // Zonas acu√°ticas
      { id: 'laguna', name: 'La Laguna', url: 'oceanandwildstudios.com/laguna', cost: 35 },
      { id: 'rio', name: 'El R√≠o', url: 'oceanandwildstudios.com/rio', cost: 30 },
      { id: 'cascada', name: 'La Cascada', url: 'oceanandwildstudios.com/cascada', cost: 40 },
      { id: 'aguas-termales', name: 'Aguas Termales', url: 'oceanandwildstudios.com/aguas-termales', cost: 55 },
      { id: 'fondo-marino', name: 'Fondo Marino', url: 'oceanandwildstudios.com/fondo-marino', cost: 85 },

      // Zonas a√©reas
      { id: 'nubes', name: 'Las Nubes', url: 'oceanandwildstudios.com/nubes', cost: 100 },
      { id: 'aurora', name: 'La Aurora', url: 'oceanandwildstudios.com/aurora', cost: 150 },
      { id: 'cielo-estrellado', name: 'Cielo Estrellado', url: 'oceanandwildstudios.com/cielo-estrellado', cost: 120 },
      { id: 'cometa', name: 'El Cometa', url: 'oceanandwildstudios.com/cometa', cost: 300 },

      // Zonas subterr√°neas
      { id: 'mina', name: 'La Mina', url: 'oceanandwildstudios.com/mina', cost: 70 },
      { id: 'cueva-hielo', name: 'Cueva de Hielo', url: 'oceanandwildstudios.com/cueva-hielo', cost: 80 },
      { id: 'tunel', name: 'El T√∫nel', url: 'oceanandwildstudios.com/tunel', cost: 60 },
      { id: 'subterraneo', name: 'El Subterr√°neo', url: 'oceanandwildstudios.com/subterraneo', cost: 90 },

      // Zonas urbanas
      { id: 'ciudad', name: 'La Ciudad', url: 'oceanandwildstudios.com/ciudad', cost: 110 },
      { id: 'pueblo', name: 'El Pueblo', url: 'oceanandwildstudios.com/pueblo', cost: 85 },
      { id: 'mercado', name: 'El Mercado', url: 'oceanandwildstudios.com/mercado', cost: 75 },
      { id: 'plaza', name: 'La Plaza', url: 'oceanandwildstudios.com/plaza', cost: 65 },
      { id: 'biblioteca', name: 'La Biblioteca', url: 'oceanandwildstudios.com/biblioteca', cost: 95 },
      { id: 'museo', name: 'El Museo', url: 'oceanandwildstudios.com/museo', cost: 105 },

      // Zonas de aventura
      { id: 'aventura', name: 'La Aventura', url: 'oceanandwildstudios.com/aventura', cost: 115 },
      { id: 'expedicion', name: 'La Expedici√≥n', url: 'oceanandwildstudios.com/expedicion', cost: 135 },
      { id: 'mision', name: 'La Misi√≥n', url: 'oceanandwildstudios.com/mision', cost: 145 },
      { id: 'busqueda', name: 'La B√∫squeda', url: 'oceanandwildstudios.com/busqueda', cost: 155 },

      // Zonas secretas (m√°s caras)
      { id: 'dimension', name: 'La Dimensi√≥n', url: 'oceanandwildstudios.com/dimension', cost: 500 },
      { id: 'realidad-alternativa', name: 'Realidad Alternativa', url: 'oceanandwildstudios.com/realidad-alternativa', cost: 750 },
      { id: 'nexo', name: 'El Nexo', url: 'oceanandwildstudios.com/nexo', cost: 1000 },
      { id: 'origen', name: 'El Origen', url: 'oceanandwildstudios.com/origen', cost: 2000 },
    ];

    // C√≥digos especiales
    const specialCodes = {
      'WILDMAGIC': { credits: 50, unlock: 'oceano' },
      'EXPLORER2024': { credits: 100, unlock: 'sabana' },
      'ALPHA123': { credits: 25, unlock: null },
    };

    // Dibujar icono de WildCredits (mismo modelo que Ocean Pay)
    function drawWildCreditsIcon(target, size = 18) {
      const canvas = typeof target === 'string' ? document.getElementById(target) : target;
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const x = canvas.width / 2;
      const y = canvas.height / 2;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(x, y);
      ctx.shadowBlur = size * 0.4;
      ctx.shadowColor = "rgba(100, 255, 100, 0.5)";

      // Forma de hoja
      ctx.beginPath();
      ctx.moveTo(0, -size * 0.6);
      ctx.quadraticCurveTo(size * 0.6, -size * 0.5, size * 0.4, size * 0.4);
      ctx.quadraticCurveTo(0, size * 0.7, -size * 0.4, size * 0.4);
      ctx.quadraticCurveTo(-size * 0.6, -size * 0.5, 0, -size * 0.6);

      const grad = ctx.createLinearGradient(0, -size * 0.6, 0, size * 0.7);
      grad.addColorStop(0, "#4ade80");
      grad.addColorStop(1, "#166534");
      ctx.fillStyle = grad;
      ctx.fill();

      // Venas brillantes
      ctx.strokeStyle = "rgba(255,255,255,0.4)";
      ctx.lineWidth = size * 0.05;
      ctx.beginPath();
      ctx.moveTo(0, -size * 0.5);
      ctx.lineTo(0, size * 0.5);
      ctx.stroke();

      ctx.lineWidth = size * 0.02;
      ctx.beginPath();
      ctx.moveTo(0, -size * 0.2);
      ctx.lineTo(size * 0.3, -size * 0.4);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(0, size * 0.1);
      ctx.lineTo(-size * 0.3, -size * 0.1);
      ctx.stroke();

      // "WC" Chip
      ctx.fillStyle = "rgba(0,0,0,0.4)";
      ctx.beginPath();
      ctx.arc(0, 0, size * 0.25, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#fff";
      ctx.font = `bold ${size * 0.25}px sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("WC", 0, 0);
      ctx.restore();
    }

    function renderWildIcons() {
      document.querySelectorAll('.wildcredits-icon-2d').forEach(canvas => {
        const size = parseInt(canvas.dataset.size || '18');
        drawWildCreditsIcon(canvas, size);
      });
      // Tambi√©n dibujar el del balance principal
      drawWildCreditsIcon('wcBalanceIcon', 18);
    }

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      // Asegurar que el balance est√© guardado en localStorage desde el inicio
      const savedBalance = localStorage.getItem('wildCredits');
      if (savedBalance === null || savedBalance === undefined) {
        // Si no existe, inicializar con el balance actual (puede ser 0)
        localStorage.setItem('wildCredits', balance.toString());
        console.log('[WildCredits] Inicializado balance en localStorage:', balance);
      } else {
        // Si existe, sincronizar el balance con el valor guardado
        balance = parseInt(savedBalance) || 0;
        console.log('[WildCredits] Balance cargado desde localStorage:', balance);
      }

      // Dibujar iconos de balance
      renderWildIcons();

      // Verificar vinculaci√≥n con Ocean Pay al cargar
      checkOceanPayLink();

      // Configurar BroadcastChannel para comunicaci√≥n con Ocean Pay
      try {
        const wildCreditsChannel = new BroadcastChannel('wildcredits-sync');

        // Escuchar solicitudes de balance desde Ocean Pay
        wildCreditsChannel.onmessage = (event) => {
          if (event.data && event.data.type === 'request-wildcredits-balance') {
            const currentBalance = parseInt(localStorage.getItem('wildCredits') || '0');
            wildCreditsChannel.postMessage({
              type: 'wildcredits-balance',
              balance: currentBalance
            });
            console.log('[WildCredits] Balance enviado a Ocean Pay mediante BroadcastChannel:', currentBalance);
          }
        };

        // Tambi√©n enviar actualizaciones cuando cambia el balance
        window.wildCreditsBroadcastChannel = wildCreditsChannel;
      } catch (e) {
        console.warn('[WildCredits] BroadcastChannel no disponible:', e);
      }

      // Actualizar siempre el balance para sincronizar
      updateBalance();
      createNewTab();
      updateRewardTimer();
      loadNavigationHistory();

      // Event listeners
      document.getElementById('newTabBtn').addEventListener('click', createNewTab);
      document.getElementById('goBtn').addEventListener('click', navigateToSite);
      document.getElementById('refreshBtn').addEventListener('click', refreshCurrentTab);
      document.getElementById('clearBtn').addEventListener('click', clearSite);
      document.getElementById('closeCodeModal').addEventListener('click', () => {
        document.getElementById('codeModal').classList.add('hidden');
      });
      document.getElementById('codeBtn').addEventListener('click', () => {
        document.getElementById('codeModal').classList.remove('hidden');
      });
      document.getElementById('infoBtn').addEventListener('click', () => {
        document.getElementById('infoModal').classList.remove('hidden');
        document.getElementById('modalBalance').textContent = balance;
        updateRewardTimer();
      });
      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('infoModal').classList.add('hidden');
      });
      document.getElementById('historyBtn').addEventListener('click', () => {
        document.getElementById('historyModal').classList.remove('hidden');
        loadNavigationHistory();
      });
      document.getElementById('closeHistory').addEventListener('click', () => {
        document.getElementById('historyModal').classList.add('hidden');
      });
      document.getElementById('redeemCodeBtn').addEventListener('click', redeemCode);
      document.getElementById('fakeBar').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') navigateToSite();
      });
      document.getElementById('quickEarnBtn').addEventListener('click', quickEarnCredits);

      // Nuevas funcionalidades
      document.getElementById('favoritesBtn').addEventListener('click', () => {
        document.getElementById('favoritesModal').classList.remove('hidden');
        loadFavorites();
      });
      document.getElementById('closeFavorites').addEventListener('click', () => {
        document.getElementById('favoritesModal').classList.add('hidden');
      });

      document.getElementById('downloadsBtn').addEventListener('click', () => {
        document.getElementById('downloadsModal').classList.remove('hidden');
        loadDownloads();
      });
      document.getElementById('closeDownloads').addEventListener('click', () => {
        document.getElementById('downloadsModal').classList.add('hidden');
      });

      document.getElementById('zoomInBtn').addEventListener('click', () => zoomIn());
      document.getElementById('zoomOutBtn').addEventListener('click', () => zoomOut());

      document.getElementById('addFavoriteBtn').addEventListener('click', addToFavorites);

      document.getElementById('searchInPageBtn').addEventListener('click', () => {
        const searchBar = document.getElementById('pageSearchBar');
        searchBar.classList.toggle('hidden');
        if (!searchBar.classList.contains('hidden')) {
          document.getElementById('pageSearchInput').focus();
        }
      });

      document.getElementById('pageSearchInput').addEventListener('input', (e) => {
        searchInPage(e.target.value);
      });
      document.getElementById('pageSearchPrev').addEventListener('click', () => {
        if (currentSearchIndex > 0) {
          // Restaurar resaltado anterior
          const prevHighlight = document.querySelector(`span[data-search-index="${currentSearchIndex}"]`);
          if (prevHighlight) {
            prevHighlight.style.cssText = 'background: rgba(255, 255, 0, 0.3); padding: 2px 0;';
          }

          currentSearchIndex--;
          highlightCurrentResult();
          document.getElementById('pageSearchCount').textContent =
            `${currentSearchIndex + 1}/${pageSearchResults.length}`;
        }
      });
      document.getElementById('pageSearchNext').addEventListener('click', () => {
        if (currentSearchIndex < pageSearchResults.length - 1) {
          // Restaurar resaltado anterior
          const prevHighlight = document.querySelector(`span[data-search-index="${currentSearchIndex}"]`);
          if (prevHighlight) {
            prevHighlight.style.cssText = 'background: rgba(255, 255, 0, 0.3); padding: 2px 0;';
          }

          currentSearchIndex++;
          highlightCurrentResult();
          document.getElementById('pageSearchCount').textContent =
            `${currentSearchIndex + 1}/${pageSearchResults.length}`;
        }
      });
      document.getElementById('pageSearchClose').addEventListener('click', () => {
        document.getElementById('pageSearchBar').classList.add('hidden');
        clearSearchHighlights();
      });

      document.getElementById('shareBtn').addEventListener('click', () => {
        document.getElementById('shareModal').classList.remove('hidden');
        showShareOptions();
      });
      document.getElementById('closeShare').addEventListener('click', () => {
        document.getElementById('shareModal').classList.add('hidden');
      });

      document.getElementById('siteInfoBtn').addEventListener('click', () => {
        document.getElementById('siteInfoModal').classList.remove('hidden');
        showSiteInfo();
      });
      document.getElementById('closeSiteInfo').addEventListener('click', () => {
        document.getElementById('siteInfoModal').classList.add('hidden');
      });

      // Aplicar zoom guardado
      applyZoom();

      // Verificar recompensas cada minuto
      setInterval(checkRewards, 60000);
      setInterval(updateRewardTimer, 1000);
      setInterval(updateQuickEarnButton, 1000);
      updateQuickEarnButton();
    });

    // Verificar vinculaci√≥n con Ocean Pay (requerida para WildCredits y otras divisas)
    async function checkOceanPayLink() {
      const opToken = localStorage.getItem('opToken');
      const opUser = JSON.parse(localStorage.getItem('opUser') || 'null');

      if (!opToken || !opUser || !opUser.id) {
        // No est√° vinculado, mostrar mensaje informativo despu√©s de un momento
        setTimeout(() => {
          showAlert('Vincula tu cuenta de Ocean Pay para usar WildCredits y otras divisas. Busca "Vincular Ocean Pay"', 'error');
        }, 2000);
      }
    }



    // Crear nueva pesta√±a
    function createNewTab(url = null) {
      const tabId = `tab-${tabCounter++}`;
      const tab = {
        id: tabId,
        title: 'Nueva pesta√±a',
        url: url || '',
        content: null
      };

      tabs.push(tab);
      activeTabId = tabId;

      renderTabs();
      updateUrlBar();

      if (url) {
        loadSite(url, tabId);
      } else {
        showWelcomeScreen(tabId);
      }
    }

    // Renderizar pesta√±as
    function renderTabs() {
      const container = document.getElementById('tabsContainer');
      container.innerHTML = '';

      tabs.forEach(tab => {
        const tabElement = document.createElement('div');
        tabElement.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
        tabElement.innerHTML = `
          <span class="tab-title" title="${tab.title}">${tab.title}</span>
          <button class="tab-close" onclick="closeTab('${tab.id}')">‚úï</button>
        `;
        tabElement.addEventListener('click', (e) => {
          if (!e.target.classList.contains('tab-close')) {
            switchToTab(tab.id);
          }
        });
        container.appendChild(tabElement);
      });
    }

    // Cambiar de pesta√±a
    function switchToTab(tabId) {
      activeTabId = tabId;
      renderTabs();
      updateUrlBar();

      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        const viewer = document.getElementById('siteViewer');
        viewer.innerHTML = tab.content || '';
      }
    }

    // Cerrar pesta√±a
    function closeTab(tabId) {
      if (tabs.length === 1) {
        showAlert('No puedes cerrar la √∫ltima pesta√±a', 'error');
        return;
      }

      const index = tabs.findIndex(t => t.id === tabId);
      tabs.splice(index, 1);

      if (activeTabId === tabId) {
        activeTabId = tabs[Math.max(0, index - 1)].id;
      }

      renderTabs();
      switchToTab(activeTabId);
    }

    // Actualizar barra de URL
    function updateUrlBar() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab) {
        document.getElementById('fakeBar').value = tab.url;
        document.getElementById('clearBtn').classList.toggle('hidden', !tab.url);
      }
    }

    // Navegar a sitio o buscar
    function navigateToSite() {
      const query = document.getElementById('fakeBar').value.trim();
      if (!query) {
        showAlert('Por favor, introduce una b√∫squeda o URL', 'error');
        return;
      }

      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab) return;

      // Verificar si es una URL v√°lida (contiene oceanandwildstudios.com o es una URL completa)
      const isUrl = query.includes('oceanandwildstudios.com/') ||
        query.startsWith('http://') ||
        query.startsWith('https://') ||
        (query.includes('.') && query.split('/').length > 1);

      if (isUrl) {
        // Es una URL, intentar cargar el sitio
        tab.url = query;
        tab.title = 'Cargando...';
        loadSite(query, activeTabId);
        addToHistory(query);
      } else {
        // Es una b√∫squeda, realizar Wild Search
        performWildSearch(query, activeTabId);
        addToHistory(`B√∫squeda: ${query}`);
      }
    }

    // Realizar b√∫squeda Wild Search
    function performWildSearch(query, tabId) {
      const tab = tabs.find(t => t.id === tabId);
      if (!tab) return;

      const searchTerm = query.toLowerCase();
      const results = [];

      // Buscar en los sitios disponibles
      sites.forEach(site => {
        const siteName = site.name.toLowerCase();
        const siteId = site.id.toLowerCase();
        const siteUrl = site.url.toLowerCase();

        // Buscar coincidencias en nombre, ID o URL
        if (siteName.includes(searchTerm) ||
          siteId.includes(searchTerm) ||
          siteUrl.includes(searchTerm) ||
          searchTerm.includes(siteId) ||
          searchTerm.includes(siteName.split(' ')[0])) {

          // Buscar palabras clave en el contenido del sitio
          let relevance = 0;
          if (siteName.includes(searchTerm)) relevance += 10;
          if (siteId === searchTerm) relevance += 20;
          if (siteUrl.includes(searchTerm)) relevance += 5;

          const isUnlocked = site.default || unlockedSites.includes(site.id);
          results.push({
            site: site,
            relevance: relevance,
            unlocked: isUnlocked,
            matchType: siteName.includes(searchTerm) ? 'nombre' :
              siteId.includes(searchTerm) ? 'id' : 'url'
          });
        }
      });

      // Tambi√©n buscar en el contenido especial (anuncios globales)
      if (searchTerm.includes('eco') || searchTerm.includes('console') ||
        searchTerm.includes('ecoxion') || searchTerm.includes('naturepedia') ||
        searchTerm.includes('currency') || searchTerm.includes('playground') ||
        searchTerm.includes('anuncio') || searchTerm.includes('progreso') ||
        searchTerm.includes('global')) {
        const globalSite = sites.find(s => s.id === 'global-announcement');
        if (globalSite && !results.find(r => r.site.id === 'global-announcement')) {
          results.push({
            site: globalSite,
            relevance: 15,
            unlocked: true,
            matchType: 'contenido'
          });
        }
      }

      // Buscar Ocean Pay
      if (searchTerm.includes('ocean pay') || searchTerm.includes('oceanpay') ||
        searchTerm.includes('vincular ocean pay') || searchTerm.includes('wildcredits') ||
        searchTerm.includes('billetera') || searchTerm.includes('wallet')) {
        const paySite = sites.find(s => s.id === 'ocean-pay-link');
        if (paySite && !results.find(r => r.site.id === 'ocean-pay-link')) {
          results.push({
            site: paySite,
            relevance: 20,
            unlocked: true,
            matchType: 'contenido'
          });
        }
      }



      // Ordenar por relevancia
      results.sort((a, b) => b.relevance - a.relevance);

      // Guardar resultados en la pesta√±a
      tab.url = `Wild Search: ${query}`;
      tab.title = `B√∫squeda: ${query}`;
      tab.content = generateSearchResults(query, results);

      if (tabId === activeTabId) {
        document.getElementById('siteViewer').innerHTML = tab.content;
      }

      renderTabs();
      updateUrlBar();
      document.getElementById('clearBtn').classList.remove('hidden');
    }

    // Generar p√°gina de resultados de b√∫squeda
    function generateSearchResults(query, results) {
      if (results.length === 0) {
        return `
          <div class="search-results">
            <div class="wild-search-logo" style="text-align: center; margin-bottom: 3rem;">
              <h1 style="font-size: 3rem; background: linear-gradient(to bottom, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent;">Wild Search</h1>
              <p class="tagline" style="color: var(--text-dim);">Ecosistema Digital de Ocean and Wild Studios</p>
            </div>
            <div class="no-results" style="text-align: center; padding: 4rem; background: var(--card-glass); border-radius: 24px; border: 1px solid var(--card-border);">
              <i class="fas fa-search-minus" style="font-size: 4rem; color: var(--text-dim); opacity: 0.2; margin-bottom: 2rem;"></i>
              <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">No se encontraron coincidencias para "${query}"</h3>
              <p style="color: var(--text-dim);">Intenta con palabras como "jungla", "oceano", "progreso" o una URL directa.</p>
              <div style="margin-top: 3rem; display: flex; justify-content: center; gap: 1rem;">
                <button onclick="clearSite()" style="margin-top: 0;">Volver al inicio</button>
              </div>
            </div>
          </div>
        `;
      }

      let resultsHtml = `
        <div class="search-results">
          <div class="wild-search-logo" style="margin-bottom: 3rem;">
            <h1 style="font-size: 2.5rem; background: linear-gradient(to bottom, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent;">Wild Search</h1>
            <p class="tagline" style="color: var(--text-dim);">Resultados de b√∫squeda global</p>
          </div>
          <div class="search-header">
            <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Coincidencias para "${query}"</h2>
            <p class="search-info">Se han identificado ${results.length} nodo${results.length !== 1 ? 's' : ''} en la red</p>
          </div>
      `;

      results.forEach((result, index) => {
        const site = result.site;
        let description = '';
        if (site.id === 'global-announcement') {
          description = 'P√°gina con anuncios globales y progreso de todos los proyectos de Ocean and Wild Studios, incluyendo EcoConsole, Ecoxion, Naturepedia y Currency Playground.';
        } else if (site.id === 'ocean-pay-link') {
          description = 'Vincula tu cuenta de Ocean Pay para gestionar tu balance de WildCredits y acceder a nodos restringidos del ecosistema.';
        } else {
          description = `Explora ${site.name}, un sitio del ecosistema de Ocean and Wild Studios. ${site.default || unlockedSites.includes(site.id) ? 'Acceso disponible.' : `Requiere ${site.cost} WildCredits para desbloquear.`}`;
        }

        resultsHtml += `
          <div class="search-result-item" onclick="openSearchResult('${site.url}', ${!site.default && !unlockedSites.includes(site.id)})">
            <div class="search-result-url">${site.url}</div>
            <div class="search-result-title">
              ${site.name}
              <span class="search-result-badge ${result.unlocked ? 'badge-unlocked' : 'badge-locked'}">
                ${result.unlocked ? 'Disponible' : 'Bloqueado'}
              </span>
            </div>
            <div class="search-result-description">${description}</div>
          </div>
        `;
      });

      resultsHtml += `</div>`;
      return resultsHtml;
    }

    // Abrir resultado de b√∫squeda
    window.openSearchResult = function (url, isLocked) {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab) return;

      if (isLocked) {
        // Cargar la p√°gina de desbloqueo con opciones
        tab.url = url;
        loadSite(url, activeTabId);
        return;
      }

      tab.url = url;
      loadSite(url, activeTabId);
    };

    // Cargar sitio
    async function loadSite(url, tabId) {
      const tab = tabs.find(t => t.id === tabId);
      if (!tab) return;

      // Normalizar URL
      let normalizedUrl = url.toLowerCase();
      if (!normalizedUrl.startsWith('oceanandwildstudios.com/')) {
        normalizedUrl = 'oceanandwildstudios.com/' + normalizedUrl;
      }

      // Buscar sitio
      const site = sites.find(s => normalizedUrl.includes(s.id)) || sites[0];

      // Verificar si est√° desbloqueado
      if (!site.default && !unlockedSites.includes(site.id)) {
        // Mostrar opciones de desbloqueo
        showLockedSite(tabId, site);
        return;
      }

      // Navegaci√≥n exitosa (sin costo de internet)
      tab.url = site.url;
      tab.title = site.name;
      tab.content = generateSiteContent(site);

      if (tabId === activeTabId) {
        document.getElementById('siteViewer').innerHTML = tab.content;
      }

      renderTabs();
      updateUrlBar();
      document.getElementById('clearBtn').classList.remove('hidden');
      document.getElementById('addFavoriteBtn').classList.remove('hidden');
      document.getElementById('searchInPageBtn').classList.remove('hidden');
      document.getElementById('shareBtn').classList.remove('hidden');
      document.getElementById('siteInfoBtn').classList.remove('hidden');
    }



    // Renderizar iconos si existen
    setTimeout(renderWildIcons, 0);

    // Generar contenido del sitio
    function generateSiteContent(site) {
      if (site.id === 'ocean-pay-link') {
        const existingToken = localStorage.getItem('opToken');
        const existingUser = JSON.parse(localStorage.getItem('opUser') || 'null');

        if (existingToken && existingUser) {
          const wildCredits = parseInt(localStorage.getItem('wildCredits') || '0');

          return `
            <div class="site-content">
              <div class="link-container" style="border-color: var(--accent);">
                <div style="text-align: center; margin-bottom: 3rem;">
                  <div style="width: 70px; height: 70px; background: rgba(124, 77, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; border: 1px solid rgba(124, 77, 255, 0.2);">
                    <i class="fas fa-wallet" style="font-size: 2rem; color: var(--accent);"></i>
                  </div>
                  <h2 style="color: var(--accent); margin-bottom: 0.5rem;">B√≥veda Wild Explorer Activa</h2>
                  <p style="color: var(--text-dim);">Gestionando WildCredits y protocolos de acceso</p>
                </div>

                <div class="balance-display" style="background: rgba(124, 77, 255, 0.05); padding: 3rem; border-radius: 24px; border: 1px solid rgba(124, 77, 255, 0.2); margin-bottom: 2rem;">
                  <h3 style="color: var(--text-main); font-weight: 800; font-size: 1.2rem; margin-bottom: 0.5rem;">Balance WildCredits Solicitado</h3>
                  <div class="balance-amount" style="font-size: 4rem; color: #ff9100; text-shadow: 0 0 20px rgba(255, 145, 0, 0.3);">${wildCredits.toLocaleString()}</div>
                  <p style="margin-top: 1rem; color: var(--text-dim); font-size: 0.8rem; letter-spacing: 2px;">PROTOCOLO WC-SYNC v5.2</p>
                </div>

                <div style="text-align: center; margin-top: 3rem;">
                  <button onclick="localStorage.removeItem('opToken'); localStorage.removeItem('opUser'); loadSite('${site.url}', activeTabId);" 
                          style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444;">
                    DISOLVER V√çNCULO SEGURO
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        return `
          <div class="site-content">
            <div class="link-container" style="border-color: var(--accent);">
              <div style="text-align: center; margin-bottom: 3rem;">
                <div style="width: 70px; height: 70px; background: rgba(124, 77, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; border: 1px solid rgba(124, 77, 255, 0.2);">
                  <i class="fas fa-vault" style="font-size: 2rem; color: var(--accent);"></i>
                </div>
                <h2 style="color: var(--accent); margin-bottom: 0.5rem;">Vincular Ocean Pay</h2>
                <p style="color: var(--text-dim);">Centraliza tus activos digitales en Wild Explorer</p>
              </div>
              
              <form id="linkAccountForm" class="link-form" onsubmit="linkOceanPayAccount(event); return false;">
                <div style="position: relative; margin-bottom: 1rem;">
                  <i class="fas fa-user-shield" style="position: absolute; left: 15px; top: 15px; color: var(--accent);"></i>
                  <input type="text" id="linkUsername" placeholder="Usuario Ocean Pay" style="padding-left: 45px !important;" required />
                </div>
                <div style="position: relative; margin-bottom: 1rem;">
                  <i class="fas fa-unlock-alt" style="position: absolute; left: 15px; top: 15px; color: var(--accent);"></i>
                  <input type="password" id="linkPassword" placeholder="Clave de Acceso" style="padding-left: 45px !important;" required />
                </div>
                <div id="linkError" class="link-error hidden" style="color: #ef4444; background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 10px; text-align: center;"></div>
                <button type="submit" id="linkSubmitBtn">ESTABLECER CONEXI√ìN BANCARIA</button>
              </form>
              
              <div id="linkLoader" class="link-loader">
                <div class="spinner"></div>
                <p style="color: var(--accent); font-weight: 700; margin-top: 1rem;">ACCEDIENDO A BOVEDA...</p>
              </div>
              
              <div id="linkSuccess" class="success-animation">
                <div class="checkmark-container" style="border-color: var(--accent);">
                  <svg class="checkmark-svg" viewBox="0 0 120 120">
                    <circle cx="60" cy="60" r="56" fill="none" stroke="rgba(124, 77, 255, 0.2)" stroke-width="4" />
                    <circle class="checkmark-circle-fill" cx="60" cy="60" r="56" fill="none" stroke="var(--accent)" stroke-width="4" 
                            stroke-dasharray="352" stroke-dashoffset="352" 
                            transform="rotate(-90 60 60)" />
                    <path class="checkmark-path" d="M 30 60 L 50 80 L 90 40" style="stroke: var(--accent);" />
                  </svg>
                </div>
                <div class="balance-display">
                  <h3 style="color: var(--accent);">¬°Acceso Concedido!</h3>
                  <div class="balance-amount" id="totalBalanceDisplay" style="color: var(--accent);">Sincronizando...</div>
                  <div class="balance-breakdown" id="balanceBreakdown"></div>
                </div>
              </div>
            </div>
          </div>
        `;
      }



      if (site.id === 'global-announcement') {
        return `
          <div class="site-content">
            <h2 style="font-size: 3rem; margin-bottom: 0.5rem;"><i class="fas fa-bullhorn" style="color: var(--neon-pink);"></i> Anuncios Globales</h2>
            <p style="margin-bottom: 3rem; color: var(--text-dim); font-size: 1.1rem;">Cronolog√≠a del progreso del ecosistema digital</p>
            
            <!-- EcoConsole -->
            <div class="announcement-card">
              <h3 style="display: flex; align-items: center; justify-content: space-between;">
                <span><i class="fas fa-gamepad" style="color: var(--accent); margin-right: 12px;"></i>EcoConsole V2</span>
                <span class="status-badge" style="background: rgba(255, 193, 7, 0.1); color: #ffc107; border: 1px solid #ffc107; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; text-transform: uppercase;">En Desarrollo</span>
              </h3>
              <p style="color: var(--text-dim); margin-top: 1rem;">Reingenier√≠a completa de hardware virtual. Nueva arquitectura de 128-WildBits.</p>
              <div class="progress-bar-container" style="background: rgba(255,255,255,0.05); height: 12px; border-radius: 6px; margin: 1.5rem 0; overflow: hidden;">
                <div class="progress-bar" style="width: 65%; height: 100%; background: var(--accent); box-shadow: 0 0 15px var(--accent-glow);"></div>
              </div>
            </div>

            <!-- Ecoxion Recode -->
            <div class="announcement-card" style="border-color: rgba(16, 185, 129, 0.3);">
              <h3 style="display: flex; align-items: center; justify-content: space-between;">
                <span><i class="fas fa-leaf" style="color: #10b981; margin-right: 12px;"></i>Ecoxion Recode</span>
                <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; text-transform: uppercase;">Lanzado</span>
              </h3>
              <p style="color: var(--text-dim); margin-top: 1rem;">Implementaci√≥n exitosa del nuevo motor de gesti√≥n ambiental y social.</p>
              <div class="progress-bar-container" style="background: rgba(255,255,255,0.05); height: 12px; border-radius: 6px; margin: 1.5rem 0; overflow: hidden;">
                <div class="progress-bar" style="width: 100%; height: 100%; background: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);"></div>
              </div>
            </div>

            <!-- Naturepedia Redise√±o -->
            <div class="announcement-card">
              <h3 style="display: flex; align-items: center; justify-content: space-between;">
                <span><i class="fas fa-book-open" style="color: var(--neon-cyan); margin-right: 12px;"></i>Naturepedia Rework</span>
                <span class="status-badge" style="background: rgba(0, 229, 255, 0.1); color: var(--neon-cyan); border: 1px solid var(--neon-cyan); padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; text-transform: uppercase;">En Desarrollo</span>
              </h3>
              <p style="color: var(--text-dim); margin-top: 1rem;">Migraci√≥n de datos a la nueva red estructural y optimizaci√≥n de enciclopedia.</p>
              <div class="progress-bar-container" style="background: rgba(255,255,255,0.05); height: 12px; border-radius: 6px; margin: 1.5rem 0; overflow: hidden;">
                <div class="progress-bar" style="width: 45%; height: 100%; background: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);"></div>
              </div>
            </div>

            <!-- Naturepedia Espacial -->
            <div class="announcement-card">
              <h3 style="display: flex; align-items: center; justify-content: space-between;">
                <span><i class="fas fa-rocket" style="color: #ff4757; margin-right: 12px;"></i>Naturepedia Espacial</span>
                <span class="status-badge" style="background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px solid #ff4757; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; text-transform: uppercase;">Planificaci√≥n</span>
              </h3>
              <p style="color: var(--text-dim); margin-top: 1rem;">Expansi√≥n del cat√°logo biol√≥gico a ecosistemas interestelares y vida extraterrestre.</p>
              <div class="progress-bar-container" style="background: rgba(255,255,255,0.05); height: 12px; border-radius: 6px; margin: 1.5rem 0; overflow: hidden;">
                <div class="progress-bar" style="width: 20%; height: 100%; background: #ff4757; box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);"></div>
              </div>
            </div>

            <!-- Currency Playground -->
            <div class="announcement-card" style="background: rgba(255, 215, 0, 0.03);">
              <h3 style="display: flex; align-items: center; justify-content: space-between;">
                <span><i class="fas fa-coins" style="color: #ffd700; margin-right: 12px;"></i>Currency Playground</span>
                <span class="status-badge" style="background: rgba(255, 215, 0, 0.1); color: #ffd700; border: 1px solid #ffd700; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; text-transform: uppercase;">Pruebas Beta</span>
              </h3>
              <p style="color: var(--text-dim); margin-top: 1rem;">Integraci√≥n final de la econom√≠a compartida. El patio de juegos regresa.</p>
              <div class="progress-bar-container" style="background: rgba(255,255,255,0.05); height: 12px; border-radius: 6px; margin: 1.5rem 0; overflow: hidden;">
                <div class="progress-bar" style="width: 90%; height: 100%; background: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);"></div>
              </div>
            </div>

            <div style="margin-top: 4rem; padding: 2rem; background: var(--card-glass); border: 1px solid var(--card-border); border-radius: 20px; text-align: center;">
              <p style="margin: 0; font-weight: 600; color: var(--text-dim);"><i class="fas fa-info-circle"></i> Los datos de progreso se actualizan v√≠a OceanLink en tiempo real.</p>
            </div>
          </div>
        `;
      }

      return `
        <div class="site-content">
          <div style="margin-bottom: 2.5rem; animation: fadeInUp 0.5s ease;">
            <h2 style="font-size: 3.5rem; margin-bottom: 0.5rem;"><i class="fas fa-globe-americas" style="color: var(--neon-cyan); margin-right: 15px;"></i>${site.name}</h2>
            <p style="color: var(--text-dim); font-size: 1.1rem; border-left: 3px solid var(--accent); padding-left: 1rem;">Nodo oficial del ecosistema digital</p>
          </div>

          <div class="announcement-card" style="background: var(--card-glass);">
            <p style="font-size: 1.2rem; line-height: 1.6; margin-bottom: 2rem;">
              Bienvenido a la interfaz de <strong>${site.name}</strong>. Est√°s explorando una secci√≥n integrada de la red de Ocean and Wild Studios.
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
              <div style="padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid var(--card-border);">
                <i class="fas fa-microchip" style="color: var(--accent); margin-bottom: 1rem; font-size: 1.5rem;"></i>
                <h4 style="margin-bottom: 0.5rem;">Tecnolog√≠a Inmersiva</h4>
                <p style="font-size: 0.85rem; color: var(--text-dim);">Optimizado para Wild Explorer Alpha.</p>
              </div>
              <div style="padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid var(--card-border);">
                <i class="fas fa-shield-alt" style="color: var(--neon-cyan); margin-bottom: 1rem; font-size: 1.5rem;"></i>
                <h4 style="margin-bottom: 0.5rem;">Acceso Seguro</h4>
                <p style="font-size: 0.85rem; color: var(--text-dim);">Conexi√≥n cifrada v√≠a OceanLink.</p>
              </div>
              <div style="padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid var(--card-border);">
                <i class="fas fa-bolt" style="color: #ffd700; margin-bottom: 1rem; font-size: 1.5rem;"></i>
                <h4 style="margin-bottom: 0.5rem;">Ecosistema Activo</h4>
                <p style="font-size: 0.85rem; color: var(--text-dim);">Interacci√≥n directa con balances y progreso.</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Mostrar sitio bloqueado
    function showLockedSite(tabId, site) {
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        tab.title = `${site.name} (Bloqueado)`;

        const opToken = localStorage.getItem('opToken');
        const opUser = JSON.parse(localStorage.getItem('opUser') || 'null');
        const hasWildCreditsAccess = opToken && opUser && opUser.id;

        const internetCost = 1.0; // 1.0 GB para desbloquear

        tab.content = `
          <div class="site-content">
            <div style="text-align: center; margin-bottom: 4rem; animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);">
              <div style="width: 100px; height: 100px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem; border: 1px solid rgba(239, 68, 68, 0.2); box-shadow: 0 0 30px rgba(239, 68, 68, 0.1);">
                <i class="fas fa-lock" style="font-size: 3rem; color: #ef4444;"></i>
              </div>
              <h2 style="margin-bottom: 1rem; background: linear-gradient(to bottom, #fff, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Nodo Restringido</h2>
              <p style="color: var(--text-dim); font-size: 1.1rem; letter-spacing: 1px;">Se requiere autorizaci√≥n de nivel Gamma para acceder a <strong>${site.name}</strong></p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; max-width: 800px; margin: 0 auto; animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;">
              <!-- Opci√≥n 1: WildCredits -->
              <div class="announcement-card" style="margin-bottom: 0; border: 1px solid ${balance >= site.cost ? 'var(--accent)' : 'var(--card-border)'}; background: ${balance >= site.cost ? 'rgba(124, 77, 255, 0.05)' : 'var(--card-glass)'};">
                <div style="text-align: center;">
                  <div style="color: var(--accent); font-size: 2rem; margin-bottom: 1.5rem;"><canvas class="wildcredits-icon-2d" data-size="40" width="60" height="60"></canvas></div>
                  <h4 style="color: white; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 2px;">Protocolo WildCredits</h4>
                  <p style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--accent);">${site.cost} <span style="font-size: 0.8rem; color: var(--text-dim);">WC</span></p>
                  <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 2rem;">Saldo disponible: ${balance}</p>
                  
                  <button onclick="unlockSite('${site.id}')" 
                          style="width: 100%; margin-top: 0; background: ${balance >= site.cost ? 'var(--accent)' : 'rgba(255,255,255,0.05)'}; 
                                 cursor: ${balance >= site.cost ? 'pointer' : 'not-allowed'};
                                 color: ${balance >= site.cost ? 'white' : 'var(--text-dim)'};
                                 border: ${balance >= site.cost ? 'none' : '1px solid var(--card-border)'};">
                    ${balance >= site.cost ? 'AUTORIZAR ACCESO' : 'SALDO INSUFICIENTE'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        if (tabId === activeTabId) {
          document.getElementById('siteViewer').innerHTML = tab.content;
        }
        renderTabs();
      }
    }

    // Desbloquear sitio con WildCredits
    window.unlockSite = function (siteId) {
      const site = sites.find(s => s.id === siteId);
      if (!site) return;

      if (balance >= site.cost) {
        balance -= site.cost;
        unlockedSites.push(siteId);
        localStorage.setItem('wildCredits', balance);
        localStorage.setItem('unlockedSites', JSON.stringify(unlockedSites));

        // Enviar informaci√≥n de transacci√≥n al actualizar balance
        updateBalance({
          amount: -site.cost,
          concepto: `Desbloqueo de ${site.name}`,
          origen: 'Wild Explorer'
        });

        loadSite(site.url, activeTabId);
        showAlert(`¬°${site.name} desbloqueado con ${site.cost} WildCredits!`, 'success');
      } else {
        showAlert(`No tienes suficientes WildCredits`, 'error');
      }
    };



    // Mostrar pantalla de bienvenida
    function showWelcomeScreen(tabId) {
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        tab.title = 'Nueva pesta√±a';
        tab.content = `
          <div class="site-content">
            <div class="wild-search-logo" style="padding: 4rem 0; animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);">
              <h1 style="font-size: 7rem; letter-spacing: -6px; margin-bottom: 0.5rem; background: linear-gradient(to bottom, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px var(--accent-glow));">Wild Explorer</h1>
              <p class="tagline" style="color: var(--text-dim); font-size: 1.4rem; letter-spacing: 4px; text-transform: uppercase; font-weight: 300;">Navegando el Multiverso Digital</p>
            </div>
            
            <div style="max-width: 750px; margin: 0 auto 5rem; animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;">
              <div class="input-wrapper" style="padding: 1.5rem 2.5rem; border-radius: 30px; background: rgba(255,255,255,0.03); border: 1px solid var(--card-border); box-shadow: 0 40px 100px rgba(0,0,0,0.5); backdrop-filter: blur(20px);">
                <i class="fas fa-search" style="color: var(--accent); font-size: 1.5rem; margin-right: 20px;"></i>
                <input type="text" id="homeSearch" placeholder="Explorar ecosistemas, bovedas o protocolos..." 
                       style="flex: 1; background: transparent !important; border: none !important; font-size: 1.25rem; color: white !important; outline: none !important; font-weight: 300;" 
                       onkeypress="if(event.key === 'Enter') { document.getElementById('fakeBar').value = this.value; navigateToSite(); }" />
                <button onclick="document.getElementById('fakeBar').value = document.getElementById('homeSearch').value; navigateToSite();" 
                        style="background: var(--accent); color: white; border: none; padding: 0.8rem 2.5rem; border-radius: 16px; font-weight: 800; cursor: pointer; transition: 0.4s; margin-left: 15px; letter-spacing: 2px;">VINCULAR</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; max-width: 500px; margin: 0 auto 5rem; animation: fadeInUp 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.4s both;">
              <div class="announcement-card" style="margin-bottom: 0; background: rgba(255,0,127,0.03); border-color: rgba(255,0,127,0.1);">
                <h3 style="color: var(--neon-pink); font-size: 1.4rem; display: flex; align-items: center; gap: 12px;"><i class="fas fa-microchip"></i> Protocolo Activo</h3>
                <p style="color: var(--text-dim); line-height: 1.8; margin-top: 1.5rem;">Sincroniza tu cuenta de <strong>Ocean Pay</strong> para gestionar WildCredits y visualizar activos de todos tus universos.</p>
                <div style="margin-top: 2rem; font-weight: 800; color: var(--neon-pink); font-size: 0.75rem; letter-spacing: 2px;">SISTEMA OP-SYNC READY</div>
              </div>
            </div>

            <div style="text-align: center; color: var(--text-dim); font-size: 0.8rem; margin-bottom: 3rem; opacity: 0.4; letter-spacing: 3px; font-weight: 400;">
              WILD EXPLORER CORE PROTOCOL ‚Ä¢ ALPHA V2.2 ‚Ä¢ OWS ENTERPRISE
            </div>
          </div>
        `;
        if (tabId === activeTabId) {
          document.getElementById('siteViewer').innerHTML = tab.content;
        }
      }
    }

    // Refrescar pesta√±a actual
    async function refreshCurrentTab() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab && tab.url) {
        await loadSite(tab.url, activeTabId);
        showAlert('Sitio recargado', 'success');
      }
    }

    // Limpiar sitio
    function clearSite() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab) {
        tab.url = '';
        tab.content = null;
        document.getElementById('fakeBar').value = '';
        document.getElementById('clearBtn').classList.add('hidden');
        showWelcomeScreen(activeTabId);
      }
    }

    // Actualizar balance
    function updateBalance(transactionInfo = null) {
      const oldBalance = parseInt(localStorage.getItem('wildCredits') || '0');
      const balanceAmountEl = document.getElementById('balanceAmount');
      if (balanceAmountEl) {
        balanceAmountEl.textContent = balance.toLocaleString();
      }

      // SIEMPRE guardar en localStorage, incluso si es 0
      localStorage.setItem('wildCredits', balance.toString());
      console.log('[WildCredits] Balance actualizado y guardado:', balance);

      // Enviar actualizaci√≥n mediante BroadcastChannel (para comunicaci√≥n entre diferentes or√≠genes)
      if (window.wildCreditsBroadcastChannel) {
        try {
          window.wildCreditsBroadcastChannel.postMessage({
            type: 'wildcredits-balance',
            balance: balance
          });
          console.log('[WildCredits] Balance enviado mediante BroadcastChannel:', balance);
        } catch (e) {
          console.warn('[WildCredits] Error enviando mediante BroadcastChannel:', e);
        }
      }

      // Disparar StorageEvent para otras pesta√±as/ventanas
      try {
        window.dispatchEvent(new StorageEvent('storage', {
          key: 'wildCredits',
          oldValue: oldBalance.toString(),
          newValue: balance.toString(),
          storageArea: localStorage
        }));
      } catch (e) {
        // En algunos navegadores StorageEvent puede no funcionar, usar CustomEvent
        window.dispatchEvent(new CustomEvent('wildcredits-updated', {
          detail: { balance, oldBalance }
        }));
      }

      // Si hay cuenta de Ocean Pay vinculada, actualizar tambi√©n en opUser y sincronizar con servidor
      const opToken = localStorage.getItem('opToken');
      const opUser = JSON.parse(localStorage.getItem('opUser') || 'null');
      if (opToken && opUser && opUser.id) {
        opUser.wildcredits = balance;
        localStorage.setItem('opUser', JSON.stringify(opUser));
        console.log('[WildCredits] Actualizado opUser.wildcredits:', balance);

        // Sincronizar con el servidor para que Ocean Pay pueda obtenerlo
        fetch('https://owsdatabase.onrender.com/ocean-pay/wildcredits/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${opToken}`
          },
          body: JSON.stringify({ wildCredits: balance })
        }).then(res => res.json())
          .then(data => {
            console.log('[WildCredits] Sincronizado con servidor:', data);
          })
          .catch(err => {
            console.warn('[WildCredits] Error sincronizando con servidor:', err);
          });

        // Notificar a otras ventanas/iframe de Ocean Pay
        window.postMessage({
          type: 'wildcredits-update',
          balance: balance,
          transaction: transactionInfo
        }, '*');

        // Si hay informaci√≥n de transacci√≥n (descuento), registrarla en el servidor
        if (transactionInfo && transactionInfo.amount < 0) {
          fetch('https://owsdatabase.onrender.com/ocean-pay/wildcredits/transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: opUser.id,
              amount: transactionInfo.amount,
              concepto: transactionInfo.concepto || 'Operaci√≥n',
              origen: transactionInfo.origen || 'Wild Explorer'
            })
          }).catch(err => console.error('Error registrando transacci√≥n:', err));
        }
      }
    }

    // Mostrar alerta
    function showAlert(message, type = 'info') {
      const alert = document.getElementById('customAlert');
      let icon = '<i class="fas fa-info-circle"></i>';
      if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
      if (type === 'error') icon = '<i class="fas fa-exclamation-triangle"></i>';

      alert.innerHTML = `${icon} <span>${message}</span>`;
      alert.className = type;
      alert.classList.add('show');

      setTimeout(() => {
        alert.classList.remove('show');
      }, 3000);
    }

    // Canjear c√≥digo
    function redeemCode() {
      const code = document.getElementById('codeInput').value.trim().toUpperCase();
      const statusEl = document.getElementById('codeStatus');

      if (!code) {
        statusEl.textContent = 'Por favor, introduce un c√≥digo';
        statusEl.className = 'error';
        return;
      }

      if (specialCodes[code]) {
        const reward = specialCodes[code];
        balance += reward.credits;
        if (reward.unlock && !unlockedSites.includes(reward.unlock)) {
          unlockedSites.push(reward.unlock);
          localStorage.setItem('unlockedSites', JSON.stringify(unlockedSites));
        }
        localStorage.setItem('wildCredits', balance);
        updateBalance();
        statusEl.textContent = `¬°C√≥digo canjeado! +${reward.credits} WildCredits${reward.unlock ? ` y ${sites.find(s => s.id === reward.unlock).name} desbloqueado` : ''}`;
        statusEl.className = 'success';
        document.getElementById('codeInput').value = '';
        setTimeout(() => {
          document.getElementById('codeModal').classList.add('hidden');
        }, 2000);
      } else {
        statusEl.textContent = 'C√≥digo inv√°lido';
        statusEl.className = 'error';
      }
    }

    // Vincular cuenta de Ocean Pay
    window.linkOceanPayAccount = async function (event) {
      event.preventDefault();

      const form = document.getElementById('linkAccountForm');
      const loader = document.getElementById('linkLoader');
      const success = document.getElementById('linkSuccess');
      const errorDiv = document.getElementById('linkError');
      const submitBtn = document.getElementById('linkSubmitBtn');

      const username = document.getElementById('linkUsername').value.trim();
      const password = document.getElementById('linkPassword').value;

      if (!username || !password) {
        errorDiv.textContent = 'Por favor, completa todos los campos';
        errorDiv.classList.remove('hidden');
        return;
      }

      // Ocultar error y mostrar loader
      errorDiv.classList.add('hidden');
      form.classList.add('hidden');
      loader.classList.add('active');
      submitBtn.disabled = true;

      try {
        const API = 'https://owsdatabase.onrender.com';

        // Obtener WildCredits ANTES de enviar la solicitud
        const wildCredits = parseInt(localStorage.getItem('wildCredits') || '0');

        const res = await fetch(`${API}/ocean-pay/link-account`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, wildCredits })
        });

        const data = await res.json();

        if (!res.ok) {
          // Mostrar mensaje de error m√°s espec√≠fico
          let errorMessage = data.error || 'Error al vincular la cuenta';
          if (res.status === 401) {
            errorMessage = 'Usuario o contrase√±a incorrectos. Verifica tus credenciales de Ocean Pay.';
          } else if (res.status === 400) {
            errorMessage = 'Faltan datos. Completa todos los campos.';
          }
          throw new Error(errorMessage);
        }

        // El servidor ya devuelve wildcredits en data.user, pero asegur√©monos de usar el valor actual
        const currentWildCredits = parseInt(localStorage.getItem('wildCredits') || '0');

        // Guardar datos - el servidor devuelve wildcredits pero usamos el valor m√°s reciente de localStorage
        const userData = {
          ...data.user,
          wildcredits: Math.max(data.user.wildcredits || 0, currentWildCredits)
        };
        localStorage.setItem('opToken', data.token);
        localStorage.setItem('opUser', JSON.stringify(userData));
        console.log('[WildCredits] Guardado opUser.wildcredits al vincular:', userData.wildcredits);

        // Esperar un poco para el loader
        await new Promise(resolve => setTimeout(resolve, 1500));

        // Ocultar loader y mostrar animaci√≥n de √©xito
        loader.classList.remove('active');
        success.classList.add('active');

        // Calcular total
        const total = wildCredits;

        // Actualizar saldo total despu√©s de la animaci√≥n del checkmark
        setTimeout(() => {
          const totalDisplay = document.getElementById('totalBalanceDisplay');
          const breakdown = document.getElementById('balanceBreakdown');

          if (totalDisplay) {
            totalDisplay.textContent = total.toLocaleString();
            totalDisplay.style.color = '#ff9100';
          }

          if (breakdown) {
            breakdown.innerHTML = `
              <div class="balance-item opacity-0" style="background: rgba(255,145,0,0.05); border: 1px solid rgba(255,145,0,0.2); padding: 1.5rem; border-radius: 20px; transition: 0.5s; width: 100%; max-width: 400px; margin: 0 auto;">
                <div style="color: #ff9100; font-size: 1.2rem; margin-bottom: 0.5rem;"><canvas class="wildcredits-icon-2d" data-size="24" width="32" height="32"></canvas></div>
                <div class="balance-item-label" style="font-size: 0.6rem;">WildCredits</div>
                <div class="balance-item-value" style="font-size: 1.2rem; color: white;">${wildCredits.toLocaleString()}</div>
              </div>
            `;

            // Animar el item
            setTimeout(() => {
              breakdown.querySelector('.balance-item').classList.remove('opacity-0');
            }, 500);
          }

          // Notificar a Ocean Pay si est√° abierto
          if (window.opener) {
            window.opener.postMessage({
              type: 'wildcredits-update',
              balance: wildCredits
            }, '*');
          }

          // Recargar la p√°gina despu√©s de mostrar los balances (4 segundos despu√©s del √©xito)
          setTimeout(() => {
            const site = sites.find(s => s.id === 'ocean-pay-link');
            if (site) {
              loadSite(site.url, activeTabId);
            }
          }, 4000);
        }, 2000);

        // Actualizar balance en la barra superior
        updateBalance();

        // Notificar actualizaci√≥n de WildCredits a otras ventanas
        window.dispatchEvent(new StorageEvent('storage', {
          key: 'wildCredits',
          newValue: wildCredits.toString()
        }));

      } catch (err) {
        loader.classList.remove('active');
        form.classList.remove('hidden');
        errorDiv.textContent = err.message || 'Error al vincular la cuenta';
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;

        // Log del error para debugging
        console.error('Error vinculando cuenta:', err);
      }
    };



    // A√±adir al historial
    function addToHistory(url) {
      const historyItem = {
        url: url,
        timestamp: Date.now(),
        title: tabs.find(t => t.id === activeTabId)?.title || url
      };
      navigationHistory.unshift(historyItem);
      if (navigationHistory.length > 50) {
        navigationHistory = navigationHistory.slice(0, 50);
      }
      localStorage.setItem('navigationHistory', JSON.stringify(navigationHistory));
    }

    // Cargar historial
    function loadNavigationHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '';

      if (navigationHistory.length === 0) {
        list.innerHTML = '<li style="text-align: center; color: #999;">No hay historial a√∫n</li>';
        return;
      }

      navigationHistory.forEach(item => {
        const li = document.createElement('li');
        const date = new Date(item.timestamp);
        li.innerHTML = `
          <strong>${item.title}</strong><br>
          <small style="color: #999;">${item.url} ‚Ä¢ ${date.toLocaleString()}</small>
        `;
        li.addEventListener('click', () => {
          createNewTab(item.url);
          document.getElementById('historyModal').classList.add('hidden');
        });
        list.appendChild(li);
      });
    }

    // Verificar recompensas
    function checkRewards() {
      const now = Date.now();
      const timeSinceLastReward = now - lastRewardTime;
      const REWARD_INTERVAL = 5 * 60 * 1000; // 5 minutos

      // Resetear contador diario si pas√≥ un d√≠a
      const lastDate = new Date(lastRewardTime);
      const currentDate = new Date();
      if (lastDate.getDate() !== currentDate.getDate()) {
        dailyCredits = 0;
      }

      if (timeSinceLastReward >= REWARD_INTERVAL && dailyCredits < DAILY_LIMIT) {
        const reward = Math.min(5, DAILY_LIMIT - dailyCredits);
        balance += reward;
        dailyCredits += reward;
        lastRewardTime = now;
        localStorage.setItem('wildCredits', balance);
        localStorage.setItem('lastRewardTime', lastRewardTime);
        localStorage.setItem('dailyCredits', dailyCredits);
        updateBalance();
        showAlert(`¬°Recompensa! +${reward} WildCredits`, 'success');
      }
    }

    // Actualizar timer de recompensa
    function updateRewardTimer() {
      const now = Date.now();
      const timeSinceLastReward = now - lastRewardTime;
      const REWARD_INTERVAL = 5 * 60 * 1000; // 5 minutos
      const timeUntilNext = Math.max(0, REWARD_INTERVAL - timeSinceLastReward);

      const minutes = Math.floor(timeUntilNext / 60000);
      const seconds = Math.floor((timeUntilNext % 60000) / 1000);

      const timerEl = document.getElementById('rewardTimer');
      if (timerEl) {
        if (timeUntilNext === 0 && dailyCredits < DAILY_LIMIT) {
          timerEl.textContent = '¬°Listo! Explora un sitio para recibir recompensa';
        } else if (dailyCredits >= DAILY_LIMIT) {
          timerEl.textContent = 'L√≠mite diario alcanzado (ma√±ana se resetear√°)';
        } else {
          timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      }
    }

    // Ganar WildCredits r√°pidamente
    function quickEarnCredits() {
      const now = Date.now();
      const timeSinceLastQuickEarn = now - lastQuickEarnTime;

      if (timeSinceLastQuickEarn < QUICK_EARN_COOLDOWN) {
        const timeLeft = QUICK_EARN_COOLDOWN - timeSinceLastQuickEarn;
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        showAlert(`‚ö° Recarga en curso: ${minutes}m ${seconds}s restantes`, 'error');
        return;
      }

      // Verificar l√≠mite diario
      if (dailyCredits + QUICK_EARN_AMOUNT > DAILY_LIMIT) {
        const available = DAILY_LIMIT - dailyCredits;
        if (available <= 0) {
          showAlert('‚ö†Ô∏è L√≠mite diario de WildCredits alcanzado', 'error');
          return;
        }
        balance += available;
        dailyCredits += available;
        showAlert(`‚ú® ¬°Protocolo completado! +${available} WC (M√°ximo diario)`, 'success');
      } else {
        balance += QUICK_EARN_AMOUNT;
        dailyCredits += QUICK_EARN_AMOUNT;
        showAlert(`‚ú® ¬°Protocolo completado! +${QUICK_EARN_AMOUNT} WC`, 'success');
      }

      lastQuickEarnTime = now;
      localStorage.setItem('wildCredits', balance);
      localStorage.setItem('dailyCredits', dailyCredits);
      localStorage.setItem('lastQuickEarnTime', lastQuickEarnTime);
      updateBalance();
      updateQuickEarnButton();
    }

    // Actualizar estado del bot√≥n de ganar r√°pido
    function updateQuickEarnButton() {
      const btn = document.getElementById('quickEarnBtn');
      if (!btn) return;

      const now = Date.now();
      const timeSinceLastQuickEarn = now - lastQuickEarnTime;
      const timeLeft = Math.max(0, QUICK_EARN_COOLDOWN - timeSinceLastQuickEarn);

      if (timeLeft > 0) {
        btn.disabled = true;
        btn.style.opacity = '0.7';
        btn.style.cursor = 'not-allowed';
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        btn.innerHTML = `<i class="fas fa-history"></i> ${minutes}:${seconds.toString().padStart(2, '0')}`;
      } else {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.innerHTML = `<i class="fas fa-bolt"></i> Ganar R√°pido`;
      }
    }

    // ===== FAVORITOS =====
    function addToFavorites() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || !tab.url) {
        showAlert('No hay sitio para agregar a favoritos', 'error');
        return;
      }

      const site = sites.find(s => tab.url.includes(s.id));
      if (!site) {
        showAlert('No se puede agregar este sitio a favoritos', 'error');
        return;
      }

      const favorite = {
        id: site.id,
        name: site.name,
        url: site.url,
        timestamp: Date.now()
      };

      if (favorites.find(f => f.id === site.id)) {
        showAlert('Este sitio ya est√° en favoritos', 'error');
        return;
      }

      favorites.push(favorite);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      showAlert(`‚≠ê ${site.name} agregado a favoritos`, 'success');
    }

    function loadFavorites() {
      const list = document.getElementById('favoritesList');
      list.innerHTML = '';

      if (favorites.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">No tienes favoritos a√∫n</p>';
        return;
      }

      favorites.forEach(fav => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 1rem; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s;';
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong style="color: #667eea;">${fav.name}</strong><br>
              <small style="color: #999;">${fav.url}</small>
            </div>
            <div>
              <button onclick="openFavorite('${fav.url}'); event.stopPropagation();" style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Abrir</button>
              <button onclick="removeFavorite('${fav.id}'); event.stopPropagation();" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
            </div>
          </div>
        `;
        item.addEventListener('click', () => openFavorite(fav.url));
        list.appendChild(item);
      });
    }

    window.openFavorite = function (url) {
      loadSite(url, activeTabId);
      document.getElementById('favoritesModal').classList.add('hidden');
    };

    window.removeFavorite = function (id) {
      favorites = favorites.filter(f => f.id !== id);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      loadFavorites();
      showAlert('Favorito eliminado', 'success');
    };

    // ===== DESCARGAS =====
    async function downloadFile(fileName, fileContent, fileType = 'text/plain') {
      try {
        // Crear blob y descargar (Gratis - OceanicEthernet discontinuado)
        const blob = new Blob([fileContent], { type: fileType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Guardar en historial de descargas
        const download = {
          fileName,
          fileType,
          size: fileContent.length,
          timestamp: Date.now(),
          url: tabs.find(t => t.id === activeTabId)?.url || ''
        };
        downloads.unshift(download);
        if (downloads.length > 50) downloads = downloads.slice(0, 50);
        localStorage.setItem('downloads', JSON.stringify(downloads));

        showAlert(`‚úÖ ${fileName} descargado`, 'success');
      } catch (err) {
        console.error('Error descargando:', err);
        showAlert(err.message || 'Error al descargar', 'error');
      }
    }

    function loadDownloads() {
      const list = document.getElementById('downloadsList');
      list.innerHTML = '';

      if (downloads.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">No hay descargas</p>';
        return;
      }

      downloads.forEach(dl => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 1rem; border-bottom: 1px solid #e0e0e0;';
        const date = new Date(dl.timestamp);
        const sizeKB = (dl.size / 1024).toFixed(2);
        item.innerHTML = `
          <div>
            <strong style="color: #667eea;">${dl.fileName}</strong><br>
            <small style="color: #999;">${sizeKB} KB ‚Ä¢ ${date.toLocaleString()}</small>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // ===== ZOOM =====
    function zoomIn() {
      currentZoom = Math.min(currentZoom + 0.1, 2);
      applyZoom();
      localStorage.setItem('zoomLevel', currentZoom.toString());
    }

    function zoomOut() {
      currentZoom = Math.max(currentZoom - 0.1, 0.5);
      applyZoom();
      localStorage.setItem('zoomLevel', currentZoom.toString());
    }

    function applyZoom() {
      const viewer = document.getElementById('siteViewer');
      if (viewer) {
        viewer.style.zoom = currentZoom;
      }
    }

    // ===== B√öSQUEDA EN P√ÅGINA =====
    function searchInPage(query) {
      if (!query) {
        clearSearchHighlights();
        document.getElementById('pageSearchCount').textContent = '0/0';
        return;
      }

      clearSearchHighlights();

      const viewer = document.getElementById('siteViewer');
      const searchText = query.trim();
      const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

      // Encontrar todas las coincidencias usando Range API
      pageSearchResults = [];
      const walker = document.createTreeWalker(
        viewer,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );

      let node;
      let textOffset = 0;

      while (node = walker.nextNode()) {
        const nodeText = node.textContent;
        let match;
        const nodeRegex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

        while ((match = nodeRegex.exec(nodeText)) !== null) {
          pageSearchResults.push({
            node: node,
            startOffset: match.index,
            endOffset: match.index + match[0].length,
            textOffset: textOffset + match.index
          });
          // Evitar bucle infinito si la regex no tiene flag global
          if (!regex.global) break;
        }

        textOffset += nodeText.length;
      }

      currentSearchIndex = pageSearchResults.length > 0 ? 0 : -1;
      highlightAllResults();
      highlightCurrentResult();

      document.getElementById('pageSearchCount').textContent =
        pageSearchResults.length > 0
          ? `${currentSearchIndex + 1}/${pageSearchResults.length}`
          : '0/0';
    }

    function highlightAllResults() {
      // Resaltar todas las coincidencias en amarillo claro
      pageSearchResults.forEach((result, index) => {
        try {
          const range = document.createRange();

          // Asegurarse de que el nodo a√∫n existe y tiene el texto correcto
          if (!result.node.parentNode) return;

          const nodeText = result.node.textContent;
          if (result.startOffset >= nodeText.length || result.endOffset > nodeText.length) {
            return; // √çndices inv√°lidos
          }

          range.setStart(result.node, result.startOffset);
          range.setEnd(result.node, result.endOffset);

          // Verificar que el contenido del rango coincide con la b√∫squeda
          const rangeText = range.toString();
          const searchText = document.getElementById('pageSearchInput').value.trim();
          if (!rangeText.toLowerCase().includes(searchText.toLowerCase())) {
            return; // No coincide, saltar
          }

          const span = document.createElement('span');
          span.className = 'search-highlight';
          span.setAttribute('data-search-index', index);
          span.style.cssText = 'background: rgba(255, 255, 0, 0.3); padding: 2px 0;';

          // Intentar usar surroundContents primero
          try {
            range.surroundContents(span);
          } catch (e) {
            // Si falla, usar m√©todo alternativo
            const contents = range.extractContents();
            span.appendChild(contents);
            range.insertNode(span);
          }
        } catch (e) {
          console.warn('No se pudo resaltar resultado:', e);
        }
      });
    }

    function highlightCurrentResult() {
      if (currentSearchIndex < 0 || currentSearchIndex >= pageSearchResults.length) return;

      const result = pageSearchResults[currentSearchIndex];
      const currentHighlight = document.querySelector(`span[data-search-index="${currentSearchIndex}"]`);

      if (currentHighlight) {
        // Resaltar el resultado actual en amarillo brillante
        currentHighlight.style.cssText = 'background: yellow; padding: 2px 0; font-weight: bold;';
        currentHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function clearSearchHighlights() {
      const viewer = document.getElementById('siteViewer');
      const highlights = viewer.querySelectorAll('.search-highlight');

      highlights.forEach(span => {
        const parent = span.parentNode;
        if (parent) {
          // Reemplazar el span con su contenido de texto
          const textNode = document.createTextNode(span.textContent);
          parent.replaceChild(textNode, span);
          parent.normalize();
        }
      });

      pageSearchResults = [];
      currentSearchIndex = -1;
    }

    // ===== COMPARTIR SITIO =====
    async function showShareOptions() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || !tab.url) {
        document.getElementById('shareContent').innerHTML = '<p>No hay sitio para compartir</p>';
        return;
      }

      const site = sites.find(s => tab.url.includes(s.id));
      const shareUrl = tab.url;
      const shareTitle = site ? site.name : 'Sitio de Wild Explorer';

      const opToken = localStorage.getItem('opToken');
      const opUser = JSON.parse(localStorage.getItem('opUser') || 'null');

      if (!opToken || !opUser || !opUser.id) {
        document.getElementById('shareContent').innerHTML = `
          <p>Debes vincular Ocean Pay para compartir sitios</p>
          <button onclick="loadSite('oceanandwildstudios.com/ocean-pay-link', activeTabId); document.getElementById('shareModal').classList.add('hidden');" style="padding: 0.7rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Vincular Ocean Pay</button>
        `;
        return;
      }

      document.getElementById('shareContent').innerHTML = `
        <div style="margin-bottom: 1rem;">
          <p><strong>Sitio:</strong> ${shareTitle}</p>
          <p><strong>URL:</strong> ${shareUrl}</p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button onclick="shareViaCopy('${shareUrl}', '${shareTitle}')" style="padding: 0.7rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">üìã Copiar enlace</button>
          <button onclick="shareViaWildNetwork('${shareUrl}', '${shareTitle}')" style="padding: 0.7rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">üåê Compartir en Wild Network</button>
        </div>
      `;
    }

    window.shareViaCopy = function (url, title) {
      navigator.clipboard.writeText(`${title} - ${url}`).then(() => {
        showAlert('‚úÖ Enlace copiado al portapapeles', 'success');
      }).catch(() => {
        showAlert('Error al copiar', 'error');
      });
    };

    window.shareViaWildNetwork = async function (url, title) {
      const opToken = localStorage.getItem('opToken');
      const opUser = JSON.parse(localStorage.getItem('opUser') || 'null');

      if (!opToken || !opUser || !opUser.id) {
        showAlert('Debes vincular Ocean Pay para compartir', 'error');
        return;
      }

      try {
        // Compartir gratis (OceanicEthernet discontinuado)
        showAlert(`‚úÖ Sitio compartido en Wild Network`, 'success');
        document.getElementById('shareModal').classList.add('hidden');
      } catch (err) {
        showAlert(err.message || 'Error al compartir', 'error');
      }
    };

    // ===== INFORMACI√ìN DEL SITIO =====
    async function showSiteInfo() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || !tab.url) {
        document.getElementById('siteInfoContent').innerHTML = '<p>No hay sitio cargado</p>';
        return;
      }

      const site = sites.find(s => tab.url.includes(s.id));
      if (!site) {
        document.getElementById('siteInfoContent').innerHTML = '<p>Informaci√≥n no disponible</p>';
        return;
      }

      const visitCount = navigationHistory.filter(h => h.url.includes(site.id)).length;
      const isFavorite = favorites.find(f => f.id === site.id);

      document.getElementById('siteInfoContent').innerHTML = `
        <div style="line-height: 1.8;">
          <p><strong>Nombre:</strong> ${site.name}</p>
          <p><strong>URL:</strong> ${site.url}</p>
          <p><strong>Estado:</strong> ${site.default ? '‚úÖ Disponible' : unlockedSites.includes(site.id) ? 'üîì Desbloqueado' : 'üîí Bloqueado'}</p>
          <p><strong>Costo de desbloqueo:</strong> ${site.cost} WildCredits</p>
          <p><strong>Visitas:</strong> ${visitCount}</p>
          <p><strong>En favoritos:</strong> ${isFavorite ? '‚≠ê S√≠' : 'No'}</p>
          <p><strong>Seguridad:</strong> ‚úÖ Sitio verificado de Ocean and Wild Studios</p>
          <p><strong>√öltima visita:</strong> ${tab.url === site.url ? 'Ahora' : 'Nunca'}</p>
          <hr style="margin: 1rem 0;">
          <button onclick="addToFavorites(); document.getElementById('siteInfoModal').classList.add('hidden');" style="padding: 0.7rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 0.5rem;">‚≠ê Agregar a favoritos</button>
          <button onclick="downloadFile('${site.name}-info.txt', 'Informaci√≥n de ${site.name}\\nURL: ${site.url}\\nEstado: ${site.default ? 'Disponible' : unlockedSites.includes(site.id) ? 'Desbloqueado' : 'Bloqueado'}\\nVisitas: ${visitCount}');" style="padding: 0.7rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">üì• Descargar info</button>
        </div>
      `;
    }
  </script>
</body>

</html>