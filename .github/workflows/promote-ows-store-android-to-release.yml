name: Promote OWS Store Android Artifact To Release

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: "GitHub Actions run ID con artifact Android"
        required: true
      artifact_name:
        description: "Artifact name (preferido)"
        required: false
        default: "ows-store-apk-release-signed"
      artifact_id:
        description: "Artifact ID numerico (opcional)"
        required: false
        default: ""
      allow_non_production_artifacts:
        description: "Permitir debug/unsigned (true/false)"
        required: false
        default: "false"
      release_tag:
        description: "Tag destino del release"
        required: true
      release_name:
        description: "Nombre del release"
        required: true
      release_notes:
        description: "Notas/changelog"
        required: false
        default: ""
      prerelease:
        description: "Publicar como prerelease (true/false)"
        required: false
        default: "false"

permissions:
  contents: write
  actions: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          if [ -z "${{ inputs.artifact_name }}" ] && [ -z "${{ inputs.artifact_id }}" ]; then
            echo "Debes indicar artifact_name o artifact_id."
            exit 1
          fi

      - name: Resolve release token
        shell: bash
        env:
          RELEASE_PAT: ${{ secrets.RELEASE_PAT }}
          GH_TOKEN_DEFAULT: ${{ github.token }}
        run: |
          TOKEN="$RELEASE_PAT"
          if [ -z "$TOKEN" ]; then
            TOKEN="$GH_TOKEN_DEFAULT"
          fi
          echo "RELEASE_TOKEN=$TOKEN" >> "$GITHUB_ENV"

      - name: Download artifact by ID
        if: ${{ inputs.artifact_id != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          artifact-ids: ${{ inputs.artifact_id }}
          path: promoted-android

      - name: Download artifact by name
        if: ${{ inputs.artifact_id == '' && inputs.artifact_name != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          name: ${{ inputs.artifact_name }}
          path: promoted-android

      - name: Validate downloaded files
        shell: bash
        run: |
          if [ ! -d promoted-android ]; then
            echo "No existe carpeta promoted-android"
            exit 1
          fi
          COUNT="$(find promoted-android -type f | wc -l | tr -d ' ')"
          if [ "$COUNT" = "0" ]; then
            echo "No se descargaron archivos."
            exit 1
          fi
          echo "Archivos descargados:"
          find promoted-android -type f -maxdepth 6 -print

      - name: Sanitize promoted files
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ inputs.allow_non_production_artifacts }}" != "true" ]; then
            find promoted-android -type f \( -iname "*unsigned*.apk" -o -iname "*debug*.apk" \) -print -delete || true
          fi
          echo "Archivos finales:"
          find promoted-android -type f -maxdepth 6 -print

      - name: Publish to owsdatabase release
        uses: softprops/action-gh-release@v2
        with:
          repository: OceanandWild/owsdatabase
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          body: ${{ inputs.release_notes }}
          draft: false
          prerelease: ${{ inputs.prerelease == 'true' }}
          make_latest: false
          files: |
            promoted-android/**/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ env.RELEASE_TOKEN }}

      - name: Sync Android metadata to OWS API
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          APK_FILE="$(find promoted-android -type f -name '*.apk' | grep -Evi 'unsigned' | head -n1 || true)"
          if [ -z "$APK_FILE" ]; then
            echo "No se encontro APK para sincronizar metadata."
            exit 0
          fi

          META_FILE="$(find promoted-android -type f -name 'android-release-metadata.json' | head -n1 || true)"
          PROJECT_SLUG="ows-store"
          PACKAGE_ID="com.oceanandwild.owsstore"
          VERSION_NAME="${{ inputs.release_tag }}"
          VERSION_CODE="0"

          if [ -n "$META_FILE" ]; then
            mapfile -t FIELDS < <(python - "$META_FILE" <<'PY'
import json,sys
data=json.load(open(sys.argv[1],'r',encoding='utf-8'))
print(data.get('project_slug',''))
print(data.get('package_id',''))
print(data.get('version_name',''))
print(data.get('version_code',''))
PY
            )
            [ -n "${FIELDS[0]:-}" ] && PROJECT_SLUG="${FIELDS[0]}"
            [ -n "${FIELDS[1]:-}" ] && PACKAGE_ID="${FIELDS[1]}"
            [ -n "${FIELDS[2]:-}" ] && VERSION_NAME="${FIELDS[2]}"
            [ -n "${FIELDS[3]:-}" ] && VERSION_CODE="${FIELDS[3]}"
          fi

          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            VERSION_CODE="0"
          fi

          APK_NAME="$(basename "$APK_FILE")"
          APK_URL="https://github.com/OceanandWild/owsdatabase/releases/download/${{ inputs.release_tag }}/${APK_NAME}"
          SIZE_BYTES="$(stat -c%s "$APK_FILE" 2>/dev/null || wc -c < "$APK_FILE")"
          SHA256="$(sha256sum "$APK_FILE" | awk '{print $1}')"
          PUBLISHED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          PAYLOAD="$(python - <<PY
import json
print(json.dumps({
  "project_slug": "${PROJECT_SLUG}",
  "package_id": "${PACKAGE_ID}",
  "version_name": "${VERSION_NAME}",
  "version_code": int("${VERSION_CODE}" or 0),
  "apk_url": "${APK_URL}",
  "sha256": "${SHA256}",
  "size_bytes": int("${SIZE_BYTES}" or 0),
  "release_notes": """${{ inputs.release_notes }}""".strip(),
  "status": "published",
  "is_mandatory": False,
  "published_at": "${PUBLISHED_AT}"
}))
PY
          )"

          curl -fsS -X POST "https://owsdatabase.onrender.com/ows-store/android/releases" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD"
