<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://owsdatabase.onrender.com/socket.io/socket.io.js"></script>
  <title>Ecoxion — Prototipo</title>
  <style>
    /* =========================
       THEME BASE — ESPACIO
       ========================= */
    :root {
      --bg-0: #05070a;
      --bg-1: #0a0e14;
      --bg-2: #0f1520;
      --bg-card: rgba(15, 21, 32, 0.7);
      --ink-0: #ffffff;
      --ink-1: #94a3b8;
      --accent: #00a8ff;
      --accent-glow: rgba(0, 168, 255, 0.5);
      --accent-2: #00ff88;
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ring: rgba(0, 168, 255, 0.1);
      --br: 16px;
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      --glass: backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      --glass-bg: rgba(15, 21, 32, 0.7);
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* 🌑 Dark Mode (Midnight/OLED) */
    body.dark-theme {
      --bg-0: #000000;
      --bg-1: #050505;
      --bg-2: #0a0a0a;
      --bg-card: rgba(0, 0, 0, 0.85);
      --glass-bg: rgba(0, 0, 0, 0.85);
      --ink-0: #ffffff;
      --ink-1: #a0a0a0;
      --accent: #00d2ff;
      --accent-2: #00ffaa;
      --ring: rgba(255, 255, 255, 0.05);
    }

    /* 🌌 Tema Espacial (Default Overrides if needed) */
    body.theme-espacial {
      --accent: #00a8ff;
      --accent-2: #00ffb3;
    }

    /* 🌿 Tema Naturaleza (Rediseñado para ser menos "verdoso") */
    body.theme-naturaleza {
      --bg-0: #050a05;
      --bg-1: #0a140a;
      --bg-2: #0f1a0f;
      --accent: #2ecc71;
      --accent-2: #a2f2b3;
      --ring: rgba(46, 204, 113, 0.1);
    }

    body.dark-theme.theme-naturaleza {
      --bg-0: #020502;
      --bg-1: #040804;
      --bg-2: #060c06;
      --accent: #27ae60;
    }

    /* 🏝️ Tema Tropical */
    body.theme-tropical {
      --bg-0: #0a0705;
      --bg-1: #1a120d;
      --bg-2: #261a14;
      --accent: #f39c12;
      --accent-2: #e67e22;
      --ring: rgba(243, 156, 18, 0.1);
    }

    body.dark-theme.theme-tropical {
      --bg-0: #050302;
      --bg-1: #0d0907;
      --bg-2: #140d0a;
      --accent: #d35400;
    }

    html,
    body {
      height: 100%;
      background: var(--bg-0);
      color: var(--ink-0);
      font: 14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Inter, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
    }

    /* Estrellas sutiles */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, #ffffff22 99%, transparent),
        radial-gradient(1px 1px at 70% 40%, #ffffff18 99%, transparent),
        radial-gradient(1px 1px at 30% 80%, #ffffff1c 99%, transparent),
        radial-gradient(1px 1px at 85% 70%, #ffffff14 99%, transparent);
      pointer-events: none;
    }

    /* ===== ZEN LAYOUT ===== */
    body.zen-layout {
      --sidebar-w: 260px;
      overflow-x: hidden;
    }

    /* =========================
   EFECTOS V2 - DESPERTAR
   ========================= */
    .awaken-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, rgba(100, 167, 255, 0.3) 0%, rgba(0, 0, 0, 0.95) 100%);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
    }

    .awaken-overlay.active {
      pointer-events: all;
      animation: awakenFadeIn 0.5s ease-out forwards;
    }

    @keyframes awakenFadeIn {
      to {
        opacity: 1;
      }
    }

    .awaken-container {
      position: relative;
      width: 400px;
      max-width: 90vw;
      text-align: center;
      transform: scale(0.8);
      opacity: 0;
    }

    .awaken-overlay.active .awaken-container {
      animation: awakenPopIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes awakenPopIn {
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .awaken-icon {
      font-size: 120px;
      position: relative;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 30px rgba(100, 167, 255, 0.8));
      animation: awakenPulse 2s ease-in-out infinite;
    }

    @keyframes awakenPulse {

      0%,
      100% {
        transform: scale(1) rotate(0deg);
        filter: drop-shadow(0 0 30px rgba(100, 167, 255, 0.8));
      }

      50% {
        transform: scale(1.1) rotate(5deg);
        filter: drop-shadow(0 0 50px rgba(179, 136, 255, 1));
      }
    }

    .awaken-title {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, #64a7ff, #b388ff, #64a7ff);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: awakenGradient 3s ease infinite;
      margin-bottom: 12px;
      text-shadow: 0 0 30px rgba(100, 167, 255, 0.5);
    }

    @keyframes awakenGradient {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    .awaken-subtitle {
      font-size: 18px;
      color: var(--ink-1);
      margin-bottom: 30px;
      opacity: 0.9;
    }

    .awaken-features {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 24px 0;
    }

    .awaken-feature {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(100, 167, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(100, 167, 255, 0.3);
      text-align: left;
      animation: awakenSlideIn 0.6s ease-out backwards;
    }

    .awaken-feature:nth-child(1) {
      animation-delay: 0.2s;
    }

    .awaken-feature:nth-child(2) {
      animation-delay: 0.3s;
    }

    .awaken-feature:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes awakenSlideIn {
      from {
        transform: translateX(-50px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .awaken-particles {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: radial-gradient(circle, #64a7ff, transparent);
      border-radius: 50%;
      animation: particleFloat 4s ease-in-out infinite;
    }

    @keyframes particleFloat {

      0%,
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        transform: translate(var(--tx), var(--ty)) scale(0);
        opacity: 0;
      }
    }

    .awaken-rings {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .awaken-ring {
      position: absolute;
      width: 300px;
      height: 300px;
      border: 2px solid;
      border-radius: 50%;
      opacity: 0;
      animation: awakenRingExpand 2s ease-out infinite;
    }

    .awaken-ring:nth-child(1) {
      border-color: rgba(100, 167, 255, 0.5);
      animation-delay: 0s;
    }

    .awaken-ring:nth-child(2) {
      border-color: rgba(179, 136, 255, 0.5);
      animation-delay: 0.4s;
    }

    .awaken-ring:nth-child(3) {
      border-color: rgba(100, 167, 255, 0.3);
      animation-delay: 0.8s;
    }

    @keyframes awakenRingExpand {
      0% {
        transform: scale(0.5);
        opacity: 1;
      }

      100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    .v2-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: linear-gradient(135deg, rgba(100, 167, 255, 0.2), rgba(179, 136, 255, 0.2));
      border: 1px solid var(--accent);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .v2-badge::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: badgeShine 2s ease-in-out infinite;
    }

    @keyframes badgeShine {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .extension-v2-available {
      position: relative;
      overflow: visible;
    }

    .extension-v2-available::after {
      content: '✨';
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 20px;
      animation: v2Sparkle 1.5s ease-in-out infinite;
      filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
    }

    @keyframes v2Sparkle {

      0%,
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }

      50% {
        transform: scale(1.3) rotate(180deg);
        opacity: 0.7;
      }
    }

    .awaken-button {
      margin-top: 24px;
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #64a7ff, #b388ff);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(100, 167, 255, 0.4);
    }

    .awaken-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(100, 167, 255, 0.6);
    }

    .awaken-button:active {
      transform: translateY(0);
    }

    .awaken-button::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .awaken-button:hover::before {
      transform: translateX(100%);
    }

    /* =========================
   MODAL DE MISIONES
   ========================= */
    .missions-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .missions-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .missions-container {
      background: linear-gradient(135deg, var(--bg-2), var(--bg-1));
      border: 2px solid var(--accent);
      border-radius: 20px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(100, 167, 255, 0.3);
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
    }

    .missions-modal.active .missions-container {
      transform: scale(1) translateY(0);
    }

    .missions-header {
      text-align: center;
      margin-bottom: 28px;
      position: relative;
    }

    .missions-header::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      border-radius: 2px;
    }

    .missions-title {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, #64a7ff, #b388ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .missions-subtitle {
      color: var(--ink-1);
      font-size: 14px;
    }

    .mission-item {
      background: var(--bg-1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mission-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .mission-item.completed {
      border-color: var(--ok);
      background: rgba(55, 214, 122, 0.1);
    }

    .mission-item.completed::before {
      transform: scaleY(1);
      background: var(--ok);
    }

    .mission-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .mission-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--ink-0);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mission-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .mission-item.completed .mission-checkbox {
      background: var(--ok);
      border-color: var(--ok);
    }

    .mission-checkbox::before {
      content: '✓';
      color: white;
      font-size: 16px;
      font-weight: bold;
      opacity: 0;
      transform: scale(0);
      transition: all 0.2s ease;
    }

    .mission-item.completed .mission-checkbox::before {
      opacity: 1;
      transform: scale(1);
    }

    .mission-description {
      color: var(--ink-1);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .mission-progress {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .mission-progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .mission-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 3px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }

    .mission-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: progressShine 2s ease-in-out infinite;
    }

    @keyframes progressShine {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .mission-progress-text {
      font-size: 12px;
      color: var(--ink-1);
      font-weight: 600;
      min-width: 60px;
      text-align: right;
    }

    .missions-footer {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .missions-progress-overall {
      margin-bottom: 20px;
    }

    .missions-progress-text {
      color: var(--ink-1);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .missions-progress-bar-overall {
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .missions-progress-fill-overall {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .awaken-button-fragmented {
      position: relative;
      overflow: visible;
      margin-top: 20px;
      padding: 16px 40px;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #64a7ff, #b388ff);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }

    .awaken-button-fragmented.active {
      opacity: 1;
      transform: scale(1);
    }

    .awaken-button-fragmented::before,
    .awaken-button-fragmented::after {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 12px;
      padding: 2px;
      background: linear-gradient(135deg, #64a7ff, #b388ff, #b388ff, #64a7ff);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      animation: fragmentBorder 3s ease-in-out infinite;
    }

    @keyframes fragmentBorder {

      0%,
      100% {
        opacity: 0;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    .awaken-button-fragmented:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 30px rgba(100, 167, 255, 0.6);
    }

    .awaken-button-fragmented:hover::before,
    .awaken-button-fragmented:hover::after {
      animation-duration: 0.8s;
      opacity: 1;
    }

    .awaken-button-fragmented:active {
      transform: scale(0.98);
    }

    .awaken-button-fragment {
      position: absolute;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #64a7ff, #b388ff);
      border-radius: 4px;
      opacity: 0;
      pointer-events: none;
    }

    /* =========================
   AGUJERO ARCOÍRIS (PENTÁGONO)
   ========================= */
    .rainbow-portal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 0;
      height: 0;
      z-index: 10001;
      pointer-events: none;
    }

    .rainbow-portal.active {
      width: 300px;
      height: 300px;
      animation: portalExpand 1.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes portalExpand {
      to {
        width: 400px;
        height: 400px;
      }
    }

    .portal-pentagon {
      width: 100%;
      height: 100%;
      position: relative;
      clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
      background: linear-gradient(135deg,
          #ff0000 0%,
          #ff7f00 20%,
          #ffff00 40%,
          #00ff00 60%,
          #0000ff 80%,
          #4b0082 100%);
      animation: portalRotate 2s linear infinite;
    }

    @keyframes portalRotate {
      to {
        transform: rotate(360deg);
      }
    }

    .portal-absorption {
      position: fixed;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 10000;
    }

    .absorption-beam {
      position: absolute;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
      animation: absorb 1s ease-out forwards;
    }

    .absorption-beam.top {
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 8px;
      height: 50vh;
    }

    .absorption-beam.left {
      top: 50%;
      left: 0;
      transform: translateY(-50%) rotate(-90deg);
      width: 8px;
      height: 50vw;
    }

    .absorption-beam.right {
      top: 50%;
      right: 0;
      transform: translateY(-50%) rotate(90deg);
      width: 8px;
      height: 50vw;
    }

    .absorption-beam.top-left {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(35deg);
      width: 8px;
      height: 70vh;
      transform-origin: center center;
    }

    .absorption-beam.top-right {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-35deg);
      width: 8px;
      height: 70vh;
      transform-origin: center center;
    }

    @keyframes absorb {
      0% {
        opacity: 0;
        transform: scaleY(1);
      }

      50% {
        opacity: 1;
        transform: scaleY(0.3);
      }

      100% {
        opacity: 0;
        transform: scaleY(0) translateY(0);
      }
    }

    .explosion-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, rgba(255, 215, 0, 0) 70%);
      z-index: 10002;
      opacity: 0;
      pointer-events: none;
      animation: explosionFlash 1s ease-out forwards;
    }

    @keyframes explosionFlash {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }

      50% {
        opacity: 1;
        transform: scale(1.2);
      }

      100% {
        opacity: 0;
        transform: scale(1.5);
      }
    }

    .awakened-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10003;
      text-align: center;
      opacity: 0;
      pointer-events: none;
    }

    .awakened-message.active {
      animation: messageAppear 1s ease-out 0.5s forwards;
    }

    .awakened-message h2 {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, #ffd700, #ffaa00, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
      margin-bottom: 16px;
    }

    .awakened-message p {
      font-size: 24px;
      color: var(--ink-0);
      font-weight: 600;
    }

    @keyframes messageAppear {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }

      100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    body.zen-layout #appContainer {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      gap: 0;
      padding: 0;
      margin: 0;
      max-width: 100%;
    }

    body.zen-layout #content {
      flex: 1;
      padding: 32px 24px;
      margin-left: 0;
      max-width: calc(100vw - var(--sidebar-w) - 48px);
      width: 100%;
    }

    /* Barra lateral izquierda */
    body.zen-layout .zen-sidebar {
      width: var(--sidebar-w);
      min-width: var(--sidebar-w);
      background: linear-gradient(180deg, rgba(15, 20, 35, 0.98), rgba(11, 15, 24, 0.95));
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-right: 2px solid rgba(100, 167, 255, 0.15);
      display: flex;
      flex-direction: column;
      padding: 0;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 100;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.4), inset -1px 0 0 rgba(255, 255, 255, 0.05);
      transition: width 0.3s ease, transform 0.3s ease;
      animation: slideInLeft 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    @keyframes slideInLeft {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    body.zen-layout .zen-sidebar::-webkit-scrollbar {
      width: 6px;
    }

    body.zen-layout .zen-sidebar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
    }

    body.zen-layout .zen-sidebar::-webkit-scrollbar-thumb {
      background: rgba(100, 167, 255, 0.3);
      border-radius: 3px;
    }

    body.zen-layout .zen-sidebar::-webkit-scrollbar-thumb:hover {
      background: rgba(100, 167, 255, 0.5);
    }

    /* ===== TABS NORMALES - REDISEÑO MODERNO ===== */
    body:not(.zen-layout) .tabs {
      display: flex;
      gap: 6px;
      padding: 12px 0 16px;
      flex-wrap: wrap;
      position: relative;
    }

    body:not(.zen-layout) .tab-btn {
      border: 2px solid transparent;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.6));
      color: var(--ink-1);
      padding: 14px 24px;
      border-radius: 16px;
      cursor: pointer;
      transition: all .4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
      font-size: 14px;
      font-weight: 600;
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      letter-spacing: 0.3px;
    }

    body:not(.zen-layout) .tab-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(100, 167, 255, 0.15), rgba(179, 136, 255, 0.15));
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: 16px;
    }

    body:not(.zen-layout) .tab-btn::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 80%;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), transparent);
      border-radius: 2px 2px 0 0;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 0 12px rgba(100, 167, 255, 0.6);
    }

    body:not(.zen-layout) .tab-btn:hover::before {
      opacity: 1;
    }

    body:not(.zen-layout) .tab-btn:hover {
      transform: translateY(-4px) scale(1.02);
      border-color: rgba(100, 167, 255, 0.3);
      box-shadow: 0 8px 24px rgba(100, 167, 255, 0.25), 0 0 0 1px rgba(100, 167, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      color: var(--ink-0);
    }

    body:not(.zen-layout) .tab-btn:hover::after {
      transform: translateX(-50%) scaleX(0.5);
    }

    body:not(.zen-layout) .tab-btn[aria-selected="true"] {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(100, 167, 255, 0.2), 0 8px 32px rgba(100, 167, 255, .4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
      background: linear-gradient(135deg, rgba(100, 167, 255, 0.25), rgba(179, 136, 255, 0.2));
      font-weight: 800;
      color: var(--accent);
      transform: translateY(-2px) scale(1.05);
      text-shadow: 0 0 20px rgba(100, 167, 255, 0.5);
    }

    body:not(.zen-layout) .tab-btn[aria-selected="true"]::before {
      opacity: 1;
      animation: tabPulse 3s ease-in-out infinite;
    }

    body:not(.zen-layout) .tab-btn[aria-selected="true"]::after {
      transform: translateX(-50%) scaleX(1);
      animation: tabGlow 2s ease-in-out infinite;
    }

    @keyframes tabPulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    @keyframes tabGlow {

      0%,
      100% {
        box-shadow: 0 0 12px rgba(100, 167, 255, 0.6);
      }

      50% {
        box-shadow: 0 0 20px rgba(100, 167, 255, 0.9), 0 0 40px rgba(179, 136, 255, 0.5);
      }
    }

    /* ===== TABS ZEN – VERTICALES REDISEÑADOS ===== */
    body.zen-layout .tabs {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px 12px;
      margin: 0;
      flex: 1;
    }

    body.zen-layout .tab-btn {
      width: 100%;
      text-align: left;
      padding: 16px 18px;
      border-radius: 14px;
      border: 2px solid transparent;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 59, 0.4));
      color: var(--ink-1);
      font-size: 14px;
      font-weight: 600;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.03);
      letter-spacing: 0.3px;
    }

    body.zen-layout .tab-btn::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%) scaleY(0);
      width: 5px;
      height: 0;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      border-radius: 0 6px 6px 0;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      opacity: 0;
      box-shadow: 0 0 16px rgba(100, 167, 255, 0.8);
    }

    body.zen-layout .tab-btn:hover {
      background: linear-gradient(135deg, rgba(100, 167, 255, 0.12), rgba(179, 136, 255, 0.08));
      color: var(--ink-0);
      transform: translateX(6px) scale(1.02);
      border-color: rgba(100, 167, 255, 0.3);
      box-shadow: 0 4px 16px rgba(100, 167, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    body.zen-layout .tab-btn:hover::before {
      opacity: 1;
      height: 65%;
      transform: translateY(-50%) scaleY(1);
    }

    body.zen-layout .tab-btn[aria-selected="true"] {
      background: linear-gradient(135deg, rgba(100, 167, 255, 0.25), rgba(179, 136, 255, 0.2));
      color: var(--accent);
      font-weight: 800;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(100, 167, 255, 0.2), 0 6px 24px rgba(100, 167, 255, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.15);
      transform: translateX(4px) scale(1.03);
      text-shadow: 0 0 16px rgba(100, 167, 255, 0.6);
    }

    body.zen-layout .tab-btn[aria-selected="true"]::before {
      opacity: 1;
      height: 75%;
      transform: translateY(-50%) scaleY(1);
      animation: zenTabGlow 2s ease-in-out infinite;
    }

    @keyframes zenTabGlow {

      0%,
      100% {
        box-shadow: 0 0 16px rgba(100, 167, 255, 0.8);
      }

      50% {
        box-shadow: 0 0 24px rgba(100, 167, 255, 1), 0 0 40px rgba(179, 136, 255, 0.6);
      }
    }

    body.zen-layout .tab-btn [data-icon] {
      font-size: 22px;
      line-height: 1;
      min-width: 26px;
      text-align: center;
      filter: drop-shadow(0 0 6px rgba(100, 167, 255, 0.4));
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: inline-block;
    }

    body.zen-layout .tab-btn:hover [data-icon] {
      filter: drop-shadow(0 0 10px rgba(100, 167, 255, 0.6));
      transform: scale(1.08) rotate(-5deg);
    }

    body.zen-layout .tab-btn[aria-selected="true"] [data-icon] {
      filter: drop-shadow(0 0 12px rgba(100, 167, 255, 1)) drop-shadow(0 0 20px rgba(179, 136, 255, 0.6));
      transform: scale(1.15);
      animation: iconBounce 2s ease-in-out infinite;
    }

    @keyframes iconBounce {

      0%,
      100% {
        transform: scale(1.15) translateY(0);
      }

      50% {
        transform: scale(1.2) translateY(-2px);
      }
    }

    body.zen-layout .tab-btn::after {
      content: '';
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%) translateX(-10px) scale(0);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: radial-gradient(circle, var(--accent), var(--accent-2));
      opacity: 0;
      box-shadow: 0 0 12px rgba(100, 167, 255, 0.8);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body.zen-layout .tab-btn[aria-selected="true"]::after {
      opacity: 1;
      transform: translateY(-50%) translateX(0) scale(1);
      animation: dotPulse 2s ease-in-out infinite;
    }

    @keyframes dotPulse {

      0%,
      100% {
        transform: translateY(-50%) translateX(0) scale(1);
        box-shadow: 0 0 12px rgba(100, 167, 255, 0.8);
      }

      50% {
        transform: translateY(-50%) translateX(0) scale(1.2);
        box-shadow: 0 0 20px rgba(100, 167, 255, 1), 0 0 30px rgba(179, 136, 255, 0.6);
      }
    }

    /* Logo Rediseñado */
    .logo-container {
      position: relative;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-ring {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, var(--accent), var(--accent-2), #67e8f9, var(--accent));
      animation: logoSpin 8s linear infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(100, 167, 255, .6), 0 0 60px rgba(100, 167, 255, .3), inset 0 2px 4px rgba(255, 255, 255, .2);
      position: relative;
      border: 3px solid rgba(100, 167, 255, 0.4);
      padding: 3px;
    }

    .logo-ring::before {
      content: '';
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      background: conic-gradient(from 180deg, var(--accent-2), #67e8f9, var(--accent), var(--accent-2));
      opacity: 0.4;
      filter: blur(12px);
      z-index: -1;
      animation: logoSpin 10s linear infinite reverse;
    }

    .logo-ring::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: conic-gradient(from 90deg, transparent, var(--accent), transparent);
      opacity: 0.6;
      animation: logoSpin 6s linear infinite;
    }

    .logo-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      position: relative;
      z-index: 1;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, .3), 0 4px 12px rgba(100, 167, 255, .4);
      border: 2px solid rgba(100, 167, 255, 0.3);
      animation: logoFloat 3s ease-in-out infinite;
    }

    @keyframes logoSpin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes logoFloat {

      0%,
      100% {
        transform: translateY(0) scale(1);
        filter: drop-shadow(0 0 8px rgba(100, 167, 255, .6));
      }

      50% {
        transform: translateY(-3px) scale(1.05);
        filter: drop-shadow(0 0 16px rgba(100, 167, 255, .9));
      }
    }

    .logo-core {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), var(--bg-0));
      box-shadow: inset 0 0 8px rgba(0, 0, 0, .8), 0 3px 10px rgba(100, 167, 255, .4);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .brand-title {
      font-size: 32px;
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: linear-gradient(135deg, #67e8f9 0%, var(--accent) 25%, var(--accent-2) 50%, var(--accent) 75%, #67e8f9 100%);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: titleGradientFlow 6s ease infinite;
      position: relative;
      filter: drop-shadow(0 0 20px rgba(100, 167, 255, .5));
      margin: 0;
      line-height: 1;
    }

    @keyframes titleGradientFlow {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    .brand-title::before {
      content: 'ECOXION';
      position: absolute;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      opacity: 0.3;
      filter: blur(8px);
      animation: titleGlow 3s ease-in-out infinite;
    }

    @keyframes titleGlow {

      0%,
      100% {
        opacity: 0.3;
        transform: scale(1);
      }

      50% {
        opacity: 0.6;
        transform: scale(1.02);
      }
    }

    .brand-title::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 120%;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), var(--accent), transparent);
      border-radius: 2px;
      opacity: 0.7;
      animation: titleUnderlineFlow 3s ease-in-out infinite;
      box-shadow: 0 0 12px rgba(100, 167, 255, .6);
    }

    @keyframes titleUnderlineFlow {

      0%,
      100% {
        transform: translateX(-50%) scaleX(0.8);
        opacity: 0.5;
        box-shadow: 0 0 12px rgba(100, 167, 255, .6);
      }

      50% {
        transform: translateX(-50%) scaleX(1);
        opacity: 0.9;
        box-shadow: 0 0 20px rgba(100, 167, 255, .9), 0 0 40px rgba(179, 136, 255, .5);
      }
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 12px 0;
      position: relative;
    }

    .brand::before {
      content: '';
      position: absolute;
      inset: -8px;
      background: radial-gradient(circle at 20% 50%, rgba(100, 167, 255, .08), transparent 70%);
      border-radius: 20px;
      pointer-events: none;
      animation: brandGlow 4s ease-in-out infinite;
    }

    @keyframes brandGlow {

      0%,
      100% {
        opacity: 0.5;
      }

      50% {
        opacity: 1;
      }
    }

    @keyframes statusPulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
        box-shadow: 0 0 8px var(--ok);
      }

      50% {
        transform: scale(1.2);
        opacity: 0.8;
        box-shadow: 0 0 16px var(--ok), 0 0 24px rgba(16, 185, 129, 0.5);
      }
    }

    .brand-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--ink-0);
      opacity: 0.9;
      font-weight: 600;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      margin-top: 2px;
      text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
      transition: all 0.3s ease;
    }

    .brand-subtitle:hover {
      opacity: 1;
      text-shadow: 0 0 16px rgba(16, 185, 129, 0.5);
    }

    /* Layout */
    #appContainer {
      max-width: 1100px;
      margin: 32px auto;
      padding: 0 16px 48px;
    }

    header.appbar {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(15, 20, 35, 0.95), rgba(15, 20, 35, 0.85));
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      z-index: 100;
      margin-bottom: 24px;
      border-bottom: 2px solid rgba(100, 167, 255, 0.2);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      padding: 0 16px;
      border-radius: 0 0 16px 16px;
    }

    #content {
      display: block;
    }

    /* Tarjetas */
    .card {
      background: var(--bg-2);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: var(--br);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    /* ====== NORMAL MODE REWORK (NO ZEN) ====== */
    body:not(.zen-layout) #appContainer {
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 12px 18px 42px;
    }

    body:not(.zen-layout) #content {
      display: block;
      width: 100%;
      margin: 0;
      max-width: none;
      padding: 0;
    }

    body:not(.zen-layout) .card {
      border-radius: 20px;
      border: 1px solid rgba(100, 167, 255, 0.2);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.045), rgba(255, 255, 255, 0.015)),
        linear-gradient(180deg, rgba(7, 13, 28, 0.94), rgba(6, 10, 22, 0.9));
      box-shadow:
        0 18px 36px rgba(0, 0, 0, 0.28),
        inset 0 0 24px rgba(100, 167, 255, 0.06);
    }

    body:not(.zen-layout) .card:hover {
      border-color: rgba(100, 167, 255, 0.34);
    }

    body:not(.zen-layout) header.appbar.normal-appbar {
      position: sticky;
      top: 10px;
      z-index: 120;
      margin-bottom: 18px;
      border: 1px solid rgba(100, 167, 255, 0.2);
      border-radius: 22px;
      background:
        radial-gradient(1200px 260px at 8% -60%, rgba(34, 211, 238, 0.2), transparent 65%),
        radial-gradient(900px 220px at 95% -40%, rgba(179, 136, 255, 0.2), transparent 62%),
        linear-gradient(180deg, rgba(11, 18, 34, 0.94), rgba(9, 14, 28, 0.88));
      box-shadow:
        0 16px 40px rgba(0, 0, 0, 0.35),
        inset 0 0 32px rgba(100, 167, 255, 0.08);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      overflow: hidden;
    }

    .normal-appbar-shell {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 16px 16px 12px;
    }

    .normal-top-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 14px;
      align-items: center;
    }

    .normal-brand-wrap {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 260px;
    }

    .normal-logo-box {
      width: 58px;
      height: 58px;
      border-radius: 16px;
      border: 1px solid rgba(100, 167, 255, 0.26);
      background: rgba(255, 255, 255, 0.03);
      box-shadow: inset 0 0 22px rgba(100, 167, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .normal-logo-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .normal-title-block h1 {
      margin: 0;
      font-size: 1.52rem;
      letter-spacing: 0.9px;
      font-weight: 800;
      color: #eff8ff;
      text-shadow: 0 0 18px rgba(34, 211, 238, 0.28);
    }

    .normal-title-sub {
      margin-top: 3px;
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.78rem;
      letter-spacing: 0.35px;
      color: var(--ink-1);
      text-transform: uppercase;
      font-weight: 700;
    }

    .normal-title-sub .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--ok);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.65);
    }

    .normal-user-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-self: end;
    }

    .normal-user-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      min-height: 44px;
      transition: all .22s ease;
    }

    .normal-user-pill .avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 3px 10px rgba(100, 167, 255, 0.35);
      flex-shrink: 0;
    }

    .normal-user-meta {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .normal-user-name {
      color: var(--ink-0);
      font-size: 0.84rem;
      font-weight: 700;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .normal-user-state {
      color: var(--ink-1);
      font-size: 0.68rem;
      line-height: 1.1;
      letter-spacing: .25px;
      text-transform: uppercase;
      font-weight: 700;
      opacity: .9;
    }

    .normal-balance-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34, 211, 238, 0.35);
      background: linear-gradient(180deg, rgba(34, 211, 238, 0.14), rgba(34, 211, 238, 0.05));
      min-height: 44px;
      box-shadow: inset 0 0 15px rgba(34, 211, 238, 0.09);
    }

    .normal-balance-pill .eco-balance-value {
      color: #67ecff;
      font-weight: 800;
      font-size: 1.02rem;
      letter-spacing: .2px;
      text-shadow: 0 0 12px rgba(34, 211, 238, 0.48);
      min-width: 40px;
      text-align: right;
    }

    .normal-tabs-wrap {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding-top: 10px;
      margin-top: 2px;
    }

    body:not(.zen-layout) .normal-tabs-wrap .tabs {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 2px 2px 6px;
      -ms-overflow-style: none;
      scrollbar-width: none;
      flex-wrap: nowrap;
    }

    body:not(.zen-layout) .normal-tabs-wrap .tabs::-webkit-scrollbar {
      display: none;
    }

    body:not(.zen-layout) .normal-tabs-wrap .nav-pill {
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
      color: #d2ebff;
      font-size: 12.5px;
      font-weight: 700;
      letter-spacing: .2px;
      min-height: 40px;
      padding: 8px 12px;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      transition: all .2s ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    body:not(.zen-layout) .normal-tabs-wrap .nav-pill:hover {
      transform: translateY(-1px);
      border-color: rgba(100, 167, 255, 0.35);
      background: linear-gradient(180deg, rgba(100, 167, 255, 0.16), rgba(100, 167, 255, 0.06));
      color: #eef7ff;
    }

    body:not(.zen-layout) .normal-tabs-wrap .nav-pill[aria-selected="true"] {
      border-color: rgba(100, 167, 255, 0.62);
      background: linear-gradient(180deg, rgba(100, 167, 255, 0.3), rgba(179, 136, 255, 0.18));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(100, 167, 255, 0.2), inset 0 0 16px rgba(100, 167, 255, 0.12);
    }

    body:not(.zen-layout) .normal-tabs-wrap .nav-pill .active-indicator {
      bottom: 0;
      height: 3px;
      border-radius: 2px 2px 0 0;
      background: linear-gradient(90deg, #22d3ee, #60a5fa, #b388ff);
    }

    @media (max-width: 900px) {
      body:not(.zen-layout) #appContainer {
        padding: 8px 10px 28px;
      }

      .normal-top-grid {
        grid-template-columns: 1fr;
      }

      .normal-user-wrap {
        justify-self: start;
        width: 100%;
        flex-wrap: wrap;
      }

      .normal-user-name {
        max-width: 220px;
      }
    }

    .grid {
      display: grid;
      gap: var(--grid-gap);
    }

    .grid.cols-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    /* Responsive para Zen Mode */
    @media (max-width: 768px) {
      body.zen-layout {
        --sidebar-w: 80px;
      }

      body.zen-layout .zen-sidebar {
        width: 80px;
        min-width: 80px;
      }

      body.zen-layout .zen-sidebar .brand h1,
      body.zen-layout .zen-sidebar #zen-username,
      body.zen-layout .zen-sidebar .brand-subtitle,
      body.zen-layout .zen-sidebar #zen-user-info>div:last-child>div:last-child,
      body.zen-layout .tab-btn span:not([data-icon]),
      body.zen-layout .ecoxionums-balance small {
        display: none !important;
      }

      body.zen-layout .zen-sidebar .brand {
        padding: 16px 8px;
      }

      body.zen-layout .zen-sidebar .tabs {
        padding: 8px 4px;
      }

      body.zen-layout .tab-btn {
        justify-content: center;
        padding: 12px 8px;
      }

      body.zen-layout .tab-btn [data-icon] {
        margin: 0;
      }

      body.zen-layout #content {
        margin-left: 80px;
        padding: 16px 12px;
      }

      body.zen-layout #zen-user-info {
        justify-content: center;
        padding: 8px;
      }

      body.zen-layout .ecoxionums-balance {
        padding: 10px 8px;
      }
    }

    @media (max-width:900px) {
      .grid.cols-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:620px) {
      .grid.cols-3 {
        grid-template-columns: 1fr;
      }
    }

    /* Botones */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ffffff1a;
      background: var(--bg-1);
      color: var(--ink-0);
      cursor: pointer;
      text-decoration: none;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn.primary {
      border-color: var(--accent);
      background: linear-gradient(180deg, #11223a, #0c1628);
    }

    /* Balance */
    .ecoxionums-balance {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: auto;
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      font-weight: 600;
      color: var(--ink-0);
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .ecoxionums-balance span:first-child {
      font-size: 18px;
      filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.4));
      animation: coinPulse 3s infinite ease-in-out;
    }

    .ecoxionums-balance:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 215, 0, 0.3);
      transform: translateY(-1px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    @keyframes coinPulse {

      0%,
      100% {
        transform: scale(1);
        filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.4));
      }

      50% {
        transform: scale(1.1);
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
      }
    }

    /* Zen Mode Balance */
    body.zen-layout .ecoxionums-balance {
      margin: auto 12px 20px 12px;
      flex-direction: column;
      padding: 20px;
      border-radius: 16px;
      background: linear-gradient(145deg, rgba(20, 20, 30, 0.6), rgba(10, 10, 20, 0.8));
      border: 1px solid rgba(255, 255, 255, 0.05);
      text-align: center;
      gap: 12px;
    }

    body.zen-layout .ecoxionums-balance span:first-child {
      font-size: 32px;
      margin-bottom: 4px;
    }

    body.zen-layout .ecoxionums-balance span:last-child {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(to right, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }

    body.zen-layout .ecoxionums-balance small {
      display: block !important;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.5;
      margin-top: -4px;
    }

    /* Dashboard */
    #content.dashboard-list {
      display: flex;
      flex-direction: column;
      gap: 25px;
      padding: 0;
    }

    body.zen-layout #content.dashboard-list {
      padding: 0;
      gap: 20px;
    }

    .extension-panel {
      background: linear-gradient(180deg, var(--bg-2), #0b0f1800);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: var(--br);
      padding: 20px;
      box-shadow: var(--shadow);
      max-height: 60vh;
      overflow-y: auto;
    }

    body.zen-layout .extension-panel {
      border-radius: 16px;
      padding: 24px;
      max-height: calc(100vh - 120px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    /* Normal mode containers: avoid compressed centered blocks across tabs */
    body:not(.zen-layout) #content > div {
      width: 100%;
    }

    body:not(.zen-layout) #content > div[style*="max-width"] {
      max-width: none !important;
      margin: 0 !important;
    }

    .eco-subs-shell {
      display: grid;
      gap: 18px;
      width: 100%;
    }

    .eco-subs-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid rgba(100, 167, 255, 0.25);
      background: linear-gradient(140deg, rgba(100, 167, 255, 0.18), rgba(179, 136, 255, 0.1));
    }

    .eco-subs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 14px;
    }

    .eco-sub-card {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: linear-gradient(180deg, rgba(16, 26, 48, 0.9), rgba(8, 15, 28, 0.92));
      padding: 16px;
      display: grid;
      gap: 12px;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      position: relative;
      overflow: hidden;
    }

    .eco-sub-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #22d3ee, #64a7ff, #b388ff);
      opacity: .7;
    }

    .eco-sub-card.active {
      border-color: rgba(55, 214, 122, 0.55);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.32), 0 0 0 1px rgba(55, 214, 122, 0.24) inset;
    }

    .eco-sub-card.recommended {
      border-color: rgba(255, 182, 72, 0.52);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.32), 0 0 0 1px rgba(255, 182, 72, 0.24) inset;
    }

    .eco-sub-plan {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .eco-sub-plan h3 {
      margin: 0;
      font-size: 20px;
      color: #e8f5ff;
    }

    .eco-sub-price {
      font-size: 26px;
      font-weight: 800;
      color: #9ad7ff;
      margin: 0;
    }

    .eco-sub-note {
      margin: 0;
      color: var(--ink-1);
      font-size: 12px;
    }

    .eco-sub-badge {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    .eco-sub-badge.active {
      color: #0c1c13;
      background: #37d67a;
    }

    .eco-sub-badge.recommended {
      color: #2f1f00;
      background: #ffb648;
    }

    .eco-sub-features {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 7px;
      color: #d4e7fb;
      font-size: 13px;
    }

    .eco-sub-features li {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      line-height: 1.35;
    }

    .eco-sub-meta {
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--ink-1);
      background: rgba(255, 255, 255, 0.03);
      display: grid;
      gap: 4px;
    }

    .eco-rewards-shell {
      display: grid;
      grid-template-columns: minmax(290px, 380px) minmax(0, 1fr);
      gap: 16px;
      align-items: start;
      width: 100%;
    }

    .eco-rewards-main,
    .eco-rewards-side {
      display: grid;
      gap: 14px;
    }

    .eco-reward-hero {
      border-radius: 18px;
      border: 1px solid rgba(255, 215, 0, 0.35);
      background: linear-gradient(155deg, rgba(255, 215, 0, 0.17), rgba(179, 136, 255, 0.12));
      padding: 18px;
      text-align: left;
    }

    .eco-reward-hero h3 {
      margin: 0 0 8px;
      color: #fff3b0;
      font-size: 22px;
    }

    .eco-reward-hero p {
      margin: 0;
      color: #f6f6db;
      opacity: .92;
      font-size: 13px;
    }

    @media (max-width: 1060px) {
      .eco-rewards-shell {
        grid-template-columns: 1fr;
      }
    }

    /* Zen Mode List Layout (Marketplace & My Extensions) */
    body.zen-layout .zen-list-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 0 16px;
    }

    body.zen-layout .zen-list-item {
      display: flex;
      align-items: center;
      gap: 20px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 16px 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    body.zen-layout .zen-list-item:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(100, 167, 255, 0.4);
      transform: translateX(6px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    body.zen-layout .zen-list-item .item-icon {
      font-size: 32px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 14px;
      flex-shrink: 0;
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.03);
    }

    body.zen-layout .zen-list-item .item-info {
      flex: 1;
      min-width: 0;
    }

    body.zen-layout .zen-list-item .item-info h3 {
      margin: 0 0 6px;
      font-size: 18px;
      font-weight: 700;
      color: var(--ink-0);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    body.zen-layout .zen-list-item .item-info p {
      margin: 0 0 10px;
      font-size: 14px;
      color: var(--ink-1);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    body.zen-layout .zen-list-item .item-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    body.zen-layout .zen-list-item .item-actions {
      flex-shrink: 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    body.zen-layout .zen-list-item .badge {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Marketplace */
    .market-item {
      background: var(--bg-2);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: var(--br);
      padding: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .market-item .icon {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: var(--bg-1);
      border: 1px solid rgba(255, 255, 255, .14);
      font-size: 24px;
    }

    .market-item .info {
      flex: 1;
    }

    .market-item h4 {
      margin: 0 0 4px;
      font-size: 15px;
    }

    .market-item p {
      margin: 0;
      color: var(--ink-1);
      font-size: 13px;
    }

    /* Alertas */
    #alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 320px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .alert {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
      background: rgba(15, 20, 35, 0.9);
      color: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
      border: 1px solid transparent;
    }

    .alert.info {
      border-color: #64a7ff;
      box-shadow: 0 0 15px #64a7ff55;
    }

    .alert.success {
      border-color: #37d67a;
      box-shadow: 0 0 15px #37d67a55;
    }

    .alert.warning {
      border-color: #ffb648;
      box-shadow: 0 0 15px #ffb64855;
    }

    .alert.error {
      border-color: #ff6b6b;
      box-shadow: 0 0 15px #ff6b6b55;
    }

    /* Loader */
    #global-loader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    #loader-progress {
      width: 300px;
      height: 4px;
      background: rgba(255, 255, 255, .1);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 20px;
    }

    #loader-progress>div {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width .3s;
    }

    /* Modal Ocean Pay */
    .ocean-pay-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .85);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn .3s ease;
    }

    .ocean-pay-modal.hidden {
      display: none;
    }

    .ocean-pay-box {
      background: linear-gradient(145deg, var(--bg-2), var(--bg-1));
      border: 2px solid var(--accent);
      border-radius: var(--br);
      padding: 32px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .6), 0 0 40px rgba(100, 167, 255, .3);
      animation: slideUp .4s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .ocean-pay-box h2 {
      margin: 0 0 8px;
      font-size: 24px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .ocean-pay-box p {
      color: var(--ink-1);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .ocean-pay-box .btn {
      width: 100%;
      justify-content: center;
      margin-top: 8px;
    }

    .ocean-pay-box .btn.skip {
      background: transparent;
      border-color: rgba(255, 255, 255, .2);
    }

    /* Mejoras visuales */
    .tab-btn:hover {
      background: rgba(255, 255, 255, .08);
      transform: translateY(-2px);
    }

    .card {
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, .4);
    }

    .market-item {
      transition: all .2s ease;
    }

    .market-item:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(100, 167, 255, .2);
    }

    /* Mejoras en inputs */
    input,
    textarea,
    select {
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--ring);
    }

    /* Rarities con colores */
    .market-item .rarity-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      background: var(--bg-1);
      border: 1px solid rgba(255, 255, 255, .14);
      color: var(--ink-1);
    }

    .market-item .rarity-badge.comun {
      border-color: rgba(180, 194, 223, .3);
      color: #b4c2df;
    }

    .market-item .rarity-badge.poco_comun {
      border-color: rgba(100, 167, 255, .3);
      color: #64a7ff;
    }

    .market-item .rarity-badge.raro {
      border-color: rgba(179, 136, 255, .3);
      color: #b388ff;
    }

    /* Animaciones de entrada */
    .extension-panel {
      animation: fadeInUp .4s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Tarjetas de suscripción */
    .subscription-card {
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      cursor: pointer;
    }

    .subscription-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 40px rgba(100, 167, 255, 0.2);
    }

    .subscription-card.active {
      animation: subscriptionPulse 2s ease-in-out infinite;
    }

    @keyframes subscriptionPulse {

      0%,
      100% {
        box-shadow: 0 8px 32px rgba(100, 167, 255, 0.3);
      }

      50% {
        box-shadow: 0 12px 48px rgba(100, 167, 255, 0.5);
      }
    }

    /* =========================
       ESTILOS DE PAQUETES (GACHA)
       ========================= */
    .package-card {
      position: relative;
      background: var(--bg-1);
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      overflow: hidden;
    }

    .package-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, .4);
      border-color: var(--accent);
    }

    .package-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      opacity: 0;
      transition: opacity .3s;
    }

    .package-card:hover::before {
      opacity: 1;
    }

    .package-icon {
      font-size: 64px;
      margin-bottom: 16px;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, .3));
      transition: transform .3s;
    }

    .package-card:hover .package-icon {
      transform: scale(1.1) rotate(5deg);
    }

    .package-price {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, .3);
      border-radius: 20px;
      font-weight: 700;
      color: var(--accent);
      margin-top: 12px;
    }

    /* Animación de Apertura */
    .opening-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .95);
      z-index: 20000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s;
    }

    .opening-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .opening-package {
      font-size: 120px;
      cursor: pointer;
      filter: drop-shadow(0 0 30px rgba(100, 167, 255, .5));
    }

    .opening-package.shaking {
      animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both infinite;
    }

    @keyframes shake {

      10%,
      90% {
        transform: translate3d(-2px, 0, 0) rotate(-2deg);
      }

      20%,
      80% {
        transform: translate3d(4px, 0, 0) rotate(4deg);
      }

      30%,
      50%,
      70% {
        transform: translate3d(-8px, 0, 0) rotate(-8deg);
      }

      40%,
      60% {
        transform: translate3d(8px, 0, 0) rotate(8deg);
      }
    }

    .opening-burst {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .reward-reveal {
      text-align: center;
      opacity: 0;
      transform: scale(0.5);
      transition: all .5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .reward-reveal.show {
      opacity: 1;
      transform: scale(1);
    }

    .reward-card {
      background: linear-gradient(145deg, var(--bg-2), var(--bg-1));
      padding: 40px;
      border-radius: 24px;
      border: 2px solid var(--accent);
      box-shadow: 0 0 60px rgba(100, 167, 255, .3);
      max-width: 400px;
      margin: 0 auto;
    }

    .reward-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .rarity-glow.comun {
      box-shadow: 0 0 40px rgba(180, 194, 223, .4);
      border-color: #b4c2df;
    }

    .rarity-glow.poco_comun {
      box-shadow: 0 0 40px rgba(100, 167, 255, .4);
      border-color: #64a7ff;
    }

    .rarity-glow.raro {
      box-shadow: 0 0 40px rgba(179, 136, 255, .4);
      border-color: #b388ff;
    }

    .rarity-glow.epica {
      box-shadow: 0 0 40px rgba(255, 215, 0, .4);
      border-color: #ffd700;
    }

    .rarity-glow.legendaria {
      box-shadow: 0 0 50px rgba(255, 80, 80, .6);
      border-color: #ff5050;
      animation: legendaryPulse 2s infinite;
    }

    @keyframes legendaryPulse {
      0% {
        box-shadow: 0 0 50px rgba(255, 80, 80, .6);
      }

      50% {
        box-shadow: 0 0 80px rgba(255, 80, 80, .9);
      }

      100% {
        box-shadow: 0 0 50px rgba(255, 80, 80, .6);
      }
    }

    /* Minigames Grids */
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 15px;
    }

    .memory-card {
      aspect-ratio: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .memory-card.flipped {
      transform: rotateY(180deg);
      background: var(--accent);
      color: white;
    }

    .memory-card.matched {
      background: var(--ok);
      color: white;
      cursor: default;
    }

    .simon-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 20px 0;
    }

    .simon-btn {
      aspect-ratio: 1;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .simon-btn:active {
      transform: scale(0.95);
    }

    .math-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 20px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>

<body>
  <div id="appContainer">
    <header class="appbar" id="appbar"></header>
    <main id="content"></main>
  </div>

  <div id="alert-container"></div>
  <div id="global-loader" style="display:none;">
    <div id="loader-text">Cargando...</div>
    <div id="loader-progress">
      <div style="width:0%"></div>
    </div>
    <div id="loader-detail"></div>
  </div>

  <!-- Modal Ocean Pay Login -->
  <div id="ocean-pay-modal" class="ocean-pay-modal hidden">
    <div class="ocean-pay-box">
      <h2 id="op-title">🌊 Ocean Pay Access</h2>
      <p id="op-desc" style="margin-bottom:20px;">Vincula tu cuenta para sincronizar Ecoxionums.</p>

      <div id="op-login-form">
        <input type="text" id="op-username" placeholder="Usuario" class="input-field"
          style="width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:1px solid var(--accent);background:rgba(0,0,0,0.2);color:white;">
        <input type="password" id="op-password" placeholder="Contraseña" class="input-field"
          style="width:100%;padding:12px;margin-bottom:20px;border-radius:8px;border:1px solid var(--accent);background:rgba(0,0,0,0.2);color:white;">

        <button id="op-login-btn" class="btn primary" onclick="submitOceanPayAuth()"
          style="width:100%;margin-bottom:10px;">🔐 Iniciar Sesión</button>
      </div>

      <div style="margin-bottom:12px;font-size:13px;color:var(--ink-1);cursor:pointer;text-decoration:underline;"
        onclick="toggleOceanPayMode()" id="op-toggle-msg">
        ¿No tienes cuenta? Regístrate aquí
      </div>

      <button class="btn skip" onclick="skipOceanPay()"
        style="margin-top:10px;width:100%;background:transparent;border:1px solid rgba(255,255,255,0.1);">Continuar sin
        vincular</button>
      <div id="op-error" style="color:var(--danger);font-size:12px;margin-top:10px;min-height:20px;text-align:center;">
      </div>
    </div>
  </div>

  <script>
    /* =========================
       CONFIGURACIÓN BASE
       ========================= */
    const API_BASE = "https://owsdatabase.onrender.com/api/extensions";
    const API_GLOBAL = "https://owsdatabase.onrender.com";
    const STORAGE_KEY = "ecoxion.state.v1";

    /* =========================
       ESTADO Y ALMACENAMIENTO
       ========================= */
    const DEFAULT_STATE = Object.freeze({
      userId: '',
      username: 'Explorador',
      installed: {},
      darkMode: false,
      currentTheme: 'espacial',
      zenMode: false,
      ecoxionums: 0,
      oceanPayLinked: false
    });

    function normalizeState(raw) {
      const incoming = (raw && typeof raw === 'object') ? raw : {};
      return {
        ...DEFAULT_STATE,
        ...incoming,
        userId: String(incoming.userId || localStorage.getItem('ecoxionUserId') || crypto.randomUUID()),
        username: String(incoming.username || localStorage.getItem('ecoxionUsername') || 'Explorador'),
        installed: (incoming.installed && typeof incoming.installed === 'object') ? incoming.installed : {},
        darkMode: incoming.darkMode === true,
        zenMode: incoming.zenMode === true,
        currentTheme: String(incoming.currentTheme || 'espacial'),
        ecoxionums: Number.isFinite(Number(incoming.ecoxionums)) ? Number(incoming.ecoxionums) : 0,
        oceanPayLinked: incoming.oceanPayLinked === true
      };
    }

    let stateSyncTimer = null;
    let stateSyncInFlight = false;
    let stateSyncQueued = null;
    const STATE_SYNC_DEBOUNCE_MS = 1200;

    async function pushStateToServer(stateSnapshot) {
      if (!stateSnapshot?.oceanPayLinked || !stateSnapshot?.userId) return;
      await fetch(`${API_BASE}/${stateSnapshot.userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(stateSnapshot)
      });
    }

    async function flushQueuedStateSync() {
      if (stateSyncInFlight || !stateSyncQueued) return;
      stateSyncInFlight = true;
      const payload = stateSyncQueued;
      stateSyncQueued = null;
      try {
        await pushStateToServer(payload);
      } catch (e) {
        console.warn("Error sincronizando con servidor:", e);
      } finally {
        stateSyncInFlight = false;
      }
      if (stateSyncQueued) {
        // Si llegaron más cambios durante el sync, enviamos solo el último snapshot.
        await flushQueuedStateSync();
      }
    }

    function queueStateSync(state) {
      if (!state?.oceanPayLinked || !state?.userId) return;
      stateSyncQueued = state;
      if (stateSyncTimer) clearTimeout(stateSyncTimer);
      stateSyncTimer = setTimeout(() => {
        stateSyncTimer = null;
        flushQueuedStateSync();
      }, STATE_SYNC_DEBOUNCE_MS);
    }

    async function loadState() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) return normalizeState(JSON.parse(stored));
      } catch (e) {
        console.warn("Error loading state:", e);
      }

      // Estado por defecto
      return normalizeState({});
    }

    async function saveState(state) {
      try {
        const normalized = normalizeState(state);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
        queueStateSync(normalized);
      } catch (e) {
        console.warn("Error saving state:", e);
      }
    }



    /* =========================
       EXTENSIONES BASE
       ========================= */
    const defaultExtensions = {
      "notes": {
        id: "notes",
        name: "Notas",
        description: "Escribe y organiza tus notas rápidamente (Función Activa: abre un panel en el dashboard).",
        rarity: "comun",
        type: "active",
        version: "1.0.0",
        version2: "2.0.0",
        hasV2: true,
        v2Features: ["Búsqueda avanzada", "Etiquetas y categorías", "Exportación a PDF"],
        icon: "📝",
        price: 0,
        missions: [
          { id: "create_3_notes", title: "Crea 3 notas", description: "Escribe y guarda al menos 3 notas diferentes", target: 3, type: "count" },
          { id: "note_length", title: "Nota extensa", description: "Crea una nota con más de 100 caracteres", target: 1, type: "length" },
          { id: "notes_mastery", title: "Maestría: Bibliotecario", description: "Acumula 20 notas guardadas para demostrar tu sabiduría", target: 20, type: "count" }
        ],
        async getPanelHTML() {
          const state = await loadState();
          const extInfo = state.installed?.[this.id] || {};
          const isV2 = extInfo?.awakened || false;

          return `
        <div id="notes-panel">
          ${isV2 ? `
            <div style="margin-bottom: 16px;padding:12px;background:linear-gradient(135deg, rgba(100,167,255,.1), rgba(179,136,255,.1));border-radius:8px;border:1px solid var(--accent);margin-bottom:16px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span class="v2-badge">V2</span>
                <span style="color:var(--accent);font-weight:600;">Notas Avanzadas Activadas</span>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                <input type="text" id="note-search" placeholder="🔍 Buscar notas..." style="flex:1;min-width:200px;padding:8px;border-radius:6px;background:var(--bg-1);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);">
                <input type="text" id="note-tags" placeholder="🏷️ Etiquetas (separadas por coma)" style="flex:1;min-width:200px;padding:8px;border-radius:6px;background:var(--bg-1);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);">
              </div>
            </div>
          ` : `
            <div style="margin-bottom:16px;padding:12px;background:rgba(255,215,0,.1);border-radius:8px;border:1px solid rgba(255,215,0,.3);text-align:center;">
              <p style="margin:0 0 12px;color:var(--warn);font-size:13px;">? <strong>V2 disponible</strong> - Despierta esta extensi?n para funciones avanzadas</p>
              <button class="btn" onclick="showMissionsModal('${this.id}')" style="background:linear-gradient(135deg, rgba(100,167,255,.2), rgba(179,136,255,.2));border:1px solid var(--accent);color:var(--accent);">Ver Misiones V2</button>
            </div>
          `}
          <div style="margin-bottom: 16px;">
            <input type="text" id="note-title" placeholder="Título" style="width:100%;padding:10px;border-radius:8px;background:var(--bg-1);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);margin-bottom:8px;">
            <textarea id="note-content" placeholder="Contenido..." style="width:100%;padding:10px;border-radius:8px;background:var(--bg-1);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);min-height:100px;"></textarea>
            <button class="btn primary" onclick="saveNote()" style="margin-top:8px;">Guardar Nota</button>
            ${isV2 ? `<button class="btn" onclick="exportNotes()" style="margin-top:8px;margin-left:8px;">📄 Exportar PDF</button>` : ''}
          </div>
          <div id="notes-list"></div>
        </div>
      `;
        },
        async onEnable() {
          loadNotes();
        }
      },
      "dark-mode": {
        id: "dark-mode",
        name: "Dark Mode",
        description: "Activa un tema oscuro OLED para toda la interfaz (Función Pasiva: se activa inmediatamente).",
        rarity: "rara",
        type: "passive",
        version: "1.1.0",
        icon: "🌙",
        price: 0,
        getPanelHTML() {
          return `<p>Dark Mode está activo. Disfruta de la interfaz oscura con ajustes dinámicos según la hora del día.</p>`;
        },
        async onEnable() {
          const state = await loadState();
          state.darkMode = true;
          await saveState(state);
          document.body.classList.add("dark-theme");
        },
        async onDisable() {
          const state = await loadState();
          state.darkMode = false;
          await saveState(state);
          document.body.classList.remove("dark-theme");
        }
      },
      "zen-mode": {
        id: "zen-mode",
        name: "Zen Mode",
        description: "Rediseña la interfaz a un formato minimalista y enfocado (Función Pasiva: se activa inmediatamente).",
        rarity: "comun",
        type: "passive",
        version: "1.0.0",
        icon: "🧘",
        price: 0,
        getPanelHTML() {
          return `<p>Zen Mode está activo. Disfruta de una interfaz más limpia y organizada.</p>`;
        },
        async onEnable() {
          const state = await loadState();
          state.zenMode = true;
          await saveState(state);
          document.body.classList.add("zen-layout");
          renderNavigation();
        },
        async onDisable() {
          const state = await loadState();
          state.zenMode = false;
          await saveState(state);
          document.body.classList.remove("zen-layout");
          renderNavigation();
        }
      },


      "blog-creator": {
        id: "blog-creator",
        name: "Blog Creator",
        description: "Crea y publica blogs en la comunidad.",
        rarity: "poco_comun",
        type: "active",
        version: "1.0",
        icon: "✍️",
        price: 0,
        getPanelHTML() {
          return `
        <div id="blog-creator" style="padding:20px; color:var(--ink-1);">
          <div class="card" style="margin-bottom:24px; background:rgba(255,255,255,0.02); border-color:rgba(100,167,255,0.2);">
            <h3 style="margin:0 0 16px; color:var(--accent); font-size:18px;">✍️ Crear Nueva Entrada</h3>
            <div style="display:flex; flex-direction:column; gap:12px;">
              <input type="text" id="blog-title" placeholder="Título impactante..." 
                style="width:100%; padding:14px; border-radius:12px; background:var(--bg-2); border:1px solid rgba(255,255,255,0.08); color:var(--ink-0); font-size:16px; font-weight:600;">
              <textarea id="blog-content" placeholder="Escribe el contenido de tu blog aquí..." 
                style="width:100%; padding:14px; border-radius:12px; background:var(--bg-2); border:1px solid rgba(255,255,255,0.08); color:var(--ink-0); min-height:180px; resize:vertical; font-family:inherit;"></textarea>
              <button class="btn primary" onclick="publishBlog()" style="padding:14px; font-weight:700; border-radius:12px; font-size:15px; background:linear-gradient(135deg, var(--accent), var(--accent-2));">Publicar como Explorador</button>
            </div>
          </div>
          
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
            <div style="height:1px; flex:1; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1));"></div>
            <span style="font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--ink-2);">Entradas Recientes</span>
            <div style="height:1px; flex:1; background:linear-gradient(90deg, rgba(255,255,255,0.1), transparent);"></div>
          </div>

          <div id="blogs-list" style="display:flex; flex-direction:column; gap:16px;">
            <div style="text-align:center; padding:40px; color:var(--ink-2);">
              <div class="loader-spinner" style="width:24px; height:24px; border:2px solid rgba(255,255,255,0.1); border-top-color:var(--accent); border-radius:50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;"></div>
              Cargando comunidad...
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() {
          loadBlogs();
        }
      },
      "clicky-coin": {
        id: "clicky-coin",
        name: "Clicky Coin",
        description: "Gana Ecoxionums haciendo clic. Extensión gratuita para obtener monedas.",
        rarity: "comun",
        type: "active",
        version: "1.0.0",
        version2: "2.0.0",
        hasV2: true,
        v2Features: ["Más recompensas por clic", "Multiplicadores de tiempo", "Logros y desafíos"],
        icon: "🪙",
        price: 0,
        defaultInstall: false,
        missions: [
          { id: "click_100", title: "100 clics", description: "Haz 100 clics en total en la moneda", target: 100, type: "clicks" },
          { id: "daily_limit", title: "Límite diario", description: "Alcanza el límite diario de clics al menos una vez", target: 1, type: "daily_limit" },
          { id: "clicky_mastery", title: "Maestría: Magnate", description: "Acumula 5,000 Ecoxionums generados (Histórico)", target: 5000, type: "earned" }
        ],
        getPanelHTML() {
          return `
        <div id="clicky-coin-panel" style="padding:16px;">
          <div style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg, rgba(255,215,0,.1), rgba(255,182,72,.1));border-radius:12px;border:1px solid rgba(255,215,0,.3);text-align:center;">
            <h4 style="margin:0 0 12px;color:#FFD700;display:flex;align-items:center;justify-content:center;gap:8px;">
              <span>🪙</span>
              <span>Clicky Coin</span>
            </h4>
            <p style="margin:0 0 20px;color:var(--ink-1);font-size:14px;">Haz clic en la moneda para ganar Ecoxionums. Cada clic vale 1-3 monedas.</p>
            
            <div style="margin-bottom:16px;">
              <div id="clicky-coin-button" style="width:120px;height:120px;margin:0 auto;background:linear-gradient(135deg, #FFD700, #FFA500);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;cursor:pointer;box-shadow:0 4px 20px rgba(255,215,0,.4);transition:all 0.2s;user-select:none;position:relative;overflow:hidden;" onclick="clickCoin()" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                🪙
              </div>
              <div id="coin-animation-container" style="position:relative;height:40px;margin-top:10px;"></div>
            </div>
            
            <div style="margin-bottom:16px;">
              <div id="clicks-today" style="color:var(--accent);font-size:24px;font-weight:700;margin-bottom:4px;">0</div>
              <div style="color:var(--ink-1);font-size:12px;">Clics hoy</div>
            </div>
            
            <div style="padding:12px;background:rgba(255,215,0,.1);border-radius:8px;border:1px solid rgba(255,215,0,.2);margin-top:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="color:var(--ink-1);font-size:13px;">Earned hoy:</span>
                <span id="earned-today" style="color:#FFD700;font-weight:600;font-size:16px;">0 🪙</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="color:var(--ink-1);font-size:13px;">Total clics:</span>
                <span id="total-clicks" style="color:var(--accent);font-weight:600;font-size:16px;">0</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="color:var(--ink-1);font-size:13px;">Total ganado:</span>
                <span id="total-clicky-earned" style="color:var(--ok);font-weight:600;font-size:16px;">0 🪙</span>
              </div>
            </div>
            
            <div style="margin-top:16px;padding:10px;background:rgba(100,167,255,.1);border-radius:8px;border:1px solid var(--accent);">
              <p style="margin:0;font-size:11px;color:var(--ink-1);">
                ⚠️ <strong>Límite diario:</strong> Máximo 50 clics por día (100-150 Ecoxionums diarios)
              </p>
            </div>
            
            <div id="autoclicker-warning" style="display:none;margin-top:12px;padding:12px;background:rgba(255,107,107,.15);border-radius:8px;border:2px solid var(--danger);text-align:center;">
              <p style="margin:0;font-size:12px;color:var(--danger);font-weight:600;">
                ⚠️ Auto-clicker detectado. Los clics demasiado rápidos no son válidos.
              </p>
            </div>
            
            <div style="margin-top:20px;padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.08);">
              <h4 style="margin:0 0 12px;font-size:15px;">💰 Retiro de Ecoxionums</h4>
              <p style="margin:0 0 12px;color:var(--ink-1);font-size:13px;">Retira tus Ecoxionums ganados a tu cuenta de Ocean Pay.</p>
              <div style="display:flex;flex-direction:column;gap:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,.05);border-radius:6px;">
                  <span style="color:var(--ink-1);font-size:13px;">Disponible para retirar:</span>
                  <span id="withdrawable-amount" style="color:var(--ok);font-weight:700;font-size:16px;">0 🪙</span>
                </div>
                <button id="withdraw-btn" class="btn primary" onclick="withdrawEcoxionums()" style="width:100%;" disabled>
                  🌊 Retirar a Ocean Pay
                </button>
                <p style="margin:0;font-size:11px;color:var(--ink-1);opacity:.7;text-align:center;">
                  Debes tener una cuenta vinculada con Ocean Pay para retirar
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() {
          updateClickyCoinPanel();
        }
      },
      "eco-generator": {
        id: "eco-generator",
        name: "Generador de Ecoxionums",
        description: "Genera Ecoxionums cada cierto tiempo. Recompensa diaria disponible.",
        rarity: "comun",
        type: "active",
        version: "1.0.0",
        version2: "2.0.0",
        hasV2: true,
        v2Features: ["Recompensas multiplicadas", "Recompensas cada 12 horas", "Bonificaciones especiales"],
        icon: "⚡",
        price: 500,
        missions: [
          { id: "claim_5_daily", title: "5 recompensas diarias", description: "Reclama 5 recompensas diarias", target: 5, type: "claims" },
          { id: "streak_3", title: "Racha de 3 días", description: "Mantén una racha de 3 días consecutivos", target: 3, type: "streak" },
          { id: "generator_mastery", title: "Maestría: Constancia Pura", description: "Mantén una racha de 7 días consecutivos", target: 7, type: "streak" }
        ],
        getPanelHTML() {
          return `
        <div id="eco-generator-panel" style="padding:16px;">
          <div style="margin-bottom:20px;padding:24px;background:linear-gradient(135deg, rgba(80, 200, 120, 0.1), rgba(0, 150, 255, 0.1));border-radius:16px;border:1px solid rgba(80, 200, 120, 0.3);position:relative;overflow:hidden;">
            <div style="position:absolute;top:-20px;right:-20px;font-size:120px;opacity:0.05;pointer-events:none;">⚡</div>
            
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h4 style="margin:0;color:var(--accent);font-size:18px;display:flex;align-items:center;gap:8px;">
                <span style="background:rgba(80, 200, 120, 0.2);padding:6px;border-radius:8px;">⚡</span>
                <span>Reactor de Energía</span>
              </h4>
              <span id="streak-badge" style="background:linear-gradient(90deg, #FF6B6B, #FF8E53);color:white;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;">Racha: 0 días</span>
            </div>

            <p style="margin:0 0 20px;color:var(--ink-1);font-size:14px;line-height:1.5;">El Reactor genera Ecoxionums cada 20 horas. Mantenerlo activo diariamente aumenta su potencia y tus recompensas.</p>
            
            <div id="daily-reward-status" style="margin-bottom:20px;text-align:center;">
              <!-- Se llena dinámicamente -->
            </div>

            <button id="claim-daily-btn" class="btn primary" onclick="claimDailyReward()" style="width:100%;padding:14px;font-size:15px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
              Reclamar Recompensa
            </button>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div style="padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.05);text-align:center;">
              <div style="font-size:12px;color:var(--ink-1);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;">Total Generado</div>
              <div id="total-earned" style="font-size:20px;font-weight:700;color:var(--ok);">0 🪙</div>
            </div>
            <div style="padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.05);text-align:center;">
              <div style="font-size:12px;color:var(--ink-1);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;">Reclamos</div>
              <div id="rewards-count" style="font-size:20px;font-weight:700;color:var(--accent);">0</div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:12px 16px;background:linear-gradient(90deg, rgba(255, 171, 0, 0.1), transparent);border-left:3px solid #ffab00;border-radius:0 8px 8px 0;">
            <p style="margin:0;font-size:12px;color:#ffab00;">
              <strong>⚡ Bono de Racha:</strong> +25% tras 3 días, +50% tras 7 días. ¡No pierdas tu racha!
            </p>
          </div>
        </div>
      `;
        },
        async onEnable() {
          updateGeneratorPanel();
          // Actualizar cada minuto
          setInterval(updateGeneratorPanel, 60000);
        }
      },
      "eco-luck": {
        id: "eco-luck",
        name: "Ecoxionum Fortuna",
        description: "Arriesga Ecoxionums para intentar ganar mucho más. Todo queda a la suerte.",
        rarity: "raro",
        type: "active",
        version: "1.0.0",
        icon: "🎲",
        price: 250,
        getPanelHTML() {
          return `
        <div id="eco-luck-panel" style="padding:16px;">
          <div style="margin-bottom:24px;padding:2px;background:linear-gradient(90deg, #FFD700, #FFA500, #FF4500);border-radius:16px;">
            <div style="background:var(--bg-0);padding:20px;border-radius:14px;position:relative;overflow:hidden;">
              <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDIxNSwwLDAuMSkiLz48L3N2Zz4=');opacity:0.3;"></div>
              
              <h4 style="margin:0 0 10px;text-align:center;font-size:22px;background:linear-gradient(to right, #FFD700, #FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800;">
                LA RUEDA DE LA FORTUNA
              </h4>
              
              <div style="display:flex;justify-content:space-between;margin-top:16px;font-size:12px;color:var(--ink-0);">
                <div style="text-align:center;">
                  <span style="display:block;font-weight:700;color:var(--ink-1);">Coste</span>
                  <span style="font-size:16px;">25 🪙</span>
                </div>
                <div style="text-align:center;">
                  <span style="display:block;font-weight:700;color:#FFD700;">Premio Máximo</span>
                  <span style="font-size:16px;">250 🪙</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="position:relative;height:240px;display:flex;align-items:center;justify-content:center;margin-bottom:30px;">
            <!-- Círculo decorativo exterior -->
            <div style="position:absolute;width:220px;height:220px;border-radius:50%;border:2px dashed rgba(255,255,255,0.1);animation:spin 20s linear infinite;"></div>
            
            <button id="eco-luck-button" class="btn" onclick="playEcoLuck()" style="width:180px;height:180px;border-radius:50%;border:none;background:radial-gradient(circle at 30% 30%, #2a2a2a, #000);box-shadow:0 0 30px rgba(255, 215, 0, 0.15);position:relative;cursor:pointer;overflow:hidden;transition:transform 0.2s;">
              <div style="position:absolute;inset:4px;border-radius:50%;background:conic-gradient(#FFD700 0% 25%, #FF4500 25% 50%, #9C27B0 50% 75%, #2196F3 75% 100%);opacity:0.2;"></div>
              <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2;">
                <span style="font-size:40px;">🎰</span>
                <span style="font-size:12px;font-weight:700;color:#FFF;text-shadow:0 2px 4px rgba(0,0,0,0.5);margin-top:4px;">GIRAR</span>
              </div>
            </button>
            
            <div id="luck-result-pop" style="position:absolute;font-size:32px;font-weight:800;text-shadow:0 4px 12px rgba(0,0,0,0.5);opacity:0;pointer-events:none;z-index:10;transform:scale(0.5);"></div>
          </div>

          <div style="text-align:center;margin-bottom:16px;">
            <div style="font-size:12px;color:var(--ink-1);margin-bottom:4px;">Último Resultado</div>
            <div id="eco-luck-last-result" style="font-size:18px;font-weight:700;">-</div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;">
            <div style="background:var(--bg-1);padding:10px;border-radius:10px;text-align:center;">
              <span style="display:block;font-size:10px;color:var(--ink-1);text-transform:uppercase;">Jugadas</span>
              <span id="eco-luck-plays" style="font-size:16px;font-weight:700;">0</span>
            </div>
            <div style="background:var(--bg-1);padding:10px;border-radius:10px;text-align:center;">
              <span style="display:block;font-size:10px;color:var(--ink-1);text-transform:uppercase;">Mejor</span>
              <span id="eco-luck-best" style="font-size:16px;font-weight:700;color:#FFD700;">0</span>
            </div>
            <div style="background:var(--bg-1);padding:10px;border-radius:10px;text-align:center;">
              <span style="display:block;font-size:10px;color:var(--ink-1);text-transform:uppercase;">Neto</span>
              <span id="eco-luck-net" style="font-size:16px;font-weight:700;">0</span>
            </div>
          </div>

          <p style="text-align:center;font-size:11px;color:var(--ink-1);opacity:0.6;">
            Probabilidades: x10 (3%), x3 (17%), x1.5 (30%), Nada (50%)
          </p>
        </div>
      `;
        },
        async onEnable() {
          updateEcoLuckPanel();
        }
      },
      "eco-stock": {
        id: "eco-stock",
        name: "Eco Stock Market",
        description: "Invierte tus Ecoxionums en empresas virtuales y gana dividendos. ¡Compra bajo, vende alto!",
        rarity: "epica",
        type: "active",
        version: "1.0.0",
        icon: "📈",
        price: 300,
        defaultInstall: false,
        getPanelHTML() {
          return `
            <div id="eco-stock-panel" style="padding:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <div style="font-size:18px;font-weight:700;color:var(--accent);">📈 Mercado de Valores</div>
                <div style="font-size:12px;padding:4px 8px;background:rgba(16,185,129,0.1);color:var(--ok);border-radius:4px;font-weight:600;" id="stock-market-status">Mercado Abierto 🟢</div>
              </div>
              
              <div style="display:grid;gap:16px;margin-bottom:24px;" id="stock-list">
                 <div style="text-align:center;padding:20px;color:var(--ink-1);">Cargando empresas...</div>
              </div>
              
              <div style="background:var(--bg-1);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.08);">
                 <h4 style="margin:0 0 12px;color:var(--ink-0);">💼 Tu Portafolio</h4>
                 <div id="my-stock-portfolio">
                    <p style="color:var(--ink-1);font-size:13px;">No tienes inversiones activas.</p>
                 </div>
              </div>
            </div>
          `;
        },
        async onEnable() {
          if (window.initEcoStock) window.initEcoStock();
        }
      },
      "calculator": {
        id: "calculator",
        name: "Calculadora",
        description: "Calculadora científica con historial de operaciones.",
        rarity: "comun",
        type: "active",
        version: "1.0.0",
        icon: "🔢",
        price: 0,
        getPanelHTML() {
          return `
        <div id="calculator-panel" style="padding:16px;">
          <div style="max-width:400px;margin:0 auto;">
            <div style="margin-bottom:16px;padding:20px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.12);">
              <input type="text" id="calc-display" readonly style="width:100%;padding:16px;font-size:28px;text-align:right;background:rgba(0,0,0,.3);border:none;border-radius:8px;color:var(--accent);font-weight:700;margin-bottom:12px;font-family:monospace;">
              <div id="calc-history" style="min-height:40px;max-height:80px;overflow-y:auto;padding:8px;background:rgba(255,255,255,.03);border-radius:6px;font-size:12px;color:var(--ink-1);font-family:monospace;"></div>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;">
              <button class="calc-btn" onclick="calcClear()" style="grid-column:span 2;background:var(--danger);color:white;">C</button>
              <button class="calc-btn" onclick="calcBackspace()">⌫</button>
              <button class="calc-btn" onclick="calcAppend('/')">÷</button>
              
              <button class="calc-btn" onclick="calcAppend('7')">7</button>
              <button class="calc-btn" onclick="calcAppend('8')">8</button>
              <button class="calc-btn" onclick="calcAppend('9')">9</button>
              <button class="calc-btn" onclick="calcAppend('*')">×</button>
              
              <button class="calc-btn" onclick="calcAppend('4')">4</button>
              <button class="calc-btn" onclick="calcAppend('5')">5</button>
              <button class="calc-btn" onclick="calcAppend('6')">6</button>
              <button class="calc-btn" onclick="calcAppend('-')">−</button>
              
              <button class="calc-btn" onclick="calcAppend('1')">1</button>
              <button class="calc-btn" onclick="calcAppend('2')">2</button>
              <button class="calc-btn" onclick="calcAppend('3')">3</button>
              <button class="calc-btn" onclick="calcAppend('+')">+</button>
              
              <button class="calc-btn" onclick="calcAppend('0')" style="grid-column:span 2;">0</button>
              <button class="calc-btn" onclick="calcAppend('.')">.</button>
              <button class="calc-btn" onclick="calcEquals()" style="background:var(--accent);color:#0a0e1a;font-weight:700;">=</button>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;margin-top:8px;">
              <button class="calc-btn" onclick="calcAppend('(')">(</button>
              <button class="calc-btn" onclick="calcAppend(')')">)</button>
              <button class="calc-btn" onclick="calcAppend('**')">x²</button>
              <button class="calc-btn" onclick="calcSqrt()">√</button>
            </div>
          </div>
        </div>
        <style>
          .calc-btn {
            padding:16px;
            font-size:18px;
            font-weight:600;
            background:var(--bg-2);
            border:1px solid rgba(255,255,255,.12);
            border-radius:8px;
            color:var(--ink-0);
            cursor:pointer;
            transition:all .2s;
          }
          .calc-btn:hover {
            background:rgba(100,167,255,.2);
            border-color:var(--accent);
            transform:translateY(-2px);
          }
          .calc-btn:active {
            transform:translateY(0) scale(.95);
          }
        </style>
      `;
        },
        async onEnable() {
          if (!window.calcHistory) window.calcHistory = [];
        }
      },
      "pomodoro": {
        id: "pomodoro",
        name: "Temporizador Pomodoro",
        description: "Técnica Pomodoro para mejorar tu productividad. 25 min trabajo, 5 min descanso.",
        rarity: "poco_comun",
        type: "active",
        version: "1.0.0",
        icon: "🍅",
        price: 300,
        getPanelHTML() {
          return `
        <div id="pomodoro-panel" style="padding:16px;">
          <div style="max-width:400px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:24px;padding:40px 20px;background:var(--bg-1);border-radius:50%;width:280px;height:280px;margin:0 auto 30px;display:flex;flex-direction:column;justify-content:center;align-items:center;border:4px solid var(--accent);box-shadow:0 0 30px rgba(var(--accent-rgb), 0.2);position:relative;">
              <div id="pomodoro-status-text" style="text-transform:uppercase;letter-spacing:2px;font-size:12px;color:var(--ink-1);margin-bottom:8px;">Tiempo de Enfoque</div>
              <div id="pomodoro-timer" style="font-size:64px;font-weight:900;color:var(--ink-0);font-variant-numeric:tabular-nums;line-height:1;">25:00</div>
              
              <!-- Circular Progress SVG -->
              <svg style="position:absolute;top:-4px;left:-4px;width:280px;height:280px;pointer-events:none;transform:rotate(-90deg);">
                <circle cx="140" cy="140" r="136" fill="none" stroke="var(--bg-2)" stroke-width="4"/>
                <circle id="pomodoro-progress" cx="140" cy="140" r="136" fill="none" stroke="var(--accent)" stroke-width="4" stroke-dasharray="854" stroke-dashoffset="0" style="transition:stroke-dashoffset 1s linear;"/>
              </svg>
            </div>
            
            <div style="display:flex;justify-content:center;gap:16px;margin-bottom:30px;">
              <button id="pomodoro-start-btn" class="btn primary" onclick="pomodoroStart()" style="width:60px;height:60px;border-radius:50%;font-size:24px;display:flex;align-items:center;justify-content:center;">▶</button>
              <button id="pomodoro-pause-btn" class="btn" onclick="pomodoroPause()" style="display:none;width:60px;height:60px;border-radius:50%;background:var(--bg-2);font-size:24px;align-items:center;justify-content:center;">⏸</button>
              <button id="pomodoro-reset-btn" class="btn" onclick="pomodoroReset()" style="width:60px;height:60px;border-radius:50%;background:var(--bg-2);font-size:24px;display:flex;align-items:center;justify-content:center;">↺</button>
            </div>

            <div style="background:linear-gradient(135deg, rgba(80, 200, 120, 0.1), rgba(0, 150, 255, 0.1));padding:16px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <div>
                 <div style="font-size:12px;color:var(--ink-1);margin-bottom:2px;">Recompensa por sesión</div>
                 <div style="font-weight:700;color:var(--ok);">+15 Ecoxionums</div>
              </div>
              <div style="font-size:24px;">🍅</div>
            </div>
            
            <div style="padding:20px;background:var(--bg-1);border-radius:16px;margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                 <label style="font-size:13px;color:var(--ink-1);">Trabajo (min)</label>
                 <input type="number" id="pomodoro-work-time" value="25" min="1" max="60" style="width:60px;padding:4px;border-radius:4px;background:var(--bg-0);border:none;text-align:center;color:var(--ink-0);">
              </div>
              <div style="display:flex;justify-content:space-between;">
                 <label style="font-size:13px;color:var(--ink-1);">Descanso (min)</label>
                 <input type="number" id="pomodoro-break-time" value="5" min="1" max="30" style="width:60px;padding:4px;border-radius:4px;background:var(--bg-0);border:none;text-align:center;color:var(--ink-0);">
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
               <div style="background:var(--bg-1);padding:12px;border-radius:12px;text-align:center;">
                 <div style="font-size:11px;color:var(--ink-1);text-transform:uppercase;">Hoy</div>
                 <div id="pomodoro-completed" style="font-size:20px;font-weight:700;color:var(--accent);">0</div>
               </div>
               <div style="background:var(--bg-1);padding:12px;border-radius:12px;text-align:center;">
                 <div style="font-size:11px;color:var(--ink-1);text-transform:uppercase;">Tiempo Total</div>
                 <div id="pomodoro-total-time" style="font-size:20px;font-weight:700;color:var(--ok);">0m</div>
               </div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() {
          if (!window.pomodoroState) {
            window.pomodoroState = {
              isRunning: false,
              isPaused: false,
              isBreak: false,
              timeLeft: 25 * 60,
              interval: null,
              completedToday: 0,
              totalTimeToday: 0
            };
          }
          updatePomodoroDisplay();
        }
      },
      "image-gallery": {
        id: "image-gallery",
        name: "Galería de Imágenes",
        description: "Guarda y organiza tus imágenes favoritas con URLs.",
        rarity: "poco_comun",
        type: "active",
        version: "1.0.0",
        icon: "🖼️",
        price: 100,
        getPanelHTML() {
          return `
        <div id="gallery-panel" style="padding:16px;">
          <div style="margin-bottom:20px;padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.08);">
            <h4 style="margin:0 0 12px;font-size:16px;">➕ Agregar Imagen</h4>
            <input type="text" id="gallery-url" placeholder="URL de la imagen" style="width:100%;padding:10px;border-radius:8px;background:var(--bg-2);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);margin-bottom:8px;">
            <input type="text" id="gallery-title" placeholder="Título (opcional)" style="width:100%;padding:10px;border-radius:8px;background:var(--bg-2);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);margin-bottom:8px;">
            <button class="btn primary" onclick="addImageToGallery()" style="width:100%;">Agregar a Galería</button>
          </div>
          
          <div id="gallery-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:16px;"></div>
          
          <div id="gallery-empty" style="text-align:center;padding:40px;color:var(--ink-1);display:none;">
            <div style="font-size:48px;margin-bottom:12px;">🖼️</div>
            <p style="margin:0;">No hay imágenes en tu galería</p>
            <p style="margin:8px 0 0;font-size:13px;opacity:.7;">Agrega URLs de imágenes para comenzar</p>
          </div>
        </div>
        
        <div id="gallery-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:10000;padding:20px;overflow:auto;" onclick="closeGalleryModal()">
          <div style="max-width:90vw;max-height:90vh;margin:auto;position:relative;" onclick="event.stopPropagation()">
            <button onclick="closeGalleryModal()" style="position:absolute;top:-40px;right:0;background:var(--danger);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;">✕ Cerrar</button>
            <img id="gallery-modal-img" src="" style="max-width:100%;max-height:90vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);">
            <div id="gallery-modal-title" style="text-align:center;margin-top:16px;font-size:18px;color:white;font-weight:600;"></div>
          </div>
        </div>
      `;
        },
        async onEnable() {
          loadGallery();
        }
      },
      "survey-rewards": {
        id: "survey-rewards",
        name: "Encuestas Rápidas",
        description: "Responde encuestas cortas y gana Ecoxionums. ¡Gratis!",
        rarity: "comun",
        type: "active",
        version: "1.0.0",
        icon: "📋",
        price: 0,
        defaultInstall: false,
        getPanelHTML() {
          return `
        <div id="survey-panel" style="padding:16px;">
          <div style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg, rgba(100,167,255,.1), rgba(179,136,255,.1));border-radius:12px;border:1px solid var(--accent);text-align:center;">
            <h4 style="margin:0 0 12px;color:var(--accent);">📋 Encuestas Disponibles</h4>
            <p style="margin:0 0 16px;color:var(--ink-1);font-size:14px;">Responde encuestas rápidas y gana entre 5-15 Ecoxionums por encuesta.</p>
            <div id="survey-list" style="display:flex;flex-direction:column;gap:12px;"></div>
          </div>
          
          <div style="padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.08);">
            <h4 style="margin:0 0 12px;font-size:15px;">📊 Tus Estadísticas</h4>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="color:var(--ink-1);">Encuestas completadas:</span>
                <span id="surveys-completed" style="font-weight:600;color:var(--accent);">0</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="color:var(--ink-1);">Total ganado:</span>
                <span id="surveys-earned" style="font-weight:600;color:var(--ok);">0 🪙</span>
              </div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() {
          loadSurveys();
        }
      },

      "comms-generator": {
        id: "comms-generator",
        name: "Generador de Comunicados",
        description: "Crea comunicados oficiales con estilo profesional. Elige plantillas y fondos.",
        tags: ["Nuevo", "Útil"],
        rarity: "epica",
        type: "active",
        version: "1.0.0",
        version2: "2.0.0",
        hasV2: true,
        v2Features: ["Fondos Animados", "Firma Digital Verificada", "Fuentes Premium"],
        icon: "📜",
        price: 750,
        missions: [
          { id: "create_1", title: "Primer Comunicado", description: "Crea tu primer comunicado.", target: 1, type: "count" },
          { id: "use_bg", title: "Explorador Visual", description: "Usa 3 fondos diferentes.", target: 3, type: "count" },
          { id: "comms_mastery", title: "Maestría: Embajador", description: "Genera 10 comunicados oficiales.", target: 10, type: "count" }
        ],
        getPanelHTML() {
          return `
            <style>
              .comms-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
              @media (max-width: 768px) { .comms-container { grid-template-columns: 1fr; } }
              
              .comms-form { background: var(--bg-1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
              .comms-form label { display: block; margin-bottom: 6px; color: var(--ink-1); font-size: 13px; font-weight: 600; }
              .comms-form input, .comms-form textarea, .comms-form select { 
                width: 100%; padding: 10px; margin-bottom: 12px; background: var(--bg-2); 
                border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--ink-0); 
              }
              
              .comms-preview-container { 
                background: #000 url('https://www.transparenttextures.com/patterns/dark-matter.png'); 
                border-radius: 12px; padding: 20px; min-height: 400px; display: flex; align-items: center; justify-content: center; 
                border: 1px solid rgba(255,255,255,0.1); overflow: hidden; position: relative;
              }
              
              .comms-preview {
                width: 100%; max-width: 360px; min-height: 500px; background: white; color: #000;
                padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative;
                transform-origin: center top; transition: all 0.3s ease;
                font-family: 'Times New Roman', serif;
              }
              
              /* Templates */
              .comms-tmpl-standard { border: 1px solid #ddd; }
              .comms-tmpl-alert { border: 4px solid #dc2626; background: #fff5f5; }
              .comms-tmpl-alert h1 { color: #dc2626; text-transform: uppercase; border-bottom: 2px solid #dc2626; padding-bottom: 10px; }
              .comms-tmpl-royal { border: 4px double #d4af37; background: #fffdf0; }
              .comms-tmpl-royal h1 { color: #d4af37; font-family: 'Cinzel', serif; text-align: center; font-size: 28px; }
              .comms-tmpl-cyber { background: #0a0e1a; color: #00ff41; border: 2px solid #00ff41; font-family: 'Courier New', monospace; }
              .comms-tmpl-cyber h1 { text-shadow: 0 0 10px #00ff41; text-transform: uppercase; }
              
              /* Backgrounds inside preview container to simulate environment */
              .comms-bg-office { background: #e2e8f0; color: #1e293b; }
              .comms-bg-space { background: radial-gradient(circle at center, #1e293b, #0f172a); color: #e2e8f0; }
              .comms-bg-cyber { background: linear-gradient(45deg, #1a0b2e, #110e1b); color: #00ff41; }
              .comms-bg-scroll { background: #fdf6e3 url('https://www.transparenttextures.com/patterns/wood-pattern.png'); color: #433422; }

              .preview-header { margin-bottom: 20px; }
              .preview-title { font-size: 24px; font-weight: bold; margin: 0 0 5px; line-height: 1.2; }
              .preview-subtitle { font-size: 14px; opacity: 0.7; font-style: italic; }
              .preview-meta { font-size: 12px; margin-bottom: 20px; border-bottom: 1px solid currentColor; padding-bottom: 10px; opacity: 0.8; display: flex; justify-content: space-between; }
              .preview-body { font-size: 14px; line-height: 1.6; white-space: pre-wrap; min-height: 200px; }
              .preview-footer { margin-top: 30px; text-align: right; }
              .preview-signature { font-family: 'Dancing Script', cursive; font-size: 24px; margin-bottom: 5px; }
              .preview-author { font-weight: bold; font-size: 12px; text-transform: uppercase; }
            </style>

            <div class="comms-container">
              <div class="comms-form">
                <h3>?? Configuraci?n</h3>
                <label>Plantilla de Texto (Contenido)</label>
                <select id="comm-text-preset" onchange="applyTextPreset()">
                  <option value="">-- Personalizado --</option>
                  <option value="notice">Aviso General</option>
                  <option value="urgent">Urgente / Alerta</option>
                  <option value="decree">Decreto Real</option>
                  <option value="system">Log del Sistema</option>
                </select>

                <label>Título del Comunicado</label>
                <input type="text" id="comm-title" placeholder="Ej: AVISO IMPORTANTE" oninput="updateCommsPreview()">
                
                <label>Subtítulo / Departamento</label>
                <input type="text" id="comm-subtitle" placeholder="Ej: Ministerio de Magia" oninput="updateCommsPreview()">
                
                <label>Fecha</label>
                <input type="date" id="comm-date" oninput="updateCommsPreview()">
                
                <label>Autor</label>
                <input type="text" id="comm-author" value="Administración" oninput="updateCommsPreview()">
                
                <label>Mensaje</label>
                <textarea id="comm-body" rows="6" placeholder="Escribe tu mensaje aquí..." oninput="updateCommsPreview()"></textarea>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <div>
                    <label>Diseño Visual</label>
                    <select id="comm-template" onchange="updateCommsPreview()">
                      <option value="standard">Estándar</option>
                      <option value="alert">Alerta Roja</option>
                      <option value="royal">Realeza</option>
                      <option value="cyber">Cyberpunk</option>
                    </select>
                  </div>
                  <div>
                    <label>Fondo de la Hoja</label>
                    <select id="comm-bg" onchange="updateCommsPreview()">
                      <option value="office">Oficina</option>
                      <option value="space">Espacio Profundo</option>
                      <option value="cyber">Neon City</option>
                      <option value="scroll">Mesa de Madera</option>
                    </select>
                  </div>
                </div>

                <div style="margin-top:20px; display:flex; gap:10px;">
                  <button class="btn primary" onclick="downloadComm()" style="flex:1;">💾 Guardar / Publicar</button>
                  <button class="btn" onclick="resetComm()" style="width:50px;">↺</button>
                </div>
              </div>

              <div class="comms-preview-container" id="comm-preview-bg">
                <div class="comms-preview comms-tmpl-standard" id="comm-card">
                  <div class="preview-header">
                    <div class="preview-title" id="prev-title">TÍTULO DEL COMUNICADO</div>
                    <div class="preview-subtitle" id="prev-subtitle">Subtítulo o Departamento</div>
                  </div>
                  <div class="preview-meta">
                    <span id="prev-date">2026-01-23</span>
                    <span>REF: <span id="prev-ref">XA-99</span></span>
                  </div>
                  <div class="preview-body" id="prev-body">
                    Escribe tu mensaje en el panel de la izquierda para ver cómo queda en tiempo real.
                  </div>
                  <div class="preview-footer">
                    <div class="preview-signature" id="prev-sig">Firma</div>
                    <div class="preview-author" id="prev-author">AUTORIZADO</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        },
        async onEnable() {
          window.applyTextPreset = function () {
            const preset = document.getElementById('comm-text-preset').value;
            if (!preset) return;

            const presets = {
              notice: {
                title: "AVISO GENERAL",
                subtitle: "Administración Central",
                body: "Por medio de la presente se informa a todos los usuarios sobre las nuevas actualizaciones del sistema.\n\nAgradecemos su colaboración.",
                template: "standard"
              },
              urgent: {
                title: "ALERTA DE SEGURIDAD",
                subtitle: "Departamento de Seguridad",
                body: "ATENCIÓN: Se ha detectado una anomalía en el sector 7.\n\nEvacuar inmediatamente. Esto no es un simulacro.",
                template: "alert"
              },
              decree: {
                title: "DECRETO REAL",
                subtitle: "La Corona",
                body: "Oíd, ciudadanos del reino.\n\nPor orden de Su Majestad, se declara día de festividad nacional en honor a los héroes de la tormenta.",
                template: "royal"
              },
              system: {
                title: "SYSTEM LOG",
                subtitle: "Root Access",
                body: "Initializing boot sequence...\nLoading modules...\n> Ecoxion Core: ONLINE\n> Security: BYPASSED\n\nWelcome back, User.",
                template: "cyber"
              }
            };

            const data = presets[preset];
            if (data) {
              document.getElementById('comm-title').value = data.title;
              document.getElementById('comm-subtitle').value = data.subtitle;
              document.getElementById('comm-body').value = data.body;

              // Opcional: Cambiar también el diseño visual si coincide
              document.getElementById('comm-template').value = data.template;

              updateCommsPreview();
            }
          };

          window.updateCommsPreview = function () {
            const title = document.getElementById('comm-title').value || 'TÍTULO DEL COMUNICADO';
            const subtitle = document.getElementById('comm-subtitle').value || 'Subtítulo o Departamento';
            const date = document.getElementById('comm-date').value || new Date().toISOString().split('T')[0];
            const author = document.getElementById('comm-author').value || 'ADMINISTRACIÓN';
            const body = document.getElementById('comm-body').value || 'Escribe tu mensaje...';
            const template = document.getElementById('comm-template').value;
            const bg = document.getElementById('comm-bg').value;

            document.getElementById('prev-title').textContent = title;
            document.getElementById('prev-subtitle').textContent = subtitle;
            document.getElementById('prev-date').textContent = date;
            document.getElementById('prev-author').textContent = author;
            document.getElementById('prev-body').textContent = body;

            // Signature (pseudo)
            document.getElementById('prev-sig').textContent = author.split(' ')[0] || 'Firma';

            // Refs
            document.getElementById('prev-ref').textContent = 'COM-' + Math.floor(Math.random() * 1000);

            // Classes - Apply BG to the CARD (Paper), not the container
            const card = document.getElementById('comm-card');
            card.className = `comms-preview comms-tmpl-${template} comms-bg-${bg}`;

            // Container always keeps its default dark style
            const container = document.getElementById('comm-preview-bg');
            container.className = `comms-preview-container`;
          };

          window.downloadComm = function () {
            showAlert('success', 'Guardado', 'El comunicado ha sido guardado en tus archivos locales.');
          };

          window.resetComm = function () {
            document.getElementById('comm-title').value = '';
            document.getElementById('comm-body').value = '';
            updateCommsPreview();
          };

          // Init date
          document.getElementById('comm-date').value = new Date().toISOString().split('T')[0];
        }
      },
      "trivia-challenge": {
        id: "trivia-challenge",
        name: "Trivia Challenge",
        description: "Responde preguntas de trivia y gana Ecoxionums. ¡Demuestra tu conocimiento!",
        rarity: "epica",
        type: "active",
        version: "1.0.0",
        icon: "🎯",
        price: 150,
        getPanelHTML() {
          return `
        <div id="trivia-panel" style="padding:16px;">
          <div style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg, rgba(147,51,234,.15), rgba(79,70,229,.15));border-radius:16px;border:2px solid rgba(147,51,234,.4);text-align:center;">
            <h3 style="margin:0 0 8px;color:#a855f7;font-size:24px;">🎯 Trivia Challenge</h3>
            <p style="margin:0 0 16px;color:var(--ink-1);font-size:14px;">Responde correctamente y gana 5-25 Ecoxionums por pregunta</p>
            <div id="trivia-question-box" style="display:none;padding:20px;background:var(--bg-1);border-radius:12px;margin-bottom:16px;">
              <div id="trivia-category" style="font-size:12px;color:var(--accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;"></div>
              <div id="trivia-question" style="font-size:18px;font-weight:600;color:var(--ink-0);margin-bottom:16px;"></div>
              <div id="trivia-answers" style="display:flex;flex-direction:column;gap:10px;"></div>
              <div id="trivia-timer" style="margin-top:16px;font-size:24px;font-weight:700;color:var(--accent);"></div>
            </div>
            <div id="trivia-result" style="display:none;padding:20px;background:var(--bg-1);border-radius:12px;margin-bottom:16px;"></div>
            <button id="trivia-start-btn" class="btn primary" onclick="startTrivia()" style="width:100%;font-size:16px;padding:14px;">🎮 Iniciar Trivia</button>
          </div>
          <div style="padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.08);">
            <h4 style="margin:0 0 12px;font-size:15px;">📊 Estadísticas</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div style="padding:12px;background:rgba(255,255,255,.03);border-radius:8px;text-align:center;">
                <div style="font-size:24px;font-weight:700;color:var(--accent);" id="trivia-correct">0</div>
                <div style="font-size:12px;color:var(--ink-1);">Correctas</div>
              </div>
              <div style="padding:12px;background:rgba(255,255,255,.03);border-radius:8px;text-align:center;">
                <div style="font-size:24px;font-weight:700;color:var(--ok);" id="trivia-earned">0</div>
                <div style="font-size:12px;color:var(--ink-1);">Ecoxionums ganados</div>
              </div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() { initTrivia(); }
      },
      "music-player": {
        id: "music-player",
        name: "Music Player",
        description: "Reproductor de música con estaciones de radio online. Escucha mientras trabajas.",
        rarity: "poco_comun",
        type: "active",
        version: "1.0.0",
        icon: "🎵",
        price: 200,
        getPanelHTML() {
          return `
        <div id="music-panel" style="padding:16px;">
          <div style="padding:24px;background:linear-gradient(135deg, rgba(236,72,153,.12), rgba(168,85,247,.12));border-radius:16px;border:1px solid rgba(236,72,153,.3);text-align:center;margin-bottom:20px;">
            <div id="music-visualizer" style="height:60px;display:flex;align-items:flex-end;justify-content:center;gap:4px;margin-bottom:16px;">
              ${Array(20).fill(0).map((_, i) => `<div class="music-bar" style="width:8px;height:${10 + Math.random() * 40}px;background:linear-gradient(180deg,#ec4899,#8b5cf6);border-radius:4px;transition:height .1s;"></div>`).join('')}
            </div>
            <div id="music-now-playing" style="font-size:18px;font-weight:600;color:var(--ink-0);margin-bottom:4px;">Selecciona una estación</div>
            <div id="music-station-name" style="font-size:13px;color:var(--ink-1);">---</div>
          </div>
          <div style="display:flex;gap:12px;justify-content:center;margin-bottom:20px;">
            <button class="btn" onclick="musicPrev()" style="width:50px;height:50px;border-radius:50%;font-size:20px;">⏮️</button>
            <button id="music-play-btn" class="btn primary" onclick="musicToggle()" style="width:70px;height:70px;border-radius:50%;font-size:28px;">▶️</button>
            <button class="btn" onclick="musicNext()" style="width:50px;height:50px;border-radius:50%;font-size:20px;">⏭️</button>
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--ink-1);">🔊 Volumen</label>
            <input type="range" id="music-volume" min="0" max="100" value="70" style="width:100%;" onchange="setMusicVolume(this.value)">
          </div>
          <div style="padding:16px;background:var(--bg-1);border-radius:12px;">
            <h4 style="margin:0 0 12px;font-size:14px;">📻 Estaciones</h4>
            <div id="music-stations" style="display:flex;flex-direction:column;gap:8px;">
              <div class="music-station" onclick="selectStation(0)" style="padding:12px;background:rgba(255,255,255,.03);border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s;">
                <span style="font-size:24px;">🎸</span><div><div style="font-weight:600;">Lo-Fi Beats</div><div style="font-size:12px;color:var(--ink-1);">Relax & Focus</div></div>
              </div>
              <div class="music-station" onclick="selectStation(1)" style="padding:12px;background:rgba(255,255,255,.03);border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s;">
                <span style="font-size:24px;">🎹</span><div><div style="font-weight:600;">Classical</div><div style="font-size:12px;color:var(--ink-1);">Piano & Orchestra</div></div>
              </div>
              <div class="music-station" onclick="selectStation(2)" style="padding:12px;background:rgba(255,255,255,.03);border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s;">
                <span style="font-size:24px;">🎤</span><div><div style="font-weight:600;">Pop Hits</div><div style="font-size:12px;color:var(--ink-1);">Top Charts</div></div>
              </div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() { initMusicPlayer(); }
      },
      "habit-tracker": {
        id: "habit-tracker",
        name: "Habit Tracker",
        description: "Crea y sigue tus hábitos diarios. Gana Ecoxionums por mantener rachas.",
        rarity: "raro",
        type: "active",
        version: "1.0.0",
        icon: "📊",
        price: 300,
        getPanelHTML() {
          return `
        <div id="habit-panel" style="padding:16px;">
          <div style="margin-bottom:20px;padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid rgba(255,255,255,.08);">
            <h4 style="margin:0 0 12px;font-size:15px;">➕ Nuevo Hábito</h4>
            <div style="display:flex;gap:8px;">
              <input type="text" id="habit-name" placeholder="Nombre del hábito..." style="flex:1;padding:10px;border-radius:8px;background:var(--bg-2);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);">
              <select id="habit-icon" style="padding:10px;border-radius:8px;background:var(--bg-2);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);font-size:18px;">
                <option>💪</option><option>📚</option><option>🏃</option><option>💧</option><option>🧘</option><option>💤</option><option>🥗</option><option>✍️</option>
              </select>
              <button class="btn primary" onclick="addHabit()">+</button>
            </div>
          </div>
          <div id="habits-list" style="display:flex;flex-direction:column;gap:12px;"></div>
          <div id="habits-empty" style="text-align:center;padding:40px;color:var(--ink-1);display:none;">
            <div style="font-size:48px;margin-bottom:12px;">📊</div>
            <p>No tienes hábitos. ¡Crea uno!</p>
          </div>
          <div style="margin-top:20px;padding:16px;background:linear-gradient(135deg, rgba(16,185,129,.1), rgba(52,211,153,.1));border-radius:12px;border:1px solid rgba(16,185,129,.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="color:var(--ink-1);">🏆 Ecoxionums por rachas:</span>
              <span id="habit-earnings" style="font-weight:700;color:var(--ok);">0 🪙</span>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() { loadHabits(); }
      },
      "weather-widget": {
        id: "weather-widget",
        name: "Weather Widget",
        description: "Consulta el clima actual y pronóstico de cualquier ciudad.",
        rarity: "comun",
        type: "active",
        version: "1.0.0",
        icon: "🌤️",
        price: 0,
        getPanelHTML() {
          return `
        <div id="weather-panel" style="padding:16px;">
          <div style="margin-bottom:20px;">
            <div style="display:flex;gap:8px;">
              <input type="text" id="weather-city" placeholder="Ingresa una ciudad..." style="flex:1;padding:12px;border-radius:8px;background:var(--bg-1);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);">
              <button class="btn primary" onclick="searchWeather()">🔍</button>
            </div>
          </div>
          <div id="weather-display" style="padding:32px;background:linear-gradient(135deg, rgba(59,130,246,.15), rgba(147,197,253,.15));border-radius:20px;border:1px solid rgba(59,130,246,.3);text-align:center;">
            <div id="weather-icon" style="font-size:72px;margin-bottom:8px;">🌤️</div>
            <div id="weather-temp" style="font-size:48px;font-weight:800;color:var(--ink-0);margin-bottom:4px;">--°C</div>
            <div id="weather-desc" style="font-size:16px;color:var(--ink-1);text-transform:capitalize;margin-bottom:16px;">Busca una ciudad</div>
            <div id="weather-location" style="font-size:14px;color:var(--accent);font-weight:600;">---</div>
          </div>
          <div id="weather-details" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;">
            <div style="padding:16px;background:var(--bg-1);border-radius:12px;text-align:center;">
              <div style="font-size:24px;margin-bottom:4px;">💧</div>
              <div id="weather-humidity" style="font-weight:600;color:var(--ink-0);">--%</div>
              <div style="font-size:11px;color:var(--ink-1);">Humedad</div>
            </div>
            <div style="padding:16px;background:var(--bg-1);border-radius:12px;text-align:center;">
              <div style="font-size:24px;margin-bottom:4px;">💨</div>
              <div id="weather-wind" style="font-weight:600;color:var(--ink-0);">-- km/h</div>
              <div style="font-size:11px;color:var(--ink-1);">Viento</div>
            </div>
            <div style="padding:16px;background:var(--bg-1);border-radius:12px;text-align:center;">
              <div style="font-size:24px;margin-bottom:4px;">🌡️</div>
              <div id="weather-feels" style="font-weight:600;color:var(--ink-0);">--°C</div>
              <div style="font-size:11px;color:var(--ink-1);">Sensación</div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() { initWeather(); }
      },
      "eco-miner": {
        id: "eco-miner",
        name: "Eco Miner",
        description: "Minería automática de Ecoxionums. Déjalo funcionando y gana pasivamente.",
        rarity: "epica",
        type: "active",
        version: "1.0.0",
        icon: "⛏️",
        price: 500,
        getPanelHTML() {
          return `
        <div id="miner-panel" style="padding:16px;">
          <div style="padding:24px;background:linear-gradient(135deg, rgba(245,158,11,.12), rgba(251,191,36,.12));border-radius:16px;border:2px solid rgba(245,158,11,.4);text-align:center;margin-bottom:20px;">
            <div id="miner-animation" style="font-size:64px;margin-bottom:16px;">⛏️</div>
            <div id="miner-status" style="font-size:18px;font-weight:600;color:var(--ink-0);margin-bottom:8px;">Minero Inactivo</div>
            <div style="font-size:14px;color:var(--ink-1);margin-bottom:16px;">0.5-2 Ecoxionums cada 30 seg</div>
            <button id="miner-toggle-btn" class="btn primary" onclick="toggleMiner()" style="width:100%;font-size:16px;padding:14px;">⛏️ Iniciar Minería</button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div style="padding:16px;background:var(--bg-1);border-radius:12px;text-align:center;">
              <div style="font-size:28px;font-weight:700;color:var(--ok);" id="miner-total">0</div>
              <div style="font-size:12px;color:var(--ink-1);">Total Minado</div>
            </div>
            <div style="padding:16px;background:var(--bg-1);border-radius:12px;text-align:center;">
              <div style="font-size:28px;font-weight:700;color:var(--accent);" id="miner-session">0</div>
              <div style="font-size:12px;color:var(--ink-1);">Esta Sesión</div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() { initMiner(); }
      },
      "mini-games": {
        id: "mini-games",
        name: "Ecoxion Arcade",
        description: "Estación de juegos retro sin límites. Snake, Memory y el nuevo Neon Jump. ¡Compite por el high score!",
        rarity: "raro",
        type: "active",
        version: "2.0.0",
        icon: "🕹️",
        price: 350,
        getPanelHTML() {
          return `
        <div id="arcade-panel" style="padding:20px; color:var(--ink-0);">
          <div style="text-align:center; margin-bottom:24px;">
            <h3 style="margin:0; font-size:28px; background:linear-gradient(to right, #f09, #30f); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:900; letter-spacing:2px; text-transform:uppercase;">ARCADE STATION</h3>
            <p style="margin:4px 0 0; color:var(--ink-1); font-size:12px; letter-spacing:1px;">INSERT COIN TO PLAY</p>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
            <!-- Neon Jump Card -->
            <div onclick="startArcadeGame('neon-jump')" class="arcade-card">
              <div class="arcade-screen" style="background:linear-gradient(to bottom, #111, #220033);">
                <div style="font-size:48px; filter:drop-shadow(0 0 10px #f0f);">🦖</div>
              </div>
              <div class="arcade-info">
                <h4>Neon Jump</h4>
                <p>Esquiva obstáculos en este endless runner neón.</p>
                <div class="arcade-score">
                  <span>🏆 High Score:</span>
                  <span id="score-neon-jump">0</span>
                </div>
              </div>
            </div>

            <!-- Snake Card -->
            <div onclick="startArcadeGame('snake')" class="arcade-card">
              <div class="arcade-screen" style="background:linear-gradient(to bottom, #001100, #002200);">
                <div style="font-size:48px; filter:drop-shadow(0 0 10px #0f0);">🐍</div>
              </div>
              <div class="arcade-info">
                <h4>Cyber Snake</h4>
                <p>El clásico inmortal con un toque cyberpunk.</p>
                <div class="arcade-score">
                  <span>🏆 High Score:</span>
                  <span id="score-snake">0</span>
                </div>
              </div>
            </div>

            <!-- Memory Card -->
            <div onclick="startArcadeGame('memory')" class="arcade-card">
              <div class="arcade-screen" style="background:linear-gradient(to bottom, #000022, #000044);">
                <div style="font-size:48px; filter:drop-shadow(0 0 10px #00f);">🧠</div>
              </div>
              <div class="arcade-info">
                <h4>Memory Matrix</h4>
                <p>Pon a prueba tu memoria visual contra el reloj.</p>
                <div class="arcade-score">
                  <span>🏆 Best Time:</span>
                  <span id="score-memory">--</span>
                </div>
              </div>
            </div>
          </div>
          
          <style>
            .arcade-card {
              background: #1a1a2e;
              border: 2px solid #2a2a4e;
              border-radius: 16px;
              overflow: hidden;
              cursor: pointer;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              box-shadow: 0 4px 0 #161625;
            }
            .arcade-card:hover {
              transform: translateY(-4px);
              box-shadow: 0 8px 0 #161625, 0 0 20px rgba(100, 100, 255, 0.2);
              border-color: var(--accent);
            }
            .arcade-card:active {
              transform: translateY(0);
              box-shadow: 0 2px 0 #161625;
            }
            .arcade-screen {
              height: 120px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-bottom: 2px solid #2a2a4e;
              position: relative;
            }
            .arcade-screen::after {
              content: '';
              position: absolute;
              inset: 0;
              background: linear-gradient(rgba(255,255,255,0.05) 50%, transparent 50%);
              background-size: 100% 4px;
              pointer-events: none;
            }
            .arcade-info {
              padding: 16px;
            }
            .arcade-info h4 {
              margin: 0 0 4px;
              color: #fff;
              font-family: 'Courier New', monospace;
              letter-spacing: -0.5px;
            }
            .arcade-info p {
              margin: 0 0 12px;
              font-size: 12px;
              color: var(--ink-1);
            }
            .arcade-score {
              display: flex;
              justify-content: space-between;
              font-size: 11px;
              color: var(--accent);
              font-weight: 700;
              text-transform: uppercase;
              background: rgba(0,0,0,0.3);
              padding: 6px 10px;
              border-radius: 6px;
            }
          </style>

          <div id="arcade-game-container" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:5000; padding:20px; overflow:auto;">
            <div style="max-width:800px; margin:0 auto; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center;">
              <button onclick="closeArcadeGame()" style="position:absolute; top:20px; right:20px; background:transparent; border:none; color:#fff; font-size:16px; cursor:pointer;">✕ CERRAR</button>
              <div id="arcade-viewport" style="width:100%; text-align:center;"></div>
            </div>
          </div>
        </div>
      `;
        },
        async onEnable() {
          updateArcadeHighScores();
        }
      },
      "quick-chat": {
        id: "quick-chat",
        name: "Quick Chat",
        description: "Chat comunitario con otros usuarios de Ecoxion.",
        rarity: "poco_comun",
        type: "active",
        version: "1.0.0",
        icon: "💬",
        price: 100,
        getPanelHTML() {
          return `
        <div id="chat-panel" style="padding:20px; color:var(--ink-1); display:flex; flex-direction:column; height:450px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin:0; font-size:18px; color:var(--accent); display:flex; align-items:center; gap:8px;">
              <span>💬</span> Quick Chat (Ecoxion Community)
            </h3>
            <div id="chat-status" style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--ok);">
              <span style="width:8px; height:8px; background:var(--ok); border-radius:50%; box-shadow:0 0 8px var(--ok);"></span>
               Conectado
            </div>
          </div>

          <div id="chat-messages" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:12px; padding:10px; background:rgba(0,0,0,0.2); border-radius:16px; border:1px solid rgba(255,255,255,0.05); margin-bottom:16px; scroll-behavior:smooth;">
            <div style="text-align:center; padding:20px; color:var(--ink-2); font-size:13px;">Iniciando conexión segura...</div>
          </div>

          <div style="display:flex; gap:10px; background:rgba(255,255,255,0.03); padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,0.08);">
            <input type="text" id="chat-input" placeholder="Envía un mensaje a la comunidad..." 
              style="flex:1; padding:12px; border:none; background:transparent; color:var(--ink-0); font-size:14px; outline:none;" 
              onkeypress="if(event.key==='Enter')sendChatMessage()">
            <button class="btn primary" onclick="sendChatMessage()" style="width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; padding:0;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
          </div>
        </div>
      `;
        },
        async onEnable() { initQuickChat(); }
      },
      "mini-calendar": {
        id: "mini-calendar",
        name: "Mini Calendar Pro",
        description: "Calendario avanzado con categorías y lista de agenda.",
        rarity: "poco_comun",
        type: "active",
        version: "2.0.0",
        icon: "📅",
        price: 150,
        getPanelHTML() {
          return `
        <div id="calendar-panel" style="padding:20px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <button class="btn" onclick="calendarPrevMonth()" style="width:40px; height:40px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">◀</button>
            <h3 id="calendar-month-title" style="margin:0; font-size:20px; color:var(--ink-0); font-weight:700;">Diciembre 2025</h3>
            <button class="btn" onclick="calendarNextMonth()" style="width:40px; height:40px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">▶</button>
          </div>
          
          <div id="calendar-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:24px;"></div>
          
          <div style="background:var(--bg-1); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.1);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
              <h4 style="margin:0; font-size:16px; color:var(--ink-0);">📅 Agenda</h4>
              <button class="btn primary" onclick="toggleAddEventForm()" style="font-size:12px; padding:6px 12px;">+ Nuevo Evento</button>
            </div>

            <div id="add-event-form" style="display:none; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.08); animation: fadeIn 0.3s ease;">
              <input type="text" id="event-title" placeholder="Título del evento..." style="width:100%; padding:12px; border-radius:10px; background:var(--bg-2); border:1px solid rgba(255,255,255,0.1); color:var(--ink-0); margin-bottom:10px;">
              <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="date" id="event-date" style="flex:1; padding:12px; border-radius:10px; background:var(--bg-2); border:1px solid rgba(255,255,255,0.1); color:var(--ink-0);">
                <select id="event-type" style="flex:1; padding:12px; border-radius:10px; background:var(--bg-2); border:1px solid rgba(255,255,255,0.1); color:var(--ink-0);">
                  <option value="personal">👤 Personal</option>
                  <option value="work">💼 Trabajo</option>
                  <option value="important">⭐ Importante</option>
                </select>
              </div>
              <div style="display:flex; gap:8px;">
                 <button class="btn primary" onclick="addCalendarEvent()" style="flex:1;">Guardar Evento</button>
                 <button class="btn" onclick="toggleAddEventForm()" style="flex:0 0 auto;">Cancelar</button>
              </div>
            </div>

            <div id="calendar-events" style="display:flex; flex-direction:column; gap:10px;"></div>
          </div>
        </div>
      `;
        },
        async onEnable() { initCalendar(); }
      }
    };

    // Cargar notas
    function loadNotes() {
      const notes = JSON.parse(localStorage.getItem('ecoxion.notes') || '[]');
      const list = document.getElementById('notes-list');
      if (!list) return;

      if (notes.length === 0) {
        list.innerHTML = '<p style="color:var(--ink-1);text-align:center;padding:20px;">No hay notas aún. Crea tu primera nota arriba.</p>';
        return;
      }

      list.innerHTML = notes.map((note, i) => `
    <div class="card" style="margin-bottom:12px;padding:16px;">
      <h4 style="margin:0 0 8px;font-size:16px;">${note.title}</h4>
      <p style="margin:0 0 12px;color:var(--ink-1);font-size:13px;max-height:60px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;">${note.content}</p>
      <div style="display:flex;gap:8px;">
        <button class="btn primary" onclick="viewNoteDetail(${i})" style="flex:1;">📖 Ver Detalle</button>
        <button class="btn" onclick="deleteNote(${i})">🗑️ Eliminar</button>
      </div>
    </div>
  `).join('');
    }

    window.saveNote = async function () {
      const title = document.getElementById('note-title')?.value;
      const content = document.getElementById('note-content')?.value;
      if (!title || !content) {
        showAlert('warning', 'Campos vacíos', 'Por favor completa el título y contenido de la nota.');
        return;
      }

      const notes = JSON.parse(localStorage.getItem('ecoxion.notes') || '[]');
      const newNote = { title, content, date: Date.now(), viewed: false };
      notes.push(newNote);
      localStorage.setItem('ecoxion.notes', JSON.stringify(notes));

      // Verificar misión de nota extensa (más de 100 caracteres)
      if (content.length > 100) {
        const state = await loadState();
        if (!state.missionProgress) state.missionProgress = {};
        if (!state.missionProgress.notes) state.missionProgress.notes = {};
        if (!state.missionProgress.notes.note_length) {
          state.missionProgress.notes.note_length = { current: 1, completed: true };
          await saveState(state);
        }
      }

      document.getElementById('note-title').value = '';
      document.getElementById('note-content').value = '';
      loadNotes();
      showAlert('success', 'Nota guardada', 'Tu nota se ha guardado correctamente.');
    };

    window.deleteNote = function (index) {
      const notes = JSON.parse(localStorage.getItem('ecoxion.notes') || '[]');
      notes.splice(index, 1);
      localStorage.setItem('ecoxion.notes', JSON.stringify(notes));
      loadNotes();
      showAlert('info', 'Nota eliminada', 'La nota se ha eliminado.');
    };

    window.viewNoteDetail = async function (index) {
      const notes = JSON.parse(localStorage.getItem('ecoxion.notes') || '[]');
      const note = notes[index];
      if (!note) return;

      // Asegurar que la nota tenga la propiedad viewed
      if (note.viewed === undefined) {
        note.viewed = false;
      }

      // Marcar como vista si no estaba vista antes
      let wasViewed = note.viewed === true;
      if (!wasViewed) {
        note.viewed = true;
        notes[index] = note;
        localStorage.setItem('ecoxion.notes', JSON.stringify(notes));

        // Actualizar tracking de misión "use_notes"
        const state = await loadState();
        if (!state.missionProgress) state.missionProgress = {};
        if (!state.missionProgress.notes) state.missionProgress.notes = {};
        if (!state.missionProgress.notes.use_notes) {
          state.missionProgress.notes.use_notes = { current: 0, completed: false };
        }

        // Contar cuántas notas únicas han sido vistas
        const viewedNotes = notes.filter(n => n.viewed === true).length;
        state.missionProgress.notes.use_notes.current = viewedNotes;
        state.missionProgress.notes.use_notes.completed = viewedNotes >= 2;

        await saveState(state);
      }

      // Crear modal para ver la nota
      const modal = document.createElement('div');
      modal.className = 'missions-modal';
      modal.style.zIndex = '9999';
      modal.innerHTML = `
    <div class="missions-container" style="max-width:700px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="margin:0;font-size:24px;color:var(--ink-0);">${note.title}</h2>
        <button class="btn" onclick="this.closest('.missions-modal').remove()" style="padding:8px 12px;">✕ Cerrar</button>
      </div>
      <div style="background:var(--bg-1);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,.1);margin-bottom:16px;">
        <div style="color:var(--ink-0);font-size:15px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;">${note.content}</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding-top:16px;border-top:1px solid rgba(255,255,255,.1);">
        <small style="color:var(--ink-1);">Creada: ${new Date(note.date).toLocaleString()}</small>
        <button class="btn" onclick="deleteNote(${index}); this.closest('.missions-modal').remove();" style="background:rgba(255,107,107,.2);border-color:var(--danger);color:var(--danger);">🗑️ Eliminar</button>
      </div>
    </div>
  `;

      document.body.appendChild(modal);

      setTimeout(() => {
        modal.classList.add('active');
      }, 10);

      // Cerrar al hacer click fuera
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          gsap.to(modal, {
            opacity: 0,
            scale: 0.9,
            duration: 0.3,
            onComplete: () => modal.remove()
          });
        }
      });
    };

    // Cargar anuncios
    function loadAnnouncements() {
      const list = document.getElementById('announcements-list');
      if (!list) return;
      list.innerHTML = `
    <div class="card" style="margin-bottom:12px;padding:16px;border-left:3px solid var(--accent);">
      <h4 style="margin:0 0 8px;">🌌 Bienvenido a Ecoxion</h4>
      <p style="margin:0;color:var(--ink-1);font-size:13px;">Ecoxion ha sido renovado con una base más limpia y moderna.</p>
    </div>
  `;
    }

    // Funciones de Blog
    window.publishBlog = async function () {
      const title = document.getElementById('blog-title')?.value;
      const content = document.getElementById('blog-content')?.value;
      if (!title || !content) {
        showAlert('error', 'Campos vacíos', 'Completa título y contenido.');
        return;
      }

      const state = await loadState();
      const author = state.username || 'Anónimo';

      try {
        const res = await fetch(`${API_GLOBAL}/api/blogs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content, author })
        });

        if (res.ok) {
          showAlert('success', 'Blog publicado', 'Tu blog se ha publicado correctamente.');
          document.getElementById('blog-title').value = '';
          document.getElementById('blog-content').value = '';
          loadBlogs();
        } else {
          throw new Error('Error al publicar');
        }
      } catch (e) {
        showAlert('error', 'Error', 'No se pudo publicar el blog. Intenta más tarde.');
      }
    };

    async function loadBlogs() {
      const list = document.getElementById('blogs-list');
      if (!list) return;

      try {
        const res = await fetch(`${API_GLOBAL}/api/blogs`);
        const blogs = await res.json();

        if (!Array.isArray(blogs) || blogs.length === 0) {
          list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--ink-2); background:rgba(255,255,255,0.01); border-radius:12px; border:1px dashed rgba(255,255,255,0.1);">No hay blogs aún. ¡Sé el primero en compartir!</div>';
          return;
        }

        list.innerHTML = blogs.map(blog => {
          const date = new Date(blog.created_at || blog.createdAt).toLocaleDateString('es-ES', {
            day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
          });
          const initial = (blog.author || 'A').charAt(0).toUpperCase();

          return `
            <div class="card" style="margin:0; padding:20px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; transition:all 0.3s; cursor:default;"
              onmouseenter="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(100,167,255,0.3)';"
              onmouseleave="this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.08)';"
            >
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:14px;">
                <div style="width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:16px; box-shadow:0 4px 10px rgba(0,0,0,0.2);">
                  ${initial}
                </div>
                <div>
                  <div style="font-size:13px; font-weight:700; color:var(--ink-0);">${blog.author || 'Anónimo'}</div>
                  <div style="font-size:11px; color:var(--ink-2);">${date}</div>
                </div>
              </div>
              <h4 style="margin:0 0 10px; font-size:18px; color:var(--ink-0); font-weight:700; line-height:1.3;">${blog.title}</h4>
              <p style="margin:0; color:var(--ink-1); font-size:14px; line-height:1.6; white-space:pre-wrap; display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden;">${blog.content}</p>
              
              <div style="margin-top:16px; display:flex; gap:10px;">
                <button class="btn" style="padding:6px 12px; font-size:12px; opacity:0.8;" onclick="showAlert('info', 'Guardado', 'Copiado al portapapeles')">🔗 Enlace</button>
                <button class="btn like-btn" style="padding:6px 12px; font-size:12px; opacity:0.8;" onclick="likeBlog(${blog.id}, this)">❤️ ${blog.likes || 0}</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        list.innerHTML = '<div style="color:var(--danger); text-align:center; padding:20px;">⚠️ Error al conectar con la red de blogs.</div>';
      }
    }

    window.likeBlog = async function (id, btn) {
      try {
        const res = await fetch(`${API_GLOBAL}/api/blogs/${id}/like`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          btn.innerHTML = `❤️ ${data.likes}`;
          btn.style.color = 'var(--warn)';
          btn.style.borderColor = 'var(--warn)';
        }
      } catch (e) {
        console.error('Error liking blog:', e);
      }
    };

    /* =========================
       GENERADOR DE ECOXIONUMS
       ========================= */
    async function updateGeneratorPanel() {
      const statusEl = document.getElementById('daily-reward-status');
      const claimBtn = document.getElementById('claim-daily-btn');
      const streakEl = document.getElementById('streak-days');
      const totalEl = document.getElementById('total-earned');
      const countEl = document.getElementById('rewards-count');

      if (!statusEl || !claimBtn) return;

      const state = await loadState();
      const generatorData = state.generatorData || {
        lastClaim: null,
        streak: 0,
        totalEarned: 0,
        rewardsCount: 0
      };

      // Actualizar estadísticas y nueva UI
      const streakBadge = document.getElementById('streak-badge');
      if (streakBadge) streakBadge.textContent = `Racha: ${generatorData.streak || 0} días`;

      if (streakEl) streakEl.textContent = generatorData.streak || 0;
      if (totalEl) totalEl.textContent = `${(generatorData.totalEarned || 0).toLocaleString()} 🪙`;
      if (countEl) countEl.textContent = generatorData.rewardsCount || 0;

      // Verificar si puede reclamar
      const now = Date.now();
      const lastClaim = generatorData.lastClaim ? new Date(generatorData.lastClaim) : null;

      if (!lastClaim) {
        statusEl.innerHTML = '<p style="color:var(--ok);margin:0;font-weight:700;">? ?El reactor est? listo!</p>';
        claimBtn.disabled = false;
        claimBtn.innerHTML = 'Reclamar Recompensa';
        claimBtn.style.opacity = '1';
        return;
      }

      const timeSinceLastClaim = now - lastClaim.getTime();
      const hoursSinceLastClaim = timeSinceLastClaim / (1000 * 60 * 60);
      const canClaim = hoursSinceLastClaim >= 20; // Puede reclamar cada 20 horas

      if (canClaim) {
        statusEl.innerHTML = '<p style="color:var(--ok);margin:0;font-weight:700;">✅ ¡Energía acumulada!</p>';
        claimBtn.disabled = false;
        claimBtn.innerHTML = 'Reclamar Recompensa';
        claimBtn.style.opacity = '1';
      } else {
        const hoursLeft = 20 - hoursSinceLastClaim;
        const h = Math.floor(hoursLeft);
        const m = Math.floor((hoursLeft - h) * 60);
        statusEl.innerHTML = `<p style="color:var(--ink-1);margin:0;">Generando energía... <br>Disponibile en: <strong>${h}h ${m}m</strong></p>`;
        claimBtn.disabled = true;
        claimBtn.innerHTML = 'Generando...';
        claimBtn.style.opacity = '0.7';
      }
    }

    window.claimDailyReward = async function () {
      const state = await loadState();
      const generatorData = state.generatorData || {
        lastClaim: null,
        streak: 0,
        totalEarned: 0,
        rewardsCount: 0
      };

      const now = Date.now();
      const lastClaim = generatorData.lastClaim ? new Date(generatorData.lastClaim) : null;

      if (lastClaim) {
        const timeSinceLastClaim = now - lastClaim.getTime();
        const hoursSinceLastClaim = timeSinceLastClaim / (1000 * 60 * 60);

        if (hoursSinceLastClaim < 20) {
          const hoursLeft = 20 - hoursSinceLastClaim;
          showAlert('warning', 'Aún no disponible', `Debes esperar ${Math.ceil(hoursLeft)} horas más.`);
          return;
        }
      }

      let baseReward = 50 + Math.floor(Math.random() * 101);
      const streak = generatorData.streak || 0;
      let streakBonus = 0;

      if (streak >= 7) streakBonus = Math.floor(baseReward * 0.5);
      else if (streak >= 3) streakBonus = Math.floor(baseReward * 0.25);

      let luckBonus = 0;
      if (Math.random() < 0.1) {
        luckBonus = 50 + Math.floor(Math.random() * 50);
        showAlert('success', '?Buen rollo!', 'Has recibido un bonus de suerte. ??');
      }

      const totalReward = baseReward + streakBonus + luckBonus;

      const lastClaimTime = lastClaim ? lastClaim.getTime() : 0;
      const hoursSinceLast = (now - lastClaimTime) / (1000 * 60 * 60);
      const newStreak = hoursSinceLast <= 28 ? (streak + 1) : 1;

      generatorData.lastClaim = new Date().toISOString();
      generatorData.streak = newStreak;
      generatorData.totalEarned = (generatorData.totalEarned || 0) + totalReward;
      generatorData.rewardsCount = (generatorData.rewardsCount || 0) + 1;

      state.generatorData = generatorData;

      // Usar awardEcoxionums para consistencia
      await awardEcoxionums(totalReward, `Generador - Racha ${newStreak}`);

      // Guardar datos específicos del generador
      state.ecoxionums = (await loadState()).ecoxionums;
      state.generatorData = generatorData;
      await saveState(state);

      updateGeneratorPanel();

      let message = `Has recibido ${totalReward.toLocaleString()} Ecoxionums`;
      if (streakBonus > 0) message += ` (+${streakBonus} bonus racha)`;
      if (luckBonus > 0) message += ` (+${luckBonus} suerte)`;
      if (newStreak > 1) message += `. Racha: ${newStreak} días 🔥`;

      showAlert('success', 'Recompensa reclamada', message);

      // Animación simple de confeti (si existiera librería, por ahora visual)
      const btn = document.getElementById('claim-daily-btn');
      if (btn) {
        gsap.to(btn, { scale: 1.1, duration: 0.2, yoyo: true, repeat: 1 });
      }
    };
    const claimBtn = document.getElementById('claim-daily-btn');
    if (claimBtn) {
      gsap.to(claimBtn, {
        scale: 1.1,
        duration: 0.2,
        yoyo: true,
        repeat: 1,
        ease: 'power2.inOut'
      });
    }


    /* =========================
       ECO-LUCK - EXTENSIÓN DE SUERTE
       ========================= */
    async function updateEcoLuckPanel(currentState = null) {
      const state = currentState || await loadState();
      const data = state.ecoLuckData || {
        plays: 0,
        totalSpent: 0,
        totalWon: 0,
        bestPrize: 0,
        lastResult: null
      };

      // Normalizar datos viejos si existen
      if (data.plays === undefined) data.plays = 0;
      if (data.totalSpent === undefined) data.totalSpent = 0;
      if (data.totalWon === undefined) data.totalWon = 0;
      if (data.bestPrize === undefined) data.bestPrize = 0;

      // NO guardamos aquí para evitar bucles, solo leemos
      // state.ecoLuckData = data; 
      // await saveState(state);

      const lastResultEl = document.getElementById('eco-luck-last-result');
      const playsEl = document.getElementById('eco-luck-plays');
      const bestEl = document.getElementById('eco-luck-best');
      const netEl = document.getElementById('eco-luck-net');

      // Continue even if some elements are missing (partial update)

      const net = (data.totalWon || 0) - (data.totalSpent || 0);

      if (!data.lastResult) {
        lastResultEl.textContent = 'Aún no has jugado.';
      } else {
        const lr = data.lastResult;
        const sign = lr.net > 0 ? '+' : lr.net < 0 ? '-' : '';
        const color = lr.net > 0 ? 'var(--ok)' : lr.net < 0 ? 'var(--danger)' : 'var(--ink-1)';
        lastResultEl.innerHTML = `<span style="color:${color};font-weight:700;">${sign}${Math.abs(lr.net)} 🪙</span>`;
      }

      playsEl.textContent = (data.plays || 0).toString();
      bestEl.textContent = `${(data.bestPrize || 0).toLocaleString()} 🪙`;

      const netSign = net > 0 ? '+' : net < 0 ? '-' : '';
      netEl.textContent = `${netSign}${Math.abs(net).toLocaleString()} 🪙`;
      netEl.style.color = net > 0 ? 'var(--ok)' : net < 0 ? 'var(--danger)' : 'var(--ink-0)';
    }

    window.playEcoLuck = async function () {
      const COST_PER_PLAY = 25;
      const state = await loadState();

      if ((state.ecoxionums || 0) < COST_PER_PLAY) {
        showAlert('error', 'Saldo insuficiente', `Necesitas al menos ${COST_PER_PLAY} Ecoxionums para jugar.`);
        return;
      }

      const btn = document.getElementById('eco-luck-button');
      if (btn) btn.disabled = true;

      const data = state.ecoLuckData || {
        plays: 0,
        totalSpent: 0,
        totalWon: 0,
        bestPrize: 0,
        lastResult: null
      };

      // Animación previa
      if (btn) {
        gsap.to(btn, { rotation: "+=720", duration: 1, ease: 'power2.inOut' });
      }

      // Pequeño delay para suspenso
      await new Promise(r => setTimeout(r, 1000));

      const roll = Math.random();
      let prize = 0;
      let multiplier = 0;

      if (roll < 0.5) {
        prize = 0; multiplier = 0;
      } else if (roll < 0.8) {
        prize = Math.round(COST_PER_PLAY * 1.5); multiplier = 1.5;
      } else if (roll < 0.97) {
        prize = COST_PER_PLAY * 3; multiplier = 3;
      } else {
        prize = COST_PER_PLAY * 10; multiplier = 10;
      }

      const net = prize - COST_PER_PLAY;

      // Actualizar datos
      data.plays = (data.plays || 0) + 1;
      data.totalSpent = (data.totalSpent || 0) + COST_PER_PLAY;
      data.totalWon = (data.totalWon || 0) + prize;
      data.bestPrize = Math.max(data.bestPrize || 0, prize);
      data.lastResult = { net, prize, at: Date.now() };

      // Usar nuestro helper para asegurar sincronía
      await awardEcoxionums(net, 'Eco-Luck - Tirada');

      // RECARGAR estado completo para asegurar que tenemos los cambios de awardEcoxionums
      // y no sobrescribimos nada con el objeto 'state' viejo
      const updatedState = await loadState();
      updatedState.ecoLuckData = data;
      await saveState(updatedState);

      updateEcoLuckPanel(updatedState);

      // Animación resultado
      const resultPop = document.getElementById('luck-result-pop');
      if (resultPop) {
        resultPop.textContent = prize > 0 ? `+${prize} ??` : 'Nada 😢';
        resultPop.style.color = prize > COST_PER_PLAY ? '#00E676' : (prize > 0 ? '#FFD700' : '#FF5252');

        gsap.fromTo(resultPop,
          { scale: 0.5, opacity: 0, y: 0 },
          { scale: 1.5, opacity: 1, y: -50, duration: 0.8, ease: 'elastic.out(1, 0.3)' }
        );

        gsap.to(resultPop, { opacity: 0, delay: 1, duration: 0.5 });
      }

      if (navigator.vibrate) navigator.vibrate(prize > 0 ? [50, 50, 50] : [30]);

      if (btn) btn.disabled = false;
    };

    /* =========================
       CLICKY COIN - EXTENSIÓN GRATUITA
       ========================= */
    async function updateClickyCoinPanel(currentState = null) {
      const state = currentState || await loadState();
      const clickyData = state.clickyCoinData || {
        clicksToday: 0,
        earnedToday: 0,
        totalEarned: 0,
        totalClicks: 0,
        reachedDailyLimit: false,
        lastClickDate: null
      };

      // Asegurar que totalClicks existe
      if (clickyData.totalClicks === undefined) {
        clickyData.totalClicks = 0;
      }

      // Verificar si es un nuevo día
      const today = new Date().toDateString();
      if (clickyData.lastClickDate !== today) {
        clickyData.clicksToday = 0;
        clickyData.earnedToday = 0;
        clickyData.lastClickDate = today;
        state.clickyCoinData = clickyData;
        await saveState(state);
      }

      // Guardar estado si se modificó
      if (state.clickyCoinData !== clickyData) {
        state.clickyCoinData = clickyData;
        await saveState(state);
      }

      // Actualizar UI
      const clicksEl = document.getElementById('clicks-today');
      const earnedEl = document.getElementById('earned-today');
      const totalClicksEl = document.getElementById('total-clicks');
      const totalEl = document.getElementById('total-clicky-earned');
      const coinBtn = document.getElementById('clicky-coin-button');

      if (clicksEl) clicksEl.textContent = (clickyData.clicksToday || 0).toString();
      if (earnedEl) earnedEl.textContent = `${(clickyData.earnedToday || 0)} 🪙`;
      if (totalClicksEl) totalClicksEl.textContent = (clickyData.totalClicks || 0).toLocaleString();
      if (totalEl) totalEl.textContent = `${(clickyData.totalEarned || 0).toLocaleString()} 🪙`;

      // Actualizar botón de retiro
      setTimeout(() => updateWithdrawButton(state), 100);

      // Deshabilitar botón si alcanzó el límite
      if (coinBtn) {
        if ((clickyData.clicksToday || 0) >= 50) {
          coinBtn.style.opacity = '0.5';
          coinBtn.style.cursor = 'not-allowed';
          coinBtn.onclick = null;
          coinBtn.innerHTML = '✅<br><span style="font-size:14px;">Límite alcanzado</span>';
        } else {
          coinBtn.style.opacity = '1';
          coinBtn.style.cursor = 'pointer';
          coinBtn.onclick = clickCoin;
          coinBtn.innerHTML = '🪙';
        }
      }
    }

    // Lock para prevenir clics simultáneos
    let isProcessingClick = false;

    // Sistema de detección de auto-clicker
    let clickHistory = []; // Array de timestamps de clics
    const MAX_CLICKS_PER_SECOND = 8; // Máximo 8 clics por segundo (humano normal)
    const CLICK_HISTORY_WINDOW = 1000; // Ventana de 1 segundo
    const AUTOCLICKER_PENALTY_MS = 3000; // Penalización de 3 segundos si se detecta auto-clicker

    window.clickCoin = async function () {
      const now = Date.now();
      if (isProcessingClick) return;

      // Limpiar clics antiguos (más de 1 segundo)
      clickHistory = clickHistory.filter(timestamp => now - timestamp < CLICK_HISTORY_WINDOW);
      clickHistory.push(now);

      // Detectar auto-clicker
      if (clickHistory.length > MAX_CLICKS_PER_SECOND) {
        const warningEl = document.getElementById('autoclicker-warning');
        if (warningEl) {
          warningEl.style.display = 'block';
          setTimeout(() => warningEl.style.display = 'none', 5000);
        }

        isProcessingClick = true;
        const coinBtn = document.getElementById('clicky-coin-button');
        if (coinBtn) {
          coinBtn.style.opacity = '0.5';
          coinBtn.style.cursor = 'not-allowed';
          coinBtn.style.pointerEvents = 'none';
        }

        showAlert('warning', 'Auto-clicker detectado', 'Por favor, haz clic de forma natural.');

        setTimeout(() => {
          isProcessingClick = false;
          if (coinBtn) {
            coinBtn.style.opacity = '1';
            coinBtn.style.cursor = 'pointer';
            coinBtn.style.pointerEvents = 'auto';
          }
          clickHistory = [];
        }, AUTOCLICKER_PENALTY_MS);
        return;
      }

      isProcessingClick = true; // Establecer bloqueo inmediatamente

      try {
        const coinBtn = document.getElementById('clicky-coin-button');
        if (coinBtn) {
          coinBtn.style.pointerEvents = 'none';
          coinBtn.style.opacity = '0.7';
        }

        const state = await loadState();

        // Inicializar clickyData con valores por defecto
        if (!state.clickyCoinData) {
          state.clickyCoinData = {
            clicksToday: 0,
            earnedToday: 0,
            totalEarned: 0,
            totalClicks: 0,
            reachedDailyLimit: false,
            lastClickDate: null
          };
        }

        const clickyData = state.clickyCoinData;

        // Asegurar que todas las propiedades existan
        if (clickyData.clicksToday === undefined) clickyData.clicksToday = 0;
        if (clickyData.earnedToday === undefined) clickyData.earnedToday = 0;
        if (clickyData.totalEarned === undefined) clickyData.totalEarned = 0;
        if (clickyData.totalClicks === undefined) clickyData.totalClicks = 0;
        if (clickyData.reachedDailyLimit === undefined) clickyData.reachedDailyLimit = false;

        // Verificar si es un nuevo día
        const today = new Date().toDateString();
        if (clickyData.lastClickDate !== today) {
          clickyData.clicksToday = 0;
          clickyData.earnedToday = 0;
          clickyData.reachedDailyLimit = false;
          clickyData.lastClickDate = today;
        }

        // Verificar límite diario
        if (clickyData.clicksToday >= 50) {
          showAlert('warning', 'Límite alcanzado', 'Has alcanzado el límite diario de 50 clics. Vuelve mañana.');
          if (coinBtn) {
            coinBtn.style.pointerEvents = 'auto';
            coinBtn.style.opacity = '1';
          }
          isProcessingClick = false;
          return;
        }

        // Calcular recompensa (1-3 Ecoxionums por clic)
        const reward = 1 + Math.floor(Math.random() * 3);

        // Actualizar datos locales
        clickyData.clicksToday += 1;
        clickyData.earnedToday += reward;
        clickyData.totalEarned += reward;
        clickyData.totalClicks += 1;

        if (clickyData.clicksToday >= 50) {
          clickyData.reachedDailyLimit = true;
        }

        state.clickyCoinData = clickyData;

        // NO agregamos al balance principal todavía (se hace al retirar)
        // state.ecoxionums += reward; <-- REMOVIDO para evitar doble ganancia

        await saveState(state);
        updateClickyCoinPanel(state);

        // Animación visual
        const animContainer = document.getElementById('coin-animation-container');
        if (coinBtn) {
          coinBtn.style.pointerEvents = 'auto';
          coinBtn.style.opacity = '1';

          gsap.to(coinBtn, {
            scale: 1.2,
            rotation: 360,
            duration: 0.3,
            ease: 'back.out(1.7)',
            onComplete: () => {
              gsap.to(coinBtn, {
                scale: 1,
                rotation: 0,
                duration: 0.2
              });
            }
          });
        }

        if (animContainer) {
          const plusText = document.createElement('div');
          plusText.textContent = `+${reward} 🪙`;
          plusText.style.position = 'absolute';
          plusText.style.left = '50%';
          plusText.style.top = '0';
          plusText.style.transform = 'translateX(-50%)';
          plusText.style.color = '#FFD700';
          plusText.style.fontSize = '20px';
          plusText.style.fontWeight = '700';
          plusText.style.pointerEvents = 'none';
          plusText.style.zIndex = '1000';
          plusText.style.textShadow = '0 2px 4px rgba(0,0,0,0.3)';
          animContainer.appendChild(plusText);

          gsap.to(plusText, {
            y: -40,
            opacity: 0,
            duration: 1,
            ease: 'power2.out',
            onComplete: () => plusText.remove()
          });
        }

        if (navigator.vibrate) navigator.vibrate(10);

        if (clickyData.clicksToday >= 50 && coinBtn) {
          coinBtn.style.opacity = '0.5';
          coinBtn.style.cursor = 'not-allowed';
          coinBtn.onclick = null;
          coinBtn.innerHTML = '✅<br><span style="font-size:14px;">Límite alcanzado</span>';
        }

      } catch (error) {
        console.error('Error en clickCoin:', error);
      } finally {
        setTimeout(() => {
          isProcessingClick = false;
        }, 150);
      }
    };

    /* =========================
       RETIRO DE ECOXIONUMS
       ========================= */
    window.withdrawEcoxionums = async function () {
      const state = await loadState();

      if (!state.oceanPayLinked || !state.userId) {
        showAlert('warning', 'Sin vincular', 'Debes vincular tu cuenta de Ocean Pay primero para retirar Ecoxionums.');
        return;
      }

      const clickyData = state.clickyCoinData || {};
      const withdrawableAmount = clickyData.totalEarned || 0;

      if (withdrawableAmount <= 0) {
        showAlert('info', 'Sin fondos', 'No tienes Ecoxionums para retirar. Gana algunos haciendo clics primero.');
        return;
      }

      try {
        showAlert('info', 'Procesando', 'Retirando Ecoxionums a tu cuenta...');

        // Transferir Ecoxionums a Ocean Pay (AWAIT es crucial)
        const res = await fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/change`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
          },
          body: JSON.stringify({
            userId: state.userId,
            amount: withdrawableAmount,
            concepto: `Retiro desde Clicky Coin`,
            origen: 'Ecoxion'
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Error al transferir');
        }

        const result = await res.json();

        // Resetear el acumulado en Clicky Coin
        clickyData.totalEarned = 0;
        state.clickyCoinData = clickyData;

        // Actualizar balance local con la respuesta del servidor
        state.ecoxionums = result.newBalance || (state.ecoxionums + withdrawableAmount);

        await saveState(state);

        // Actualizar UI
        if (typeof updateClickyCoinPanel === 'function') updateClickyCoinPanel(state);
        await updateBalance(); // Ahora sí podemos llamar a updateBalance con seguridad

        showAlert('success', 'Retiro exitoso', `Has retirado ${withdrawableAmount.toLocaleString()} Ecoxionums a tu cuenta de Ocean Pay. 🎉`);
      } catch (error) {
        console.error('Error al retirar:', error);
        showAlert('error', 'Error', error.message || 'No se pudo completar el retiro. Intenta más tarde.');
      }
    };

    async function updateWithdrawButton(currentState = null) {
      const state = currentState || await loadState();
      const withdrawBtn = document.getElementById('withdraw-btn');
      const withdrawableEl = document.getElementById('withdrawable-amount');

      if (!withdrawBtn || !withdrawableEl) return;

      const clickyData = state.clickyCoinData || {};
      const withdrawableAmount = clickyData.totalEarned || 0;

      withdrawableEl.textContent = `${withdrawableAmount.toLocaleString()} 🪙`;

      // Habilitar botón solo si hay fondos y está vinculado
      if (withdrawableAmount > 0 && state.oceanPayLinked) {
        withdrawBtn.disabled = false;
        withdrawBtn.style.opacity = '1';
      } else {
        withdrawBtn.disabled = true;
        withdrawBtn.style.opacity = '0.6';
      }
    }

    /* =========================
       SISTEMA DE DESPERTAR V2
       ========================= */
    window.awakenExtension = async function (extId) {
      const ext = defaultExtensions[extId];
      if (!ext || !ext.hasV2) {
        showAlert('error', 'Error', 'Esta extensión no tiene versión V2 disponible.');
        return;
      }

      const state = await loadState();
      const extInfo = state.installed[extId];

      if (!extInfo) {
        showAlert('error', 'Error', 'La extensión debe estar instalada para despertarla.');
        return;
      }

      if (extInfo.awakened) {
        showAlert('info', 'Ya despertada', 'Esta extensión ya está en su versión V2.');
        return;
      }

      // Verificar si todas las misiones están completas
      const missionProgress = await checkMissionProgress(extId);
      const allMissionsComplete = ext.missions ? ext.missions.every(m => {
        const progress = missionProgress[m.id] || { current: 0, completed: false };
        return progress.completed;
      }) : true;

      if (!allMissionsComplete) {
        // Mostrar modal de misiones
        showMissionsModal(extId);
        return;
      }

      // Si todas las misiones están completas, iniciar Sincronización de Despertar
      showUltimateAwakening(ext, async () => {
        // Actualizar estado
        extInfo.awakened = true;
        extInfo.awakenedAt = Date.now();
        state.installed[extId] = extInfo;
        await saveState(state);

        // Re-renderizar
        if (currentTab === 'dashboard') {
          renderDashboard();
        } else if (currentTab === 'marketplace') {
          renderMarketplace();
        } else if (currentTab === 'my-extensions') {
          renderMyExtensions();
        }

        showAlert('success', '¡Sincronización Completa!', `${ext.name} ha alcanzado el nivel V2. Nuevas capacidades desbloqueadas.`);
      });
    };

    function showUltimateAwakening(extOrId, onComplete) {
      // 0. Resolver extensión si es string
      const ext = typeof extOrId === 'string' ? defaultExtensions[extOrId] : extOrId;
      if (!ext) {
        console.error('Extensión no encontrada para animación:', extOrId);
        if (onComplete) onComplete();
        return;
      }

      // 1. Overlay Oscuro
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed; inset: 0; background: #000; z-index: 20000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: all; overflow: hidden;
      `;
      document.body.appendChild(overlay);

      // 2. Elementos de Animación
      const container = document.createElement('div');
      container.style.cssText = `position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;`;

      const icon = document.createElement('div');
      icon.innerHTML = ext.icon;
      icon.style.cssText = `font-size: 150px; opacity: 0; transform: scale(0.5); filter: drop-shadow(0 0 0px rgba(100,167,255,0)); z-index: 10;`;

      const ring1 = document.createElement('div');
      ring1.style.cssText = `position: absolute; width: 300px; height: 300px; border: 2px solid var(--accent); border-radius: 50%; opacity: 0; transform: scale(0);`;

      const ring2 = document.createElement('div');
      ring2.style.cssText = `position: absolute; width: 500px; height: 500px; border: 4px solid var(--accent-2); border-radius: 50%; opacity: 0; transform: scale(0); border-style: dashed;`;

      const text = document.createElement('h1');
      text.textContent = `DESPERTANDO ${ext.name.toUpperCase()}...`;
      text.style.cssText = `
        position: absolute; bottom: 20%; font-size: 32px; font-weight: 800; color: #fff;
        text-shadow: 0 0 20px var(--accent); letter-spacing: 4px; opacity: 0; text-align: center;
      `;

      const particles = document.createElement('div');
      particles.style.cssText = 'position: absolute; inset: 0; pointer-events: none;';

      container.appendChild(ring1);
      container.appendChild(ring2);
      container.appendChild(particles);
      container.appendChild(icon);
      container.appendChild(text);
      overlay.appendChild(container);

      // 3. Crear Partículas
      for (let i = 0; i < 50; i++) {
        const p = document.createElement('div');
        p.style.cssText = `
          position: absolute; width: 4px; height: 4px; background: #fff; border-radius: 50%;
          left: 50%; top: 50%; opacity: 0;
        `;
        particles.appendChild(p);
      }

      // 4. Secuencia GSAP
      const tl = gsap.timeline();

      // Fase 1: Oscurecer y mostrar icono
      tl.to(overlay, { opacity: 1, duration: 0.5 })
        .to(icon, { opacity: 1, scale: 1, duration: 1, ease: 'elastic.out(1, 0.5)' }, "-=0.3")
        .to(text, { opacity: 1, duration: 0.8 }, "-=0.8");

      // Fase 2: Carga de Energía (Partículas implosionan RÁPIDO)
      const partEls = particles.children;
      for (let i = 0; i < partEls.length; i++) {
        const angle = Math.random() * Math.PI * 2;
        const dist = 300 + Math.random() * 300;
        const x = Math.cos(angle) * dist;
        const y = Math.sin(angle) * dist;

        gsap.set(partEls[i], { x: x, y: y, opacity: 1 });
        // Duración reducida significativamente para mayor velocidad
        tl.to(partEls[i], {
          x: 0, y: 0, opacity: 0, duration: 0.6 + Math.random() * 0.4, ease: 'power4.in'
        }, "-=0.9"); // Comenzar antes para overlap
      }

      // Fase 3: Explosión y Anillos
      tl.to(icon, { filter: 'drop-shadow(0 0 50px rgba(100,167,255,1))', scale: 1.2, duration: 0.3 }, "-=0.2")
        .to(ring1, { opacity: 1, scale: 1.5, borderWidth: 0, duration: 0.8, ease: 'power2.out' }, ">")
        .to(ring2, { opacity: 1, scale: 1.5, padding: 0, rotation: 180, duration: 1.2, ease: 'power2.out' }, "<0.1")
        .to(overlay, { background: '#fff', duration: 0.1 }, "-=0.2") // Flash blanco
        .to(overlay, { background: '#000', duration: 0.2 })
        .set(text, { textContent: `¡${ext.name} ACTUALIZADO!`, color: 'var(--ok)', textShadow: '0 0 30px var(--ok)' })
        .to(text, { scale: 1.2, duration: 0.5, ease: 'back.out' })

        // Fase 4: Finalizar
        .to(overlay, {
          opacity: 0, delay: 1.2, duration: 0.8, onComplete: () => {
            overlay.remove();
            if (onComplete) onComplete();
          }
        });
    }

    window.exportNotes = function () {
      showAlert('info', 'Exportar PDF', 'Función V2: Exportación a PDF próximamente.');
    };

    /* =========================
       WORD BATTLE - FUNCIONES
       ========================= */

    const wordBattle = {
      socket: null,
      roomCode: null,
      userId: localStorage.getItem('userId') || 'guest_' + Math.random().toString(36).substring(2, 8),
      playerName: null,
      isHost: false,
      players: [],

      init() {
        if (this.socket) return;
        // Conectar al servidor producción
        this.socket = io('https://owsdatabase.onrender.com');

        // Listeners
        this.socket.on('connect', () => console.log('🔌 Conectado a Word Battle Server'));

        this.socket.on('wb_joined', (data) => {
          this.roomCode = data.roomCode;
          this.isHost = data.isHost;
          this.showLobby();
        });

        this.socket.on('wb_room_update', (room) => {
          this.players = room.players;
          this.updateLobbyUI();
        });

        this.socket.on('wb_game_started', () => {
          this.startGameUI();
        });

        this.socket.on('wb_new_turn', (data) => {
          this.updateTurnUI(data);
        });

        this.socket.on('wb_word_accepted', (data) => {
          this.showMessage(`✅ ${data.word} (+10pts)`, 'success');
          // Animación visual si se desea
        });

        this.socket.on('wb_player_damage', (data) => {
          this.updatePlayerLives(data.playerId, data.lives);
          const p = this.players.find(pl => pl.id === data.playerId);
          if (p) this.showMessage(`💔 ${p.name} pierde una vida`, 'error');
        });

        this.socket.on('wb_player_eliminated', (data) => {
          const p = this.players.find(pl => pl.id === data.playerId);
          if (p) this.showMessage(`💀 ${p.name} eliminado`, 'error');
          this.updatePlayersList();
        });

        this.socket.on('wb_game_over', (data) => {
          this.showResults(data.winner);
        });

        this.socket.on('wb_error', (msg) => {
          this.showMessage(msg, 'error');
        });
      },

      selectMode(mode) {
        this.init(); // Asegurar conexión
        document.querySelector('.wb-mode-screen').classList.remove('active');
        if (mode === 'create') {
          document.querySelector('.wb-create-screen').classList.add('active');
        } else {
          document.querySelector('.wb-join-screen').classList.add('active');
        }
      },

      backToMode() {
        document.querySelectorAll('.wb-mode-screen, .wb-create-screen, .wb-join-screen, .wb-lobby-screen').forEach(el => el.classList.remove('active'));
        document.querySelector('.wb-mode-screen').classList.add('active');
      },

      createRoom() {
        const playerName = document.getElementById('wb-createPlayerName').value.trim();
        if (!playerName) return this.showMessage('Ingresa un nombre', 'error');
        this.playerName = playerName;
        this.socket.emit('wb_create_room', { playerName });
      },

      joinRoom() {
        const roomCode = document.getElementById('wb-joinRoomCode').value.trim();
        const playerName = document.getElementById('wb-joinPlayerName').value.trim();
        if (!roomCode || !playerName) return this.showMessage('Completa los datos', 'error');
        this.playerName = playerName;
        this.socket.emit('wb_join_room', { roomCode, playerName });
      },

      showLobby() {
        document.querySelectorAll('.wb-create-screen, .wb-join-screen').forEach(el => el.classList.remove('active'));
        document.querySelector('.wb-lobby-screen').classList.add('active');
        document.getElementById('wb-roomCodeDisplay').textContent = this.roomCode;
      },

      updateLobbyUI() {
        document.getElementById('wb-playerCount').textContent = this.players.length;
        const list = document.getElementById('wb-lobbyPlayersList');
        list.innerHTML = this.players.map(p => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-2);border:1px solid rgba(255,255,255,.1);border-radius:8px;margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:10px;">
              <div style="font-size:20px;">${p.avatar}</div>
              <span style="font-weight:bold;color:var(--ink-0);">${p.name}</span>
            </div>
            ${p.id === this.players[0]?.id ? '<span style="color:var(--accent);">👑 Host</span>' : ''}
          </div>
        `).join('');

        const startBtn = document.getElementById('wb-startGameBtn');
        if (this.isHost) {
          startBtn.style.display = this.players.length >= 1 ? 'block' : 'none'; // Permitir 1 jugador para testing
          startBtn.textContent = this.players.length < 2 ? '🎮 Jugar Solo (Prueba)' : '🎮 Iniciar Partida';
        } else {
          startBtn.style.display = 'none';
        }
      },

      copyRoomCode() {
        navigator.clipboard.writeText(this.roomCode);
        this.showMessage('Código copiado', 'success');
      },

      leaveRoom() {
        // Recargar para desconectar limpio o emitir evento
        location.reload();
      },

      startGame() {
        this.socket.emit('wb_start_game', { roomCode: this.roomCode });
      },

      startGameUI() {
        document.querySelector('.wb-lobby-screen').classList.remove('active');
        document.querySelector('.wb-game-screen').classList.add('active');
      },

      updateTurnUI(data) {
        document.getElementById('wb-lettersDisplay').textContent = data.letters;
        document.getElementById('wb-currentPlayer').textContent = data.playerName;
        document.getElementById('wb-wordInput').value = '';
        document.getElementById('wb-wordInput').focus();

        // Timer visual
        const timerEl = document.getElementById('wb-timer');
        timerEl.textContent = data.timeLeft + 's';

        // Determinar si es mi turno
        const isMyTurn = data.playerId === this.socket.id;
        const input = document.getElementById('wb-wordInput');
        const btn = document.getElementById('wb-submitBtn');

        if (isMyTurn) {
          input.disabled = false;
          btn.disabled = false;
          input.placeholder = "¡TU TURNO! Escribe...";
          document.body.style.borderColor = "var(--accent)";
        } else {
          input.disabled = true;
          btn.disabled = true;
          input.placeholder = `Turno de ${data.playerName}`;
          document.body.style.borderColor = "transparent";
        }

        this.updatePlayersList(data.playerId);
      },

      updatePlayersList(currentTurnId) {
        const grid = document.getElementById('wb-playersGame');
        grid.innerHTML = this.players.map(p => {
          const isActive = p.id === currentTurnId;
          const livesHtml = Array(3).fill(0).map((_, i) => i < p.lives ? '❤️' : '🖤').join('');

          return `
            <div class="wb-player-card ${isActive ? 'active' : ''} ${p.lives <= 0 ? 'eliminated' : ''}" style="opacity:${p.lives <= 0 ? 0.5 : 1}">
              <div style="display:flex;justify-content:space-between;">
                <span class="wb-player-name">${p.name}</span>
                <span style="font-weight:bold;color:var(--ok);">${p.score || 0} pts</span>
              </div>
              <div class="wb-player-lives">${livesHtml}</div>
            </div>
          `;
        }).join('');
      },

      updatePlayerLives(playerId, lives) {
        const p = this.players.find(pl => pl.id === playerId);
        if (p) p.lives = lives;
        this.updatePlayersList();
      },

      submitWord() {
        const word = document.getElementById('wb-wordInput').value.trim();
        if (!word) return;
        this.socket.emit('wb_submit_word', { roomCode: this.roomCode, word });
      },

      showResults(winner) {
        document.querySelector('.wb-game-screen').classList.remove('active');
        document.querySelector('.wb-results-screen').classList.add('active');

        const podium = document.getElementById('wb-podium');
        // Ordenar por score
        const sorted = [...this.players].sort((a, b) => (b.score || 0) - (a.score || 0));

        podium.innerHTML = sorted.slice(0, 3).map((p, i) => `
          <div class="wb-podium-place ${i === 0 ? 'first' : i === 1 ? 'second' : 'third'}">
            <div class="position">${i === 0 ? '🥇' : i === 1 ? '🥈' : '🥉'}</div>
            <div class="name">${p.name}</div>
            <div class="reward">${p.score || 0} pts</div>
          </div>
        `).join('');
      },

      resetGame() {
        location.reload(); // Simple reset
      },

      showMessage(text, type) {
        const box = document.getElementById('wb-messageBox') || document.getElementById('wb-gameMessageBox');
        if (box) {
          box.innerHTML = `<div class="wb-message ${type}">${text}</div>`;
          setTimeout(() => box.innerHTML = '', 3000);
        }
      }
    };


    function initWordBattle() {
      // Connect specifically when extension is loaded
      wordBattle.init();

      // Enter key for game input
      const wordInput = document.getElementById('wb-wordInput');
      if (wordInput) {
        wordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            wordBattle.submitWord();
          }
        });
      }

      // Enter key for Create Room
      const createName = document.getElementById('wb-createPlayerName');
      if (createName) {
        createName.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') wordBattle.createRoom();
        });
      }

      // Enter key for Join Room
      const joinCode = document.getElementById('wb-joinRoomCode');
      const joinName = document.getElementById('wb-joinPlayerName');
      if (joinCode) {
        joinCode.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            if (joinName.value) wordBattle.joinRoom();
            else joinName.focus();
          }
        });
      }
      if (joinName) {
        joinName.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') wordBattle.joinRoom();
        });
      }
    }

    /* =========================
       DAILY REWARDS - FUNCIONES
       ========================= */

    /* =========================
       DAILY REWARDS - FUNCIONES
       ========================= */

    const miniGamesConfig = {
      clickGame: { id: 'clickGame', name: 'Click Rápido', description: 'Haz tantos clicks como puedas en 10s.', color: 'linear-gradient(135deg, #667eea, #764ba2)', model: 'coin' },
      memoryGame: { id: 'memoryGame', name: 'Memoria', description: 'Encuentra los pares de cartas.', color: 'linear-gradient(135deg, #f6d365, #fda085)', model: 'cards' },
      numberGuess: { id: 'numberGuess', name: 'Adivina el Número', description: 'Adivina el número entre 1 y 100.', color: 'linear-gradient(135deg, #84fab0, #8fd3f4)', model: 'dice' },
      mathChallenge: { id: 'mathChallenge', name: 'Reto Matemático', description: 'Resuelve operaciones matemáticas.', color: 'linear-gradient(135deg, #ff9a9e, #fecfef)', model: 'calculator' },
      reactionTest: { id: 'reactionTest', name: 'Test de Reacción', description: 'Click cuando cambie el color.', color: 'linear-gradient(135deg, #a18cd1, #fbc2eb)', model: 'bolt' },
      simonSays: { id: 'simonSays', name: 'Simon Dice', description: 'Repite la secuencia de colores.', color: 'linear-gradient(135deg, #ffecd2, #fcb69f)', model: 'simon' }
    };

    function drawGameModel(canvas, model) {
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#64a7ff';

      ctx.clearRect(0, 0, w, h);
      ctx.imageSmoothingEnabled = true;

      const drawShadow = () => {
        ctx.shadowColor = 'rgba(0,0,0,0.3)';
        ctx.shadowBlur = 8;
        ctx.shadowOffsetY = 4;
      };

      switch (model) {
        case 'coin':
          drawShadow();
          ctx.beginPath();
          ctx.arc(w / 2, h / 2, w * 0.35, 0, Math.PI * 2);
          ctx.fillStyle = '#FFD700';
          ctx.fill();
          ctx.strokeStyle = '#DAA520';
          ctx.lineWidth = 4;
          ctx.stroke();
          ctx.beginPath();
          ctx.arc(w / 2, h / 2, w * 0.25, 0, Math.PI * 2);
          ctx.strokeStyle = '#DAA520';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = '#DAA520';
          ctx.font = 'bold 24px serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('$', w / 2, h / 2);
          break;
        case 'cards':
          drawShadow();
          ctx.fillStyle = '#fff';
          ctx.roundRect(w * 0.2, h * 0.2, w * 0.4, h * 0.6, 5);
          ctx.fill();
          ctx.strokeStyle = themeColor;
          ctx.stroke();
          ctx.fillStyle = themeColor;
          ctx.roundRect(w * 0.4, h * 0.3, w * 0.4, h * 0.6, 5);
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.stroke();
          break;
        case 'dice':
          drawShadow();
          ctx.fillStyle = '#fff';
          ctx.roundRect(w * 0.25, h * 0.25, w * 0.5, h * 0.5, 8);
          ctx.fill();
          ctx.fillStyle = '#333';
          const dots = [[0.4, 0.4], [0.6, 0.6], [0.5, 0.5]];
          dots.forEach(d => {
            ctx.beginPath();
            ctx.arc(w * d[0], h * d[1], 4, 0, Math.PI * 2);
            ctx.fill();
          });
          break;
        case 'calculator':
          drawShadow();
          ctx.fillStyle = '#333';
          ctx.roundRect(w * 0.25, h * 0.2, w * 0.5, h * 0.7, 5);
          ctx.fill();
          ctx.fillStyle = '#9cf';
          ctx.fillRect(w * 0.35, h * 0.3, w * 0.3, h * 0.15);
          ctx.fillStyle = '#fff';
          for (let i = 0; i < 6; i++) {
            ctx.fillRect(w * (0.35 + (i % 2) * 0.18), h * (0.55 + Math.floor(i / 2) * 0.12), w * 0.12, h * 0.08);
          }
          break;
        case 'bolt':
          drawShadow();
          ctx.fillStyle = '#FFD700';
          ctx.beginPath();
          ctx.moveTo(w * 0.5, h * 0.1);
          ctx.lineTo(w * 0.3, h * 0.5);
          ctx.lineTo(w * 0.5, h * 0.5);
          ctx.lineTo(w * 0.4, h * 0.9);
          ctx.lineTo(w * 0.7, h * 0.4);
          ctx.lineTo(w * 0.5, h * 0.4);
          ctx.closePath();
          ctx.fill();
          break;
        case 'simon':
          drawShadow();
          const colors = ['#f55', '#5f5', '#55f', '#ff5'];
          colors.forEach((c, i) => {
            ctx.fillStyle = c;
            ctx.beginPath();
            ctx.moveTo(w / 2, h / 2);
            ctx.arc(w / 2, h / 2, w * 0.4, i * Math.PI / 2, (i + 1) * Math.PI / 2);
            ctx.closePath();
            ctx.fill();
          });
          ctx.fillStyle = '#222';
          ctx.beginPath();
          ctx.arc(w / 2, h / 2, w * 0.15, 0, Math.PI * 2);
          ctx.fill();
          break;
      }
    }

    const dailyRewards = {
      calculateDailyReward(streakValue = 0) {
        const safe = Math.max(0, Number(streakValue) || 0);
        return Math.min(260, 80 + safe * 12);
      },
      async claimDaily() {
        const state = await loadState();
        const now = Date.now();
        const lastClaim = state.dailyRewards?.lastClaim || 0;
        const timeSince = now - lastClaim;
        const oneDay = 24 * 60 * 60 * 1000;

        if (timeSince < oneDay) {
          const timeLeft = oneDay - timeSince;
          const hours = Math.floor(timeLeft / (60 * 60 * 1000));
          const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
          showAlert('warning', 'Ya reclamaste hoy', `Vuelve en ${hours}h ${minutes}m`);
          return;
        }

        const currentStreak = state.dailyRewards?.streak || 0;
        const reward = this.calculateDailyReward(currentStreak);

        // Sincronizar con servidor ANTES de actualizar UI si está vinculado
        if (state.oceanPayLinked && state.userId) {
          try {
            const res = await fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/change`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
              },
              body: JSON.stringify({
                userId: state.userId,
                amount: reward,
                concepto: 'Recompensa Diaria Ecoxion',
                origen: 'Ecoxion'
              })
            });
            if (res.ok) {
              const data = await res.json();
              if (data.newBalance !== undefined) state.ecoxionums = data.newBalance;
            }
          } catch (e) {
            console.warn('Error sync daily reward:', e);
            state.ecoxionums = (state.ecoxionums || 0) + reward;
          }
        } else {
          state.ecoxionums = (state.ecoxionums || 0) + reward;
        }

        if (!state.dailyRewards) state.dailyRewards = {};
        state.dailyRewards.lastClaim = now;
        state.dailyRewards.streak = (state.dailyRewards.streak || 0) + 1;
        state.dailyRewards.totalEarned = (state.dailyRewards.totalEarned || 0) + reward;

        await saveState(state);
        await updateBalance();

        showAlert('success', '¡Recompensa reclamada!', `+${reward} Ecoxionums`);
        this.updateDailyUI();
      },

      async updateDailyUI() {
        const state = await loadState();
        const now = Date.now();
        const lastClaim = state.dailyRewards?.lastClaim || 0;
        const timeSince = now - lastClaim;
        const oneDay = 24 * 60 * 60 * 1000;

        const btn = document.getElementById('dr-claimDailyBtn');
        const timer = document.getElementById('dr-dailyTimer');

        if (btn && timer) {
          if (timeSince >= oneDay) {
            btn.disabled = false;
            btn.textContent = '🎁 Reclamar recompensa';
            timer.textContent = '¡Disponible ahora!';
            timer.style.color = 'var(--ok)';
          } else {
            btn.disabled = true;
            const timeLeft = oneDay - timeSince;
            const hours = Math.floor(timeLeft / (60 * 60 * 1000));
            const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
            btn.textContent = '⏰ Ya reclamado';
            timer.textContent = `Próxima recompensa en ${hours}h ${minutes}m`;
            timer.style.color = 'var(--ink-1)';
          }
        }

        const totalEarnedEl = document.getElementById('dr-totalEarned');
        if (totalEarnedEl) totalEarnedEl.textContent = state.dailyRewards?.totalEarned || 0;

        const streakEl = document.getElementById('dr-dailyStreak');
        if (streakEl) streakEl.textContent = state.dailyRewards?.streak || 0;

        const missionsEl = document.getElementById('dr-missionsCompleted');
        if (missionsEl) missionsEl.textContent = state.dailyRewards?.missionsCompleted || 0;

        const nextAmount = document.getElementById('dr-dailyAmount');
        if (nextAmount) {
          const projectedStreak = (state.dailyRewards?.streak || 0) + 1;
          nextAmount.textContent = `+${this.calculateDailyReward(projectedStreak)} 🪙`;
        }

        this.updateMissions();
        this.renderMiniGamesSection();
      },

      async updateMissions() {
        const state = await loadState();
        const missions = [
          { id: 'open_5_extensions', title: 'Explorador', desc: 'Abre 5 extensiones diferentes', reward: 35, target: 5, current: state.dailyRewards?.missions?.open_5_extensions || 0 },
          { id: 'spend_30_min', title: 'Tiempo en Ecoxion', desc: 'Pasa 30 minutos en Ecoxion', reward: 45, target: 30, current: Math.floor((state.dailyRewards?.missions?.spend_30_min || 0) / 60) },
          { id: 'play_3_minigames', title: 'Jugador', desc: 'Juega 3 mini-juegos', reward: 40, target: 3, current: state.dailyRewards?.missions?.play_3_minigames || 0 }
        ];

        const list = document.getElementById('dr-missionsList');
        if (!list) return;

        list.innerHTML = missions.map(m => {
          const progress = Math.min(100, (m.current / m.target) * 100);
          const completed = m.current >= m.target;

          return `
        <div class="dr-mission-card ${completed ? 'completed' : ''}">
          <div class="dr-mission-header">
            <div class="dr-mission-title">${completed ? '✅' : '📌'} ${m.title}</div>
            <div class="dr-mission-reward">+${m.reward} 🪙</div>
          </div>
          <div style="color:var(--ink-1);font-size:0.9em;margin-bottom:8px;">${m.desc}</div>
          <div class="dr-mission-progress">
            <div class="dr-mission-progress-bar" style="width:${progress}%"></div>
          </div>
          <div style="text-align:right;font-size:0.85em;color:var(--ink-1);margin-top:4px;">
            ${m.current}/${m.target} ${completed ? '✓ Completada' : ''}
          </div>
        </div>
      `;
        }).join('');
      },

      async initMiniGameData(gameId) {
        const state = await loadState();
        const today = new Date().toDateString();
        if (!state.dailyRewards) state.dailyRewards = {};
        if (!state.dailyRewards.miniGames) state.dailyRewards.miniGames = {};
        if (!state.dailyRewards.miniGames[gameId]) state.dailyRewards.miniGames[gameId] = { lastDate: today, playsToday: 0 };

        if (state.dailyRewards.miniGames[gameId].lastDate !== today) {
          state.dailyRewards.miniGames[gameId].playsToday = 0;
          state.dailyRewards.miniGames[gameId].lastDate = today;
        }
        await saveState(state);
        return state.dailyRewards.miniGames[gameId];
      },

      async registerMiniGamePlay(gameId) {
        const state = await loadState();
        const today = new Date().toDateString();
        if (!state.dailyRewards) state.dailyRewards = {};
        if (!state.dailyRewards.miniGames) state.dailyRewards.miniGames = {};
        if (!state.dailyRewards.miniGames[gameId]) {
          state.dailyRewards.miniGames[gameId] = { lastDate: today, playsToday: 0 };
        }
        if (state.dailyRewards.miniGames[gameId].lastDate !== today) {
          state.dailyRewards.miniGames[gameId].lastDate = today;
          state.dailyRewards.miniGames[gameId].playsToday = 0;
        }
        state.dailyRewards.miniGames[gameId].playsToday += 1;
        await saveState(state);
      },

      getMiniGameCooldown(gameData) {
        const today = new Date().toDateString();
        const plays = gameData?.lastDate === today ? Number(gameData?.playsToday || 0) : 0;
        const locked = plays >= 3;
        if (!locked) {
          return {
            plays,
            locked: false,
            remainingMs: 0,
            remainingLabel: 'Listo'
          };
        }
        const now = new Date();
        const nextReset = new Date(now);
        nextReset.setHours(24, 0, 0, 0);
        const remainingMs = Math.max(0, nextReset.getTime() - now.getTime());
        const hh = Math.floor(remainingMs / 3600000);
        const mm = Math.floor((remainingMs % 3600000) / 60000);
        const ss = Math.floor((remainingMs % 60000) / 1000);
        return {
          plays,
          locked: true,
          remainingMs,
          remainingLabel: `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`
        };
      },

      async renderMiniGamesSection() {
        const container = document.getElementById('dr-minigames-container');
        if (!container) return;

        const state = await loadState();
        const miniGamesData = state.dailyRewards?.miniGames || {};
        const today = new Date().toDateString();

        container.style.display = 'grid';
        container.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))';
        container.style.gap = '20px';
        container.innerHTML = '';

        Object.values(miniGamesConfig).forEach(game => {
          const gameData = miniGamesData[game.id] || { playsToday: 0, lastDate: today };
          const cooldown = this.getMiniGameCooldown(gameData);
          const plays = cooldown.plays;
          const isLocked = cooldown.locked;
          const progress = (plays / 3) * 100;

          const card = document.createElement('div');
          card.className = 'minigame-card-premium';
          card.onclick = isLocked
            ? () => showAlert('info', 'Minijuego en recarga', `${game.name} disponible en ${cooldown.remainingLabel}`)
            : () => dailyRewards.play(game.id);
          card.style.cssText = `
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: ${isLocked ? 'default' : 'pointer'};
            position: relative;
            overflow: hidden;
            ${isLocked ? 'opacity: 0.6; filter: grayscale(0.5);' : ''}
          `;

          if (!isLocked) {
            card.onmouseenter = () => {
              card.style.background = 'rgba(255,255,255,0.06)';
              card.style.borderColor = 'var(--accent)';
              card.style.transform = 'translateY(-5px)';
            };
            card.onmouseleave = () => {
              card.style.background = 'rgba(255,255,255,0.03)';
              card.style.borderColor = 'rgba(255,255,255,0.08)';
              card.style.transform = 'translateY(0)';
            };
          }

          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <canvas id="canvas-${game.id}" width="80" height="80" style="width:60px; height:60px;"></canvas>
              <div style="text-align:right;">
                <span style="font-size:10px; text-transform:uppercase; font-weight:700; color:var(--ink-2); letter-spacing:1px;">Estado</span>
                <div style="font-size:12px; font-weight:700; color:${isLocked ? 'var(--warn)' : 'var(--ok)'}">
                  ${isLocked ? 'AGOTADO' : 'DISPONIBLE'}
                </div>
                ${isLocked ? `<div class="dr-cooldown-time">${cooldown.remainingLabel}</div>` : ''}
              </div>
            </div>
            <div>
              <h3 style="margin:0 0 6px; font-size:18px; color:var(--ink-0);">${game.name}</h3>
              <p style="margin:0; font-size:13px; color:var(--ink-1); line-height:1.4;">${game.description}</p>
            </div>
            <div style="margin-top:auto;">
              <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:6px;">
                <span style="color:var(--ink-1);">Intentos diarios</span>
                <span style="font-weight:700; color:var(--ink-0);">${plays}/3</span>
              </div>
              <div style="height:6px; background:rgba(255,255,255,0.05); border-radius:3px; overflow:hidden;">
                <div style="height:100%; width:${progress}%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width 0.5s ease;"></div>
              </div>
            </div>
            ${isLocked ? `
              <div class="dr-cooldown-overlay">
                <div class="dr-cooldown-pill">
                  <span class="dr-cooldown-spinner"></span>
                  <span>⏱️ Recarga: ${cooldown.remainingLabel}</span>
                </div>
              </div>
            ` : ''}
          `;

          container.appendChild(card);
          // Dibujar el modelo
          const canvas = document.getElementById(`canvas-${game.id}`);
          drawGameModel(canvas, game.model);
        });
      },

      play(gameId) {
        const game = miniGamesConfig[gameId];
        if (game) {
          // Mapear funciones
          if (gameId === 'clickGame') this.playClickGame();
          else if (gameId === 'memoryGame') this.playMemoryGame();
          else if (gameId === 'numberGuess') this.playNumberGuess();
          else if (gameId === 'mathChallenge') this.playMathChallenge();
          else if (gameId === 'reactionTest') this.playReactionTest();
          else if (gameId === 'simonSays') this.playSimonSays();
        }
      },

      async playClickGame() {
        const gameData = await this.initMiniGameData('clickGame');
        if (gameData.playsToday >= 3) {
          showAlert('warning', 'Límite alcanzado', 'Vuelve mañana.');
          return;
        }

        const overlay = this.createOverlay();
        let clicks = 0;
        let timeLeft = 10;
        let isGameOver = false;

        overlay.innerHTML = `
          <div class="minigame-modal">
            <h2>🖱️ Click Rápido</h2>
            <div class="score-display" id="cg-clicks">0</div>
            <div class="timer-display">Tiempo: <span id="cg-time">10</span>s</div>
            <div id="cg-hitArea" class="cg-hit-area">
              <button id="cg-clickBtn" class="game-action-btn" type="button">CLICK!</button>
              <div class="cg-hit-hint">Toca cualquier parte de esta zona para contar clicks</div>
            </div>
            <div id="cg-processing" style="display:none; margin-top:16px; color:var(--accent); font-weight:700; animation: pulse 1s infinite;">
              Procesando recompensa...
            </div>
            <button class="close-btn" id="cg-cancelBtn" onclick="this.closest('.overlay').remove()">Cancelar</button>
          </div>
        `;
        document.body.appendChild(overlay);

        const clickBtn = document.getElementById('cg-clickBtn');
        const hitArea = document.getElementById('cg-hitArea');
        const clicksEl = document.getElementById('cg-clicks');
        const timeEl = document.getElementById('cg-time');
        const processingEl = document.getElementById('cg-processing');
        const cancelBtn = document.getElementById('cg-cancelBtn');

        let lastTapTs = 0;
        const handleClickHit = (ev) => {
          if (ev) ev.preventDefault();
          if (ev?.target?.id === 'cg-cancelBtn') return;
          if (isGameOver) return;
          const now = Date.now();
          if (now - lastTapTs < 35) return;
          lastTapTs = now;
          clicks++;
          clicksEl.textContent = clicks;
          clickBtn.style.transform = 'scale(0.95)';
          setTimeout(() => clickBtn.style.transform = 'scale(1)', 50);
        };

        hitArea.style.touchAction = 'manipulation';
        clickBtn.style.userSelect = 'none';
        // Captura amplia para evitar casos donde el botón no recibe el toque/click.
        ['click', 'pointerdown', 'touchstart'].forEach((evt) => {
          hitArea.addEventListener(evt, handleClickHit, { passive: false });
        });

        const interval = setInterval(async () => {
          timeLeft--;
          timeEl.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(interval);
            isGameOver = true;

            // Bloquear acciones inmediatamente
            clickBtn.disabled = true;
            clickBtn.style.opacity = '0.5';
            clickBtn.textContent = 'FIN!';
            processingEl.style.display = 'block';
            cancelBtn.style.display = 'none';

            const reward = Math.min(28, Math.max(8, Math.floor(clicks / 1.8)));

            await this.registerMiniGamePlay('clickGame');

            await this.giveReward(reward, 'Click Rápido');

            setTimeout(() => {
              overlay.remove();
              showAlert('success', '¡Completado!', `${clicks} clicks = +${reward} 🪙`);
              this.renderMiniGamesSection();
            }, 800);
          }
        }, 1000);
      },

      async playMemoryGame() {
        const gameData = await this.initMiniGameData('memoryGame');
        if (gameData.playsToday >= 3) {
          showAlert('warning', 'Límite alcanzado', 'Vuelve mañana.');
          return;
        }

        const emojis = ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼'];
        const cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
        let flipped = [];
        let matched = 0;
        let moves = 0;
        let isGameOver = false;

        const overlay = this.createOverlay();
        overlay.innerHTML = `
          <div class="minigame-modal" style="max-width:500px;">
            <h2 style="margin:0 0 10px;">🧠 Memoria</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
              <div class="timer-display" style="margin:0;">Movimientos: <span id="mg-moves">0</span></div>
              <div id="mg-processing" style="display:none; color:var(--accent); font-weight:700; animation: pulse 1s infinite;">
                Guardando...
              </div>
            </div>
            <div id="mg-grid" class="memory-grid"></div>
            <button class="close-btn" id="mg-cancelBtn" onclick="this.closest('.overlay').remove()">Cerrar</button>
          </div>
        `;
        document.body.appendChild(overlay);

        const grid = document.getElementById('mg-grid');
        const movesEl = document.getElementById('mg-moves');
        const processingEl = document.getElementById('mg-processing');
        const cancelBtn = document.getElementById('mg-cancelBtn');

        cards.forEach((emoji, i) => {
          const card = document.createElement('div');
          card.className = 'memory-card';
          card.dataset.emoji = emoji;
          card.textContent = '?';

          const memoryEvent = ('onpointerdown' in window) ? 'pointerdown' : 'click';
          card.addEventListener(memoryEvent, async (ev) => {
            ev.preventDefault();
            if (isGameOver || flipped.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) return;

            card.textContent = emoji;
            card.classList.add('flipped');
            flipped.push(card);

            if (flipped.length === 2) {
              moves++;
              movesEl.textContent = moves;

              if (flipped[0].dataset.emoji === flipped[1].dataset.emoji) {
                matched += 2;
                flipped.forEach(c => c.classList.add('matched'));
                flipped = [];

                if (matched === cards.length) {
                  isGameOver = true;
                  processingEl.style.display = 'block';
                  cancelBtn.style.display = 'none';

                  const reward = Math.max(14, 45 - moves);

                  await this.registerMiniGamePlay('memoryGame');
                  await this.giveReward(reward, 'Memoria');

                  setTimeout(() => {
                    overlay.remove();
                    showAlert('success', '¡Completado!', `${moves} movimientos = +${reward} 🪙`);
                    this.renderMiniGamesSection();
                  }, 800);
                }
              } else {
                setTimeout(() => {
                  flipped.forEach(c => {
                    c.textContent = '?';
                    c.classList.remove('flipped');
                  });
                  flipped = [];
                }, 1000);
              }
            }
          });
          grid.appendChild(card);
        });
      },

      async playNumberGuess() {
        const gameData = await this.initMiniGameData('numberGuess');
        if (gameData.playsToday >= 3) {
          showAlert('warning', 'Límite alcanzado', 'Vuelve mañana.');
          return;
        }

        const target = Math.floor(Math.random() * 100) + 1;
        let attempts = 0;
        let isGameOver = false;

        const overlay = this.createOverlay();
        overlay.innerHTML = `
          <div class="minigame-modal">
            <h2 style="margin-bottom:10px;">🎲 Adivina el Número</h2>
            <p>Entre 1 y 100</p>
            <div id="ng-hint" class="hint-text" style="font-size:1.2em; font-weight:700; margin:15px 0;">¡Empieza!</div>
            <input type="number" id="ng-input" class="game-input" placeholder="Tu número" style="width:100%; font-size:1.5em; text-align:center; margin-bottom:16px; border-radius:12px;">
            <button id="ng-guessBtn" class="game-action-btn">ADIVINAR</button>
            <div id="ng-processing" style="display:none; margin-top:16px; color:var(--accent); font-weight:700; animation: pulse 1s infinite;">
              Verificando...
            </div>
            <button class="close-btn" id="ng-cancelBtn" onclick="this.closest('.overlay').remove()">Cancelar</button>
          </div>
        `;
        document.body.appendChild(overlay);

        const input = document.getElementById('ng-input');
        const hint = document.getElementById('ng-hint');
        const btn = document.getElementById('ng-guessBtn');
        const processingEl = document.getElementById('ng-processing');
        const cancelBtn = document.getElementById('ng-cancelBtn');

        const guess = async () => {
          if (isGameOver) return;
          const num = parseInt(input.value);
          if (!num) return;
          attempts++;

          if (num === target) {
            isGameOver = true;
            btn.disabled = true;
            btn.style.opacity = '0.5';
            processingEl.style.display = 'block';
            cancelBtn.style.display = 'none';

            const reward = Math.max(10, 35 - attempts * 2);
            await this.registerMiniGamePlay('numberGuess');
            await this.giveReward(reward, 'Adivina el Número');

            setTimeout(() => {
              overlay.remove();
              showAlert('success', '¡Correcto!', `${attempts} intentos = +${reward} 🪙`);
              this.renderMiniGamesSection();
            }, 800);
          } else if (num < target) {
            hint.textContent = '⬆️ Más alto';
            hint.style.color = 'var(--accent)';
          } else {
            hint.textContent = '⬇️ Más bajo';
            hint.style.color = 'var(--accent-2)';
          }
          input.value = '';
          input.focus();
        };

        btn.addEventListener('click', guess);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') guess(); });
        input.focus();
      },

      async playMathChallenge() {
        const gameData = await this.initMiniGameData('mathChallenge');
        if (gameData.playsToday >= 3) {
          showAlert('warning', 'Límite alcanzado', 'Vuelve mañana.');
          return;
        }

        let score = 0;
        let timeLeft = 30;
        let currentAnswer = 0;
        let isGameOver = false;

        const overlay = this.createOverlay();
        overlay.innerHTML = `
          <div class="minigame-modal">
            <h2 style="margin-bottom:10px;">🧮 Reto Matemático</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
              <div class="timer-display" style="margin:0;">Tiempo: <span id="mc-time">30</span>s</div>
              <div class="score-display" style="margin:0;">Puntos: <span id="mc-score">0</span></div>
            </div>
            <div id="mc-problem" style="font-size:3.5em; margin:24px 0; font-weight:800; color:var(--ink-0); text-shadow:0 0 20px rgba(255,255,255,0.1);">Ready?</div>
            <div class="math-options" id="mc-options">
              <button class="game-action-btn" id="mc-startBtn">EMPEZAR</button>
            </div>
            <div id="mc-processing" style="display:none; margin-top:20px; color:var(--accent); font-weight:700; animation: pulse 1s infinite;">
                Guardando progreso...
            </div>
            <button class="close-btn" id="mc-cancelBtn" onclick="this.closest('.overlay').remove()">Cancelar</button>
          </div>
        `;
        document.body.appendChild(overlay);

        const problemEl = document.getElementById('mc-problem');
        const optionsEl = document.getElementById('mc-options');
        const scoreEl = document.getElementById('mc-score');
        const timeEl = document.getElementById('mc-time');
        const processingEl = document.getElementById('mc-processing');
        const cancelBtn = document.getElementById('mc-cancelBtn');
        const startBtn = document.getElementById('mc-startBtn');

        const nextProblem = () => {
          if (isGameOver) return;
          const ops = ['+', '-', '*'];
          const op = ops[Math.floor(Math.random() * ops.length)];
          let a = Math.floor(Math.random() * 20) + 1;
          let b = Math.floor(Math.random() * 20) + 1;

          if (op === '*') { a = Math.floor(Math.random() * 10) + 1; b = Math.floor(Math.random() * 10) + 1; }
          if (op === '-') { if (a < b) [a, b] = [b, a]; }

          currentAnswer = eval(`${a} ${op} ${b}`);
          problemEl.textContent = `${a} ${op} ${b}`;

          // Generar opciones
          const options = [currentAnswer];
          while (options.length < 4) {
            const wrong = currentAnswer + Math.floor(Math.random() * 12) - 6;
            if (wrong !== currentAnswer && !options.includes(wrong) && (wrong >= 0 || op === '-')) options.push(wrong);
          }
          options.sort(() => Math.random() - 0.5);

          optionsEl.innerHTML = options.map(opt =>
            `<button class="game-btn option-btn" data-opt="${opt}">${opt}</button>`
          ).join('');
        };

        const checkMath = (val) => {
          if (isGameOver) return;
          if (val === currentAnswer) {
            score++;
            scoreEl.textContent = score;
            gsap.fromTo(scoreEl, { scale: 1.5 }, { scale: 1, duration: 0.3 });
            nextProblem();
          } else {
            timeLeft -= 3; // Penalización reducida para balance
            problemEl.style.color = 'var(--danger)';
            gsap.to(problemEl, {
              x: 10, repeat: 3, yoyo: true, duration: 0.05, onComplete: () => {
                problemEl.style.color = 'var(--ink-0)';
                problemEl.style.x = 0;
              }
            });
          }
        };

        const startMathGame = () => {
          startBtn.disabled = true;
          startBtn.style.opacity = '0.6';
          nextProblem();

          const interval = setInterval(async () => {
            timeLeft--;
            timeEl.textContent = Math.max(0, timeLeft);

            if (timeLeft <= 0) {
              clearInterval(interval);
              isGameOver = true;

              optionsEl.style.pointerEvents = 'none';
              optionsEl.style.opacity = '0.5';
              problemEl.textContent = 'FIN';
              processingEl.style.display = 'block';
              cancelBtn.style.display = 'none';

              const reward = Math.min(42, Math.floor(score * 2));

              await this.registerMiniGamePlay('mathChallenge');
              await this.giveReward(reward, 'Reto Matemático');

              setTimeout(() => {
                overlay.remove();
                showAlert('success', '¡Tiempo!', `${score} correctas = +${reward} 🪙`);
                this.renderMiniGamesSection();
              }, 800);
            }
          }, 1000);
        };

        optionsEl.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-opt]');
          if (!btn) return;
          const val = Number(btn.dataset.opt);
          if (!Number.isFinite(val)) return;
          checkMath(val);
        });

        startBtn.addEventListener('click', startMathGame);
      },

      async playReactionTest() {
        const gameData = await this.initMiniGameData('reactionTest');
        if (gameData.playsToday >= 3) {
          showAlert('warning', 'Límite alcanzado', 'Vuelve mañana.');
          return;
        }

        const overlay = this.createOverlay();
        overlay.innerHTML = `
          <div class="minigame-modal" id="rt-area" style="width:100%;height:100%;max-width:none;border-radius:0;background:var(--danger);cursor:pointer;display:flex;flex-direction:column;justify-content:center;transition:background 0.2s;">
            <h2 style="font-size:4em;color:white;margin:0;">ESPERA...</h2>
            <p style="color:white;opacity:0.8;font-size:1.5em;margin-top:10px;">Haz click cuando se ponga VERDE</p>
            <div id="rt-processing" style="display:none; color:white; font-weight:700; margin-top:20px; animation: pulse 1s infinite;">
                Guardando resultado...
            </div>
            <button class="close-btn" id="rt-cancelBtn" style="position:absolute;bottom:40px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.5);border:none;color:white;padding:10px 30px;border-radius:30px;" onclick="event.stopPropagation();this.closest('.overlay').remove()">Cancelar</button>
          </div>
        `;
        document.body.appendChild(overlay);

        const area = document.getElementById('rt-area');
        const h2 = area.querySelector('h2');
        const processingEl = document.getElementById('rt-processing');
        const cancelBtn = document.getElementById('rt-cancelBtn');
        let startTime = 0;
        let waiting = true;
        let timeout;
        let isGameOver = false;

        const start = () => {
          const delay = 2000 + Math.random() * 3000;
          timeout = setTimeout(() => {
            if (isGameOver) return;
            waiting = false;
            area.style.background = 'var(--ok)';
            h2.textContent = '¡CLICK!';
            startTime = Date.now();
          }, delay);
        };

        const reactionEvent = ('onpointerdown' in window) ? 'pointerdown' : 'click';
        area.addEventListener(reactionEvent, async (e) => {
          if (isGameOver || e.target.classList.contains('close-btn')) return;

          if (waiting) {
            clearTimeout(timeout);
            h2.textContent = '¡Muy pronto!';
            area.style.background = 'var(--warn)';
            setTimeout(() => {
              if (isGameOver) return;
              area.style.background = 'var(--danger)';
              h2.textContent = 'ESPERA...';
              start();
            }, 1000);
          } else {
            isGameOver = true;
            const time = Date.now() - startTime;
            const reward = Math.max(10, Math.floor(40 - time / 16));

            area.style.cursor = 'default';
            processingEl.style.display = 'block';
            cancelBtn.style.display = 'none';

            await this.registerMiniGamePlay('reactionTest');
            await this.giveReward(Math.max(5, reward), 'Test de Reacción');

            setTimeout(() => {
              overlay.remove();
              showAlert('success', '¡Rápido!', `${time}ms = +${Math.max(5, reward)} 🪙`);
              this.renderMiniGamesSection();
            }, 800);
          }
        });

        start();
      },

      async playSimonSays() {
        const gameData = await this.initMiniGameData('simonSays');
        if (gameData.playsToday >= 3) {
          showAlert('warning', 'Límite alcanzado', 'Vuelve mañana.');
          return;
        }

        const overlay = this.createOverlay();
        overlay.innerHTML = `
          <div class="minigame-modal">
            <h2 style="margin-bottom:10px;">🎹 Simon Dice</h2>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <div class="score-display" style="margin:0;">Ronda: <span id="ss-round">1</span></div>
              <div id="ss-processing" style="display:none; color:var(--accent); font-weight:700; animation: pulse 1s infinite;">
                Guardando...
              </div>
            </div>
            <div class="simon-grid">
              <div class="simon-btn" id="sb-0" style="background:#ff5555;"></div>
              <div class="simon-btn" id="sb-1" style="background:#5599ff;"></div>
              <div class="simon-btn" id="sb-2" style="background:#ffcc00;"></div>
              <div class="simon-btn" id="sb-3" style="background:#55ff55;"></div>
            </div>
            <div id="ss-msg" style="height:24px; color:var(--ink-1); font-weight:600; text-align:center;">Observa la secuencia...</div>
            <button class="close-btn" id="ss-cancelBtn" onclick="this.closest('.overlay').remove()">Cancelar</button>
          </div>
        `;
        document.body.appendChild(overlay);

        const sequence = [];
        let playerSeq = [];
        let round = 1;
        let playing = false;
        let isGameOver = false;

        const playSequence = async () => {
          if (isGameOver) return;
          playing = true;
          document.getElementById('ss-msg').textContent = 'Observa la secuencia...';
          sequence.push(Math.floor(Math.random() * 4));

          for (let i = 0; i < sequence.length; i++) {
            if (isGameOver) return;
            await new Promise(r => setTimeout(r, 600));
            const btn = document.getElementById(`sb-${sequence[i]}`);
            if (!btn) return;
            btn.style.opacity = '1';
            btn.style.boxShadow = `0 0 20px ${btn.style.background}`;
            btn.style.transform = 'scale(1.05)';
            await new Promise(r => setTimeout(r, 400));
            btn.style.opacity = '0.6';
            btn.style.boxShadow = 'none';
            btn.style.transform = 'scale(1)';
          }

          playing = false;
          playerSeq = [];
          document.getElementById('ss-msg').textContent = '¡Tu turno!';
        };

        const btns = document.querySelectorAll('.simon-btn');
        const processingEl = document.getElementById('ss-processing');
        const cancelBtn = document.getElementById('ss-cancelBtn');

        btns.forEach((btn, i) => {
          btn.style.opacity = '0.6';
          const simonEvent = ('onpointerdown' in window) ? 'pointerdown' : 'click';
          btn.addEventListener(simonEvent, async (ev) => {
            ev.preventDefault();
            if (playing || isGameOver) return;

            // Animación click
            btn.style.opacity = '1';
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => {
              btn.style.opacity = '0.6';
              btn.style.transform = 'scale(1)';
            }, 200);

            playerSeq.push(i);

            if (playerSeq[playerSeq.length - 1] !== sequence[playerSeq.length - 1]) {
              isGameOver = true;
              processingEl.style.display = 'block';
              cancelBtn.style.display = 'none';
              document.getElementById('ss-msg').textContent = '¡Secuencia incorrecta!';
              document.getElementById('ss-msg').style.color = 'var(--warn)';

              const reward = Math.max(10, (round - 1) * 5);
              await this.registerMiniGamePlay('simonSays');
              await this.giveReward(reward, 'Simon Dice');

              setTimeout(() => {
                overlay.remove();
                showAlert('info', 'Fin del juego', `Llegaste a la ronda ${round}. +${reward} 🪙`);
                this.renderMiniGamesSection();
              }, 800);
              return;
            }

            if (playerSeq.length === sequence.length) {
              playing = true;
              document.getElementById('ss-msg').textContent = '¡Bien hecho!';
              round++;
              document.getElementById('ss-round').textContent = round;
              setTimeout(playSequence, 1000);
            }
          });
        });

        setTimeout(playSequence, 1000);
      },

      createOverlay() {
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;';
        return overlay;
      },

      async giveReward(amount, source) {
        try {
          const state = await loadState();
          if (!state.dailyRewards) state.dailyRewards = {};
          if (!state.dailyRewards.missions) state.dailyRewards.missions = {};
          if (!state.dailyRewards.claims) state.dailyRewards.claims = {};

          // Incrementar progreso de misiones
          state.dailyRewards.missions.play_3_minigames = (state.dailyRewards.missions.play_3_minigames || 0) + 1;

          // Verificar si se completó la misión "Jugador" (play_3_minigames)
          const today = new Date().toDateString();
          let missionReward = 0;
          if (state.dailyRewards.missions.play_3_minigames >= 3 && state.dailyRewards.claims.play_3_minigames !== today) {
            missionReward = 40;
            state.dailyRewards.missionsCompleted = (state.dailyRewards.missionsCompleted || 0) + 1;
            state.dailyRewards.claims.play_3_minigames = today;
          }

          const totalReward = amount + missionReward;
          state.dailyRewards.totalEarned = (state.dailyRewards.totalEarned || 0) + totalReward;
          await saveState(state);
          await awardEcoxionums(totalReward, `Recompensa: ${source || 'Daily Rewards'}`);
          this.updateDailyUI();
          if (missionReward > 0) {
            setTimeout(() => {
              showAlert('success', '¡Misión Completada!', `Has jugado 3 mini-juegos. Recompensa: +${missionReward} 🪙`);
            }, 500);
          }
        } catch (error) {
          console.error('[Daily Rewards] Error al dar recompensa:', error);
        }
      }
    };

    function initDailyRewards() {
      dailyRewards.updateDailyUI();

      setInterval(() => {
        dailyRewards.updateDailyUI();
      }, 60000);
    }

    /* =========================
       SISTEMA DE MISIONES
       ========================= */
    async function checkMissionProgress(extId) {
      const state = await loadState();
      const ext = defaultExtensions[extId];
      const extInfo = state.installed[extId] || {};
      const missionData = state.missionProgress || {};
      const extMissions = missionData[extId] || {};

      const progress = {};

      if (!ext.missions) return progress;

      for (const mission of ext.missions) {
        const currentData = extMissions[mission.id] || { current: 0 };
        let current = currentData.current || 0;
        let completed = current >= mission.target;

        // Verificar progreso según el tipo de misión
        switch (mission.type) {
          case 'count':
            // Para notas - contar desde notas guardadas
            if (extId === 'notes') {
              const notes = JSON.parse(localStorage.getItem('ecoxion.notes') || '[]');
              current = notes.length;
              completed = current >= mission.target;
            }
            break;
          case 'length':
            // Para nota extensa - verificar si hay alguna nota con más de 100 caracteres
            if (extId === 'notes') {
              const notes = JSON.parse(localStorage.getItem('ecoxion.notes') || '[]');
              const hasLongNote = notes.some(note => note.content && note.content.length > 100);
              current = hasLongNote ? 1 : 0;
              completed = current >= mission.target;
            }
            break;
          case 'view':
            // Para usar notas - contar notas vistas
            if (extId === 'notes') {
              const notes = JSON.parse(localStorage.getItem('ecoxion.notes') || '[]');
              // Asegurarse de que todas las notas tengan la propiedad viewed
              notes.forEach((note, idx) => {
                if (note.viewed === undefined) {
                  note.viewed = false;
                  notes[idx] = note;
                }
              });
              if (notes.some(n => n.viewed === undefined)) {
                localStorage.setItem('ecoxion.notes', JSON.stringify(notes));
              }
              const viewedNotes = notes.filter(n => n.viewed === true).length;
              current = viewedNotes;
              completed = current >= mission.target;
            }
            break;
          case 'clicks':
            // Para clicky-coin - contar clics totales
            if (extId === 'clicky-coin') {
              const clickyData = state.clickyCoinData || {};
              current = clickyData.totalClicks || 0;
              completed = current >= mission.target;
            }
            break;
          case 'claims':
            // Para eco-generator - contar recompensas reclamadas
            if (extId === 'eco-generator') {
              const genData = state.generatorData || {};
              current = genData.rewardsCount || 0;
              completed = current >= mission.target;
            }
            break;
          case 'earned':
            // Para ganados - usar totalEarned
            if (extId === 'clicky-coin') {
              const clickyData = state.clickyCoinData || {};
              current = clickyData.totalEarned || 0;
              completed = current >= mission.target;
            } else if (extId === 'eco-generator') {
              const genData = state.generatorData || {};
              current = genData.totalEarned || 0;
              completed = current >= mission.target;
            }
            break;
          case 'streak':
            // Para racha
            if (extId === 'eco-generator') {
              const genData = state.generatorData || {};
              current = genData.streak || 0;
              completed = current >= mission.target;
            }
            break;
          case 'daily_limit':
            // Para límite diario
            if (extId === 'clicky-coin') {
              const clickyData = state.clickyCoinData || {};
              current = clickyData.reachedDailyLimit ? 1 : 0;
              completed = current >= mission.target;
            }
            break;
        }

        progress[mission.id] = { current, completed, target: mission.target };
      }

      return progress;
    }

    async function showMissionsModal(extId) {
      const ext = defaultExtensions[extId];
      if (!ext || !ext.missions) return;

      const missionProgress = await checkMissionProgress(extId);
      const allComplete = ext.missions.every(m => missionProgress[m.id]?.completed);

      const modal = document.createElement('div');
      modal.className = 'missions-modal';
      modal.innerHTML = `
    <div class="missions-container">
      <div class="missions-header">
        <div class="missions-title">${ext.icon} Misiones de ${ext.name}</div>
        <div class="missions-subtitle">Completa todas las misiones para despertar a V2</div>
      </div>
      
      <div id="missions-list">
        ${ext.missions.map(mission => {
        const progress = missionProgress[mission.id] || { current: 0, completed: false, target: mission.target };
        const percentage = Math.min(100, (progress.current / progress.target) * 100);

        return `
            <div class="mission-item ${progress.completed ? 'completed' : ''}">
              <div class="mission-header">
                <div class="mission-title">
                  <span class="mission-checkbox"></span>
                  ${mission.title}
                </div>
              </div>
              <div class="mission-description">${mission.description}</div>
              <div class="mission-progress">
                <div class="mission-progress-bar">
                  <div class="mission-progress-fill" style="width: ${percentage}%"></div>
                </div>
                <div class="mission-progress-text">${progress.current}/${progress.target}</div>
              </div>
            </div>
          `;
      }).join('')}
      </div>
      
      <div class="missions-footer">
        <div class="missions-progress-overall">
          <div class="missions-progress-text">
            Progreso: ${ext.missions.filter(m => missionProgress[m.id]?.completed).length}/${ext.missions.length} misiones completadas
          </div>
          <div class="missions-progress-bar-overall">
            <div class="missions-progress-fill-overall" style="width: ${(ext.missions.filter(m => missionProgress[m.id]?.completed).length / ext.missions.length) * 100}%"></div>
          </div>
        </div>
        
        ${allComplete ? `
          <button id="awaken-btn-fragmented" class="awaken-button-fragmented" onclick="triggerAwakening('${extId}');">
            ✨ DESPERTAR EXTENSIÓN
          </button>
        ` : `
          <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;">
            <button class="btn" onclick="refreshMissionsModal('${extId}');" style="background:rgba(100,167,255,.2);border:1px solid var(--accent);color:var(--accent);">🔄 Actualizar</button>
            <button class="btn" onclick="closeMissionsModal();">Cerrar</button>
          </div>
        `}
      </div>
    </div>
  `;

      document.body.appendChild(modal);

      setTimeout(() => {
        modal.classList.add('active');
      }, 10);

      // Si todas están completas, animar el botón fragmentado
      if (allComplete) {
        setTimeout(() => {
          const btn = document.getElementById('awaken-btn-fragmented');
          if (btn) {
            btn.classList.add('active');
            // Crear fragmentos
            createButtonFragments(btn);
          }
        }, 500);
      }

      window.closeMissionsModal = function () {
        gsap.to(modal, {
          opacity: 0,
          scale: 0.9,
          duration: 0.3,
          onComplete: () => modal.remove()
        });
      };

      window.triggerAwakening = async function (extId) {
        closeMissionsModal();
        setTimeout(async () => {
          await showUltimateAwakening(extId, async () => {
            const state = await loadState();
            const extInfo = state.installed[extId];
            extInfo.awakened = true;
            extInfo.awakenedAt = Date.now();
            state.installed[extId] = extInfo;
            await saveState(state);
            if (currentTab === 'dashboard') renderDashboard();
            else if (currentTab === 'marketplace') renderMarketplace();
            showAlert('success', '¡Despertada!', 'La extensión ha sido despertada a V2.');
          });
        }, 300);
      };

      window.refreshMissionsModal = async function (extId) {
        closeMissionsModal();
        setTimeout(() => {
          showMissionsModal(extId);
        }, 300);
      };
    }

    function createButtonFragments(button) {
      const fragments = [];
      const rect = button.getBoundingClientRect();

      for (let i = 0; i < 12; i++) {
        const fragment = document.createElement('div');
        fragment.className = 'awaken-button-fragment';
        fragment.style.left = (rect.left + Math.random() * rect.width) + 'px';
        fragment.style.top = (rect.top + Math.random() * rect.height) + 'px';
        document.body.appendChild(fragment);
        fragments.push(fragment);

        gsap.from(fragment, {
          x: (Math.random() - 0.5) * 200,
          y: (Math.random() - 0.5) * 200,
          opacity: 0,
          scale: 0,
          duration: 0.6,
          delay: i * 0.05,
          ease: 'back.out(1.7)',
          onComplete: () => {
            fragment.style.opacity = '0';
            setTimeout(() => fragment.remove(), 500);
          }
        });
      }
    }



    /* =========================
       SISTEMA DE ALERTAS
       ========================= */
    function showAlert(type, title, message, duration = 5000) {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.innerHTML = `
    <span class="alert-icon">${type === 'success' ? '?' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}</span>
    <div>
      <div style="font-weight:600;font-size:14px;">${title}</div>
      <div style="font-size:13px;opacity:0.9;">${message}</div>
    </div>
  `;

      container.appendChild(alert);
      gsap.from(alert, { x: 300, opacity: 0, duration: 0.3 });

      setTimeout(() => {
        gsap.to(alert, {
          x: 300,
          opacity: 0,
          duration: 0.3,
          onComplete: () => alert.remove()
        });
      }, duration);
    }

    // Normaliza texto remoto/local para evitar mojibake visible en UI.
    function normalizeUiText(value, fallback = '') {
      const raw = String(value ?? fallback ?? '');
      const trimmed = raw.trim();
      if (!trimmed) return String(fallback ?? '');
      const suspicious = /[\u00C3\u00C2\u00E2\u00F0]/.test(trimmed);
      if (!suspicious) return trimmed;
      try {
        const fixed = decodeURIComponent(escape(trimmed));
        return fixed && fixed.trim() ? fixed.trim() : trimmed;
      } catch {
        return trimmed;
      }
    }

    /* =========================
       NAVEGACIÓN
       ========================= */
    /* =========================
       NAVEGACIÓN (Rediseño Estilo Zen)
       ========================= */
    function createHeader() {
      const header = document.createElement('header');
      header.id = 'appbar';
      header.className = 'appbar normal-appbar';

      const state = loadState().then(s => s).catch(() => ({ username: 'Explorador', oceanPayLinked: false }));

      header.innerHTML = `
    <div class="normal-appbar-shell">
      <div class="normal-top-grid">
        <div class="normal-brand-wrap">
          <div class="normal-logo-box">
            <img src="assets/ecoxion.png" alt="Ecoxion Logo" onerror="this.style.display='none'; this.parentElement.textContent='E'; this.parentElement.style.fontWeight='800'; this.parentElement.style.color='var(--accent)';">
          </div>
          <div class="normal-title-block">
            <h1>ECOXION</h1>
            <div class="normal-title-sub" id="brand-subtitle">
              <span class="dot"></span>
              <span>Conectado</span>
            </div>
          </div>
        </div>

        <div class="normal-user-wrap">
          <div id="user-info" class="normal-user-pill">
            <span class="avatar">👤</span>
            <span class="normal-user-meta">
              <span id="username-display" class="normal-user-name">Cargando...</span>
              <span id="username-state" class="normal-user-state">Cuenta local</span>
            </span>
          </div>
          <div class="normal-balance-pill">
            <span style="font-size:1rem;">🪙</span>
            <span class="eco-balance-value" data-role="eco-balance">0</span>
          </div>
        </div>
      </div>

      <div class="normal-tabs-wrap">
        <nav class="tabs" data-role="main-tabs"></nav>
      </div>
    </div>
  `;

      state.then(s => {
        const usernameEl = header.querySelector('#username-display');
        const usernameStateEl = header.querySelector('#username-state');
        const userInfo = header.querySelector('#user-info');
        const brandSubtitle = header.querySelector('#brand-subtitle');
        const isLinked = s?.oceanPayLinked === true;

        if (usernameEl) usernameEl.textContent = normalizeUiText(s?.username, 'Explorador');
        if (usernameStateEl) usernameStateEl.textContent = isLinked ? 'Ocean Pay Vinculado' : 'Cuenta local';

        if (brandSubtitle) {
          brandSubtitle.innerHTML = isLinked
            ? `<span class="dot"></span><span>Conectado · Sincronizado</span>`
            : `<span class="dot" style="background:var(--ink-1); box-shadow:none;"></span><span>Modo local</span>`;
        }

        if (userInfo) {
          if (isLinked) {
            userInfo.style.borderColor = 'rgba(100, 167, 255, 0.42)';
            userInfo.style.background = 'rgba(100, 167, 255, 0.1)';
            userInfo.style.boxShadow = '0 0 18px rgba(100,167,255,0.14)';
          } else {
            userInfo.style.borderColor = 'rgba(255, 255, 255, 0.14)';
            userInfo.style.background = 'rgba(255, 255, 255, 0.05)';
            userInfo.style.boxShadow = 'none';
          }
        }
      });

      return header;
    }

    function buildSidebarZen() {
      const sidebar = document.createElement('div');
      sidebar.className = 'zen-sidebar';

      const state = loadState().then(s => s).catch(() => ({ username: 'Explorador', oceanPayLinked: false }));

      sidebar.innerHTML = `
    <div style="padding:28px 16px;border-bottom:2px solid rgba(100, 167, 255, 0.2);position:relative;overflow:hidden;background:linear-gradient(180deg, rgba(15,23,42,0.8), rgba(30,41,59,0.6));">
      <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, rgba(100,167,255,.08), rgba(179,136,255,.05));opacity:0.6;pointer-events:none;"></div>
      <div class="brand" style="flex-direction:column;align-items:center;position:relative;z-index:1;gap:12px;">
        <div class="logo-container" style="width:64px;height:64px;">
          <div class="logo-ring" style="width:64px;height:64px;">
            <img src="assets/ecoxion.png" alt="Ecoxion Logo" class="logo-image" onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
            <div class="logo-core" style="display:none;"></div>
          </div>
        </div>
        <div style="text-align:center;">
          <h1 class="brand-title" style="font-size:22px;margin:0 0 8px;letter-spacing:1.5px;">ECOXION</h1>
          <div class="brand-subtitle" id="zen-brand-subtitle" style="font-size:11px;opacity:0.8;display:flex;align-items:center;justify-content:center;gap:6px;">
            <span style="display:inline-block;width:6px;height:6px;background:var(--ok);border-radius:50%;box-shadow:0 0 8px var(--ok);animation:statusPulse 2s ease-in-out infinite;"></span>
            <span>Conectado</span>
          </div>
        </div>
      </div>
    </div>
    
    <div style="padding:16px 12px 8px;border-bottom:1px solid rgba(255,255,255,.05);">
      <div id="zen-user-info" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.04);border-radius:10px;border:1px solid rgba(255,255,255,.08);margin-bottom:8px;">
        <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 8px rgba(100,167,255,.3);">👤</div>
        <div style="flex:1;min-width:0;">
          <div id="zen-username" style="font-size:13px;font-weight:600;color:var(--ink-0);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Cargando...</div>
          <div style="font-size:11px;color:var(--ink-1);opacity:0.7;">Usuario</div>
        </div>
      </div>
    </div>
    
    <nav class="tabs" data-role="main-tabs" style="flex:1;overflow-y:auto;"></nav>
    
    <div style="padding:16px 12px;border-top:2px solid rgba(100, 167, 255, 0.15);position:relative;overflow:hidden;">
      <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, rgba(100,167,255,.05), rgba(179,136,255,.03));opacity:0.5;pointer-events:none;"></div>
      <div class="ecoxionums-balance" style="position:relative;z-index:1;">
        <span>🪙</span>
        <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
          <span class="eco-balance-value" data-role="eco-balance" style="font-size:18px;">0</span>
          <small style="font-size:11px;color:var(--ink-1);opacity:0.7;">Ecoxionums</small>
        </div>
      </div>
    </div>
  `;

      // Actualizar información de usuario
      state.then(s => {
        const usernameEl = sidebar.querySelector('#zen-username');
        const brandSubtitleEl = sidebar.querySelector('#zen-brand-subtitle');
        const userInfoEl = sidebar.querySelector('#zen-user-info');

        if (usernameEl) {
          usernameEl.textContent = normalizeUiText(s.username, 'Explorador');
        }

        if (brandSubtitleEl) {
          brandSubtitleEl.textContent = s.oceanPayLinked ? 'Conectado' : 'Prototipo';
        }

        if (userInfoEl && s.oceanPayLinked) {
          userInfoEl.style.borderColor = 'rgba(100, 167, 255, 0.3)';
          userInfoEl.style.background = 'rgba(100, 167, 255, 0.1)';
        }
      });

      return sidebar;
    }

    // Legacy renderer retained for reference only.
    async function renderNavigationLegacy() {
      const state = await loadState();
      const isZen = state.zenMode === true;

      // Enforce Body Class
      if (isZen) document.body.classList.add('zen-layout');
      else document.body.classList.remove('zen-layout');

      // Remove existing navigation (sidebar or header)
      const existingNav = document.querySelector('.zen-sidebar');
      if (existingNav) existingNav.remove();

      // Build new navigation
      let navElement;
      if (isZen) {
        navElement = buildSidebarZen();
      } else {
        navElement = createHeader();
      }

      // Insert at the top of the app wrapper or body
      const content = document.getElementById('content');
      if (content && content.parentNode) {
        content.parentNode.insertBefore(navElement, content);
      } else {
        document.body.prepend(navElement);
      }

      renderTabs();
    }

    function renderTabs() {
      const tabsContainers = Array.from(document.querySelectorAll('[data-role="main-tabs"]'));
      if (!tabsContainers.length) return;
      const visibleTabsContainer = tabsContainers.find(el => el.offsetParent !== null) || tabsContainers[0];

      const tabs = [
        { id: 'dashboard', label: 'Dashboard', icon: '&#128200;' },
        { id: 'marketplace', label: 'Marketplace', icon: '&#128722;' },
        { id: 'commerce', label: 'Comercio', icon: '&#128179;' },
        { id: 'my-extensions', label: 'Mis Exts', icon: '&#129513;' },
        { id: 'packages', label: 'Paquetes', icon: '&#128230;' },
        { id: 'rewards', label: 'Premios', icon: '&#127873;' },
        { id: 'subscriptions', label: 'Suscripciones', icon: '&#11088;' },
        { id: 'statistics', label: 'Stats', icon: '&#128200;' },
        { id: 'settings', label: 'Ajustes', icon: '&#9881;&#65039;' }
      ];

      // Estilo de "Pills" moderno
      visibleTabsContainer.innerHTML = tabs.map(tab => `
    <button class="nav-pill" data-tab="${tab.id}" aria-selected="false" 
            style="position:relative;overflow:hidden;padding:8px 16px; border-radius:20px; border:1px solid transparent; background:rgba(255,255,255,.03); color:var(--ink-1); font-size:13px; font-weight:600; display:flex; align-items:center; gap:8px; cursor:pointer; transition:all 0.2s ease; white-space:nowrap;">
      <span style="font-size:16px;">${tab.icon}</span>
      <span>${tab.label}</span>
      <div class="active-indicator" style="width:0; height:2px; background:var(--accent); border-radius:2px; position:absolute; bottom:4px; left:50%; transform:translateX(-50%); transition:width 0.2s;"></div>
    </button>
  `).join('');

      // Update logic for pill selection styling
      const updatePillStyles = (selectedId) => {
        visibleTabsContainer.querySelectorAll('.nav-pill').forEach(btn => {
          const isActive = btn.dataset.tab === selectedId;
          btn.setAttribute('aria-selected', isActive);

          if (isActive) {
            btn.style.background = 'rgba(100,167,255,.15)';
            btn.style.color = 'var(--accent)';
            btn.style.borderColor = 'rgba(100,167,255,.3)';
            btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
          } else {
            btn.style.background = 'rgba(255,255,255,.03)';
            btn.style.color = 'var(--ink-1)';
            btn.style.borderColor = 'transparent';
            btn.style.boxShadow = 'none';
          }
          const indicator = btn.querySelector('.active-indicator');
          if (indicator) indicator.style.width = isActive ? '72%' : '0';
        });
      };

      visibleTabsContainer.querySelectorAll('.nav-pill').forEach(btn => {
        btn.addEventListener('click', () => {
          updatePillStyles(btn.dataset.tab);
          switchTab(btn.dataset.tab);
        });
      });

      // Init styles
      updatePillStyles(currentTab);
    }

    let currentTab = 'dashboard';
    function switchTab(tabId) {
      currentTab = tabId;

      // Actualizar tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.setAttribute('aria-selected', btn.dataset.tab === tabId);
      });

      // Renderizar contenido
      if (tabId === 'dashboard') renderDashboard();
      else if (tabId === 'my-extensions') renderMyExtensions();
      else if (tabId === 'packages') renderPackages();
      else if (tabId === 'rewards') renderRewards();
      else if (tabId === 'marketplace') renderMarketplace();
      else if (tabId === 'commerce') renderCommerce();
      else if (tabId === 'statistics') renderStatistics();
      else if (tabId === 'subscriptions') renderSubscriptions();
      else if (tabId === 'settings') renderSettings();
    }

    /* =========================
       DASHBOARD
       ========================= */
    async function renderDashboard() {
      const content = document.getElementById('content');
      content.className = 'dashboard-list';
      content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--ink-1);">Cargando dashboard...</div>';

      const state = await loadState();
      const activeExtensions = Object.values(state.installed).filter(ext => ext.enabled);

      if (activeExtensions.length === 0) {
        content.innerHTML = `
      <div class="card" style="text-align:center;padding:40px;">
        <h2>No hay extensiones instaladas</h2>
        <p style="color:var(--ink-1);">Ve al Marketplace para instalar tu primera extensión.</p>
        <button class="btn primary" onclick="switchTab('marketplace')" style="margin-top:16px;">Ir al Marketplace</button>
      </div>
    `;
        return;
      }

      content.innerHTML = '';

      // Tarjeta resumen de estado
      const summary = document.createElement('div');
      summary.className = 'card';
      summary.style.marginBottom = '16px';
      const totalExts = Object.keys(state.installed || {}).length;
      const ecoBalance = state.ecoxionums || 0;
      const linked = state.oceanPayLinked;
      summary.innerHTML = `
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;justify-content:space-between;">
      <div>
        <h2 style="margin:0 0 4px;font-size:22px;">Resumen de tu ecosistema</h2>
        <p style="margin:0;color:var(--ink-1);font-size:13px;">Extensiones activas: ${activeExtensions.length}/${totalExts}</p>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="min-width:130px;padding:10px 12px;border-radius:10px;background:rgba(100,167,255,.08);border:1px solid rgba(100,167,255,.4);">
          <div style="font-size:11px;color:var(--ink-1);text-transform:uppercase;letter-spacing:.5px;">Ecoxionums</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent);" id="dashboard-eco-balance">${ecoBalance.toLocaleString()}</div>
        </div>
        <div style="min-width:130px;padding:10px 12px;border-radius:10px;background:rgba(55,214,122,.08);border:1px solid rgba(55,214,122,.4);">
          <div style="font-size:11px;color:var(--ink-1);text-transform:uppercase;letter-spacing:.5px;">Ocean Pay</div>
          <div style="font-size:13px;font-weight:600;color:${linked ? 'var(--ok)' : 'var(--warn)'};">
            ${linked ? 'Conectado' : 'No vinculado'}
          </div>
        </div>
      </div>
    </div>
  `;
      content.appendChild(summary);

      for (const extInfo of activeExtensions) {
        const ext = defaultExtensions[extInfo.id];
        if (!ext || !ext.getPanelHTML) continue;

        const panel = document.createElement('div');
        panel.className = 'card extension-panel';
        panel.setAttribute('data-panel', extInfo.id);
        panel.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.1);">
        <div style="font-size:32px;position:relative;width:48px;height:48px;">
          <canvas id="canvas-dash-${extInfo.id}" width="96" height="96" style="width:100%;height:100%;object-fit:contain;"></canvas>
          ${extInfo.awakened ? '<span style="position:absolute;top:-8px;right:-8px;font-size:16px;filter:drop-shadow(0 0 8px rgba(100,167,255,0.8));">✨</span>' : ''}
        </div>
        <div style="flex:1;">
          <h3 style="margin:0;font-size:18px;display:flex;align-items:center;gap:8px;">
            ${ext.name}
            ${extInfo.awakened ? '<span class="v2-badge">V2</span>' : ''}
          </h3>
          <small style="color:var(--ink-1);">v${extInfo.awakened && ext.version2 ? ext.version2 : ext.version}</small>
        </div>
        ${ext.hasV2 && !extInfo.awakened ? `
          <button class="btn" onclick="showMissionsModal('${ext.id}')" style="background:linear-gradient(135deg, rgba(100,167,255,.2), rgba(179,136,255,.2));border:1px solid var(--accent);color:var(--accent);padding:6px 12px;font-size:12px;">
            ✨ Ver Misiones V2
          </button>
        ` : ''}
      </div>
      <div class="panel-content" id="panel-content-${extInfo.id}">Cargando...</div>
    `;

        content.appendChild(panel);

        // Draw Canvas Icon immediately
        const rarityColors = { comun: '#94a3b8', poco_comun: '#64a7ff', rara: '#60a5fa', epica: '#a855f7', legendaria: '#f59e0b' };
        drawExtensionIcon(`canvas-dash-${extInfo.id}`, extInfo.id, rarityColors[ext.rarity] || 'var(--accent)');

        // Cargar contenido del panel de forma asíncrona
        (async () => {
          const panelContent = panel.querySelector(`#panel-content-${extInfo.id}`);
          if (panelContent) {
            try {
              const html = await ext.getPanelHTML();
              panelContent.innerHTML = html;
            } catch (e) {
              panelContent.innerHTML = '<p style="color:var(--danger);">Error al cargar el panel.</p>';
            }
          }
        })();

        // Inicializar extensión
        if (typeof ext.onEnable === 'function') {
          setTimeout(() => ext.onEnable(extInfo), 100);
        }

        // Inicializar paneles específicos si existen
        if (extInfo.id === 'eco-generator') {
          setTimeout(updateGeneratorPanel, 200);
        }
        if (extInfo.id === 'clicky-coin') {
          setTimeout(updateClickyCoinPanel, 200);
        }
      }

      // Actualizar paneles con timers activos
      const generatorPanel = document.getElementById('eco-generator-panel');
      if (generatorPanel) {
        updateGeneratorPanel();
        setInterval(updateGeneratorPanel, 60000); // Actualizar cada minuto
      }

      const clickyPanel = document.getElementById('clicky-coin-panel');
      if (clickyPanel) {
        updateClickyCoinPanel();
        // Actualizar botón de retiro periódicamente
        setInterval(updateWithdrawButton, 2000);
      }
    }

    /* =========================
       MIS EXTENSIONES
       ========================= */
    async function renderMyExtensions() {
      const content = document.getElementById('content');
      content.className = '';
      content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--ink-1);">Cargando extensiones...</div>';

      const state = await loadState();
      const isZen = document.body.classList.contains('zen-layout');

      // Filtrar solo extensiones que existen en defaultExtensions
      const installedExtensions = Object.entries(state.installed || {})
        .filter(([id]) => defaultExtensions[id])
        .map(([id, info]) => ({
          ...defaultExtensions[id],
          ...info,
          id
        }));

      // Limpiar extensiones huérfanas
      const orphanedExtensions = Object.keys(state.installed || {}).filter(id => !defaultExtensions[id]);
      if (orphanedExtensions.length > 0) {
        orphanedExtensions.forEach(id => delete state.installed[id]);
        await saveState(state);
      }

      if (installedExtensions.length === 0) {
        content.innerHTML = `
          <div class="card" style="text-align:center;padding:60px 40px;">
            <div style="font-size:64px;margin-bottom:20px;">🧩</div>
            <h2 style="margin:0 0 12px;">No tienes extensiones instaladas</h2>
            <p style="color:var(--ink-1);margin:0 0 24px;">Explora el Marketplace para descubrir extensiones increíbles</p>
            <button class="btn primary" onclick="switchTab('marketplace')" style="padding:14px 32px;font-size:16px;">
              🛒 Ir al Marketplace
            </button>
          </div>
        `;
        return;
      }

      const header = document.createElement('div');
      header.className = 'card';
      header.style.marginBottom = '20px';
      header.style.textAlign = isZen ? 'left' : 'center';
      header.innerHTML = `
        <h2 style="margin:0 0 8px;font-size:28px;display:flex;align-items:center;justify-content:${isZen ? 'flex-start' : 'center'};gap:12px;">
          <span>🧩</span>
          <span>Mis Extensiones</span>
        </h2>
        <p style="margin:0;color:var(--ink-1);font-size:14px;">
          Gestiona tus extensiones instaladas: habilita, deshabilita o desinstala
        </p>
      `;
      content.innerHTML = '';
      content.appendChild(header);

      const listContainer = document.createElement('div');
      if (isZen) {
        listContainer.className = 'zen-list-layout';
      } else {
        listContainer.style.display = 'grid';
        listContainer.style.gap = '16px';
      }

      installedExtensions.forEach(ext => {
        const rarityColors = {
          comun: '#94a3b8',
          poco_comun: '#64a7ff',
          rara: '#60a5fa',
          epica: '#a855f7',
          legendaria: '#f59e0b'
        };
        const accentColor = rarityColors[ext.rarity] || 'var(--accent)';

        if (isZen) {
          const item = document.createElement('div');
          item.className = 'zen-list-item';
          if (!ext.enabled) item.style.opacity = '0.6';

          const actionButtons = `
            ${ext.type === 'passive' ? `
              <button class="btn" onclick="toggleExtension('${ext.id}')" style="background:${ext.enabled ? 'var(--warn)' : 'var(--ok)'}; border-color:${ext.enabled ? 'var(--warn)' : 'var(--ok)'}; font-size:12px; padding:6px 12px;">
                ${ext.enabled ? 'Deshabilitar' : 'Habilitar'}
              </button>
            ` : `
              <button class="btn primary" onclick="switchTab('dashboard')" style="font-size:12px; padding:6px 12px;">Panel</button>
            `}
            ${!ext.defaultInstall ? `
              <button class="btn" onclick="uninstallExtension('${ext.id}')" style="background:var(--danger); border-color:var(--danger); font-size:12px; padding:6px 12px;">Borrar</button>
            ` : ''}
            ${ext.hasV2 && !ext.awakened ? `
              <button class="btn" onclick="showMissionsModal('${ext.id}')" style="background:linear-gradient(135deg, #a855f7, #6366f1); border:none; color:white; font-size:12px; padding:6px 12px;">✨ V2</button>
            ` : ''}
          `;

          item.innerHTML = `
            <div class="item-icon" style="color:${accentColor};">
               <canvas id="canvas-my-zen-${ext.id}" width="96" height="96" style="width:40px;height:40px;object-fit:contain;"></canvas>
            </div>
            <div class="item-info">
              <h3>
                ${ext.name}
                ${ext.awakened ? '<span class="badge" style="background:#10b98120; color:#10b981; border:1px solid #10b98140;">V2</span>' : ''}
              </h3>
              <p>${ext.description}</p>
              <div class="item-meta">
                <span class="badge" style="background:${accentColor}15; color:${accentColor}; border: 1px solid ${accentColor}30;">${ext.rarity.replace('_', ' ')}</span>
                <span style="font-size:12px; color:var(--ink-1); font-weight:600;">${ext.type === 'passive' ? '⚡ Pasiva' : '?? Activa'}</span>
                <span style="opacity:0.6; font-size:12px;">v${ext.awakened && ext.version2 ? ext.version2 : ext.version}</span>
              </div>
            </div>
            <div class="item-actions">
              ${actionButtons}
            </div>
          `;
          listContainer.appendChild(item);
        } else {
          const item = document.createElement('div');
          item.className = 'card';
          item.style.cssText = `position:relative; overflow:hidden; transition:all 0.3s ease; ${!ext.enabled ? 'opacity:0.6;' : ''}`;
          item.innerHTML = `
            <div style="position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); opacity:${ext.enabled ? '1' : '0.3'};"></div>
            <div style="display:flex; align-items:start; gap:20px; padding-top:8px;">
              <div style="font-size:48px; position:relative; flex-shrink:0; width:64px; height:64px;">
                <canvas id="canvas-my-card-${ext.id}" width="96" height="96" style="width:100%;height:100%;object-fit:contain;"></canvas>
                ${ext.awakened ? '<span style="position:absolute; top:-4px; right:-4px; font-size:20px; filter:drop-shadow(0 0 8px rgba(100,167,255,0.8));">✨</span>' : ''}
              </div>
              <div style="flex:1; min-width:0;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:wrap;">
                  <h3 style="margin:0; font-size:20px; font-weight:700;">${ext.name}</h3>
                  ${ext.awakened ? '<span class="v2-badge">V2</span>' : ''}
                  <span style="padding:4px 10px; background:rgba(100,167,255,.15); border:1px solid rgba(100,167,255,.3); border-radius:8px; font-size:11px; font-weight:600; color:var(--accent); text-transform:uppercase;">
                    ${ext.type === 'passive' ? '⚡ Pasiva' : '?? Activa'}
                  </span>
                  ${ext.enabled ?
              '<span style="padding:4px 10px; background:rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.3); border-radius:8px; font-size:11px; font-weight:600; color:var(--ok);">✓ Habilitada</span>' :
              '<span style="padding:4px 10px; background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.3); border-radius:8px; font-size:11px; font-weight:600; color:var(--danger);">✗ Deshabilitada</span>'
            }
                </div>
                <p style="margin:0 0 12px; color:var(--ink-1); font-size:14px; line-height:1.5;">${ext.description}</p>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                  <span style="font-size:12px; color:var(--ink-1);"><strong>Versión:</strong> ${ext.awakened && ext.version2 ? ext.version2 : ext.version}</span>
                  <span style="color:rgba(255,255,255,.2);">•</span>
                  <span style="font-size:12px; color:var(--ink-1);"><strong>Rareza:</strong> ${ext.rarity.replace('_', ' ')}</span>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  ${ext.type === 'passive' ? `
                    <button class="btn" onclick="toggleExtension('${ext.id}')" style="background:${ext.enabled ? 'var(--warn)' : 'var(--ok)'}; border-color:${ext.enabled ? 'var(--warn)' : 'var(--ok)'}; min-width:140px;">
                      ${ext.enabled ? '⏸️ Deshabilitar' : '▶️ Habilitar'}
                    </button>
                  ` : `
                    <button class="btn primary" onclick="switchTab('dashboard')" style="min-width:140px;">📱 Abrir Panel</button>
                  `}
                  ${!ext.defaultInstall ? `
                    <button class="btn" onclick="uninstallExtension('${ext.id}')" style="background:var(--danger); border-color:var(--danger); min-width:140px;">🗑️ Desinstalar</button>
                  ` : `
                    <button class="btn" disabled style="opacity:0.5; cursor:not-allowed; min-width:140px;" title="Esta extensi?n no se puede desinstalar">?? Predeterminada</button>
                  `}
                  ${ext.hasV2 && !ext.awakened ? `
                    <button class="btn" onclick="showMissionsModal('${ext.id}')" style="background:linear-gradient(135deg, rgba(100,167,255,.2), rgba(179,136,255,.2)); border:1px solid var(--accent); color:var(--accent); min-width:140px;">✨ Despertar V2</button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
          listContainer.appendChild(item);
        }
      });
      content.appendChild(listContainer);

      // Draw all icons after insertion
      installedExtensions.forEach(ext => {
        const rarityColors = { comun: '#94a3b8', poco_comun: '#64a7ff', rara: '#60a5fa', epica: '#a855f7', legendaria: '#f59e0b' };
        const color = rarityColors[ext.rarity] || 'var(--accent)';
        if (isZen) {
          drawExtensionIcon(`canvas-my-zen-${ext.id}`, ext.id, color);
        } else {
          drawExtensionIcon(`canvas-my-card-${ext.id}`, ext.id, color);
        }
      });
    }

    window.toggleExtension = async function (extId) {
      const state = await loadState();
      const ext = defaultExtensions[extId];
      const extInfo = state.installed[extId];

      if (!ext || !extInfo) return;

      const newStatus = !extInfo.enabled;
      extInfo.enabled = newStatus;

      // Actualizar UI y estado inmediatamente
      await saveState(state);
      renderMyExtensions();

      if (newStatus) {
        showAlert('success', 'Extensión habilitada', `${ext.name} ha sido habilitada.`);
        if (typeof ext.onEnable === 'function') ext.onEnable(extInfo);
      } else {
        showAlert('info', 'Extensión deshabilitada', `${ext.name} ha sido deshabilitada.`);
        if (typeof ext.onDisable === 'function') ext.onDisable(extInfo);
      }
    };

    window.uninstallExtension = async function (extId) {
      const state = await loadState();
      const ext = defaultExtensions[extId];

      if (!ext) return;

      if (ext.defaultInstall) {
        showAlert('warning', 'No se puede desinstalar', 'Esta extensión es predeterminada y no se puede desinstalar.');
        return;
      }

      const confirmed = confirm(`¿Estás seguro de que deseas desinstalar "${ext.name}"?\n\nEsta acción no se puede deshacer.`);

      if (!confirmed) return;

      // Deshabilitar primero si tiene onDisable
      if (state.installed[extId]?.enabled && typeof ext.onDisable === 'function') {
        await ext.onDisable(state.installed[extId]);
      }

      delete state.installed[extId];
      await saveState(state);

      showAlert('success', 'Extensión desinstalada', `${ext.name} ha sido desinstalada correctamente.`);
      renderMyExtensions();
    };

    /* =========================
       RECOMPENSAS DIARIAS
       ========================= */
    async function renderRewards() {
      const content = document.getElementById('content');
      content.className = '';
      content.innerHTML = `
    <div class="eco-rewards-shell">
      <div class="eco-rewards-side">
        <div class="eco-reward-hero">
          <h3>Recompensas y Minijuegos</h3>
          <p>Completa rutina diaria, misiones y partidas rapidas para acelerar Ecoxionums.</p>
        </div>
        <div class="card">
          <div class="dr-reward-card">
            <div style="font-size:3em;margin-bottom:8px;">🎁</div>
            <h3 style="margin:0 0 8px;color:var(--accent);">Recompensa Diaria</h3>
            <p style="margin:0 0 12px;color:var(--ink-1);font-size:0.9em;">Escala con tu racha diaria</p>
            <div class="dr-reward-amount" id="dr-dailyAmount">+80 🪙</div>
            <button class="dr-claim-btn" id="dr-claimDailyBtn" onclick="dailyRewards.claimDaily()">🎁 Reclamar</button>
            <div id="dr-dailyTimer" style="margin-top:12px;color:var(--ink-1);font-size:0.9em;"></div>
          </div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 12px;color:var(--ink-0);">📊 Estadisticas</h3>
          <div class="dr-stats-grid">
            <div class="dr-stat-card">
              <div class="dr-stat-value" id="dr-totalEarned">0</div>
              <div class="dr-stat-label">Total Ganado</div>
            </div>
            <div class="dr-stat-card">
              <div class="dr-stat-value" id="dr-dailyStreak">0</div>
              <div class="dr-stat-label">Racha</div>
            </div>
            <div class="dr-stat-card">
              <div class="dr-stat-value" id="dr-missionsCompleted">0</div>
              <div class="dr-stat-label">Misiones</div>
            </div>
          </div>
        </div>
      </div>
      <div class="eco-rewards-main">
        <div class="card" style="margin-bottom:20px;">
          <h3 style="margin:0 0 12px;color:var(--ink-0);">📋 Misiones Diarias</h3>
          <div class="dr-missions-grid" id="dr-missionsList"></div>
        </div>
        <div class="card" style="margin-bottom:20px;">
          <h3 style="margin:0 0 12px;color:var(--ink-0);">🎮 Minijuegos</h3>
          <div id="dr-minigames-container" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;"></div>
        </div>
      </div>
    </div>
  `;

      if (!document.getElementById('daily-reward-style-fix')) {
        const style = document.createElement('style');
        style.id = 'daily-reward-style-fix';
        style.textContent = `
          .dr-reward-card { background: linear-gradient(135deg, rgba(100,167,255,.15), rgba(179,136,255,.15)); border: 2px solid var(--accent); border-radius: 12px; padding: 20px; text-align: center; }
          .dr-reward-amount { font-size: 3em; font-weight: bold; color: #ffd700; margin: 12px 0; }
          .dr-claim-btn { width: 100%; padding: 14px; font-size: 1.1em; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
          .dr-claim-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,215,0,.4); }
          .dr-claim-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; background: #666; }
          .dr-missions-grid { display: grid; gap: 12px; margin-bottom: 4px; }
          .dr-mission-card { background: var(--bg-1); border: 2px solid rgba(255,255,255,.08); border-radius: 10px; padding: 16px; transition: all 0.3s; }
          .dr-mission-card.completed { border-color: var(--ok); background: rgba(55,214,122,.1); }
          .dr-mission-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
          .dr-mission-title { font-weight: bold; color: var(--ink-0); font-size: 1.03em; }
          .dr-mission-reward { color: #ffd700; font-weight: bold; }
          .dr-mission-progress { background: rgba(255,255,255,.05); height: 8px; border-radius: 4px; overflow: hidden; margin: 8px 0; }
          .dr-mission-progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width 0.3s; }
          .dr-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
          .dr-stat-card { background: var(--bg-1); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,.08); }
          .dr-stat-value { font-size: 1.8em; font-weight: bold; color: var(--accent); }
          .dr-stat-label { font-size: 0.85em; color: var(--ink-1); margin-top: 4px; }
          .minigame-card-premium { min-height: 210px; }
          .minigame-modal { background: var(--bg-1); padding: 30px; border-radius: 24px; text-align: center; max-width: 420px; width: 92%; max-height: 85vh; overflow-y: auto; border: 2px solid var(--accent); box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; animation: modalPop 0.24s cubic-bezier(0.175, 0.885, 0.32, 1.275); scrollbar-width: thin; scrollbar-color: var(--accent) transparent; }
          .minigame-modal::-webkit-scrollbar { width: 6px; }
          .minigame-modal::-webkit-scrollbar-track { background: transparent; }
          .minigame-modal::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 20px; }
          @keyframes modalPop { from { transform: scale(0.86); opacity: 0; } to { transform: scale(1); opacity: 1; } }
          .minigame-modal h2 { margin: 0 0 14px; color: var(--accent); font-size: 2em; }
          .score-display { font-size: 3.2em; font-weight: 900; color: #ffd700; margin: 10px 0; text-shadow: 0 4px 12px rgba(255, 215, 0, 0.3); }
          .timer-display { font-size: 1.2em; color: var(--ink-1); margin-bottom: 18px; font-variant-numeric: tabular-nums; }
          .game-action-btn { width: 180px; height: 180px; border-radius: 50%; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 2em; font-weight: 800; cursor: pointer; box-shadow: 0 10px 30px rgba(102,126,234,.35); transition: transform .1s; }
          .game-action-btn:active { transform: scale(0.95); }
          .cg-hit-area { margin: 0 auto; width: min(100%, 320px); border: 1px dashed rgba(255,255,255,0.24); border-radius: 20px; padding: 12px; display: grid; place-items: center; background: radial-gradient(circle at 50% 20%, rgba(102,126,234,.18), rgba(0,0,0,0)); }
          .cg-hit-hint { margin-top: 10px; font-size: 11px; color: var(--ink-1); text-align: center; }
          .dr-cooldown-time { margin-top: 4px; font-size: 11px; font-weight: 700; color: var(--warn); letter-spacing: 0.3px; }
          .dr-cooldown-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); }
          .dr-cooldown-pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--bg-2); border: 1px solid rgba(255,255,255,0.14); border-radius: 999px; font-size: 12px; font-weight: 700; color: var(--warn); box-shadow: 0 6px 20px rgba(0,0,0,0.35); }
          .dr-cooldown-spinner { width: 12px; height: 12px; border-radius: 50%; border: 2px solid rgba(245,158,11,0.25); border-top-color: var(--warn); animation: drSpin 1s linear infinite; }
          @keyframes drSpin { to { transform: rotate(360deg); } }
          .close-btn { margin-top: 24px; padding: 10px 24px; background: rgba(255,255,255,0.1); color: var(--ink-1); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
          .close-btn:hover { background: var(--danger); color: #fff; }
          .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
          .memory-card { aspect-ratio: 1; background: var(--bg-2); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2em; cursor: pointer; transition: all 0.3s; user-select: none; }
          .memory-card.flipped, .memory-card.matched { background: var(--accent); border-color: var(--accent); transform: rotateY(180deg); }
          .memory-card.matched { background: var(--ok); border-color: var(--ok); opacity: .56; }
          .math-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
          .option-btn { padding: 20px; font-size: 1.4em; background: var(--bg-2); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; color: var(--ink-0); cursor: pointer; transition: all 0.2s; }
          .option-btn:hover { border-color: var(--accent); background: rgba(100,167,255,.12); }
          .simon-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 240px; margin: 0 auto; }
          .simon-btn { aspect-ratio: 1; border-radius: 16px; cursor: pointer; transition: all 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
          .simon-btn:active { transform: scale(0.95); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
          .game-input { width: 100%; padding: 16px; font-size: 1.4em; text-align: center; background: var(--bg-2); border: 2px solid var(--accent); border-radius: 12px; color: var(--ink-0); margin-bottom: 16px; font-family: monospace; }
          .game-btn { width: 100%; padding: 16px; background: var(--accent); color: #0a0e1a; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; }
        `;
        document.head.appendChild(style);
      }

      initDailyRewards();
    }

    /* =========================
       MARKETPLACE
       ========================= */
    /* =========================
       SISTEMA DE PAQUETES (GACHA)
       ========================= */
    const packagesConfig = {
      'starter': {
        id: 'starter',
        name: 'Paquete de Inicio',
        description: 'Ideal para nuevos exploradores. Contiene extensiones básicas.',
        price: 100,
        icon: '📦',
        color: 'var(--ok)',
        probabilities: { comun: 70, poco_comun: 25, rara: 5, epica: 0, legendaria: 0 }
      },
      'advanced': {
        id: 'advanced',
        name: 'Paquete Avanzado',
        description: 'Mejora tu arsenal con herramientas más potentes.',
        price: 250,
        icon: '💼',
        color: 'var(--accent)',
        probabilities: { comun: 30, poco_comun: 50, rara: 15, epica: 5, legendaria: 0 }
      },
      'elite': {
        id: 'elite',
        name: 'Paquete de Élite',
        description: 'Solo para los más exigentes. Alta probabilidad de rarezas.',
        price: 600,
        icon: '💎',
        color: 'var(--accent-2)',
        probabilities: { comun: 10, poco_comun: 30, rara: 40, epica: 18, legendaria: 2 }
      },
      'developer': {
        id: 'developer',
        name: 'Pack Desarrollador',
        description: 'Herramientas enfocadas en productividad y código.',
        price: 350,
        icon: '👨‍💻',
        color: '#F59E0B',
        theme: 'dev',
        probabilities: { comun: 20, poco_comun: 40, rara: 30, epica: 10, legendaria: 0 }
      },
      'gamer': {
        id: 'gamer',
        name: 'Pack Gamer',
        description: 'Juegos y entretenimiento para tus descansos.',
        price: 350,
        icon: '🎮',
        color: '#EF4444',
        theme: 'game',
        probabilities: { comun: 20, poco_comun: 40, rara: 30, epica: 10, legendaria: 0 }
      }
    };

    async function renderPackages() {
      const content = document.getElementById('content');
      content.innerHTML = '';
      content.className = '';

      const state = await loadState();

      content.innerHTML = `
        <div class="card" style="margin-bottom:24px;text-align:center;background:linear-gradient(135deg, rgba(100,167,255,.1), rgba(179,136,255,.1));border:1px solid var(--accent);">
          <div style="font-size:48px;margin-bottom:16px;">🎁</div>
          <h2 style="margin:0 0 8px;font-size:32px;background:linear-gradient(90deg, var(--accent), var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Tienda de Paquetes</h2>
          <p style="color:var(--ink-1);max-width:600px;margin:0 auto 24px;">
            Adquiere paquetes sorpresa y obtén extensiones aleatorias. ¡Puedes conseguir extensiones Épicas o Legendarias!
          </p>
          <div style="display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(0,0,0,.3);border-radius:20px;border:1px solid rgba(255,255,255,.1);">
            <span>Tu saldo:</span>
            <span style="font-weight:700;color:var(--ok);font-size:18px;">${(state.ecoxionums || 0).toLocaleString()} 🪙</span>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:24px;">
          ${Object.values(packagesConfig).map(pkg => `
            <div class="package-card" onclick="buyPackage('${pkg.id}')">
              <div class="package-icon">${pkg.icon}</div>
              <h3 style="margin:0 0 8px;color:${pkg.color};">${pkg.name}</h3>
              <p style="margin:0 0 16px;font-size:13px;color:var(--ink-1);min-height:40px;">${pkg.description}</p>
              
              <div style="display:flex;justify-content:center;gap:4px;margin-bottom:16px;">
                ${pkg.probabilities.legendaria > 0 ? `<span title="Legendaria: ${pkg.probabilities.legendaria}%" style="width:8px;height:8px;border-radius:50%;background:#ff5050;"></span>` : ''}
                ${pkg.probabilities.epica > 0 ? `<span title="Épica: ${pkg.probabilities.epica}%" style="width:8px;height:8px;border-radius:50%;background:#ffd700;"></span>` : ''}
                ${pkg.probabilities.rara > 0 ? `<span title="Rara: ${pkg.probabilities.rara}%" style="width:8px;height:8px;border-radius:50%;background:#b388ff;"></span>` : ''}
                ${pkg.probabilities.poco_comun > 0 ? `<span title="Poco Común: ${pkg.probabilities.poco_comun}%" style="width:8px;height:8px;border-radius:50%;background:#64a7ff;"></span>` : ''}
                <span title="Común: ${pkg.probabilities.comun}%" style="width:8px;height:8px;border-radius:50%;background:#b4c2df;"></span>
              </div>

              <div class="package-price">
                ${pkg.price} 🪙
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    window.buyPackage = async function (pkgId) {
      const pkg = packagesConfig[pkgId];
      if (!pkg) return;

      const state = await loadState();

      // Verificar saldo
      if ((state.ecoxionums || 0) < pkg.price) {
        showAlert('error', 'Saldo insuficiente', `Necesitas ${pkg.price} Ecoxionums para comprar este paquete.`);
        return;
      }

      // Confirmar compra
      const confirmed = confirm(`¿Comprar ${pkg.name} por ${pkg.price} Ecoxionums?`);
      if (!confirmed) return;

      // Descontar saldo
      state.ecoxionums -= pkg.price;

      // Sincronizar con servidor si es necesario
      // Sincronizar con servidor si es necesario
      if (state.oceanPayLinked && state.userId) {
        try {
          await fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/change`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
            },
            body: JSON.stringify({
              userId: state.userId,
              amount: -pkg.price,
              concepto: `Compra: ${pkg.name}`,
              origen: 'Ecoxion'
            })
          }).catch(console.warn);
        } catch (e) { }
      }

      await saveState(state);
      updateBalance(); // Actualizar UI de saldo inmediatamente

      // Iniciar secuencia de apertura
      await openPackage(pkg);
    };

    async function openPackage(pkg) {
      // 1. Determinar rareza basada en probabilidades
      const roll = Math.random() * 100;
      let rarity = 'comun';
      let cumulative = 0;

      const probs = pkg.probabilities;
      if (roll < (cumulative += probs.legendaria)) rarity = 'legendaria';
      else if (roll < (cumulative += probs.epica)) rarity = 'epica';
      else if (roll < (cumulative += probs.rara)) rarity = 'rara';
      else if (roll < (cumulative += probs.poco_comun)) rarity = 'poco_comun';

      // 2. Seleccionar extensión de esa rareza
      // Filtrar extensiones disponibles por rareza y tema (si aplica)
      let availableExts = Object.values(defaultExtensions).filter(e => e.rarity === rarity);

      if (pkg.theme) {
        // Si el paquete tiene tema, intentar filtrar por tema (esto requeriría que las extensiones tengan tags o categorías)
        // Por ahora, simularemos preferencia por ciertas extensiones según el ID del paquete
        if (pkg.id === 'gamer') {
          const games = availableExts.filter(e => ['mini-games', 'eco-stock', 'clicky-coin', 'trivia-challenge'].includes(e.id));
          if (games.length > 0) availableExts = games;
        } else if (pkg.id === 'developer') {
          const devTools = availableExts.filter(e => ['notes', 'pomodoro', 'calculator', 'password-vault'].includes(e.id));
          if (devTools.length > 0) availableExts = devTools;
        }
      }

      // Si no hay extensiones de esa rareza (ej. legendaria), bajar de categoría
      if (availableExts.length === 0) {
        const rarities = ['legendaria', 'epica', 'rara', 'poco_comun', 'comun'];
        const idx = rarities.indexOf(rarity);
        for (let i = idx + 1; i < rarities.length; i++) {
          availableExts = Object.values(defaultExtensions).filter(e => e.rarity === rarities[i]);
          if (availableExts.length > 0) {
            rarity = rarities[i];
            break;
          }
        }
      }

      const rewardExt = availableExts[Math.floor(Math.random() * availableExts.length)];

      // 3. Mostrar animación
      showOpeningAnimation(pkg, rewardExt);
    }

    function showOpeningAnimation(pkg, reward) {
      // Crear overlay
      const overlay = document.createElement('div');
      overlay.className = 'opening-overlay active';
      overlay.innerHTML = `
        <div class="opening-package" id="pkg-anim-icon">${pkg.icon}</div>
        <div class="opening-burst" id="pkg-burst"></div>
        <div class="reward-reveal" id="pkg-reward">
          <div class="reward-card rarity-glow ${reward.rarity}">
            <div class="reward-icon">${reward.icon}</div>
            <h2 style="color:var(--accent);margin-bottom:8px;">${reward.name}</h2>
            <div style="display:inline-block;padding:4px 12px;border-radius:12px;background:rgba(255,255,255,.1);font-size:12px;margin-bottom:16px;">
              ${reward.rarity.replace('_', ' ').toUpperCase()}
            </div>
            <p style="color:var(--ink-1);font-size:14px;margin-bottom:24px;">${reward.description}</p>
            <button class="btn primary" id="pkg-claim-btn">¡Genial!</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      const icon = document.getElementById('pkg-anim-icon');
      const rewardEl = document.getElementById('pkg-reward');
      const btn = document.getElementById('pkg-claim-btn');

      // Secuencia de animación
      // 1. Shake
      setTimeout(() => icon.classList.add('shaking'), 500);

      // 2. Click para abrir (o auto después de unos segundos)
      icon.onclick = () => triggerOpen();

      function triggerOpen() {
        icon.classList.remove('shaking');

        // Explosión
        gsap.to(icon, { scale: 1.5, opacity: 0, duration: 0.3, ease: 'power2.in' });

        // Crear partículas
        createConfetti(window.innerWidth / 2, window.innerHeight / 2);

        // Mostrar recompensa
        setTimeout(async () => {
          icon.style.display = 'none';
          rewardEl.classList.add('show');

          // Procesar recompensa
          const state = await loadState();
          if (!state.installed[reward.id]) {
            state.installed[reward.id] = {
              id: reward.id,
              enabled: true,
              installedAt: Date.now()
            };
            await saveState(state);
            showAlert('success', '¡Nueva extensión!', `${reward.name} añadida a tu colección.`);
          } else {
            // Ya la tiene: dar compensación
            const compensation = Math.floor(pkg.price * 0.3);
            state.ecoxionums += compensation;

            // Sincronizar compensación
            if (state.oceanPayLinked && state.userId) {
              await fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/change`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
                },
                body: JSON.stringify({
                  userId: state.userId,
                  amount: compensation,
                  concepto: `Compensación repetida: ${reward.name}`,
                  origen: 'Ecoxion'
                })
              }).catch(console.warn);
            }

            await saveState(state);
            updateBalance();

            const msg = document.createElement('div');
            msg.innerHTML = `<p style="color:var(--ok);margin-top:12px;">¡Ya la tenías! Compensación: +${compensation} 🪙</p>`;
            rewardEl.querySelector('.reward-card').insertBefore(msg, btn);
          }
        }, 400);
      }

      btn.onclick = () => {
        gsap.to(overlay, { opacity: 0, duration: 0.3, onComplete: () => overlay.remove() });
        renderPackages(); // Recargar para actualizar saldo
      };
    }

    function createConfetti(x, y) {
      const colors = ['#64a7ff', '#b388ff', '#ffd700', '#ff5050', '#ffffff'];
      for (let i = 0; i < 50; i++) {
        const el = document.createElement('div');
        el.style.cssText = `position:fixed;left:${x}px;top:${y}px;width:8px;height:8px;background:${colors[Math.floor(Math.random() * colors.length)]};border-radius:50%;pointer-events:none;z-index:20001;`;
        document.body.appendChild(el);

        const angle = Math.random() * Math.PI * 2;
        const velocity = 100 + Math.random() * 200;

        gsap.to(el, {
          x: Math.cos(angle) * velocity,
          y: Math.sin(angle) * velocity,
          opacity: 0,
          duration: 1 + Math.random(),
          ease: 'power2.out',
          onComplete: () => el.remove()
        });
      }
    }


    /* =========================
       MARKETPLACE
       ========================= */
    /* =========================
       MARKETPLACE (Rediseño Moderno)
       ========================= */
    /* =========================
       ICONOS 2D HAND-MADE (CANVAS)
       ========================= */
    function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
      if (typeof stroke === 'undefined') { stroke = true; }
      if (typeof radius === 'undefined') { radius = 5; }
      if (typeof radius === 'number') { radius = { tl: radius, tr: radius, br: radius, bl: radius }; } else {
        var defaultRadius = { tl: 0, tr: 0, br: 0, bl: 0 };
        for (var side in defaultRadius) { radius[side] = radius[side] || defaultRadius[side]; }
      }
      ctx.beginPath();
      ctx.moveTo(x + radius.tl, y);
      ctx.lineTo(x + width - radius.tr, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
      ctx.lineTo(x + width, y + height - radius.br);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
      ctx.lineTo(x + radius.bl, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
      ctx.lineTo(x, y + radius.tl);
      ctx.quadraticCurveTo(x, y, x + radius.tl, y);
      ctx.closePath();
      if (fill) { ctx.fill(); }
      if (stroke) { ctx.stroke(); }
    }

    function drawExtensionIcon(canvasId, type, accentColor) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const cx = w / 2;
      const cy = h / 2;

      ctx.clearRect(0, 0, w, h);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      switch (type) {
        // --- EXISTING ---
        case 'notes': // Notebook
          ctx.fillStyle = '#fef3c7'; roundRect(ctx, 25, 20, 50, 60, 4, true, false); // Pages
          ctx.fillStyle = '#3b82f6'; roundRect(ctx, 20, 20, 10, 60, 2, true, false); // Spine
          ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; for (let i = 0; i < 4; i++) { ctx.beginPath(); ctx.moveTo(35, 30 + i * 10); ctx.lineTo(65, 30 + i * 10); ctx.stroke(); } // Lines
          ctx.fillStyle = accentColor; ctx.beginPath(); ctx.moveTo(55, 30); ctx.lineTo(85, 10); ctx.lineTo(90, 15); ctx.lineTo(60, 45); ctx.fill(); // Pencil
          break;
        case 'blog-creator': // Blog
          ctx.fillStyle = '#fff'; roundRect(ctx, 20, 20, 60, 50, 4, true, true);
          ctx.fillStyle = accentColor; ctx.fillRect(25, 25, 50, 10); // Header
          ctx.fillStyle = '#ccc'; for (let i = 0; i < 3; i++) { ctx.fillRect(25, 40 + i * 8, 40, 4); }
          ctx.fillStyle = accentColor; ctx.beginPath(); ctx.arc(70, 60, 12, 0, Math.PI * 2); ctx.fill(); // Pen tip/Button
          ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(65, 60); ctx.lineTo(75, 60); ctx.moveTo(70, 55); ctx.lineTo(70, 65); ctx.stroke();
          break;
        case 'eco-stock': // Graph
          ctx.strokeStyle = accentColor; ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(25, 75);
          ctx.lineTo(40, 60); ctx.lineTo(55, 65);
          ctx.lineTo(75, 40); ctx.lineTo(95, 20);
          ctx.stroke();
          // Points
          ctx.fillStyle = '#fff';
          [[25, 75], [40, 60], [55, 65], [75, 40], [95, 20]].forEach(p => {
            ctx.beginPath(); ctx.arc(p[0], p[1], 3, 0, Math.PI * 2); ctx.fill();
          });
          // Axis
          ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 2;
          ctx.beginPath(); ctx.moveTo(20, 20); ctx.lineTo(20, 80); ctx.lineTo(80, 80); ctx.stroke();
          break;
        case 'comms-generator': // Scroll
          ctx.fillStyle = '#e2e8f0';
          ctx.beginPath(); ctx.moveTo(20, 20); ctx.lineTo(80, 20); ctx.lineTo(80, 80); ctx.lineTo(20, 80); ctx.fill();
          ctx.strokeStyle = accentColor; ctx.lineWidth = 2;
          for (let i = 0; i < 4; i++) { ctx.beginPath(); ctx.moveTo(30, 35 + i * 10); ctx.lineTo(70, 35 + i * 10); ctx.stroke(); }
          ctx.fillStyle = accentColor; ctx.beginPath(); ctx.arc(65, 70, 8, 0, Math.PI * 2); ctx.fill();
          break;
        case 'trivia-challenge': // Target
          ctx.strokeStyle = accentColor; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.arc(cx, cy, 30, 0, Math.PI * 2); ctx.stroke();
          ctx.beginPath(); ctx.arc(cx, cy, 20, 0, Math.PI * 2); ctx.stroke();
          ctx.fillStyle = accentColor; ctx.beginPath(); ctx.arc(cx, cy, 8, 0, Math.PI * 2); ctx.fill();
          ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(cx + 10, cy + 10); ctx.lineTo(cx + 25, cy + 25); ctx.stroke();
          break;
        case 'music-player': // Note
          ctx.fillStyle = accentColor;
          ctx.beginPath(); ctx.ellipse(35, 70, 10, 8, -0.3, 0, Math.PI * 2); ctx.fill();
          ctx.beginPath(); ctx.ellipse(75, 60, 10, 8, -0.3, 0, Math.PI * 2); ctx.fill();
          ctx.strokeStyle = accentColor; ctx.lineWidth = 5;
          ctx.beginPath(); ctx.moveTo(42, 68); ctx.lineTo(42, 30); ctx.lineTo(82, 20); ctx.lineTo(82, 58); ctx.stroke();
          ctx.lineWidth = 8; ctx.beginPath(); ctx.moveTo(42, 30); ctx.lineTo(82, 20); ctx.stroke();
          break;
        case 'habit-tracker': // Chart
          ctx.fillStyle = accentColor;
          ctx.fillRect(20, 60, 15, 25);
          ctx.globalAlpha = 0.6; ctx.fillRect(45, 40, 15, 45);
          ctx.globalAlpha = 1; ctx.fillRect(70, 25, 15, 60);
          ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(15, 85); ctx.lineTo(90, 85); ctx.stroke();
          break;
        case 'weather-widget': // Weather
          ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(65, 35, 15, 0, Math.PI * 2); ctx.fill();
          ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 2;
          for (let i = 0; i < 8; i++) {
            const ang = (i * Math.PI * 2) / 8;
            ctx.beginPath(); ctx.moveTo(65 + Math.cos(ang) * 20, 35 + Math.sin(ang) * 20); ctx.lineTo(65 + Math.cos(ang) * 28, 35 + Math.sin(ang) * 28); ctx.stroke();
          }
          ctx.fillStyle = '#e2e8f0'; ctx.beginPath(); ctx.arc(35, 65, 15, 0, Math.PI * 2); ctx.arc(55, 65, 18, 0, Math.PI * 2); ctx.arc(45, 50, 18, 0, Math.PI * 2); ctx.fill();
          break;
        case 'eco-miner': // Pickaxe
          ctx.save(); ctx.translate(cx, cy); ctx.rotate(-Math.PI / 4);
          ctx.strokeStyle = '#b45309'; ctx.lineWidth = 6; ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(0, 40); ctx.stroke();
          ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 8; ctx.beginPath(); ctx.moveTo(-30, -15); ctx.quadraticCurveTo(0, -25, 30, -15); ctx.stroke();
          ctx.restore();
          break;
        case 'mini-games': // Gamepad
          ctx.fillStyle = accentColor; ctx.globalAlpha = 0.2; roundRect(ctx, 10, 30, 80, 45, 12, true, false);
          ctx.globalAlpha = 1; ctx.strokeStyle = accentColor; ctx.lineWidth = 3; roundRect(ctx, 10, 30, 80, 45, 12, false, true);
          ctx.fillStyle = '#fff'; ctx.fillRect(25, 48, 4, 12); ctx.fillRect(21, 52, 12, 4);
          ctx.beginPath(); ctx.arc(70, 52, 3, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(62, 58, 3, 0, Math.PI * 2); ctx.fill();
          break;
        case 'quick-chat': // Bubble
          ctx.fillStyle = accentColor;
          ctx.beginPath(); ctx.moveTo(20, 25); ctx.lineTo(80, 25); ctx.quadraticCurveTo(90, 25, 90, 35); ctx.lineTo(90, 65);
          ctx.quadraticCurveTo(90, 75, 80, 75); ctx.lineTo(40, 75); ctx.lineTo(25, 90); ctx.lineTo(30, 75); ctx.lineTo(20, 75);
          ctx.quadraticCurveTo(10, 75, 10, 65); ctx.lineTo(10, 35); ctx.quadraticCurveTo(10, 25, 20, 25); ctx.fill();
          ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(35, 50, 4, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(50, 50, 4, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(65, 50, 4, 0, Math.PI * 2); ctx.fill();
          break;
        case 'mini-calendar': // Calendar
          ctx.fillStyle = '#ef4444';
          ctx.beginPath(); ctx.moveTo(20, 20); ctx.lineTo(80, 20); ctx.lineTo(80, 40); ctx.lineTo(20, 40); ctx.fill();
          ctx.fillStyle = '#fff'; ctx.fillRect(20, 40, 60, 45);
          ctx.strokeStyle = '#ccc'; ctx.strokeRect(20, 40, 60, 45);
          ctx.fillStyle = '#000'; ctx.font = 'bold 30px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('23', cx, cy + 10);
          break;

        // --- NEW ADDITIONS ---
        case 'eco-generator': // Energy Core
          const grad = ctx.createRadialGradient(cx, cy, 5, cx, cy, 40);
          grad.addColorStop(0, '#fff'); grad.addColorStop(0.5, accentColor); grad.addColorStop(1, 'transparent');
          ctx.fillStyle = grad; /*ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI*2); ctx.fill();*/
          ctx.strokeStyle = accentColor; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.arc(cx, cy, 15, 0, Math.PI * 2); ctx.stroke();
          for (let i = 0; i < 3; i++) {
            ctx.save(); ctx.translate(cx, cy); ctx.rotate((i * Math.PI * 2) / 3);
            ctx.beginPath(); ctx.ellipse(0, 0, 10, 35, 0, 0, Math.PI * 2); ctx.stroke();
            ctx.restore();
          }
          break;
        case 'clicky-coin': // Coin w/ Hand
          ctx.fillStyle = '#FFD700';
          ctx.beginPath(); ctx.arc(cx - 5, cy, 25, 0, Math.PI * 2); ctx.fill();
          ctx.strokeStyle = '#B8860B'; ctx.lineWidth = 3; ctx.stroke();
          ctx.fillStyle = '#FFF'; ctx.font = 'bold 24px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('$', cx - 5, cy + 2);
          // Hand
          ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
          ctx.beginPath(); ctx.moveTo(cx + 10, cy + 10); ctx.lineTo(cx + 20, cy - 10); ctx.lineTo(cx + 25, cy - 8); ctx.lineTo(cx + 35, cy + 15);
          ctx.closePath(); ctx.fill(); ctx.stroke();
          break;
        case 'eco-luck': // Dice
          ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
          // Die 1
          roundRect(ctx, 25, 35, 30, 30, 5, true, true);
          ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(40, 50, 3, 0, Math.PI * 2); ctx.fill();
          // Die 2
          ctx.fillStyle = '#fff';
          roundRect(ctx, 50, 20, 30, 30, 5, true, true);
          ctx.fillStyle = '#000';
          ctx.beginPath(); ctx.arc(58, 28, 3, 0, Math.PI * 2); ctx.fill();
          ctx.beginPath(); ctx.arc(72, 42, 3, 0, Math.PI * 2); ctx.fill();
          break;
        case 'calculator': // Keypad
          ctx.fillStyle = '#333'; roundRect(ctx, 25, 15, 46, 66, 4, true, false);
          ctx.fillStyle = '#8bd'; ctx.fillRect(30, 20, 36, 12); // Screen
          ctx.fillStyle = '#666';
          for (let r = 0; r < 4; r++) { for (let c = 0; c < 3; c++) { ctx.fillRect(30 + c * 13, 38 + r * 10, 8, 6); } }
          break;
        case 'pomodoro': // Tomato
          ctx.fillStyle = '#ef4444';
          ctx.beginPath(); ctx.arc(cx, cy + 5, 28, 0, Math.PI * 2); ctx.fill();
          ctx.fillStyle = '#10b981'; // Leave
          ctx.beginPath(); ctx.moveTo(cx, cy - 23); ctx.quadraticCurveTo(cx - 10, cy - 30, cx - 15, cy - 15); ctx.quadraticCurveTo(cx, cy - 23, cx + 15, cy - 15); ctx.quadraticCurveTo(cx + 10, cy - 30, cx, cy - 23); ctx.fill();
          break;
        case 'image-gallery': // Photos
          ctx.translate(cx, cy); ctx.rotate(-0.2); ctx.translate(-cx, -cy);
          ctx.fillStyle = '#fff'; ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1;
          ctx.fillRect(30, 30, 40, 45); ctx.strokeRect(30, 30, 40, 45);
          ctx.fillStyle = '#ccc'; ctx.fillRect(34, 34, 32, 25);
          ctx.translate(cx, cy); ctx.rotate(0.4); ctx.translate(-cx, -cy);
          ctx.fillStyle = '#fff'; ctx.strokeStyle = '#ddd';
          ctx.fillRect(35, 25, 40, 45); ctx.strokeRect(35, 25, 40, 45);
          ctx.fillStyle = accentColor; ctx.fillRect(39, 29, 32, 25);
          break;
        case 'survey-rewards': // Clipboard
          ctx.fillStyle = '#8B4513'; ctx.fillRect(30, 15, 36, 66); // Board
          ctx.fillStyle = '#fff'; ctx.fillRect(34, 25, 28, 52); // Paper
          ctx.fillStyle = '#ccc'; ctx.fillRect(38, 12, 20, 8); // Clip
          ctx.fillStyle = '#ccc';
          for (let i = 0; i < 4; i++) { ctx.fillRect(38, 35 + i * 10, 20, 2); }
          break;
        case 'dark-mode': // Moon
          ctx.fillStyle = '#fbbf24';
          ctx.beginPath(); ctx.arc(cx, cy, 25, -Math.PI / 2, Math.PI / 2, true);
          ctx.quadraticCurveTo(cx - 10, cy, cx, cy - 25); ctx.fill();
          ctx.fillStyle = '#fff';
          ctx.beginPath(); ctx.arc(cx + 20, cy - 20, 2, 0, Math.PI * 2); ctx.fill();
          ctx.beginPath(); ctx.arc(cx + 15, cy + 10, 1.5, 0, Math.PI * 2); ctx.fill();
          break;
        case 'zen-mode': // Lotus/YinYang
          ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
          ctx.beginPath(); ctx.arc(cx, cy, 25, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
          ctx.fillStyle = '#000';
          ctx.beginPath(); ctx.arc(cx, cy, 25, -Math.PI / 2, Math.PI / 2); ctx.fill();
          ctx.beginPath(); ctx.arc(cx, cy - 12.5, 12.5, 0, Math.PI * 2); ctx.fill();
          ctx.fillStyle = '#fff';
          ctx.beginPath(); ctx.arc(cx, cy + 12.5, 12.5, 0, Math.PI * 2); ctx.fill();
          // Dots
          ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(cx, cy - 12.5, 4, 0, Math.PI * 2); ctx.fill();
          ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(cx, cy + 12.5, 4, 0, Math.PI * 2); ctx.fill();
          break;
        case 'ocean-pay': // Credit Card
          ctx.fillStyle = '#09f';
          roundRect(ctx, 15, 30, 66, 40, 6, true, false);
          ctx.fillStyle = '#004'; ctx.fillRect(15, 40, 66, 8); // Strip
          ctx.fillStyle = '#fc0'; ctx.fillRect(20, 55, 12, 8); // Chip
          break;
        default: // Default Box
          ctx.strokeStyle = accentColor; ctx.lineWidth = 4; ctx.strokeRect(20, 20, 60, 60);
          ctx.fillStyle = accentColor; ctx.globalAlpha = 0.5; ctx.fillRect(20, 20, 60, 60);
      }
    }

    async function renderMarketplace() {
      const content = document.getElementById('content');
      content.innerHTML = '';
      content.className = '';

      const state = await loadState();
      const isZen = document.body.classList.contains('zen-layout');
      const installedIds = new Set(Object.keys(state.installed || {}));

      // Header del Marketplace
      const header = document.createElement('div');
      header.style.textAlign = isZen ? 'left' : 'center';
      header.style.marginBottom = '32px';
      header.style.padding = isZen ? '0 16px' : '0';
      header.innerHTML = `
        <h2 style="font-size:32px; margin-bottom:12px; background:linear-gradient(135deg, #fff, var(--ink-1)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">Explorar Extensiones</h2>
        <p style="color:var(--ink-1); font-size:16px; max-width:600px; margin:${isZen ? '0' : '0 auto'};">
           Potencia tu experiencia con herramientas, juegos y utilidades diseñadas para el ecosistema.
        </p>
      `;
      content.appendChild(header);

      const grid = document.createElement('div');
      if (isZen) {
        grid.className = 'zen-list-layout';
      } else {
        // Grid responsive moderno
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
        grid.style.gap = '24px';
        grid.style.padding = '0 16px';
      }

      Object.values(defaultExtensions).forEach(ext => {
        const isInstalled = installedIds.has(ext.id);
        const extInfo = state.installed[ext.id] || {};
        const hasV2Available = ext.hasV2 && isInstalled && !extInfo.awakened;

        // Colores de rareza para bordes/sombras
        const rarityColors = {
          comun: '#94a3b8',
          poco_comun: '#64a7ff',
          rara: '#60a5fa',
          epica: '#a855f7',
          legendaria: '#f59e0b'
        };
        const accentColor = rarityColors[ext.rarity] || 'var(--accent)';

        if (isZen) {
          const item = document.createElement('div');
          item.className = 'zen-list-item';
          item.style.position = 'relative'; // Ensure relative positioning for tags

          const actionButton = isInstalled && extInfo.enabled
            ? hasV2Available
              ? `<button class="btn" onclick="showMissionsModal('${ext.id}')" style="background:linear-gradient(135deg, #a855f7, #6366f1); border:none; padding:8px 18px; font-size:13px; font-weight:700;">Despertar ✨</button>`
              : `<button class="btn secondary" onclick="uninstallExtension('${ext.id}')" style="font-size:12px; padding:8px 16px;">Desinstalar</button>`
            : `<button class="btn primary" onclick="installExtension('${ext.id}')" style="padding:10px 24px; font-size:13px; font-weight:700;">${ext.price === 0 ? 'Instalar' : 'Comprar'}</button>`;

          item.innerHTML = `
            <div style="position:absolute; top:12px; left:0; z-index:10; display:flex; flex-direction:column; gap:4px; align-items:flex-start; pointer-events:none;">
                 ${(ext.tags || []).map((tag, i) => `
                   <div style="
                     background: var(--accent);
                     color: var(--bg-0);
                     font-size: 9px;
                     font-weight: 800;
                     padding: 3px 10px;
                     border-radius: 0 4px 4px 0;
                     box-shadow: 2px 2px 6px rgba(0,0,0,0.4);
                     text-transform: uppercase;
                     position: relative;
                     border-left: 2px solid rgba(255,255,255,0.2);
                   ">
                     ${tag}
                   </div>
                 `).join('')}
            </div>
            <div class="item-icon" style="color:${accentColor}; margin-left:10px;">
               <canvas id="canvas-zen-${ext.id}" width="96" height="96" style="width:48px; height:48px; object-fit:contain;"></canvas>
            </div>
            <div class="item-info">
              <h3>
                ${ext.name} 
                ${extInfo.awakened ? '<span class="badge" style="background:#10b98120; color:#10b981; border:1px solid #10b98140;">V2</span>' : ''}
              </h3>
              <p>${ext.description}</p>
              <div class="item-meta">
                <span class="badge" style="background:${accentColor}15; color:${accentColor}; border: 1px solid ${accentColor}30;">${ext.rarity.replace('_', ' ')}</span>
                <span style="opacity:0.6; font-size:12px;">v${extInfo.awakened && ext.version2 ? ext.version2 : ext.version}</span>
                <span style="color:rgba(255,255,255,0.2);">•</span>
                ${ext.price > 0 && !isInstalled ?
              `<span style="font-weight:700; color:var(--accent); font-size:14px;">${ext.price} 🪙</span>` :
              `<span style="color:var(--ok); font-weight:600; font-size:14px;">${isInstalled ? '✓ Instalada' : 'Gratis'}</span>`
            }
              </div>
            </div>
            <div class="item-actions">
              ${actionButton}
            </div>
          `;
          grid.appendChild(item);
        } else {
          const item = document.createElement('div');
          item.className = 'market-card';
          item.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01))';
          item.style.border = `1px solid rgba(255,255,255,0.08)`;
          item.style.borderRadius = '20px';
          item.style.padding = '24px';
          item.style.display = 'flex';
          item.style.flexDirection = 'column';
          item.style.gap = '20px';
          item.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
          item.style.position = 'relative';
          item.style.overflow = 'hidden';

          item.onmouseenter = () => {
            item.style.transform = 'translateY(-6px)';
            item.style.boxShadow = `0 12px 30px -10px ${accentColor}40`;
            item.style.borderColor = `${accentColor}80`;
          };
          item.onmouseleave = () => {
            item.style.transform = 'translateY(0)';
            item.style.boxShadow = 'none';
            item.style.borderColor = 'rgba(255,255,255,0.08)';
          };

          item.innerHTML = `
            <div style="position:absolute; top:20px; left:0; z-index:10; display:flex; flex-direction:column; gap:6px; align-items:flex-start; pointer-events:none;">
                 ${(ext.tags || []).map((tag, i) => `
                   <div style="
                     background: var(--accent);
                     color: var(--bg-0);
                     font-size: 10px;
                     font-weight: 800;
                     padding: 4px 12px;
                     border-radius: 0 4px 4px 0;
                     box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
                     text-transform: uppercase;
                     position: relative;
                     border-left: 2px solid rgba(255,255,255,0.2);
                   ">
                     ${tag}
                   </div>
                 `).join('')}
            </div>

            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-top: 10px;">
                <div style="width:56px; height:56px; border-radius:16px; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; font-size:28px;">
                   <canvas id="canvas-card-${ext.id}" width="96" height="96" style="width:100%; height:100%; object-fit:contain;"></canvas>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                   <span style="font-size:11px; text-transform:uppercase; letter-spacing:0.5px; font-weight:700; color:${accentColor}; padding:4px 8px; background:${accentColor}15; border-radius:6px;">${ext.rarity.replace('_', ' ')}</span>
                   ${extInfo.awakened ? '<span style="font-size:10px; font-weight:700; color:#10b981; padding:2px 6px; background:rgba(16,185,129,0.1); border-radius:4px;">✨ V2</span>' : ''}
                </div>
            </div>
            <div style="flex:1;">
                <h3 style="font-size:18px; font-weight:700; color:var(--ink-0); margin:0 0 8px;">${ext.name}</h3>
                <p style="font-size:14px; color:var(--ink-1); line-height:1.5; margin:0;">${ext.description}</p>
            </div>
            ${hasV2Available ? `
              <div style="padding:10px; background:linear-gradient(90deg, rgba(255,215,0,0.1), transparent); border-left:3px solid #ffd700; border-radius:4px;">
                <p style="margin:0; font-size:12px; color:#ffd700; font-weight:600;">✨ ¡Versión V2 Disponible!</p>
              </div>
            ` : ''}
            <div style="border-top:1px solid rgba(255,255,255,0.05); padding-top:16px; display:flex; gap:12px; align-items:center;">
                <div style="flex:1;">
                   ${ext.price > 0 && !isInstalled ?
              `<div style="font-size:18px; font-weight:700; color:var(--ink-0);">${ext.price} <span style="font-size:14px; color:var(--ink-2);">🪙</span></div>` :
              `<div style="font-size:14px; font-weight:600; color:var(--ok);">Gratis</div>`
            }
                </div>
                <div style="flex:0 0 auto;">
                   ${isInstalled && extInfo.enabled
              ? hasV2Available
                ? `<button class="btn" onclick="showMissionsModal('${ext.id}')" style="background:linear-gradient(135deg, #a855f7, #6366f1); border:none; padding:10px 20px;">Despertar ✨</button>`
                : `<button class="btn secondary" onclick="uninstallExtension('${ext.id}')" style="font-size:13px; padding:8px 16px;">Desinstalar</button>`
              : `<button class="btn primary" onclick="installExtension('${ext.id}')" style="padding:10px 24px;">${ext.price === 0 ? 'Instalar' : 'Comprar'}</button>`
            }
                </div>
            </div>
          `;
          grid.appendChild(item);
        }
      });


      content.appendChild(grid);

      // Renderizar los iconos Canvas después de insertar en el DOM
      Object.values(defaultExtensions).forEach(ext => {
        const rarityColors = { comun: '#94a3b8', poco_comun: '#64a7ff', rara: '#60a5fa', epica: '#a855f7', legendaria: '#f59e0b' };
        const color = rarityColors[ext.rarity] || '#a855f7';

        if (isZen) {
          drawExtensionIcon(`canvas-zen-${ext.id}`, ext.id, color);
        } else {
          drawExtensionIcon(`canvas-card-${ext.id}`, ext.id, color);
        }
      });


    }

    /* =========================
       INSTALAR/DESINSTALAR EXTENSIONES
       ========================= */
    async function installExtension(id) {
      const ext = defaultExtensions[id];
      if (!ext) return;

      const state = await loadState();

      // Verificar precio
      if (ext.price > 0) {
        if (state.ecoxionums < ext.price) {
          showAlert('error', 'Saldo insuficiente', `Necesitas ${ext.price} Ecoxionums para comprar esta extensión.`);
          return;
        }
      }

      // Instalación Optimista
      if (!state.installed) state.installed = {};
      state.installed[id] = {
        id,
        enabled: true,
        installedAt: Date.now()
      };

      if (ext.price > 0) {
        state.ecoxionums -= ext.price;
      }

      // Guardar y renderizar inmediatamente
      await saveState(state);
      updateBalance();

      showAlert('success', 'Extensión instalada', `${ext.name} se ha instalado correctamente.`);
      if (currentTab === 'marketplace') renderMarketplace();
      else if (currentTab === 'dashboard') renderDashboard();

      // Sincronización en segundo plano si hay precio y Ocean Pay
      if (ext.price > 0 && state.oceanPayLinked && state.userId) {
        fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/change`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
          },
          body: JSON.stringify({
            userId: state.userId,
            amount: -ext.price,
            concepto: `Compra de extensión: ${ext.name}`,
            origen: 'Ecoxion'
          })
        }).catch(e => console.warn('Error sincronizando compra en servidor:', e));
      }
    }

    async function uninstallExtension(id) {
      const state = await loadState();
      if (!state.installed[id]) return;

      delete state.installed[id];
      await saveState(state);

      showAlert('info', 'Extensión desinstalada', 'La extensión se ha desinstalado correctamente.');

      if (currentTab === 'marketplace') renderMarketplace();
      else if (currentTab === 'dashboard') renderDashboard();
    }

    /* =========================
       SUSCRIPCIONES
       ========================= */
    async function renderSubscriptions() {
      const content = document.getElementById('content');
      content.innerHTML = '';
      content.className = '';

      const state = await loadState();
      let currentSubscription = null;
      if (state.oceanPayLinked && state.userId) {
        try {
          const res = await fetch(`${API_GLOBAL}/api/ecoxion/subscription/${state.userId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}` }
          });
          if (res.ok) currentSubscription = await res.json();
        } catch (e) {
          console.warn('Error cargando suscripcion:', e);
        }
      }

      const activePlan = currentSubscription?.plan || 'free';
      const plans = [
        {
          id: 'free',
          icon: '🆓',
          title: 'Free',
          priceLabel: 'Gratis',
          cycle: 'Sin vencimiento',
          features: ['Acceso base a extensiones', 'Funciones generales', 'Panel local completo']
        },
        {
          id: 'plus',
          icon: '✨',
          title: 'Plus',
          price: 420,
          priceLabel: '420 🪙',
          cycle: 'cada 30 dias',
          features: ['Extensiones mejoradas', 'Misiones premium', 'Prioridad en recompensas']
        },
        {
          id: 'pro',
          icon: '🌌',
          title: 'Pro',
          price: 750,
          priceLabel: '750 🪙',
          cycle: 'cada 30 dias',
          recommended: true,
          features: ['Todo Plus', 'Acceso anticipado', 'Perfiles de rendimiento avanzados']
        },
        {
          id: 'ultra',
          icon: '👑',
          title: 'Ultra',
          price: 1250,
          priceLabel: '1250 🪙',
          cycle: 'cada 30 dias',
          features: ['Todo Pro', 'Toolset experto completo', 'Canal prioritario + extras visuales']
        }
      ];

      const subscriptionMeta = currentSubscription ? `
        <div class="eco-sub-meta">
          <div><strong>Plan activo:</strong> ${currentSubscription.planName || currentSubscription.plan || 'N/A'}</div>
          <div><strong>Renovacion:</strong> ${currentSubscription.renewAt ? new Date(currentSubscription.renewAt).toLocaleString('es-ES') : 'Sin dato'}</div>
          <div><strong>Vencimiento:</strong> ${currentSubscription.endsAt ? new Date(currentSubscription.endsAt).toLocaleString('es-ES') : 'Sin dato'}</div>
        </div>
      ` : '<div class="eco-sub-meta"><div><strong>Plan activo:</strong> Free</div><div>Sin suscripcion premium activa.</div></div>';

      content.innerHTML = `
        <div class="eco-subs-shell">
          <div class="eco-subs-header">
            <div>
              <h2 style="margin:0;font-size:28px;">Suscripciones Ecoxion</h2>
              <p style="margin:8px 0 0;color:var(--ink-1);">Sincronizadas con Ocean Pay (renovacion y saldo en tiempo real).</p>
            </div>
            ${subscriptionMeta}
          </div>

          <div class="eco-subs-grid">
            ${plans.map((plan) => {
              const isActive = activePlan === plan.id || (plan.id === 'free' && !currentSubscription);
              const cardClass = `eco-sub-card ${isActive ? 'active' : ''} ${plan.recommended && !isActive ? 'recommended' : ''}`.trim();
              const badge = isActive
                ? '<span class="eco-sub-badge active">Activo</span>'
                : (plan.recommended ? '<span class="eco-sub-badge recommended">Recomendado</span>' : '');
              const action = plan.id === 'free'
                ? '<button class="btn" style="width:100%;" disabled>Plan base</button>'
                : (isActive
                  ? '<button class="btn" style="width:100%;background:rgba(255,107,107,.15);border-color:var(--danger);color:var(--danger);" onclick="cancelSubscription()">Cancelar renovacion</button>'
                  : `<button class="btn primary" style="width:100%;" onclick="selectPlan('${plan.id}')">Activar ${plan.title}</button>`);
              return `
                <article class="${cardClass}">
                  <div class="eco-sub-plan">
                    <h3>${plan.icon} ${plan.title}</h3>
                    ${badge}
                  </div>
                  <p class="eco-sub-price">${plan.priceLabel}</p>
                  <p class="eco-sub-note">${plan.cycle || ''}</p>
                  <ul class="eco-sub-features">
                    ${plan.features.map((f) => `<li><span>•</span><span>${f}</span></li>`).join('')}
                  </ul>
                  ${action}
                </article>
              `;
            }).join('')}
          </div>

          ${!state.oceanPayLinked ? `
            <div class="card" style="border-color:var(--accent);">
              <p style="margin:0 0 12px;color:var(--ink-0);">Debes vincular Ocean Pay para suscribirte.</p>
              <button class="btn primary" onclick="openOceanPay()">Vincular Ocean Pay</button>
            </div>
          ` : ''}
        </div>
      `;
    }

    window.selectPlan = async function (planId) {
      const state = await loadState();
      const planPrices = { plus: 420, pro: 750, ultra: 1250 };
      const planLabels = { plus: 'Plus', pro: 'Pro', ultra: 'Ultra' };

      if (!state.oceanPayLinked || !state.userId) {
        showAlert('warning', 'Sin vincular', 'Debes vincular tu cuenta de Ocean Pay para suscribirte.');
        openOceanPay();
        return;
      }

      if (!planPrices[planId]) {
        showAlert('info', 'Plan base', 'El plan Free no requiere compra.');
        return;
      }

      await updateBalance();
      const updated = await loadState();
      const price = planPrices[planId];
      if ((updated.ecoxionums || 0) < price) {
        showAlert('error', 'Saldo insuficiente', `Necesitas ${price} Ecoxionums para activar ${planLabels[planId]}.`);
        return;
      }

      const confirmed = confirm(`Confirmar activacion de ${planLabels[planId]} por ${price} Ecoxionums / 30 dias?`);
      if (!confirmed) return;

      try {
        const res = await fetch(`${API_GLOBAL}/api/ecoxion/subscribe`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
          },
          body: JSON.stringify({ userId: state.userId, plan: planId })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Error al suscribirse');
        }

        const data = await res.json();
        if (typeof data.balance === 'number') {
          state.ecoxionums = data.balance;
        } else {
          state.ecoxionums = Math.max(0, (state.ecoxionums || 0) - price);
        }
        await saveState(state);
        await updateBalance();

        showAlert('success', 'Suscripcion activada', `${planLabels[planId]} activa hasta ${new Date(data.subscription?.endsAt || Date.now()).toLocaleDateString('es-ES')}.`);
        setTimeout(() => renderSubscriptions(), 350);
      } catch (error) {
        console.error('Error al suscribirse:', error);
        showAlert('error', 'Error', error.message || 'No se pudo procesar la suscripcion.');
      }
    };

    window.cancelSubscription = async function () {
      const state = await loadState();
      if (!state.oceanPayLinked || !state.userId) return;

      const confirmed = confirm('Cancelar la renovacion automatica? Mantendras beneficios hasta la fecha de vencimiento.');
      if (!confirmed) return;

      try {
        const res = await fetch(`${API_GLOBAL}/api/ecoxion/subscription/cancel`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
          },
          body: JSON.stringify({ userId: state.userId })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Error al cancelar');
        }

        showAlert('success', 'Suscripcion cancelada', 'La renovacion automatica fue cancelada correctamente.');
        setTimeout(() => renderSubscriptions(), 350);
      } catch (error) {
        console.error('Error al cancelar:', error);
        showAlert('error', 'Error', error.message || 'No se pudo cancelar la suscripcion.');
      }
    };

    /* =========================
       ESTADISTICAS
       ========================= */
    async function renderStatistics() {
      const content = document.getElementById('content');
      content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--ink-1);">Cargando estadísticas maestras...</div>';

      const state = await loadState();

      // Calcular estadísticas generales
      const totalExtensions = Object.keys(state.installed || {}).length;
      const activeExtensions = Object.values(state.installed || {}).filter(ext => ext.enabled).length;
      const totalEcoxionums = state.ecoxionums || 0;

      const clickyData = state.clickyCoinData || {};
      const clickyEarned = clickyData.totalEarned || 0;
      const genData = state.generatorData || {};
      const genEarned = genData.totalEarned || 0;
      const dailyData = state.dailyRewards || {};
      const dailyEarned = dailyData.totalEarned || 0;
      const dailyStreak = dailyData.streak || 0;
      const luckData = state.ecoLuckData || {};
      const luckEarned = luckData.totalEarned || 0;

      const totalHistorical = clickyEarned + genEarned + dailyEarned + luckEarned;

      // Calcular nivel (XP System)
      const level = Math.floor(Math.sqrt(totalHistorical / 10)) + 1;
      const nextLevelThreshold = Math.pow(level, 2) * 10;
      const prevLevelThreshold = Math.pow(level - 1, 2) * 10;
      const currentLevelProgress = ((totalHistorical - prevLevelThreshold) / (nextLevelThreshold - prevLevelThreshold)) * 100;

      // Datos simulados de actividad (para el gráfico)
      const activityDays = ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'];
      const activityData = [45, 60, 30, 85, 40, 95, 70]; // Simulado basado en el nivel

      content.innerHTML = `
        <style>
          .stats-grid-premium {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
          }
          .stat-card-premium {
            background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
          }
          .stat-card-premium:hover {
            border-color: var(--accent);
            background: rgba(100,167,255,0.08);
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.3);
          }
          .level-badge-premium {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 900;
            color: white;
            box-shadow: 0 0 30px rgba(100,167,255,0.5);
            position: relative;
          }
          .level-badge-premium::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 24px;
            border: 2px solid var(--accent);
            opacity: 0.5;
            animation: pulse 2s infinite;
          }
          .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 120px;
            gap: 10px;
            margin-top: 20px;
          }
          .chart-bar {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            position: relative;
            transition: all 0.6s ease;
          }
          .chart-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--accent), var(--accent-2));
            border-radius: 4px;
            transition: height 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          }
          .achievement-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.03);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s;
          }
          .achievement-unlocked {
            background: rgba(255,215,0,0.1);
            border-color: #FFD700;
            color: #FFD700;
            box-shadow: 0 0 15px rgba(255,215,0,0.2);
          }
        </style>

        <div class="card" style="margin-bottom:24px; display:flex; flex-wrap:wrap; gap:32px; align-items:center; background:linear-gradient(135deg, rgba(15,20,35,0.6), rgba(100,167,255,0.05)); border:1px solid rgba(255,255,255,0.1); border-radius:32px; padding:32px;">
          <div class="level-badge-premium">${level}</div>
          <div style="flex:1;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h2 style="margin:0; font-size:36px; font-weight:900;">Rango: <span style="color:var(--accent);">${level < 5 ? 'Aspirante' : level < 15 ? 'Vanguardista' : 'Maestro Ecoxion'}</span></h2>
              <div style="text-align:right;">
                <div style="font-size:12px; color:var(--ink-1); margin-bottom:4px;">Eco-Patrimonio</div>
                <div style="font-size:32px; font-weight:900; color:var(--ok); text-shadow:0 0 20px rgba(16,185,129,0.3);">${totalEcoxionums.toLocaleString()} 🪙</div>
              </div>
            </div>
            <div style="margin-bottom:12px; display:flex; justify-content:space-between; font-size:14px;">
              <span style="color:var(--ink-1); font-weight:600;">Siguente Nivel: ${level + 1}</span>
              <span style="font-weight:700; color:var(--accent);">${totalHistorical} / ${nextLevelThreshold} XP</span>
            </div>
            <div style="height:12px; background:rgba(255,255,255,0.05); border-radius:10px; overflow:hidden; padding:2px;">
              <div style="height:100%; width:${currentLevelProgress}%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius:8px; box-shadow:0 0 20px var(--accent);"></div>
            </div>
          </div>
        </div>

        <div class="stats-grid-premium">
          <div class="stat-card-premium">
            <div style="font-size:14px; color:var(--ink-2); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">Actividad Semanal</div>
            <div class="chart-container">
              ${activityDays.map((day, i) => `
                <div class="chart-bar" title="${day}: ${activityData[i]}%">
                  <div class="chart-bar-fill" style="height:${activityData[i]}%"></div>
                  <div style="position:absolute; bottom:-20px; width:100%; text-align:center; font-size:9px; color:var(--ink-2);">${day}</div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="stat-card-premium">
             <div style="font-size:14px; color:var(--ink-2); margin-bottom:16px; text-transform:uppercase; letter-spacing:1px;">Logros Recientes</div>
             <div style="display:flex; flex-wrap:wrap; gap:12px;">
                <div class="achievement-icon ${totalHistorical > 100 ? 'achievement-unlocked' : ''}" title="Primeros 100 XP">🪙</div>
                <div class="achievement-icon ${activeExtensions >= 5 ? 'achievement-unlocked' : ''}" title="Coleccionista (5+ Apps)">📱</div>
                <div class="achievement-icon ${dailyStreak >= 7 ? 'achievement-unlocked' : ''}" title="Fidelidad (Racha 7 días)">🔥</div>
                <div class="achievement-icon ${totalHistorical > 1000 ? 'achievement-unlocked' : ''}" title="Millonario Eco">💎</div>
                <div class="achievement-icon ${state.oceanPayLinked ? 'achievement-unlocked' : ''}" title="Ciudadano Verificado">🌊</div>
             </div>
             <div style="margin-top:20px; font-size:12px; color:var(--ink-1);">
                Has desbloqueado ${[totalHistorical > 100, activeExtensions >= 5, dailyStreak >= 7, totalHistorical > 1000, state.oceanPayLinked].filter(Boolean).length} de 5 hitos.
             </div>
          </div>

          <div class="stat-card-premium" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; background:linear-gradient(135deg, rgba(100,167,255,0.05), rgba(179,136,255,0.05));">
             <div style="font-size:48px; margin-bottom:10px;">🛡️</div>
             <div style="font-weight:700; font-size:18px; margin-bottom:4px;">Estatus de Cuenta</div>
             <div style="color:${state.oceanPayLinked ? 'var(--ok)' : 'var(--warn)'}; font-size:14px; font-weight:600;">
               ${state.oceanPayLinked ? 'Sincronizada con Ocean Pay' : 'Local (No sincronizada)'}
             </div>
             <button class="btn" onclick="switchTab('commerce')" style="margin-top:16px; font-size:12px;">Gestionar</button>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(400px, 1fr)); gap:24px;">
          <!-- Desglose por Fuente -->
          <div class="card" style="margin:0; border-radius:24px;">
            <h3 style="margin:0 0 24px; font-size:20px; display:flex; align-items:center; gap:12px;">
              <span style="width:36px; height:36px; background:rgba(255,215,0,0.1); border-radius:10px; display:flex; align-items:center; justify-content:center; color:#FFD700;">📊</span>
              Distribución de Ingresos
            </h3>
            <div style="display:flex; flex-direction:column; gap:20px;">
              ${[
          { label: 'Clicky Coin', value: clickyEarned, color: '#FFD700', icon: '🪙' },
          { label: 'Generador', value: genEarned, color: 'var(--accent)', icon: '⚡' },
          { label: 'Misiones', value: dailyEarned, color: 'var(--ok)', icon: '🎁' },
          { label: 'Eco Luck', value: luckEarned, color: 'var(--accent-2)', icon: '🎲' }
        ].map(item => {
          const perc = totalHistorical > 0 ? (item.value / totalHistorical) * 100 : 0;
          return `
                  <div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px;">
                      <span style="display:flex; align-items:center; gap:10px; font-weight:600;">${item.icon} ${item.label}</span>
                      <span style="font-weight:700;">${item.value.toLocaleString()} 🪙 <small style="font-weight:400; opacity:0.6; margin-left:4px;">(${Math.round(perc)}%)</small></span>
                    </div>
                    <div style="height:8px; background:rgba(255,255,255,0.05); border-radius:4px; overflow:hidden;">
                      <div style="height:100%; width:${perc}%; background:${item.color}; box-shadow:0 0 10px ${item.color}44;"></div>
                    </div>
                  </div>
                `;
        }).join('')}
            </div>
          </div>

          <!-- Actividad Reciente -->
          <div class="card" style="margin:0; border-radius:24px;">
            <h3 style="margin:0 0 24px; font-size:20px; display:flex; align-items:center; gap:12px;">
              <span style="width:36px; height:36px; background:rgba(100,167,255,0.1); border-radius:10px; display:flex; align-items:center; justify-content:center; color:var(--accent);">🕒</span>
              Metas de Hoy
            </h3>
            <div style="display:flex; flex-direction:column; gap:16px;">
              <div class="activity-item">
                 <div style="width:44px; height:44px; border-radius:14px; background:rgba(100,167,255,0.1); display:flex; align-items:center; justify-content:center; color:var(--accent); font-size:20px;">📋</div>
                 <div style="flex:1;">
                    <div style="font-size:15px; font-weight:700;">Misiones Diarias</div>
                    <div style="font-size:13px; color:var(--ink-2);">${state.dailyRewards?.missionsCompleted || 0} de 5 misiones listas</div>
                 </div>
              </div>
              <div class="activity-item">
                 <div style="width:44px; height:44px; border-radius:14px; background:rgba(16,185,129,0.1); display:flex; align-items:center; justify-content:center; color:var(--ok); font-size:20px;">🎮</div>
                 <div style="flex:1;">
                    <div style="font-size:15px; font-weight:700;">Mini-juegos</div>
                    <div style="font-size:13px; color:var(--ink-2);">${state.dailyRewards?.missions?.play_3_minigames || 0} partidas completadas</div>
                 </div>
              </div>
              <div class="activity-item">
                 <div style="width:44px; height:44px; border-radius:14px; background:rgba(255,215,0,0.1); display:flex; align-items:center; justify-content:center; color:#FFD700; font-size:20px;">🪙</div>
                 <div style="flex:1;">
                    <div style="font-size:15px; font-weight:700;">Clics Diarios</div>
                    <div style="font-size:13px; color:var(--ink-2);">${state.clickyCoinData?.clicksToday || 0} de 50 permitidos</div>
                 </div>
              </div>
            </div>
            <button class="btn primary" onclick="switchTab('daily-rewards')" style="width:100%; margin-top:20px; border-radius:12px;">Ir a Misiones</button>
          </div>
        </div>
      `;
    }

    /* =========================
       COMERCIO
       ========================= */
    async function renderCommerce() {
      const content = document.getElementById('content');
      content.innerHTML = '';
      content.className = '';

      const state = await loadState();

      content.innerHTML = `
      <div class="card" style="margin-bottom:20px;text-align:center;background:linear-gradient(135deg, rgba(16,185,129,.1), rgba(52,211,153,.1));border:1px solid var(--ok);">
      <div style="font-size:48px;margin-bottom:12px;">💳</div>
      <h2 style="margin:0 0 8px;font-size:32px;color:var(--ok);">Centro de Comercio</h2>
      <p style="color:var(--ink-1);margin:0 auto 20px;max-width:500px;">
        Gestiona tus Ecoxionums, realiza transferencias y conecta con Ocean Pay.
      </p>
      
      <div style="display:inline-flex;flex-direction:column;gap:8px;padding:20px 40px;background:rgba(0,0,0,.2);border-radius:16px;border:1px solid rgba(255,255,255,.1);">
        <span style="font-size:14px;color:var(--ink-1);text-transform:uppercase;letter-spacing:1px;">Balance Actual</span>
        <div style="font-size:42px;font-weight:800;color:var(--ok);text-shadow:0 0 20px rgba(16,185,129,.3);">
          ${(state.ecoxionums || 0).toLocaleString()} 🪙
        </div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-bottom:24px;">
      <!-- Tarjeta Ocean Pay -->
      <div class="card" style="background:var(--bg-1);border:1px solid ${state.oceanPayLinked ? 'var(--accent)' : 'var(--warn)'};">
        <h3 style="margin:0 0 16px;display:flex;align-items:center;gap:10px;color:var(--accent);">
          <span>🌊</span>
          <span>Estado de Ocean Pay</span>
        </h3>
        
        <div style="margin-bottom:20px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.05);">
            <span style="color:var(--ink-1);">Estado</span>
            <span style="font-weight:600;color:${state.oceanPayLinked ? 'var(--ok)' : 'var(--warn)'};">
              ${state.oceanPayLinked ? '? Vinculado' : '⚠️ No vinculado'}
            </span>
          </div>
          ${state.oceanPayLinked ? `
            <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
              <span style="color:var(--ink-1);">Usuario</span>
              <span style="font-weight:600;color:var(--ink-0);">${state.username}</span>
            </div>
          ` : `
            <p style="font-size:13px;color:var(--ink-1);margin:0;">
              Vincula tu cuenta para asegurar tus bienes y habilitar transferencias.
            </p>
          `}
        </div>
        
        ${state.oceanPayLinked ? `
          <button class="btn" onclick="unlinkOceanPay()" style="width:100%;margin-bottom:8px;">Desvincular</button>
          <button class="btn primary" onclick="updateBalance()" style="width:100%;">🔄 Sincronizar Saldo</button>
        ` : `
          <button class="btn primary" onclick="openOceanPay()" style="width:100%;">🌊 Conectar Ocean Pay</button>
        `}
      </div>

      <!-- Acciones Rápidas -->
      <div class="card">
        <h3 style="margin:0 0 16px;display:flex;align-items:center;gap:10px;">
          <span>⚡</span>
          <span>Acciones Rápidas</span>
        </h3>
        
        <div style="display:grid;gap:12px;">
          <button class="btn primary" onclick="switchTab('packages')" style="justify-content:center;padding:16px;">
            <span style="margin-right:8px;">🎁</span> Comprar Paquetes
          </button>
          <button class="btn" onclick="showTransferModal()" style="justify-content:center;padding:16px;">
            <span style="margin-right:8px;">💸</span> Enviar Ecoxionums
          </button>
          <button class="btn" onclick="switchTab('marketplace')" style="justify-content:center;padding:16px;">
            <span style="margin-right:8px;">🛒</span> Ir al Marketplace
          </button>
        </div>
      </div>
    </div>
    <!-- Historial Real -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;">📜 Historial de Transacciones</h3>
        <button onclick="renderCommerce()" style="background:transparent;border:none;color:var(--accent);cursor:pointer;">🔄</button>
      </div>
      <div id="tx-history-list" style="display:flex;flex-direction:column;gap:8px;">
        <div style="text-align:center;padding:20px;color:var(--ink-1);">Cargando historial...</div>
      </div>
    </div>
    `;

      // Cargar historial si está conectado
      if (state.oceanPayLinked && state.userId) {
        loadTransactionHistory(state.userId).then(txs => {
          const container = document.getElementById('tx-history-list');
          if (!container) return;

          if (!txs || txs.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--ink-1);background:rgba(255,255,255,.03);border-radius:8px;">No hay transacciones recientes.</div>`;
            return;
          }

          container.innerHTML = txs.map(tx => {
            const isIncoming = tx.monto > 0;
            const date = new Date(tx.fecha || tx.created_at || Date.now()).toLocaleDateString();
            return `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,.03);border-radius:8px;border-left:3px solid ${isIncoming ? 'var(--ok)' : 'var(--warn)'};">
                <div>
                  <div style="font-weight:600;font-size:14px;margin-bottom:2px;">${tx.concepto || 'Transacción'}</div>
                  <div style="font-size:11px;color:var(--ink-1);">${date} • ${tx.origen || 'Ecoxion'}</div>
                </div>
                <div style="font-weight:700;color:${isIncoming ? 'var(--ok)' : 'var(--warn)'};">
                  ${isIncoming ? '+' : ''}${tx.monto} 🪙
                </div>
              </div>
      `;
          }).join('');
        });
      }
    }

    async function loadTransactionHistory(userId) {
      try {
        const res = await fetch(`${API_GLOBAL}/ocean-pay/history/${userId}`);
        if (res.ok) return await res.json();
      } catch (e) { console.error(e); }
      return [];
    }

    /* =========================
       TRANSFERENCIAS P2P
       ========================= */
    async function showTransferModal() {
      const state = await loadState();

      if (!state.oceanPayLinked) {
        showAlert('warning', 'Requiere Ocean Pay', 'Debes vincular tu cuenta de Ocean Pay para realizar transferencias.');
        return;
      }

      // Crear modal
      const modal = document.createElement('div');
      modal.className = 'opening-overlay active'; // Reutilizamos clase de overlay
      modal.style.background = 'rgba(0,0,0,0.8)';
      modal.style.backdropFilter = 'blur(5px)';
      modal.innerHTML = `
      <div class="card" style="width:100%;max-width:450px;animation:slideUp 0.3s ease-out;">
          <h2 style="margin:0 0 20px;display:flex;align-items:center;gap:10px;">
            <span>💸</span> Enviar Ecoxionums
          </h2>
          
          <div style="margin-bottom:20px;padding:16px;background:rgba(100,167,255,.1);border-radius:8px;border:1px solid var(--accent);">
             <div style="font-size:12px;color:var(--ink-1);">Tu Balance:</div>
             <div style="font-size:24px;font-weight:700;color:var(--accent);">${(state.ecoxionums || 0).toLocaleString()} 🪙</div>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:8px;font-size:14px;">Destinatario (Usuario exacto)</label>
            <input type="text" id="tx-recipient" class="input-field" placeholder="Ej: OceanandWild" style="width:100%;padding:12px;border-radius:8px;background:var(--bg-1);border:1px solid rgba(255,255,255,.1);color:var(--ink-0);">
          </div>
          
          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:8px;font-size:14px;">Cantidad</label>
            <input type="number" id="tx-amount" class="input-field" placeholder="0" min="1" style="width:100%;padding:12px;border-radius:8px;background:var(--bg-1);border:1px solid rgba(255,255,255,.1);color:var(--ink-0);">
          </div>
          
          <div style="margin-bottom:24px;">
            <label style="display:block;margin-bottom:8px;font-size:14px;">Nota (Opcional)</label>
            <input type="text" id="tx-note" class="input-field" placeholder="Ej: Regalo de bienvenida" style="width:100%;padding:12px;border-radius:8px;background:var(--bg-1);border:1px solid rgba(255,255,255,.1);color:var(--ink-0);">
          </div>

          <div style="display:flex;gap:12px;">
            <button class="btn" id="tx-cancel" style="flex:1;">Cancelar</button>
            <button class="btn primary" id="tx-send" style="flex:1;">Enviar 💸</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      const closeModal = () => modal.remove();

      modal.querySelector('#tx-cancel').onclick = closeModal;
      modal.querySelector('#tx-send').onclick = async () => {
        const recipient = modal.querySelector('#tx-recipient').value.trim();
        const amount = parseInt(modal.querySelector('#tx-amount').value);
        const note = modal.querySelector('#tx-note').value.trim();

        if (!recipient) return showAlert('error', 'Falta datos', 'Ingresa el nombre del destinatario.');
        if (!amount || amount <= 0) return showAlert('error', 'Cantidad inválida', 'Ingresa una cantidad mayor a 0.');
        if (amount > state.ecoxionums) return showAlert('error', 'Saldo insuficiente', 'No tienes suficientes Ecoxionums.');
        if (recipient.toLowerCase() === state.username.toLowerCase()) return showAlert('error', 'Error', 'No puedes enviarte dinero a ti mismo.');

        const btn = modal.querySelector('#tx-send');
        btn.textContent = 'Enviando...';
        btn.disabled = true;

        try {
          const opToken = localStorage.getItem('opToken');
          const res = await fetch(`${API_GLOBAL}/ocean-pay/transfer`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${opToken}`
            },
            body: JSON.stringify({
              recipientUsername: recipient,
              amount: amount,
              currency: 'ecoxionums',
              note: note
            })
          });

          const data = await res.json();

          if (res.ok) {
            showAlert('success', '¡Enviado!', `Has enviado ${amount} Ecoxionums a ${recipient}.`);
            closeModal();
            updateBalance(); // Actualizar UI
            renderCommerce(); // Recargar historial (cuando esté implementado)
          } else {
            showAlert('error', 'Error', data.error || 'Falló la transferencia.');
            btn.textContent = 'Enviar 💸';
            btn.disabled = false;
          }
        } catch (e) {
          console.error(e);
          showAlert('error', 'Error de conexión', 'No se pudo conectar con el servidor.');
          btn.textContent = 'Enviar 💸';
          btn.disabled = false;
        }
      };
    }


    /* =========================
       CONFIGURACIÓN
       ========================= */
    async function renderSettings() {
      const content = document.getElementById('content');
      content.innerHTML = '';
      content.className = '';

      const state = await loadState();

      content.innerHTML = `
      <div class="card">
      <h2>Configuración</h2>
      
      <div style="margin-top:24px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;">Tema:</label>
        <select id="theme-select" style="width:100%;padding:10px;border-radius:8px;background:var(--bg-1);border:1px solid rgba(255,255,255,.12);color:var(--ink-0);">
          <option value="espacial" ${state.currentTheme === 'espacial' ? 'selected' : ''}>🌌 Espacial</option>
          <option value="naturaleza" ${state.currentTheme === 'naturaleza' ? 'selected' : ''}>🌿 Naturaleza</option>
          <option value="tropical" ${state.currentTheme === 'tropical' ? 'selected' : ''}>🏝️ Tropical</option>
        </select>
      </div>
      
      <div style="margin-top:24px;">
        <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
          <input type="checkbox" id="dark-mode-toggle" ${state.darkMode ? 'checked' : ''} style="width:20px;height:20px;">
          <div>
            <span style="font-weight:600;display:block;">Dark Mode</span>
            <small style="color:var(--ink-1);font-size:11px;">"Dark Mode": Esta es una función pasiva que se activa inmediatamente al alternar. No tiene un panel de control.</small>
          </div>
        </label>
      </div>
      
      <div style="margin-top:24px;">
        <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
          <input type="checkbox" id="zen-mode-toggle" ${state.zenMode ? 'checked' : ''} style="width:20px;height:20px;">
          <div>
            <span style="font-weight:600;display:block;">Modo Zen</span>
            <small style="color:var(--ink-1);font-size:11px;">"Zen Mode": Esta es una función pasiva que se activa inmediatamente al alternar. No tiene un panel de control.</small>
          </div>
        </label>
      </div>
      
      <div style="margin-top:32px;padding-top:24px;border-top:1px solid rgba(255,255,255,.1);">
        <h3 style="margin:0 0 12px;font-size:16px;">Ocean Pay</h3>
        ${state.oceanPayLinked
          ? `<p style="color:var(--ok);margin:0 0 12px;">✅ Vinculado con Ocean Pay</p>
             <p style="color:var(--ink-1);font-size:13px;margin:0 0 16px;">Usuario: ${state.username}</p>
             <button class="btn" onclick="unlinkOceanPay()" style="width:100%;background:var(--warn);border-color:var(--warn);">
               ?? Cerrar Sesi?n
             </button>`
          : `<p style="color:var(--ink-1);margin:0 0 12px;">No vinculado con Ocean Pay</p>
             <button class="btn primary" onclick="openOceanPay()" style="width:100%;">🌊 Vincular Ocean Pay</button>`
        }
      </div>

      ${state.username === 'OceanandWild'
          ? `<div style="margin-top:32px;padding-top:24px;border-top:1px solid rgba(255,255,255,.1);">
             <h3 style="margin:0 0 12px;font-size:16px;">🛠️ Panel de Admin</h3>
             <button class="btn primary" onclick="adminRequestEcoxionums()" style="width:100%;margin-bottom:8px;background:linear-gradient(135deg, #FFD700, #FFA500);border:none;color:black;">
               💰 Generar Ecoxionums
             </button>
           </div>`
          : ''
        }
      
      
      <button class="btn primary" onclick="saveSettings()" style="margin-top:24px;">Guardar Configuración</button>
    </div>
      `;

      // Listeners
      document.getElementById('theme-select').addEventListener('change', applyTheme);
      document.getElementById('dark-mode-toggle').addEventListener('change', toggleDarkMode);
      document.getElementById('zen-mode-toggle').addEventListener('change', toggleZenMode);
    }

    function applyTheme(theme) {
      if (typeof theme === 'object') {
        theme = theme.target.value;
      }

      // Eliminar cualquier tema previo
      const classes = Array.from(document.body.classList);
      classes.forEach(c => {
        if (c.startsWith('theme-')) document.body.classList.remove(c);
      });

      // Aplicar nuevo tema
      document.body.classList.add(`theme-${theme}`);

      loadState().then(state => {
        state.currentTheme = theme;
        saveState(state);
      });
    }

    function toggleDarkMode(e) {
      const enabled = e.target.checked;
      document.body.classList.toggle('dark-theme', enabled);

      loadState().then(state => {
        state.darkMode = enabled;
        saveState(state);

        // Activar/desactivar extensión
        if (enabled && state.installed['dark-mode']) {
          defaultExtensions['dark-mode'].onEnable();
        } else if (!enabled && state.installed['dark-mode']) {
          defaultExtensions['dark-mode'].onDisable();
        }
      });
    }

    function toggleZenMode(e) {
      const enabled = e.target.checked;
      document.body.classList.toggle('zen-layout', enabled);

      loadState().then(state => {
        state.zenMode = enabled;
        saveState(state);
        renderNavigation();
      });
    }

    window.saveSettings = function () {
      showAlert('success', 'Configuración guardada', 'Tus preferencias se han guardado correctamente.');
    };

    window.adminRequestEcoxionums = async function () {
      const input = prompt("ADMIN: Ingresa la cantidad de Ecoxionums a generar:", "1000");
      if (!input) return;

      const amount = parseInt(input);
      if (isNaN(amount) || amount <= 0) {
        showAlert('error', 'Error', 'Cantidad inválida');
        return;
      }

      await awardEcoxionums(amount, 'Generación Admin');
      showAlert('success', 'Admin', `Se generaron ${amount.toLocaleString()} Ecoxionums`);
    };

    function updateBalanceUI(amount) {
      const balanceEls = Array.from(document.querySelectorAll('[data-role="eco-balance"]'));
      const dashboardBalanceEl = document.getElementById('dashboard-eco-balance');
      balanceEls.forEach(el => {
        el.textContent = Math.round(amount || 0).toLocaleString();
      });
      if (dashboardBalanceEl) dashboardBalanceEl.textContent = Math.round(amount || 0).toLocaleString();
    }

    /* =========================
       ACTUALIZAR BALANCE
       ========================= */
    async function updateBalance() {
      const state = await loadState();

      // Actualizar UI con lo que tenemos localmente primero
      updateBalanceUI(state.ecoxionums);

      // Si está vinculado con Ocean Pay, obtener desde servidor para asegurar sincronía
      if (state.oceanPayLinked && state.userId) {
        try {
          const res = await fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/balance`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('opToken') || ''}`
            }
          });
          if (res.ok) {
            const data = await res.json();
            const ecoxionums = data.ecoxionums || 0;
            state.ecoxionums = ecoxionums;
            await saveState(state);
            updateBalanceUI(ecoxionums);
            return;
          }
        } catch (e) {
          console.warn('Error obteniendo Ecoxionums:', e);
        }
      }
    }

    // Helper para dar recompensas de forma consistente
    async function awardEcoxionums(amount, concepto = 'Recompensa') {
      const state = await loadState();
      state.ecoxionums = (state.ecoxionums || 0) + amount;
      await saveState(state);
      updateBalanceUI(state.ecoxionums);

      if (state.oceanPayLinked && state.userId) {
        try {
          const token = localStorage.getItem('opToken');
          if (!token) {
            showAlert('warning', 'Sesión Expirada', 'Tus ganancias no se guardan en la nube. Inicia sesión de nuevo.');
            return state.ecoxionums;
          }

          const opUser = JSON.parse(localStorage.getItem('opUser') || '{}');
          const targetId = state.userId || opUser.id;

          if (!targetId) {
            console.warn('No userId found for sync');
            return state.ecoxionums;
          }

          const res = await fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/change`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              userId: targetId,
              amount: amount,
              concepto: concepto,
              origen: 'Ecoxion'
            })
          });

          if (res.ok) {
            const data = await res.json();
            if (data.newBalance !== undefined) {
              state.ecoxionums = data.newBalance;
              await saveState(state);
              updateBalanceUI(state.ecoxionums);
            }
          } else {
            const errData = await res.json().catch(() => ({}));
            console.warn('Error syncing earnings:', errData);
            if (res.status === 401) {
              showAlert('error', 'Sesión Caducada', 'Inicia sesión en Ocean Pay nuevamente para guardar tu progreso.');
            } else {
              showAlert('warning', 'Error de Nube', `No se pudo guardar: ${errData.error || 'Error desconocido'}`);
            }
          }
        } catch (e) {
          console.warn('Error sincronizando recompensa:', e);
          showAlert('warning', 'Sin Conexión', 'Tus ganancias se guardaron localmente pero no en la nube.');
        }
      }
      return state.ecoxionums;
    }


    /* =========================
       NAVEGACIÓN
       ========================= */
    function renderNavigation() {
      const isZen = document.body.classList.contains('zen-layout');
      const container = document.getElementById('appContainer');
      if (!container) {
        console.warn('renderNavigation: appContainer no encontrado, usando fallback en body.');
      }

      // Limpiar TODAS las navegaciones existentes para evitar duplicados
      const existingAppbar = document.getElementById('appbar');
      const existingSidebar = document.querySelector('.zen-sidebar');
      const existingTabs = document.querySelectorAll('[data-role="main-tabs"]');

      if (existingAppbar) existingAppbar.remove();
      if (existingSidebar) existingSidebar.remove();
      existingTabs.forEach(tab => {
        const parent = tab.parentElement;
        if (parent && (parent.classList.contains('appbar') || parent.classList.contains('zen-sidebar'))) {
          // Ya se eliminó con el padre
        } else {
          tab.remove();
        }
      });

      // Crear nueva navegación
      const nav = isZen ? buildSidebarZen() : createHeader();

      if (isZen) {
        // Verificar si ya existe un sidebar para evitar duplicados
        const existingSidebar = document.querySelector('.zen-sidebar');
        if (existingSidebar) {
          existingSidebar.remove();
        }
        if (container) {
          container.insertBefore(nav, container.firstChild);
        } else {
          document.body.prepend(nav);
        }
        const content = document.getElementById('content');
        if (content) {
          content.style.marginLeft = 'var(--sidebar-w)';
          content.style.transition = 'margin-left 0.3s ease';
        }
      } else {
        const content = document.getElementById('content');
        if (content) {
          if (container) {
            container.insertBefore(nav, content);
          } else {
            content.parentNode?.insertBefore(nav, content);
          }
          content.style.marginLeft = '0';
          content.style.maxWidth = 'none';
          content.style.margin = '0';
          content.style.padding = '0';
        } else if (!container) {
          document.body.prepend(nav);
        }
      }

      // Pequeño delay para asegurar que el DOM está listo
      setTimeout(() => {
        renderTabs();
        updateBalance();
        updateUserInfo();
      }, 10);
    }

    async function updateUserInfo() {
      const state = await loadState();
      const usernameEl = document.getElementById('username-display');
      const brandSubtitleEl = document.getElementById('brand-subtitle');
      const zenUsernameEl = document.getElementById('zen-username');
      const zenBrandSubtitleEl = document.getElementById('zen-brand-subtitle');
      const zenUserInfoEl = document.getElementById('zen-user-info');

      if (usernameEl) {
        usernameEl.textContent = normalizeUiText(state.username, 'Explorador');
        if (state.oceanPayLinked) {
          usernameEl.style.color = 'var(--accent)';
          const userInfo = usernameEl.closest('#user-info');
          if (userInfo) {
            userInfo.style.borderColor = 'rgba(100, 167, 255, 0.3)';
            userInfo.style.background = 'rgba(100, 167, 255, 0.08)';
          }
        }
      }

      if (brandSubtitleEl) {
        brandSubtitleEl.textContent = state.oceanPayLinked ? 'Conectado' : 'Prototipo';
      }

      // Actualizar también en Zen Mode
      if (zenUsernameEl) {
        zenUsernameEl.textContent = normalizeUiText(state.username, 'Explorador');
      }

      if (zenBrandSubtitleEl) {
        zenBrandSubtitleEl.textContent = state.oceanPayLinked ? 'Conectado' : 'Prototipo';
      }

      if (zenUserInfoEl && state.oceanPayLinked) {
        zenUserInfoEl.style.borderColor = 'rgba(100, 167, 255, 0.3)';
        zenUserInfoEl.style.background = 'rgba(100, 167, 255, 0.1)';
      }
    }

    /* =========================
       OCEAN PAY
       ========================= */
    async function openOceanPay() {
      // Si ya está vinculado, solo mostrar mensaje o panel de usuario
      const state = await loadState();
      if (state.oceanPayLinked) {
        showAlert('info', 'Ya vinculado', 'Tu cuenta Ocean Pay está activa.');
        return;
      }

      // Mostrar modal
      const modal = document.getElementById('ocean-pay-modal');
      const box = modal.querySelector('.ocean-pay-box');
      modal.classList.remove('hidden');

      // Animación de entrada
      if (window.gsap) {
        gsap.fromTo(box, { scale: 0.8, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.3, ease: 'back.out(1.7)' });
      }
    }

    async function submitOceanPayLogin() {
      const u = document.getElementById('op-username').value.trim();
      const p = document.getElementById('op-password').value.trim();
      const err = document.getElementById('op-error');
      const btn = document.getElementById('op-login-btn');

      if (!u || !p) {
        if (err) err.textContent = 'Por favor completa ambos campos';
        return;
      }

      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loader-spinner" style="width:14px;height:14px;border-width:2px;"></span> Conectando...';
      }
      if (err) err.textContent = '';

      try {
        const res = await fetch(`${API_GLOBAL}/ocean-pay/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p })
        });

        const data = await res.json();

        if (res.ok && data.success) {
          // Login Success
          localStorage.setItem('opToken', data.token);
          if (data.user) {
            localStorage.setItem('opUser', JSON.stringify(data.user));
          }

          const state = await loadState();
          state.userId = data.user.id;
          state.username = data.user.username; // Usar nombre de Ocean Pay
          state.oceanPayLinked = true;
          state.ecoxionums = data.ecoxionums || 0;

          await saveState(state);

          document.getElementById('ocean-pay-modal').classList.add('hidden');

          // Refrescar UI
          updateBalance();
          updateUserInfo();
          if (typeof renderCommerce === 'function' && currentTab === 'commerce') renderCommerce();
          if (typeof renderSettings === 'function' && currentTab === 'settings') renderSettings();

          showAlert('success', 'Conectado', `?Bienvenido de vuelta, ${data.user.username}! ??`);
        } else {
          if (err) err.textContent = data.error || 'Credenciales inválidas. Verifica usuario y contraseña.';
          if (navigator.vibrate) navigator.vibrate(200);
        }
      } catch (e) {
        console.error(e);
        if (err) err.textContent = 'Error de conexión con el servidor Ocean Pay.';
      }

      if (btn) {
        btn.disabled = false;
        btn.textContent = '?? Iniciar Sesi?n';
      }
    }

    function skipOceanPay() {
      const modal = document.getElementById('ocean-pay-modal');
      modal.classList.add('hidden');
      localStorage.setItem('ecoSkipOceanPay', 'true');
      showAlert('info', 'Modo Local', 'Puedes vincular tu cuenta más tarde en Ajustes.');
    }

    /* =========================
       CERRAR SESIÓN Y ELIMINAR CUENTA
       ========================= */
    async function unlinkOceanPay() {
      const confirmed = confirm('¿Estás seguro de que deseas cerrar sesión de Ocean Pay?\n\nTus Ecoxionums se mantendrán en tu cuenta de Ocean Pay.');

      if (!confirmed) return;

      try {
        const state = await loadState();

        // Limpiar datos de Ocean Pay
        state.oceanPayLinked = false;
        state.userId = crypto.randomUUID();

        // Mantener el username pero limpiar vinculación
        localStorage.removeItem('opUser');
        localStorage.removeItem('opToken');
        localStorage.removeItem('ecoxionUserId');

        await saveState(state);
        await updateBalance();
        await updateUserInfo();

        showAlert('success', 'Sesión cerrada', 'Has cerrado sesión de Ocean Pay correctamente.');

        // Recargar configuración para mostrar cambios
        renderTab('settings');
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
        showAlert('error', 'Error', 'Hubo un problema al cerrar sesión. Intenta de nuevo.');
      }
    }

    let isOpRegisterMode = false;

    window.toggleOceanPayMode = function () {
      isOpRegisterMode = !isOpRegisterMode;
      const title = document.getElementById('op-title');
      const btn = document.getElementById('op-login-btn');
      const toggleMsg = document.getElementById('op-toggle-msg');
      const errorMsg = document.getElementById('op-error');

      if (errorMsg) errorMsg.textContent = ''; // Clear errors on toggle

      if (isOpRegisterMode) {
        if (title) title.textContent = '🌊 Crear Cuenta Ocean Pay';
        if (btn) btn.textContent = '📝 Registrarse y Vincular';
        if (toggleMsg) toggleMsg.textContent = '¿Ya tienes cuenta? Inicia sesión';
      } else {
        if (title) title.textContent = '🌊 Ocean Pay Access';
        if (btn) btn.textContent = '?? Iniciar Sesi?n';
        if (toggleMsg) toggleMsg.textContent = '¿No tienes cuenta? Regístrate aquí';
      }
    };

    window.submitOceanPayAuth = async function () {
      const u = document.getElementById('op-username').value.trim();
      const p = document.getElementById('op-password').value.trim();
      const err = document.getElementById('op-error');
      const btn = document.getElementById('op-login-btn');

      if (!u || !p) {
        if (err) err.textContent = 'Por favor completa todos los campos';
        return;
      }

      if (err) err.textContent = '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loader-spinner" style="width:14px;height:14px;border-width:2px;"></span> Procesando...';
      }

      const endpoint = isOpRegisterMode ? '/ocean-pay/register' : '/ocean-pay/login';

      try {
        const res = await fetch(`${API_GLOBAL}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p })
        });

        const data = await res.json();

        if (res.ok && data.success) {
          // Success Logic (Same for both)
          localStorage.setItem('opToken', data.token);
          if (data.user) {
            localStorage.setItem('opUser', JSON.stringify(data.user));
          }

          // SYNC LOGIC: Transfer local balance to cloud if > 0
          const currentLocal = (await loadState()).ecoxionums || 0;
          if (currentLocal > 0) {
            try {
              const syncRes = await fetch(`${API_GLOBAL}/ocean-pay/sync-ecoxionums`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + data.token },
                body: JSON.stringify({ amount: currentLocal })
              });
              const syncData = await syncRes.json();

              if (syncData.success) {
                // Update local state with new server balance
                const state = await loadState();
                state.ecoxionums = syncData.newBalance;
                showAlert('success', 'Sincronizado', `Se han añadido ${currentLocal} Ecoxionums a tu cuenta Cloud.`);
              } else {
                console.error('Sync failed:', syncData.error);
                // Fallback: use server data or keep local? 
                // We'll trust server data to avoid conflicts, but warn user.
                const state = await loadState();
                state.ecoxionums = data.ecoxionums || 0;
                showAlert('warning', 'Sincronización parcial', 'No se pudo sincronizar el saldo local. Contacta soporte.');
              }
            } catch (e) {
              console.error('Sync error:', e);
              const state = await loadState();
              state.ecoxionums = data.ecoxionums || 0;
            }
          } else {
            const state = await loadState();
            state.ecoxionums = data.ecoxionums || 0;
          }

          const state = await loadState();
          state.userId = data.user.id;
          state.username = data.user.username;
          state.oceanPayLinked = true;
          // state.ecoxionums is already set above

          await saveState(state);

          document.getElementById('ocean-pay-modal').classList.add('hidden');

          updateBalance();
          updateUserInfo();
          if (typeof renderCommerce === 'function' && currentTab === 'commerce') renderCommerce();
          if (typeof renderSettings === 'function' && currentTab === 'settings') renderSettings();

          showAlert('success', isOpRegisterMode ? '?Bienvenido!' : 'Conectado', `?Hola, ${data.user.username}! ??`);
        } else {
          if (err) err.textContent = data.error || 'Error en la autenticación.';
          if (navigator.vibrate) navigator.vibrate(200);
        }
      } catch (e) {
        console.error(e);
        if (err) err.textContent = 'Error de conexión con el servidor.';
      }

      if (btn) {
        btn.disabled = false;
        btn.textContent = isOpRegisterMode ? '?? Registrarse y Vincular' : '?? Iniciar Sesi?n';
      }
    };

    /* =========================
       INICIALIZACIÓN
       ========================= */
    async function initializeApp() {
      const state = await loadState();

      // Verificar si necesita vincular Ocean Pay
      const opUser = JSON.parse(localStorage.getItem('opUser') || '{}');
      const skipModal = localStorage.getItem('ecoSkipOceanPay');

      if (opUser.id) {
        // Ya está vinculado, actualizar estado
        state.userId = opUser.id;
        state.username = opUser.username || state.username;
        state.oceanPayLinked = true;

        // FETCH SERVER BALANCE on init to keep in sync
        try {
          const res = await fetch(`${API_GLOBAL}/ocean-pay/ecoxionums/${opUser.id}`);
          const sData = await res.json();
          if (sData && sData.ecoxionums !== undefined) {
            const serverBal = parseFloat(sData.ecoxionums || 0);
            const localBal = state.ecoxionums || 0;
            const hasSynced = localStorage.getItem('opSyncedBalance') === 'true';

            // Solo sobreescribir si el balance del servidor es mayor o ya hemos sincronizado antes
            if (serverBal > localBal || hasSynced) {
              state.ecoxionums = serverBal;
            } else {
              console.log('SafeSync: Preservando saldo local mayor', localBal, 'vs server', serverBal);
            }
          }
        } catch (e) { console.warn('Could not fetch server balance', e); }

        await saveState(state);
        await updateBalance();
        updateUserInfo();
      } else if (!skipModal) {
        // Mostrar modal después de un pequeño delay solo si no se saltó antes
        setTimeout(() => {
          document.getElementById('ocean-pay-modal').classList.remove('hidden');
        }, 500);
      }

      // Instalar extensiones por defecto
      const defaultExts = Object.values(defaultExtensions).filter(ext => ext.defaultInstall);
      for (const ext of defaultExts) {
        if (!state.installed[ext.id]) {
          if (!state.installed) state.installed = {};
          state.installed[ext.id] = {
            id: ext.id,
            enabled: true,
            installedAt: Date.now()
          };
        }
      }
      await saveState(state);

      // Aplicar tema
      if (state.currentTheme) {
        applyTheme(state.currentTheme);
      }

      // Aplicar dark mode
      if (state.darkMode) {
        document.body.classList.add('dark-theme');
      }

      // Aplicar modo zen
      if (state.zenMode) {
        document.body.classList.add('zen-layout');
      }

      // Renderizar navegación
      renderNavigation();

      // Cargar tab inicial
      switchTab('dashboard');

      // Inicializar usuario si no existe
      if (!state.userId || !state.username) {
        state.userId = crypto.randomUUID();
        state.username = 'Explorador';
        localStorage.setItem('ecoxionUserId', state.userId);
        localStorage.setItem('ecoxionUsername', state.username);
        await saveState(state);
        updateUserInfo();
      }

      // Actualizar balance y usuario
      await updateBalance();
      await updateUserInfo();

      // Escuchar actualizaciones de balance desde Ocean Pay
      window.addEventListener('message', (e) => {
        if (e.data?.type === 'eco-balance-update') {
          loadState().then(state => {
            state.ecoxionums = e.data.balance || 0;
            saveState(state);
            updateBalance();
          });
        }
      });

      if (!document.getElementById('ocean-pay-modal').classList.contains('hidden')) {
        return; // No mostrar alerta si el modal está abierto
      }

      showAlert('success', 'Bienvenido a Ecoxion', `?Hola, ${state.username} ! ??`);
    }

    /* =========================
       CALCULADORA
       ========================= */
    window.calcAppend = function (value) {
      const display = document.getElementById('calc-display');
      if (display.value === '0' && value !== '.') {
        display.value = value;
      } else {
        display.value += value;
      }
    };

    window.calcClear = function () {
      document.getElementById('calc-display').value = '0';
    };

    window.calcBackspace = function () {
      const display = document.getElementById('calc-display');
      display.value = display.value.slice(0, -1) || '0';
    };

    window.calcEquals = function () {
      const display = document.getElementById('calc-display');
      const expression = display.value;

      try {
        // Evaluar la expresión de forma segura
        const result = Function('"use strict"; return (' + expression + ')')();

        // Agregar al historial
        if (!window.calcHistory) window.calcHistory = [];
        window.calcHistory.unshift(`${expression} = ${result} `);
        if (window.calcHistory.length > 10) window.calcHistory.pop();

        // Actualizar historial en UI
        const historyEl = document.getElementById('calc-history');
        if (historyEl) {
          historyEl.innerHTML = window.calcHistory.map(h => `<div>${h}</div>`).join('');
        }

        display.value = result;
      } catch (e) {
        display.value = 'Error';
        setTimeout(() => display.value = '0', 1500);
      }
    };

    window.calcSqrt = function () {
      const display = document.getElementById('calc-display');
      try {
        const value = parseFloat(display.value);
        display.value = Math.sqrt(value);
      } catch (e) {
        display.value = 'Error';
      }
    };

    /* =========================
       POMODORO
       ========================= */
    function renderPomodoroStatsDummy() {
      // Placeholder for safe deletion or future expansion
    }

    window.pomodoroStart = function () {
      if (!window.pomodoroState) return;

      if (window.pomodoroState.isPaused) {
        window.pomodoroState.isPaused = false;
      } else if (!window.pomodoroState.isRunning) {
        // Iniciar nuevo
        const workTime = parseInt(document.getElementById('pomodoro-work-time')?.value || 25);
        if (!window.pomodoroState.isBreak) window.pomodoroState.timeLeft = workTime * 60;
        window.pomodoroState.totalTime = window.pomodoroState.isBreak ?
          parseInt(document.getElementById('pomodoro-break-time')?.value || 5) * 60 : workTime * 60;
      }

      window.pomodoroState.isRunning = true;
      updatePomodoroBtns();

      if (window.pomodoroState.interval) clearInterval(window.pomodoroState.interval);

      window.pomodoroState.interval = setInterval(async () => {
        window.pomodoroState.timeLeft--;
        updatePomodoroDisplay();

        if (window.pomodoroState.timeLeft <= 0) {
          clearInterval(window.pomodoroState.interval);

          if (!window.pomodoroState.isBreak) {
            // Completó sesión de trabajo
            window.pomodoroState.completedToday++;
            const workTime = parseInt(document.getElementById('pomodoro-work-time')?.value || 25);
            window.pomodoroState.totalTimeToday += workTime;

            // DAR RECOMPENSA DE ECOXIONUMS (Solo si duró más de 20 mins)
            if (workTime >= 20) {
              await awardEcoxionums(15, 'Pomodoro Completado');
              showAlert('success', '¡Enfoque completado!', '+15 Ecoxionums ganados (min. 20m). ¡Disfruta tu descanso!');
            } else {
              showAlert('success', '¡Sesión completada!', 'Buen trabajo. (Sin recompensa por ser < 20 min)');
            }

            // Configurar descanso
            const breakTime = parseInt(document.getElementById('pomodoro-break-time')?.value || 5);
            window.pomodoroState.timeLeft = breakTime * 60;
            window.pomodoroState.totalTime = breakTime * 60;
            window.pomodoroState.isBreak = true;

            showAlert('success', '¡Enfoque completado!', '+15 Ecoxionums ganados. ¡Disfruta tu descanso!');
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            // Auto star break or wait? Let's auto start for smooth flow or wait
            pomodoroStart(); // Auto start break
          } else {
            // Terminó descanso
            pomodoroReset();
            showAlert('info', 'Descanso terminado', '¿Listo para otra sesión?');
            if (navigator.vibrate) navigator.vibrate(200);
          }
        }
      }, 1000);
    };

    function updatePomodoroBtns() {
      const startBtn = document.getElementById('pomodoro-start-btn');
      const pauseBtn = document.getElementById('pomodoro-pause-btn');

      if (startBtn && pauseBtn) {
        if (window.pomodoroState.isRunning) {
          startBtn.style.display = 'none';
          pauseBtn.style.display = 'flex';
        } else {
          startBtn.style.display = 'flex';
          pauseBtn.style.display = 'none';
        }
      }
    }

    function updatePomodoroDisplay() {
      if (!window.pomodoroState) return;

      const timerEl = document.getElementById('pomodoro-timer');
      const progressCircle = document.getElementById('pomodoro-progress');
      const statusText = document.getElementById('pomodoro-status-text');

      if (timerEl) {
        const m = Math.floor(window.pomodoroState.timeLeft / 60).toString().padStart(2, '0');
        const s = (window.pomodoroState.timeLeft % 60).toString().padStart(2, '0');
        timerEl.textContent = `${m}:${s}`;
      }

      if (statusText) {
        statusText.textContent = window.pomodoroState.isBreak ? "Tiempo de Descanso" : "Tiempo de Enfoque";
        statusText.style.color = window.pomodoroState.isBreak ? "var(--ok)" : "var(--ink-1)";
      }

      if (progressCircle) {
        // Circumference = 2 * PI * r = 2 * PI * 136 ≈ 854
        const total = window.pomodoroState.totalTime || (parseInt(document.getElementById('pomodoro-work-time')?.value || 25) * 60);
        const fraction = window.pomodoroState.timeLeft / total;
        const offset = 854 * (1 - fraction);
        progressCircle.style.strokeDashoffset = offset;
        progressCircle.style.stroke = window.pomodoroState.isBreak ? "var(--ok)" : "var(--accent)";
      }

      const completedEl = document.getElementById('pomodoro-completed');
      const totalTimeEl = document.getElementById('pomodoro-total-time');

      if (completedEl) completedEl.textContent = window.pomodoroState.completedToday;
      if (totalTimeEl) totalTimeEl.textContent = `${window.pomodoroState.totalTimeToday}m`;
    }

    window.pomodoroPause = function () {
      if (!window.pomodoroState) return;

      clearInterval(window.pomodoroState.interval);
      window.pomodoroState.isRunning = false;
      window.pomodoroState.isPaused = true;
      updatePomodoroBtns();
    };

    window.pomodoroReset = function () {
      if (!window.pomodoroState) return;

      clearInterval(window.pomodoroState.interval);
      window.pomodoroState.isRunning = false;
      window.pomodoroState.isPaused = false;
      window.pomodoroState.isBreak = false;

      const workTime = parseInt(document.getElementById('pomodoro-work-time')?.value || 25);
      window.pomodoroState.timeLeft = workTime * 60;
      window.pomodoroState.totalTime = workTime * 60;

      updatePomodoroBtns();
      updatePomodoroDisplay();
    };

    /* =========================
       GALERÍA DE IMÁGENES
       ========================= */
    function loadGallery() {
      const images = JSON.parse(localStorage.getItem('ecoxion.gallery') || '[]');
      const grid = document.getElementById('gallery-grid');
      const empty = document.getElementById('gallery-empty');

      if (!grid) return;

      if (images.length === 0) {
        grid.innerHTML = '';
        if (empty) empty.style.display = 'block';
        return;
      }

      if (empty) empty.style.display = 'none';

      grid.innerHTML = images.map((img, index) => `
        <div class="gallery-item" style="position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:var(--bg-1);transition:all .3s;cursor:pointer;" onmouseenter="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 24px rgba(0,0,0,.3)'" onmouseleave="this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <img src="${img.url}" alt="${img.title || 'Imagen'}" onclick="openGalleryModal('${img.url}', '${img.title || ''}')" style="width:100%;height:200px;object-fit:cover;display:block;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23333%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2216%22%3EError al cargar%3C/text%3E%3C/svg%3E'">
          ${img.title ? `
            <div style="padding:12px;background:var(--bg-2);">
              <div style="font-size:14px;font-weight:600;color:var(--ink-0);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${img.title}</div>
            </div>` : ''}
          <button onclick="event.stopPropagation();deleteGalleryImage(${index})" style="position:absolute;top:8px;right:8px;background:var(--danger);color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;box-shadow:0 2px 8px rgba(0,0,0,.3);">🗑️</button>
        </div>
      `).join('');
    }

    window.addImageToGallery = function () {
      const url = document.getElementById('gallery-url').value.trim();
      const title = document.getElementById('gallery-title').value.trim();

      if (!url) {
        showAlert('warning', 'URL requerida', 'Por favor ingresa una URL de imagen.');
        return;
      }

      const images = JSON.parse(localStorage.getItem('ecoxion.gallery') || '[]');
      images.unshift({ url, title, addedAt: Date.now() });
      localStorage.setItem('ecoxion.gallery', JSON.stringify(images));

      document.getElementById('gallery-url').value = '';
      document.getElementById('gallery-title').value = '';

      loadGallery();
      showAlert('success', 'Imagen agregada', 'La imagen se ha agregado a tu galería.');
    };

    window.deleteGalleryImage = function (index) {
      if (!confirm('¿Eliminar esta imagen de la galería?')) return;

      const images = JSON.parse(localStorage.getItem('ecoxion.gallery') || '[]');
      images.splice(index, 1);
      localStorage.setItem('ecoxion.gallery', JSON.stringify(images));

      loadGallery();
      showAlert('info', 'Imagen eliminada', 'La imagen se ha eliminado de tu galería.');
    };

    window.openGalleryModal = function (url, title) {
      const modal = document.getElementById('gallery-modal');
      const img = document.getElementById('gallery-modal-img');
      const titleEl = document.getElementById('gallery-modal-title');

      if (modal && img) {
        img.src = url;
        if (titleEl) titleEl.textContent = title || '';
        modal.style.display = 'flex';
      }
    };

    window.closeGalleryModal = function () {
      const modal = document.getElementById('gallery-modal');
      if (modal) modal.style.display = 'none';
    };

    /* =========================
       ENCUESTAS RÁPIDAS
       ========================= */
    function loadSurveys() {
      const surveys = [
        { id: 1, title: "¿Qué te parece Ecoxion?", reward: 10, questions: ["¿Cómo calificarías tu experiencia?", "¿Qué mejorarías?"] },
        { id: 2, title: "Preferencias de extensiones", reward: 15, questions: ["¿Qué tipo de extensiones prefieres?", "¿Cuánto pagarías por una extensión premium?"] },
        { id: 3, title: "Uso de Ecoxionums", reward: 12, questions: ["¿En qué gastas tus Ecoxionums?", "¿Te gustaría más formas de ganarlos?"] }
      ];

      const state = JSON.parse(localStorage.getItem('ecoxion.state.v1') || '{}');
      const completedSurveys = state.surveyData?.completed || [];

      const list = document.getElementById('survey-list');
      if (!list) return;

      const availableSurveys = surveys.filter(s => !completedSurveys.includes(s.id));

      if (availableSurveys.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--ink-1);">No hay encuestas disponibles por ahora. ¡Vuelve pronto!</div>';
        return;
      }

      list.innerHTML = availableSurveys.map(survey => `
        <div style="padding:16px;background:var(--bg-1);border-radius:10px;border:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div style="flex:1;">
            <div style="font-weight:600;margin-bottom:4px;">${survey.title}</div>
            <div style="font-size:12px;color:var(--ink-1);">${survey.questions.length} preguntas • +${survey.reward} ??</div>
          </div>
          <button class="btn primary" onclick="completeSurvey(${survey.id}, ${survey.reward})" style="min-width:120px;">Responder</button>
        </div>
      `).join('');

      // Actualizar estadísticas
      const completedEl = document.getElementById('surveys-completed');
      const earnedEl = document.getElementById('surveys-earned');
      if (completedEl) completedEl.textContent = completedSurveys.length;
      if (earnedEl) earnedEl.textContent = (state.surveyData?.totalEarned || 0).toLocaleString();
    }

    window.completeSurvey = async function (surveyId, reward) {
      // Simular completar encuesta
      const confirmed = confirm(`¿Completar esta encuesta por ${reward} Ecoxionums ?\n\n(En una versión real, aquí aparecerían las preguntas)`);

      if (!confirmed) return;

      const state = await loadState();

      if (!state.surveyData) state.surveyData = { completed: [], totalEarned: 0 };
      state.surveyData.completed.push(surveyId);
      state.surveyData.totalEarned = (state.surveyData.totalEarned || 0) + reward;
      state.ecoxionums = (state.ecoxionums || 0) + reward;

      await saveState(state);
      await updateBalance();

      showAlert('success', '¡Encuesta completada!', `Has ganado ${reward} Ecoxionums. ¡Gracias por tu opinión! ??`);
      loadSurveys();
    };

    /* =========================
       VER ANUNCIOS
       ========================= */
    function updateWatchAdsPanel() {
      const state = JSON.parse(localStorage.getItem('ecoxion.state.v1') || '{}');
      const adsData = state.adsData || {};
      const today = new Date().toDateString();

      // Resetear si es un nuevo día
      if (adsData.lastDate !== today) {
        adsData.watchedToday = 0;
        adsData.earnedToday = 0;
        adsData.lastDate = today;
      }

      const watchedToday = adsData.watchedToday || 0;
      const earnedToday = adsData.earnedToday || 0;
      const totalEarned = adsData.totalEarned || 0;

      const watchedEl = document.getElementById('ads-watched-today');
      const earnedTodayEl = document.getElementById('ads-earned-today');
      const totalEarnedEl = document.getElementById('ads-total-earned');

      if (watchedEl) watchedEl.textContent = `${watchedToday} / 10`;
      if (earnedTodayEl) earnedTodayEl.textContent = `${earnedToday.toLocaleString()} 🪙`;
      if (totalEarnedEl) totalEarnedEl.textContent = `${totalEarned.toLocaleString()} 🪙`;

      const btn = document.getElementById('watch-ad-btn');
      if (btn) {
        btn.disabled = watchedToday >= 10;
        if (watchedToday >= 10) {
          btn.textContent = '✅ Límite diario alcanzado';
          btn.style.opacity = '0.5';
        }
      }
    }

    window.watchAd = async function () {
      const state = await loadState();
      const today = new Date().toDateString();

      if (!state.adsData) state.adsData = {};
      if (state.adsData.lastDate !== today) {
        state.adsData.watchedToday = 0;
        state.adsData.earnedToday = 0;
        state.adsData.lastDate = today;
      }

      if (state.adsData.watchedToday >= 10) {
        showAlert('warning', 'Límite alcanzado', 'Has alcanzado el límite diario de 10 anuncios.');
        return;
      }

      // Simular anuncio de 30 segundos
      const btn = document.getElementById('watch-ad-btn');
      const statusEl = document.getElementById('ad-status');
      const timerEl = document.getElementById('ad-timer');
      const containerEl = document.getElementById('ad-container');

      if (btn) btn.disabled = true;
      if (statusEl) statusEl.style.display = 'none';
      if (timerEl) timerEl.style.display = 'block';
      if (containerEl) containerEl.style.background = 'linear-gradient(135deg, rgba(249,115,22,.2), rgba(251,146,60,.2))';

      let timeLeft = 30;
      const interval = setInterval(() => {
        timeLeft--;
        if (timerEl) timerEl.textContent = timeLeft;

        if (timeLeft <= 0) {
          clearInterval(interval);

          // Dar recompensa
          const reward = Math.floor(Math.random() * 11) + 10; // 10-20
          state.ecoxionums = (state.ecoxionums || 0) + reward;
          state.adsData.watchedToday = (state.adsData.watchedToday || 0) + 1;
          state.adsData.earnedToday = (state.adsData.earnedToday || 0) + reward;
          state.adsData.totalEarned = (state.adsData.totalEarned || 0) + reward;

          saveState(state).then(() => {
            updateBalance();
            updateWatchAdsPanel();

            if (statusEl) {
              statusEl.textContent = '¡Anuncio completado!';
              statusEl.style.display = 'block';
            }
            if (timerEl) timerEl.style.display = 'none';
            if (containerEl) containerEl.style.background = 'rgba(0,0,0,.3)';
            if (btn) {
              btn.disabled = false;
              if (state.adsData.watchedToday >= 10) {
                btn.textContent = '✅ Límite diario alcanzado';
                btn.disabled = true;
                btn.style.opacity = '0.5';
              }
            }

            showAlert('success', '?Anuncio completado!', `Has ganado ${reward} Ecoxionums. ??`);

            setTimeout(() => {
              if (statusEl) statusEl.textContent = 'Haz clic en "Ver Anuncio" para comenzar';
            }, 3000);
          });
        }
      }, 1000);
    };


    /* =========================
       ECO STOCK MARKET LOGIC
       ========================= */
    async function initEcoStock() {
      // Simular datos de mercado
      const companies = [
        { id: 'OCN', name: 'Ocean Tech', price: 150, change: 2.5 },
        { id: 'WLD', name: 'Wild Energy', price: 80, change: -1.2 },
        { id: 'ECO', name: 'Eco Systems', price: 220, change: 5.0 },
        { id: 'SOL', name: 'Solar Future', price: 45, change: 0.5 }
      ];

      const list = document.getElementById('stock-list');
      if (!list) return;

      // Load user portfolio
      const state = await loadState();
      const portfolio = state.stockPortfolio || {}; // { 'OCN': amount }

      let html = '';
      companies.forEach(c => {
        // Fluctuación aleatoria simple para demo visual
        const flux = (Math.random() - 0.5) * 5;
        const currentPrice = Math.round(c.price + flux);
        const isPositive = flux >= 0;
        const userShares = portfolio[c.id] || 0;

        html += `
           <div style="background:var(--bg-1);padding:14px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.05);">
             <div>
               <div style="font-weight:700;font-size:16px;">${c.name} <span style="color:var(--ink-1);font-size:12px;">$${c.id}</span></div>
               <div style="font-size:13px;color:${isPositive ? 'var(--ok)' : 'var(--danger)'};">
                 ${currentPrice} <span class="icon-ecoxionum"></span> (${isPositive ? '+' : ''}${flux.toFixed(1)}%)
               </div>
             </div>
             <div style="text-align:right;">
               <div style="font-size:12px;color:var(--ink-1);margin-bottom:4px;">Posees: ${userShares}</div>
               <div style="display:flex;gap:6px;">
                 <button class="btn" style="padding:4px 8px;font-size:12px;background:var(--danger);border:none;" onclick="tradeStock('${c.id}', -1, ${currentPrice})">Vender</button>
                 <button class="btn" style="padding:4px 8px;font-size:12px;background:var(--ok);border:none;" onclick="tradeStock('${c.id}', 1, ${currentPrice})">Comprar</button>
               </div>
             </div>
           </div>
         `;
      });

      list.innerHTML = html;
      updatePortfolioUI(portfolio, companies);
    }

    function updatePortfolioUI(portfolio, companies) {
      const div = document.getElementById('my-stock-portfolio');
      if (!div) return;

      const holdings = Object.entries(portfolio).filter(([k, v]) => v > 0);

      if (holdings.length === 0) {
        div.innerHTML = '<p style="color:var(--ink-1);font-size:13px;">No tienes inversiones activas.</p>';
        return;
      }

      div.innerHTML = holdings.map(([id, amount]) => {
        const comp = companies.find(c => c.id === id) || { name: id };
        return `<div style="font-size:14px;margin-bottom:4px;">• <strong>${comp.name}</strong>: ${amount} acciones</div>`;
      }).join('');
    }

    window.tradeStock = async function (symbol, amount, price) {
      const state = await loadState();
      if (!state.stockPortfolio) state.stockPortfolio = {};

      if (amount > 0) {
        // BUY
        const cost = price * amount;
        if (state.ecoxionums < cost) {
          showAlert('error', 'Saldo insuficiente');
          return;
        }
        state.ecoxionums -= cost;
        state.stockPortfolio[symbol] = (state.stockPortfolio[symbol] || 0) + amount;
        showAlert('success', 'Compra exitosa', `Has comprado 1 acción de ${symbol} por ${cost} ??`);
      } else {
        // SELL
        const sellAmount = Math.abs(amount);
        if (!state.stockPortfolio[symbol] || state.stockPortfolio[symbol] < sellAmount) {
          showAlert('error', 'No tienes acciones', 'No puedes vender acciones que no tienes.');
          return;
        }
        state.stockPortfolio[symbol] -= sellAmount;
        const gain = price * sellAmount;
        state.ecoxionums += gain;
        showAlert('success', 'Venta exitosa', `Has vendido 1 acción de ${symbol} por ${gain} ??`);
      }

      await saveState(state);
      updateBalance();
      initEcoStock(); // Refresh UI
    };

    /* =========================
       TRIVIA CHALLENGE - FUNCIONES
       ========================= */
    const triviaQuestions = [
      { category: "Ciencia", question: "¿Cuál es el planeta más grande del sistema solar?", answers: ["Júpiter", "Saturno", "Neptuno", "Urano"], correct: 0 },
      { category: "Historia", question: "¿En qué año cayó el Muro de Berlín?", answers: ["1989", "1991", "1985", "1990"], correct: 0 },
      { category: "Geografía", question: "¿Cuál es la capital de Australia?", answers: ["Sídney", "Melbourne", "Canberra", "Perth"], correct: 2 },
      { category: "Tecnología", question: "¿Quién fundó Microsoft?", answers: ["Steve Jobs", "Bill Gates", "Elon Musk", "Mark Zuckerberg"], correct: 1 },
      { category: "Naturaleza", question: "¿Cuál es el animal más rápido del mundo?", answers: ["León", "Guepardo", "Halcón peregrino", "Águila"], correct: 2 },
      { category: "Arte", question: "¿Quién pintó La Mona Lisa?", answers: ["Miguel Ángel", "Rafael", "Leonardo da Vinci", "Botticelli"], correct: 2 },
      { category: "Deportes", question: "¿En qué país se celebraron los Juegos Olímpicos de 2016?", answers: ["China", "Brasil", "Reino Unido", "Japón"], correct: 1 },
      { category: "Música", question: "¿Cuántas cuerdas tiene un ukelele estándar?", answers: ["4", "6", "5", "8"], correct: 0 }
    ];
    let triviaState = { current: null, timer: null, stats: { correct: 0, earned: 0 } };

    function initTrivia() {
      const saved = localStorage.getItem('ecoxion.trivia');
      if (saved) triviaState.stats = JSON.parse(saved);
      updateTriviaStats();
    }

    window.startTrivia = async function () {
      const q = triviaQuestions[Math.floor(Math.random() * triviaQuestions.length)];
      triviaState.current = q;

      document.getElementById('trivia-question-box').style.display = 'block';
      document.getElementById('trivia-result').style.display = 'none';
      document.getElementById('trivia-start-btn').style.display = 'none';
      document.getElementById('trivia-category').textContent = q.category;
      document.getElementById('trivia-question').textContent = q.question;

      const answersEl = document.getElementById('trivia-answers');
      answersEl.innerHTML = q.answers.map((a, i) => `
        <button onclick="answerTrivia(${i})" style="padding:12px;background:var(--bg-2);border:1px solid rgba(255,255,255,.12);border-radius:8px;color:var(--ink-0);cursor:pointer;text-align:left;transition:all .2s;">${a}</button>
      `).join('');

      let time = 15;
      document.getElementById('trivia-timer').textContent = time + 's';
      triviaState.timer = setInterval(() => {
        time--;
        document.getElementById('trivia-timer').textContent = time + 's';
        if (time <= 0) {
          clearInterval(triviaState.timer);
          showTriviaResult(false, 0);
        }
      }, 1000);
    };

    window.answerTrivia = async function (index) {
      clearInterval(triviaState.timer);
      const correct = index === triviaState.current.correct;
      const reward = correct ? Math.floor(Math.random() * 21) + 5 : 0;

      if (correct) {
        triviaState.stats.correct++;
        triviaState.stats.earned += reward;
        localStorage.setItem('ecoxion.trivia', JSON.stringify(triviaState.stats));
        await awardEcoxionums(reward, 'Trivia Ecoxion');
      }

      showTriviaResult(correct, reward);
    };

    function showTriviaResult(correct, reward) {
      document.getElementById('trivia-question-box').style.display = 'none';
      document.getElementById('trivia-result').style.display = 'block';
      document.getElementById('trivia-start-btn').style.display = 'block';
      document.getElementById('trivia-result').innerHTML = `
        <div style="font-size:48px;margin-bottom:12px;">${correct ? '🎉' : '😔'}</div>
        <div style="font-size:18px;font-weight:600;color:${correct ? 'var(--ok)' : 'var(--danger)'};">${correct ? '¡Correcto!' : '¡Incorrecto!'}</div>
        ${correct ? `<div style="margin-top:8px;color:var(--ok);">+${reward} Ecoxionums</div>` : ''}
        <div style="margin-top:8px;color:var(--ink-1);font-size:13px;">Respuesta: ${triviaState.current.answers[triviaState.current.correct]}</div>
      `;
      updateTriviaStats();
    }

    function updateTriviaStats() {
      const correctEl = document.getElementById('trivia-correct');
      const earnedEl = document.getElementById('trivia-earned');
      if (correctEl) correctEl.textContent = triviaState.stats.correct;
      if (earnedEl) earnedEl.textContent = triviaState.stats.earned;
    }

    /* =========================
       MUSIC PLAYER - FUNCIONES
       ========================= */
    let musicState = { playing: false, currentStation: 0, audio: null };
    const musicStations = [
      { name: 'Lo-Fi Beats', url: 'https://streams.fluxfm.de/Chillhop/mp3-128/streams.fluxfm.de/' },
      { name: 'Classical', url: 'https://live.musopen.org:8085/streamvbr0' },
      { name: 'Pop Hits', url: 'https://stream.0nlineradio.com/pop128' }
    ];

    function initMusicPlayer() {
      if (!musicState.audio) musicState.audio = new Audio();
      animateMusicBars();
    }

    function animateMusicBars() {
      if (!musicState.playing) return;
      const bars = document.querySelectorAll('.music-bar');
      bars.forEach(bar => {
        bar.style.height = (10 + Math.random() * 50) + 'px';
      });
      requestAnimationFrame(() => setTimeout(animateMusicBars, 100));
    }

    window.selectStation = function (index) {
      musicState.currentStation = index;
      const station = musicStations[index];
      document.getElementById('music-now-playing').textContent = station.name;
      document.getElementById('music-station-name').textContent = 'Radio Online';
      if (musicState.playing) {
        musicState.audio.src = station.url;
        musicState.audio.play().catch(() => { });
      }
    };

    window.musicToggle = function () {
      musicState.playing = !musicState.playing;
      const btn = document.getElementById('music-play-btn');
      if (musicState.playing) {
        btn.textContent = '⏸️';
        musicState.audio.src = musicStations[musicState.currentStation].url;
        musicState.audio.play().catch(() => { });
        animateMusicBars();
      } else {
        btn.textContent = '▶️';
        musicState.audio.pause();
      }
    };

    window.musicPrev = function () { selectStation((musicState.currentStation - 1 + musicStations.length) % musicStations.length); };
    window.musicNext = function () { selectStation((musicState.currentStation + 1) % musicStations.length); };
    window.setMusicVolume = function (val) { if (musicState.audio) musicState.audio.volume = val / 100; };

    /* =========================
       HABIT TRACKER - FUNCIONES
       ========================= */
    function loadHabits() {
      const habits = JSON.parse(localStorage.getItem('ecoxion.habits') || '[]');
      renderHabits(habits);
    }

    function renderHabits(habits) {
      const list = document.getElementById('habits-list');
      const empty = document.getElementById('habits-empty');
      if (!list) return;

      if (habits.length === 0) {
        list.innerHTML = '';
        if (empty) empty.style.display = 'block';
        return;
      }
      if (empty) empty.style.display = 'none';

      const today = new Date().toDateString();
      list.innerHTML = habits.map((h, i) => {
        const completedToday = h.completedDates?.includes(today);
        return `
          <div style="padding:16px;background:var(--bg-1);border-radius:12px;border:1px solid ${completedToday ? 'var(--ok)' : 'rgba(255,255,255,.08)'};">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:24px;">${h.icon}</span>
                <span style="font-weight:600;">${h.name}</span>
              </div>
              <div style="display:flex;gap:8px;">
                <button onclick="completeHabit(${i})" class="btn ${completedToday ? '' : 'primary'}" style="padding:8px 12px;" ${completedToday ? 'disabled' : ''}>${completedToday ? '✅' : '✓'}</button>
                <button onclick="deleteHabit(${i})" class="btn" style="padding:8px 12px;">🗑️</button>
              </div>
            </div>
            <div style="margin-top:8px;font-size:12px;color:var(--ink-1);">Racha: ${h.streak || 0} días</div>
          </div>
        `;
      }).join('');
    }

    window.addHabit = function () {
      const name = document.getElementById('habit-name')?.value;
      const icon = document.getElementById('habit-icon')?.value || '💪';
      if (!name) return showAlert('warning', 'Nombre requerido', 'Ingresa un nombre para el hábito');

      const habits = JSON.parse(localStorage.getItem('ecoxion.habits') || '[]');
      habits.push({ name, icon, streak: 0, completedDates: [] });
      localStorage.setItem('ecoxion.habits', JSON.stringify(habits));
      document.getElementById('habit-name').value = '';
      loadHabits();
      showAlert('success', '¡Hábito creado!', `${icon} ${name} agregado`);
    };

    window.completeHabit = async function (index) {
      const habits = JSON.parse(localStorage.getItem('ecoxion.habits') || '[]');
      const today = new Date().toDateString();
      if (!habits[index].completedDates) habits[index].completedDates = [];
      habits[index].completedDates.push(today);
      habits[index].streak = (habits[index].streak || 0) + 1;

      const reward = habits[index].streak >= 7 ? 15 : habits[index].streak >= 3 ? 10 : 5;
      localStorage.setItem('ecoxion.habits', JSON.stringify(habits));

      await awardEcoxionums(reward, `Hábito: ${habits[index].name}`);
      loadHabits();
      showAlert('success', '¡Hábito completado!', `+${reward} Ecoxionums por tu racha de ${habits[index].streak} días`);
    };

    window.deleteHabit = function (index) {
      const habits = JSON.parse(localStorage.getItem('ecoxion.habits') || '[]');
      habits.splice(index, 1);
      localStorage.setItem('ecoxion.habits', JSON.stringify(habits));
      loadHabits();
    };

    /* =========================
       WEATHER WIDGET - FUNCIONES
       ========================= */
    function initWeather() {
      const saved = localStorage.getItem('ecoxion.weather.city');
      if (saved) {
        document.getElementById('weather-city').value = saved;
        searchWeather();
      }
    }

    window.searchWeather = async function () {
      const city = document.getElementById('weather-city')?.value;
      if (!city) return showAlert('warning', 'Ciudad requerida', 'Ingresa el nombre de una ciudad');

      try {
        const res = await fetch(`https://wttr.in/${encodeURIComponent(city)}?format=j1`);
        const data = await res.json();
        const current = data.current_condition[0];
        const location = data.nearest_area[0];

        const weatherIcons = { 'Sunny': '☀️', 'Clear': '🌙', 'Partly cloudy': '⛅', 'Cloudy': '☁️', 'Overcast': '☁️', 'Rain': '🌧️', 'Heavy rain': '⛈️', 'Snow': '❄️', 'Mist': '🌫️', 'Fog': '🌫️' };
        const desc = current.weatherDesc[0].value;
        const icon = weatherIcons[desc] || '🌤️';

        document.getElementById('weather-icon').textContent = icon;
        document.getElementById('weather-temp').textContent = current.temp_C + '°C';
        document.getElementById('weather-desc').textContent = desc;
        document.getElementById('weather-location').textContent = location.areaName[0].value + ', ' + location.country[0].value;
        document.getElementById('weather-humidity').textContent = current.humidity + '%';
        document.getElementById('weather-wind').textContent = current.windspeedKmph + ' km/h';
        document.getElementById('weather-feels').textContent = current.FeelsLikeC + '°C';

        localStorage.setItem('ecoxion.weather.city', city);
      } catch (e) {
        showAlert('error', 'Error', 'No se pudo obtener el clima. Verifica el nombre de la ciudad.');
      }
    };

    /* =========================
       ECO MINER - FUNCIONES
       ========================= */
    let minerState = { active: false, interval: null, session: 0, total: 0 };

    function initMiner() {
      const saved = localStorage.getItem('ecoxion.miner');
      if (saved) minerState = { ...minerState, ...JSON.parse(saved) };
      updateMinerUI();
    }

    function updateMinerUI() {
      const totalEl = document.getElementById('miner-total');
      const sessionEl = document.getElementById('miner-session');
      const statusEl = document.getElementById('miner-status');
      const btnEl = document.getElementById('miner-toggle-btn');

      if (totalEl) totalEl.textContent = minerState.total;
      if (sessionEl) sessionEl.textContent = minerState.session;
      if (statusEl) statusEl.textContent = minerState.active ? 'Minando...' : 'Minero Inactivo';
      if (btnEl) btnEl.textContent = minerState.active ? '⏹️ Detener Minería' : '⛏️ Iniciar Minería';
    }

    window.toggleMiner = async function () {
      minerState.active = !minerState.active;

      if (minerState.active) {
        minerState.session = 0;
        minerState.interval = setInterval(async () => {
          const reward = Math.random() < 0.5 ? 1 : Math.floor(Math.random() * 2) + 1;
          minerState.session += reward;
          minerState.total += reward;

          const state = await loadState();
          state.ecoxionums = (state.ecoxionums || 0) + reward;
          await saveState(state);
          updateBalance();

          localStorage.setItem('ecoxion.miner', JSON.stringify({ total: minerState.total }));
          updateMinerUI();
        }, 30000);
        showAlert('info', 'Minero iniciado', 'Empezarás a ganar Ecoxionums pasivamente');
      } else {
        clearInterval(minerState.interval);
        showAlert('info', 'Minero detenido', `Ganaste ${minerState.session} Ecoxionums esta sesión`);
      }
      updateMinerUI();
    };

    /* =========================
       MINI GAMES - FUNCIONES
       ========================= */
    window.startMiniGame = function (game) {
      const container = document.getElementById('minigame-container');
      if (!container) return;
      container.style.display = 'block';

      if (game === 'snake') initSnakeGame(container);
      else if (game === 'memory') initMemoryGame(container);
    };

    function initSnakeGame(container) {
      container.innerHTML = `
        <div style="text-align:center;padding:20px;background:var(--bg-1);border-radius:12px;">
          <h4 style="margin:0 0 16px;color:var(--accent);">🐍 Snake</h4>
          <canvas id="snake-canvas" width="300" height="300" style="background:#1a1a2e;border-radius:8px;"></canvas>
          <div style="margin-top:12px;">
            <span style="color:var(--ink-1);">Puntuación: </span>
            <span id="snake-score" style="font-weight:700;color:var(--ok);">0</span>
          </div>
          <p style="font-size:12px;color:var(--ink-1);margin-top:8px;">Usa las flechas del teclado</p>
          <button class="btn" onclick="closeMinigame()" style="margin-top:12px;">Cerrar</button>
        </div>
      `;

      const canvas = document.getElementById('snake-canvas');
      const ctx = canvas.getContext('2d');
      const box = 15;
      let snake = [{ x: 9 * box, y: 9 * box }];
      let food = { x: Math.floor(Math.random() * 20) * box, y: Math.floor(Math.random() * 20) * box };
      let d = 'RIGHT';
      let score = 0;

      document.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft' && d !== 'RIGHT') d = 'LEFT';
        else if (e.key === 'ArrowUp' && d !== 'DOWN') d = 'UP';
        else if (e.key === 'ArrowRight' && d !== 'LEFT') d = 'RIGHT';
        else if (e.key === 'ArrowDown' && d !== 'UP') d = 'DOWN';
      });

      const gameLoop = setInterval(() => {
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (let i = 0; i < snake.length; i++) {
          ctx.fillStyle = i === 0 ? '#10b981' : '#34d399';
          ctx.fillRect(snake[i].x, snake[i].y, box, box);
        }

        ctx.fillStyle = '#ef4444';
        ctx.fillRect(food.x, food.y, box, box);

        let snakeX = snake[0].x;
        let snakeY = snake[0].y;

        if (d === 'LEFT') snakeX -= box;
        if (d === 'UP') snakeY -= box;
        if (d === 'RIGHT') snakeX += box;
        if (d === 'DOWN') snakeY += box;

        if (snakeX === food.x && snakeY === food.y) {
          score++;
          document.getElementById('snake-score').textContent = score;
          food = { x: Math.floor(Math.random() * 20) * box, y: Math.floor(Math.random() * 20) * box };
        } else {
          snake.pop();
        }

        const newHead = { x: snakeX, y: snakeY };

        if (snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || snake.some(s => s.x === newHead.x && s.y === newHead.y)) {
          clearInterval(gameLoop);
          endMiniGame('snake', score);
          return;
        }

        snake.unshift(newHead);
      }, 150);

      container.dataset.gameLoop = gameLoop;
    }

    function initMemoryGame(container) {
      const emojis = ['??', '??', '🎯', '🎪', '🎨', '🎭', '🎪', '??', '??', '🎯', '🎨', '🎭'];
      const shuffled = emojis.sort(() => Math.random() - 0.5);
      let flipped = [];
      let matched = 0;
      let moves = 0;

      container.innerHTML = `
        <div style="text-align:center;padding:20px;background:var(--bg-1);border-radius:12px;">
          <h4 style="margin:0 0 16px;color:var(--accent);">🧠 Memory</h4>
          <div id="memory-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-width:280px;margin:0 auto;"></div>
          <div style="margin-top:12px;"><span style="color:var(--ink-1);">Movimientos: </span><span id="memory-moves" style="font-weight:700;">0</span></div>
          <button class="btn" onclick="closeMinigame()" style="margin-top:12px;">Cerrar</button>
        </div>
      `;

      const grid = document.getElementById('memory-grid');
      shuffled.forEach((emoji, i) => {
        const card = document.createElement('div');
        card.style = 'width:60px;height:60px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;';
        card.dataset.index = i;
        card.dataset.emoji = emoji;
        card.textContent = '?';
        card.onclick = () => flipCard(card);
        grid.appendChild(card);
      });

      function flipCard(card) {
        if (flipped.length >= 2 || card.dataset.flipped) return;

        card.textContent = card.dataset.emoji;
        card.dataset.flipped = 'true';
        card.style.background = 'var(--bg-2)';
        flipped.push(card);

        if (flipped.length === 2) {
          moves++;
          document.getElementById('memory-moves').textContent = moves;

          if (flipped[0].dataset.emoji === flipped[1].dataset.emoji) {
            matched += 2;
            flipped = [];
            if (matched === shuffled.length) {
              setTimeout(() => endMiniGame('memory', Math.max(30 - moves, 10)), 500);
            }
          } else {
            setTimeout(() => {
              flipped.forEach(c => { c.textContent = '?'; c.style.background = 'var(--accent)'; delete c.dataset.flipped; });
              flipped = [];
            }, 1000);
          }
        }
      }
    }

    async function endMiniGame(game, score) {
      const reward = Math.max(5, Math.min(30, score));
      await awardEcoxionums(reward, `Mini-juego: ${game}`);
      showAlert('success', '¡Juego terminado!', `Ganaste ${reward} Ecoxionums`);
      closeMinigame();
    }

    window.closeMinigame = function () {
      const container = document.getElementById('minigame-container');
      if (container) {
        if (container.dataset.gameLoop) clearInterval(parseInt(container.dataset.gameLoop));
        container.style.display = 'none';
        container.innerHTML = '';
      }
    };

    /* =========================
       QUICK CHAT - FUNCIONES
       ========================= */
    let chatMessages = [];
    let chatInterval = null;

    async function initQuickChat() {
      // Limpiar rastro de chat offline
      localStorage.removeItem('ecoxion.chat');

      // Primera carga
      await fetchChatMessages();

      // Iniciar polling (cada 3 segundos)
      if (chatInterval) clearInterval(chatInterval);
      chatInterval = setInterval(fetchChatMessages, 3000);
    }

    async function fetchChatMessages() {
      const container = document.getElementById('chat-messages');
      if (!container) {
        if (chatInterval) {
          clearInterval(chatInterval);
          chatInterval = null;
        }
        return;
      }

      try {
        const res = await fetch(`${API_GLOBAL}/ecoxion/messages`);
        const messages = await res.json();

        // Solo renderizar si hay cambios o es la primera vez
        if (JSON.stringify(messages) !== JSON.stringify(chatMessages)) {
          chatMessages = messages;
          renderChatMessages();
        }
      } catch (e) {
        console.error('Error fetching chat:', e);
        const status = document.getElementById('chat-status');
        if (status) {
          status.innerHTML = '<span style="width:8px; height:8px; background:var(--warn); border-radius:50%;"></span> Reconectando...';
          status.style.color = 'var(--warn)';
        }
      }
    }

    async function renderChatMessages() {
      const container = document.getElementById('chat-messages');
      if (!container) return;

      const state = await loadState();
      const currentUsername = state.username || 'Explorador';

      if (chatMessages.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--ink-2); font-size:13px;">No hay mensajes. ¡Sé el primero en saludar!</div>';
        return;
      }

      container.innerHTML = chatMessages.map(m => {
        const isSelf = m.sender_username === currentUsername;
        const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        return `
          <div style="display:flex; flex-direction:column; ${isSelf ? 'align-items:flex-end' : 'align-items:flex-start'}; gap:4px;">
            ${!isSelf ? `<div style="font-size:11px; font-weight:700; color:var(--accent); margin-left:4px;">${m.sender_username}</div>` : ''}
            <div style="
              padding:10px 14px; 
              background:${isSelf ? 'linear-gradient(135deg, var(--accent), var(--accent-2))' : 'rgba(255,255,255,0.08)'}; 
              color:${isSelf ? '#0a0e1a' : 'var(--ink-0)'}; 
              border-radius:${isSelf ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; 
              max-width:85%; 
              font-size:14px; 
              line-height:1.4;
              box-shadow:0 2px 8px rgba(0,0,0,0.1);
              position:relative;
            ">
              ${m.message}
              <div style="font-size:9px; opacity:0.6; text-align:right; margin-top:4px;">${time}</div>
            </div>
          </div>
        `;
      }).join('');

      // Auto-scroll al final
      container.scrollTop = container.scrollHeight;
    }

    window.sendChatMessage = async function () {
      const input = document.getElementById('chat-input');
      const message = input?.value?.trim();
      if (!message) return;

      const state = await loadState();
      const username = state.username || 'Explorador';

      // Feedback visual inmediato (opcional, pero mejor esperar al POST)
      input.value = '';
      input.disabled = true;

      try {
        const res = await fetch(`${API_GLOBAL}/ecoxion/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, message })
        });

        if (res.ok) {
          await fetchChatMessages();
        } else {
          showAlert('error', 'Error', 'No se pudo enviar el mensaje.');
        }
      } catch (e) {
        showAlert('error', 'Error', 'Problema de conexión con el servidor.');
      } finally {
        input.disabled = false;
        input.focus();
      }
    };

    /* =========================
       ARCADE STATION - LOGIC
       ========================= */
    const arcadeState = {
      activeGame: null,
      loop: null,
      score: 0,
      highScores: JSON.parse(localStorage.getItem('ecoxion.arcade.scores') || '{}')
    };

    window.startArcadeGame = function (gameId) {
      const container = document.getElementById('arcade-game-container');
      const viewport = document.getElementById('arcade-viewport');
      if (!container || !viewport) return;

      container.style.display = 'flex';
      viewport.innerHTML = '';
      arcadeState.activeGame = gameId;
      arcadeState.score = 0;

      if (gameId === 'neon-jump') initNeonJump(viewport);
      else if (gameId === 'snake') initArcadeSnake(viewport);
      else if (gameId === 'memory') initArcadeMemory(viewport);
    };

    window.closeArcadeGame = function () {
      const container = document.getElementById('arcade-game-container');
      if (container) container.style.display = 'none';
      if (arcadeState.loop) cancelAnimationFrame(arcadeState.loop);
      if (arcadeState.interval) clearInterval(arcadeState.interval);
      arcadeState.activeGame = null;
    };

    function updateArcadeHighScores() {
      const scores = arcadeState.highScores;
      const ids = { 'neon-jump': 'score-neon-jump', 'snake': 'score-snake', 'memory': 'score-memory' };

      for (const [game, elId] of Object.entries(ids)) {
        const el = document.getElementById(elId);
        if (el) el.textContent = scores[game] || (game === 'memory' ? '--' : 0);
      }
    }

    function saveArcadeScore(game, score, isTime = false) {
      const current = arcadeState.highScores[game] || (isTime ? 999999 : 0);
      const isNewRecord = isTime ? (score < current) : (score > current);

      if (isNewRecord) {
        arcadeState.highScores[game] = score;
        localStorage.setItem('ecoxion.arcade.scores', JSON.stringify(arcadeState.highScores));
        updateArcadeHighScores();
        showAlert('success', '🏆 NEW HIGH SCORE!', `Nuevo récord en ${game}: ${score}`);
        // Small XP reward for breaking record
        awardEcoxionums(10, `Récord Arcade: ${game}`);
      }
    }

    /* --- GAME: NEON JUMP --- */
    function initNeonJump(viewport) {
      const canvas = document.createElement('canvas');
      canvas.width = 600;
      canvas.height = 300;
      canvas.style.background = '#000';
      canvas.style.border = '2px solid #f0f';
      canvas.style.borderRadius = '8px';
      viewport.appendChild(canvas);

      const ctx = canvas.getContext('2d');
      let player = { x: 50, y: 200, w: 30, h: 30, dy: 0, jumpPower: -12, grounded: true };
      let obstacles = [];
      let frame = 0;
      let speed = 5;
      let gravity = 0.6;
      let score = 0;

      function update() {
        if (!arcadeState.activeGame) return;

        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Player physics
        if (!player.grounded) {
          player.dy += gravity;
          player.y += player.dy;
        }

        if (player.y > 250) {
          player.y = 250;
          player.dy = 0;
          player.grounded = true;
        }

        // Draw Player (Neon Dino)
        ctx.fillStyle = '#0ff';
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#0ff';
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.shadowBlur = 0;

        // Obstacles
        if (frame % 100 === 0) {
          obstacles.push({ x: canvas.width, y: 250, w: 20 + Math.random() * 20, h: 30 + Math.random() * 20, type: 'block' });
          speed += 0.1;
        }

        obstacles.forEach((obs, i) => {
          obs.x -= speed;
          ctx.fillStyle = '#f0f';
          ctx.shadowBlur = 10;
          ctx.shadowColor = '#f0f';
          ctx.fillRect(obs.x, obs.y - obs.h + 30, obs.w, obs.h);
          ctx.shadowBlur = 0;

          // Collision
          if (
            player.x < obs.x + obs.w &&
            player.x + player.w > obs.x &&
            player.y < obs.y - obs.h + 30 + obs.h &&
            player.y + player.h > obs.y - obs.h + 30
          ) {
            startArcadeGameOver();
          }

          if (obs.x + obs.w < 0) {
            obstacles.splice(i, 1);
            score++;
          }
        });

        // Floor
        ctx.strokeStyle = '#f0f';
        ctx.beginPath();
        ctx.moveTo(0, 280);
        ctx.lineTo(canvas.width, 280);
        ctx.stroke();

        // Score
        ctx.fillStyle = '#fff';
        ctx.font = '20px monospace';
        ctx.fillText(`SCORE: ${score}`, 10, 30);

        frame++;
        arcadeState.score = score;
        arcadeState.loop = requestAnimationFrame(update);
      }

      function jump(e) {
        if ((e.code === 'Space' || e.code === 'ArrowUp') && player.grounded) {
          player.dy = player.jumpPower;
          player.grounded = false;
        }
      }

      document.addEventListener('keydown', jump);
      // Cleanup listener on close is handled by global logic resetting context, but ideally should remove.
      // For simplicity/robustness in a snippet, we just start update.
      update();

      function startArcadeGameOver() {
        cancelAnimationFrame(arcadeState.loop);
        saveArcadeScore('neon-jump', score);
        ctx.fillStyle = 'white';
        ctx.font = '40px monospace';
        ctx.fillText('GAME OVER', 200, 150);
        ctx.font = '20px monospace';
        ctx.fillText('Press Space to Restart', 180, 190);
        document.addEventListener('keydown', restartHandler);
      }

      function restartHandler(e) {
        if (e.code === 'Space') {
          document.removeEventListener('keydown', restartHandler);
          window.startArcadeGame('neon-jump');
        }
      }
    }

    /* --- GAME: SNAKE (Arcade Version) --- */
    function initArcadeSnake(viewport) {
      // Re-use logic but adapted for this viewport
      viewport.innerHTML = '<canvas id="arcade-snake-canvas" width="400" height="400" style="background:#000;border:2px solid #0f0;"></canvas>';
      const canvas = document.getElementById('arcade-snake-canvas');
      const ctx = canvas.getContext('2d');
      const box = 20;
      let snake = [{ x: 9 * box, y: 10 * box }];
      let food = { x: Math.floor(Math.random() * 19) * box, y: Math.floor(Math.random() * 19) * box };
      let score = 0;
      let d;

      document.addEventListener('keydown', direction);
      function direction(event) {
        if (event.key == 'ArrowLeft' && d != 'RIGHT') d = 'LEFT';
        else if (event.key == 'ArrowUp' && d != 'DOWN') d = 'UP';
        else if (event.key == 'ArrowRight' && d != 'LEFT') d = 'RIGHT';
        else if (event.key == 'ArrowDown' && d != 'UP') d = 'DOWN';
      }

      arcadeState.interval = setInterval(draw, 100);

      function draw() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, 400, 400);

        for (let i = 0; i < snake.length; i++) {
          ctx.fillStyle = (i == 0) ? '#0f0' : '#050';
          ctx.shadowBlur = 10;
          ctx.shadowColor = '#0f0';
          ctx.fillRect(snake[i].x, snake[i].y, box, box);
          ctx.shadowBlur = 0;
        }

        ctx.fillStyle = '#f00';
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#f00';
        ctx.fillRect(food.x, food.y, box, box);
        ctx.shadowBlur = 0;

        let snakeX = snake[0].x;
        let snakeY = snake[0].y;

        if (d == 'LEFT') snakeX -= box;
        if (d == 'UP') snakeY -= box;
        if (d == 'RIGHT') snakeX += box;
        if (d == 'DOWN') snakeY += box;

        if (snakeX == food.x && snakeY == food.y) {
          score++;
          food = { x: Math.floor(Math.random() * 19) * box, y: Math.floor(Math.random() * 19) * box };
        } else {
          snake.pop();
        }

        let newHead = { x: snakeX, y: snakeY };

        if (snakeX < 0 || snakeX > 380 || snakeY < 0 || snakeY > 380 || collision(newHead, snake)) {
          clearInterval(arcadeState.interval);
          saveArcadeScore('snake', score);
        }

        snake.unshift(newHead);

        ctx.fillStyle = "white";
        ctx.font = "20px monospace";
        ctx.fillText(score, 2 * box, 1.6 * box);
      }

      function collision(head, array) {
        for (let i = 0; i < array.length; i++) {
          if (head.x == array[i].x && head.y == array[i].y) return true;
        }
        return false;
      }
    }

    /* --- GAME: MEMORY (Arcade Version) --- */
    function initArcadeMemory(viewport) {
      viewport.innerHTML = '<div id="arcade-memory-grid" style="display:grid;grid-template-columns:repeat(4,100px);gap:10px;"></div><div style="color:white;margin-top:20px;font-family:monospace;font-size:24px;">Time: <span id="mem-time">0</span>s</div>';
      const emojis = ['🚀', '🪐', '👽', '☄️', '🌌', '🔭', '🛸', '🛰️'];
      const cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
      const grid = document.getElementById('arcade-memory-grid');
      let flipped = [];
      let matched = 0;
      let startTime = Date.now();

      arcadeState.interval = setInterval(() => {
        document.getElementById('mem-time').textContent = Math.floor((Date.now() - startTime) / 1000);
      }, 1000);

      cards.forEach((emoji, i) => {
        const card = document.createElement('div');
        card.style = 'width:100px;height:100px;background:#000044;border:2px solid #44f;display:flex;align-items:center;justify-content:center;font-size:40px;cursor:pointer;user-select:none;';
        card.dataset.val = emoji;
        card.onclick = () => {
          if (flipped.length < 2 && !card.classList.contains('flip')) {
            card.textContent = emoji;
            card.classList.add('flip');
            flipped.push(card);
            if (flipped.length === 2) checkMatch();
          }
        };
        grid.appendChild(card);
      });

      function checkMatch() {
        if (flipped[0].dataset.val === flipped[1].dataset.val) {
          matched++;
          flipped = [];
          if (matched === emojis.length) {
            clearInterval(arcadeState.interval);
            const finalTime = Math.floor((Date.now() - startTime) / 1000);
            saveArcadeScore('memory', finalTime, true); // true = lower is better
          }
        } else {
          setTimeout(() => {
            flipped.forEach(c => { c.textContent = ''; c.classList.remove('flip'); });
            flipped = [];
          }, 800);
        }
      }
    }


    /* =========================
       MINI CALENDAR PRO - LOGIC
       ========================= */
    let calendarState = { year: new Date().getFullYear(), month: new Date().getMonth() };

    function initCalendar() {
      // Migrate old data if necessary (simple check)
      const events = JSON.parse(localStorage.getItem('ecoxion.calendar') || '[]');
      if (events.length > 0 && !events[0].type) {
        events.forEach(e => e.type = 'personal'); // Default type
        localStorage.setItem('ecoxion.calendar', JSON.stringify(events));
      }

      renderCalendar();
      renderCalendarEvents();
    }

    function toggleAddEventForm() {
      const form = document.getElementById('add-event-form');
      if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const title = document.getElementById('calendar-month-title');
      if (!grid) return;

      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const daysInMonth = new Date(calendarState.year, calendarState.month + 1, 0).getDate();
      const firstDay = new Date(calendarState.year, calendarState.month, 1).getDay();
      const today = new Date();

      title.textContent = `${monthNames[calendarState.month]} ${calendarState.year}`;

      const days = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
      grid.innerHTML = days.map(d => `<div style="text-align:center;font-size:11px;color:var(--ink-1);padding:4px;">${d}</div>`).join('');

      for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';

      const events = JSON.parse(localStorage.getItem('ecoxion.calendar') || '[]');

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${calendarState.year}-${String(calendarState.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = events.filter(e => e.date === dateStr);
        const hasEvent = dayEvents.length > 0;
        const isToday = today.getDate() === day && today.getMonth() === calendarState.month && today.getFullYear() === calendarState.year;

        // Dots for events
        let dotsHtml = '';
        if (hasEvent) {
          dotsHtml = `<div style="display:flex;justify-content:center;gap:2px;margin-top:2px;">
             ${dayEvents.slice(0, 3).map(e => {
            let color = e.type === 'work' ? '#f09' : (e.type === 'important' ? '#fc0' : '#0cf');
            return `<div style="width:4px;height:4px;border-radius:50%;background:${color};"></div>`;
          }).join('')}
           </div>`;
        }

        grid.innerHTML += `
          <div style="text-align:center;padding:8px;border-radius:8px;font-size:13px;position:relative;
            ${isToday ? 'background:var(--accent);color:#0a0e1a;font-weight:700;' : 'background:var(--bg-1);'}
            ${hasEvent ? 'border:1px solid rgba(255,255,255,0.1);' : ''}
            cursor:pointer;transition:transform 0.2s;"
            onmouseenter="this.style.transform='scale(1.1)'" onmouseleave="this.style.transform='scale(1)'">
            ${day}
            ${dotsHtml}
          </div>
        `;
      }
    }

    function renderCalendarEvents() {
      const container = document.getElementById('calendar-events');
      if (!container) return;

      const events = JSON.parse(localStorage.getItem('ecoxion.calendar') || '[]');
      // Show events this month or future
      const upcoming = events.filter(e => new Date(e.date) >= new Date().setHours(0, 0, 0, 0)).slice(0, 5);

      if (upcoming.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink-1);font-style:italic;">No hay eventos próximos en la agenda.</div>';
        return;
      }

      container.innerHTML = upcoming.map((e, i) => {
        let typeIcon = e.type === 'work' ? '💼' : (e.type === 'important' ? '⭐' : '👤');
        let typeColor = e.type === 'work' ? 'rgba(255,0,153,0.1)' : (e.type === 'important' ? 'rgba(255,204,0,0.1)' : 'rgba(0,204,255,0.1)');
        let typeBorder = e.type === 'work' ? '#f09' : (e.type === 'important' ? '#fc0' : '#0cf');

        return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:${typeColor};border-left:3px solid ${typeBorder};border-radius:0 8px 8px 0;margin-bottom:4px;">
          <div style="flex:1;">
            <div style="font-weight:600;display:flex;align-items:center;gap:6px;">${typeIcon} ${e.title}</div>
            <div style="font-size:12px;color:var(--ink-0);opacity:0.7;">${new Date(e.date).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'long' })}</div>
          </div>
          <button onclick="deleteCalendarEvent(${i})" class="btn" style="padding:6px;background:transparent;color:var(--ink-1);">✕</button>
        </div>
      `}).join('');
    }

    window.addCalendarEvent = function () {
      const title = document.getElementById('event-title')?.value;
      const date = document.getElementById('event-date')?.value;
      const type = document.getElementById('event-type')?.value || 'personal';

      if (!title || !date) return showAlert('warning', 'Campos requeridos', 'Ingresa título y fecha');

      const events = JSON.parse(localStorage.getItem('ecoxion.calendar') || '[]');
      events.push({ title, date, type });
      events.sort((a, b) => new Date(a.date) - new Date(b.date));
      localStorage.setItem('ecoxion.calendar', JSON.stringify(events));

      document.getElementById('event-title').value = '';
      document.getElementById('add-event-form').style.display = 'none';

      renderCalendar();
      renderCalendarEvents();
      showAlert('success', '¡Evento agregado!', `${title} guardado en agenda.`);
    };

    window.deleteCalendarEvent = function (index) {
      const events = JSON.parse(localStorage.getItem('ecoxion.calendar') || '[]');
      events.splice(index, 1);
      localStorage.setItem('ecoxion.calendar', JSON.stringify(events));
      renderCalendar();
      renderCalendarEvents();
    };

    /* =========================
       ARRANCAR
 
       ========================= */
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
  <style>
    /* New Ecoxionum Icon 2D */
    :root {
      --icon-eco: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="g" x1="0" y1="0" x2="100" y2="100"><stop offset="0" stop-color="%2322d3ee"/><stop offset="1" stop-color="%230ea5e9"/></linearGradient></defs><circle cx="50" cy="50" r="45" fill="url(%23g)"/><circle cx="50" cy="50" r="35" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"/><path d="M50 20 L50 80 M20 50 L80 50" stroke="rgba(255,255,255,0.5)" stroke-width="4" stroke-linecap="round"/><circle cx="50" cy="50" r="15" fill="rgba(255,255,255,0.2)"/></svg>');
    }

    .icon-ecoxionum {
      display: inline-block;
      width: 1.3em;
      height: 1.3em;
      vertical-align: -0.3em;
      background-image: var(--icon-eco);
      background-size: contain;
      background-repeat: no-repeat;
      margin: 0 2px;
      filter: drop-shadow(0 0 4px rgba(34, 211, 238, 0.4));
      animation: coinFloat 3s ease-in-out infinite;
    }

    @keyframes coinFloat {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-2px);
      }
    }
  </style>

  <script>
    // --- ICON REPLACEMENT SYSTEM ---

    // Override updateBalance to use Icon
    const originalUpdateBalance = window.updateBalance;
    window.updateBalance = async function () {
      if (originalUpdateBalance) await originalUpdateBalance();

      const state = await loadState();
      const balanceAmount = state.ecoxionums || 0;

      // Update specific ID targets
      const targets = ['user-balance', 'header-balance', 'sidebar-balance'];
      targets.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = `${balanceAmount.toLocaleString()} <span class="icon-ecoxionum"></span>`;
      });

      // Also replace any lingering emojis in visible text
      replaceIconsGlobal();
    };

    // DOM Walker to replace emojis safely
    function replaceIconsGlobal() {
      const walker = document.createTreeWalker(
        document.body,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );

      let node;
      const nodesToReplace = [];
      while (node = walker.nextNode()) {
        if (node.nodeValue && (node.nodeValue.includes('??') || node.nodeValue.includes('💎'))) {
          nodesToReplace.push(node);
        }
      }

      nodesToReplace.forEach(node => {
        const span = document.createElement('span');
        span.innerHTML = node.nodeValue
          .replace(/🪙/g, '<span class="icon-ecoxionum"></span>')
          .replace(/💎/g, '<span class="icon-ecoxionum"></span>'); // Replace gem too if used as currency

        if (node.parentNode) {
          node.parentNode.replaceChild(span, node);
        }
      });
    }

    // Run on init
    replaceIconsGlobal();

    // Hook into showAlert to replace icons there too
    const originalShowAlert = window.showAlert || function () { };
    window.showAlert = function (type, title, msg) {
      // Modify msg to replace emoji
      if (msg && typeof msg === 'string') {
        msg = msg.replace(/🪙/g, '<span class="icon-ecoxionum"></span>');
      }
      originalShowAlert(type, title, msg);
    };

  </script>
</body>

</html>







