name: Promote OWS Store Android Artifact To Release

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: "GitHub Actions run ID que contiene el artifact Android"
        required: true
        type: string
      artifact_id:
        description: "Artifact ID (opcional si usas artifact_name)"
        required: false
        type: string
      artifact_name:
        description: "Artifact name (recomendado: ows-store-apk-release-signed)"
        required: false
        default: "ows-store-apk-release-signed"
        type: string
      allow_non_production_artifacts:
        description: "Permitir artifact debug/unsigned (no recomendado)"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      release_tag:
        description: "Tag unico del release (ej. ows-store-android-v2026.02.24-001)"
        required: true
        type: string
      release_name:
        description: "Nombre del release"
        required: true
        type: string
      release_notes:
        description: "Notas/changelog"
        required: false
        type: string
      prerelease:
        description: "Publicar como prerelease"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  actions: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        shell: bash
        run: |
          if [ -z "${{ inputs.artifact_id }}" ] && [ -z "${{ inputs.artifact_name }}" ]; then
            echo "Debes indicar artifact_id o artifact_name."
            exit 1
          fi

          name_lc="$(echo '${{ inputs.artifact_name }}' | tr '[:upper:]' '[:lower:]')"
          if [ "${{ inputs.allow_non_production_artifacts }}" != "true" ] && [ -n "$name_lc" ]; then
            if [[ "$name_lc" == *"debug"* ]] || [[ "$name_lc" == *"unsigned"* ]]; then
              echo "Artifact no-productivo detectado: $name_lc"
              echo "Usa ows-store-apk-release-signed o habilita allow_non_production_artifacts=true."
              exit 1
            fi
          fi

      - name: Download artifact by ID
        if: ${{ inputs.artifact_id != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          artifact-ids: ${{ inputs.artifact_id }}
          github-token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          path: promoted-android

      - name: Download artifact by name
        if: ${{ inputs.artifact_id == '' && inputs.artifact_name != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          name: ${{ inputs.artifact_name }}
          github-token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          path: promoted-android

      - name: List files
        shell: bash
        run: |
          echo "Files to release:"
          find promoted-android -type f -maxdepth 6 -print

      - name: Publish to owsdatabase releases
        uses: softprops/action-gh-release@v2
        with:
          repository: OceanandWild/owsdatabase
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          body: ${{ inputs.release_notes }}
          draft: false
          prerelease: ${{ inputs.prerelease == 'true' }}
          make_latest: false
          files: |
            promoted-android/**/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
