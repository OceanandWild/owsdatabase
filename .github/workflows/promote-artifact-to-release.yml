name: Promote Action Artifact To Release

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: "GitHub Actions run ID de origen"
        required: true
        type: string
      artifact_name:
        description: "Nombre del artifact (usa este o artifact_id)"
        required: false
        type: string
      artifact_id:
        description: "ID numerico del artifact (opcional, preferido si lo tienes)"
        required: false
        type: string
      release_tag:
        description: "Tag del Release destino (debe ser unico)"
        required: true
        type: string
      release_name:
        description: "Nombre visible del Release"
        required: true
        type: string
      release_notes:
        description: "Notas / changelog del Release"
        required: false
        type: string
      mark_latest:
        description: "Marcar como latest"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      prerelease:
        description: "Publicar como prerelease"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      target_repository:
        description: "Repo destino owner/name (default: OceanandWild/floretshop)"
        required: true
        default: "OceanandWild/floretshop"
        type: string

permissions:
  contents: write
  actions: read

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          if [ -z "${{ inputs.artifact_name }}" ] && [ -z "${{ inputs.artifact_id }}" ]; then
            echo "Debes indicar artifact_name o artifact_id."
            exit 1
          fi

      - name: Download artifact by ID
        if: ${{ inputs.artifact_id != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          artifact-ids: ${{ inputs.artifact_id }}
          github-token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          path: promoted-artifact

      - name: Download artifact by name
        if: ${{ inputs.artifact_id == '' && inputs.artifact_name != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          name: ${{ inputs.artifact_name }}
          github-token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          path: promoted-artifact

      - name: Show downloaded files
        shell: bash
        run: |
          echo "Contenido descargado:"
          find promoted-artifact -type f -maxdepth 5 -print

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ inputs.target_repository }}
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          body: ${{ inputs.release_notes }}
          draft: false
          prerelease: ${{ inputs.prerelease == 'true' }}
          make_latest: ${{ inputs.mark_latest }}
          files: |
            promoted-artifact/**/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}

      - name: Sync Android release metadata to OWS API
        continue-on-error: true
        shell: bash
        run: |
          set -u
          TARGET_REPO="${{ inputs.target_repository }}"
          DEFAULT_PROJECT_SLUG=""
          DEFAULT_PACKAGE_ID=""

          if [ "$TARGET_REPO" = "OceanandWild/floretshop" ]; then
            DEFAULT_PROJECT_SLUG="floret-shop"
            DEFAULT_PACKAGE_ID="com.oceanandwild.floretshop"
          elif [ "$TARGET_REPO" = "OceanandWild/owsdatabase" ]; then
            DEFAULT_PROJECT_SLUG="ows-store"
            DEFAULT_PACKAGE_ID="com.oceanandwild.owsstore"
          else
            echo "Repositorio sin mapeo Android para OWS API: $TARGET_REPO"
            exit 0
          fi

          APK_FILE="$(find promoted-artifact -type f -name '*.apk' | grep -Evi 'unsigned' | grep -Ei 'signed|release' | head -n1 || true)"
          if [ -z "$APK_FILE" ]; then
            APK_FILE="$(find promoted-artifact -type f -name '*.apk' | head -n1 || true)"
          fi
          if [ -z "$APK_FILE" ]; then
            echo "No se encontro APK para sincronizar metadata."
            exit 0
          fi

          META_FILE="$(find promoted-artifact -type f -name 'android-release-metadata.json' | head -n1 || true)"
          PROJECT_SLUG="$DEFAULT_PROJECT_SLUG"
          PACKAGE_ID="$DEFAULT_PACKAGE_ID"
          VERSION_NAME="${{ inputs.release_tag }}"
          VERSION_CODE="0"

          if [ -n "$META_FILE" ]; then
            mapfile -t META_FIELDS < <(python - "$META_FILE" <<'PY'
import json,sys
p=sys.argv[1]
data=json.load(open(p,'r',encoding='utf-8'))
print(data.get('project_slug',''))
print(data.get('package_id',''))
print(data.get('version_name',''))
print(data.get('version_code',''))
PY
            )
            [ -n "${META_FIELDS[0]:-}" ] && PROJECT_SLUG="${META_FIELDS[0]}"
            [ -n "${META_FIELDS[1]:-}" ] && PACKAGE_ID="${META_FIELDS[1]}"
            [ -n "${META_FIELDS[2]:-}" ] && VERSION_NAME="${META_FIELDS[2]}"
            [ -n "${META_FIELDS[3]:-}" ] && VERSION_CODE="${META_FIELDS[3]}"
          fi

          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            VERSION_CODE="0"
          fi
          if [ "$VERSION_CODE" -le 0 ]; then
            VERSION_CODE="$(python - <<'PY'
import re
tag=r"${{ inputs.release_tag }}"
m=re.search(r'(\d{4})\.(\d{2})\.(\d{2})-(\d{3,4})', tag)
if not m:
    print("0")
else:
    y,mn,d,hhmm=m.groups()
    print(f"{y[-2:]}{mn}{d}{hhmm}")
PY
            )"
          fi

          APK_NAME="$(basename "$APK_FILE")"
          APK_URL="https://github.com/${TARGET_REPO}/releases/download/${{ inputs.release_tag }}/${APK_NAME}"
          SIZE_BYTES="$(stat -c%s "$APK_FILE" 2>/dev/null || wc -c < "$APK_FILE")"
          SHA256="$(sha256sum "$APK_FILE" | awk '{print $1}')"
          PUBLISHED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          PAYLOAD="$(python - <<PY
import json
payload={
  "project_slug": "${PROJECT_SLUG}",
  "package_id": "${PACKAGE_ID}",
  "version_name": "${VERSION_NAME}",
  "version_code": int("${VERSION_CODE}" or 0),
  "apk_url": "${APK_URL}",
  "sha256": "${SHA256}",
  "size_bytes": int("${SIZE_BYTES}" or 0),
  "release_notes": """${{ inputs.release_notes }}""".strip(),
  "status": "published",
  "is_mandatory": False,
  "published_at": "${PUBLISHED_AT}"
}
print(json.dumps(payload))
PY
          )"

          echo "Sincronizando metadata Android para ${PROJECT_SLUG}..."
          curl -fsS -X POST "https://owsdatabase.onrender.com/ows-store/android/releases" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD"
