name: Promote Artifact To Release

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: "GitHub Actions run ID de origen"
        required: true
      artifact_name:
        description: "Nombre del artifact (preferido)"
        required: false
        default: ""
      artifact_id:
        description: "Artifact ID numerico (opcional)"
        required: false
        default: ""
      release_tag:
        description: "Tag destino del release"
        required: true
      release_name:
        description: "Nombre visible del release"
        required: true
      release_notes:
        description: "Notas/changelog"
        required: false
        default: ""
      mark_latest:
        description: "Marcar como latest (true/false)"
        required: false
        default: "false"
      prerelease:
        description: "Publicar como prerelease (true/false)"
        required: false
        default: "false"
      target_repository:
        description: "Repositorio destino owner/name"
        required: true
        default: "OceanandWild/floretshop"

permissions:
  contents: write
  actions: read

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          if [ -z "${{ inputs.artifact_name }}" ] && [ -z "${{ inputs.artifact_id }}" ]; then
            echo "Debes indicar artifact_name o artifact_id."
            exit 1
          fi

      - name: Resolve release token
        shell: bash
        env:
          RELEASE_PAT: ${{ secrets.RELEASE_PAT }}
          GH_TOKEN_DEFAULT: ${{ github.token }}
        run: |
          TOKEN="$RELEASE_PAT"
          if [ -z "$TOKEN" ]; then
            TOKEN="$GH_TOKEN_DEFAULT"
          fi
          echo "RELEASE_TOKEN=$TOKEN" >> "$GITHUB_ENV"

      - name: Download artifact by ID
        if: ${{ inputs.artifact_id != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          artifact-ids: ${{ inputs.artifact_id }}
          path: promoted-artifact

      - name: Download artifact by name
        if: ${{ inputs.artifact_id == '' && inputs.artifact_name != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          name: ${{ inputs.artifact_name }}
          path: promoted-artifact

      - name: Validate downloaded files
        shell: bash
        run: |
          if [ ! -d promoted-artifact ]; then
            echo "No existe carpeta promoted-artifact"
            exit 1
          fi
          COUNT="$(find promoted-artifact -type f | wc -l | tr -d ' ')"
          if [ "$COUNT" = "0" ]; then
            echo "No se descargaron archivos."
            exit 1
          fi
          echo "Archivos descargados:"
          find promoted-artifact -type f -maxdepth 6 -print

      - name: Sanitize promoted files
        shell: bash
        run: |
          set -euo pipefail
          find promoted-artifact -type f \( -iname "*unsigned*.apk" -o -iname "*debug*.apk" \) -print -delete || true
          echo "Archivos finales:"
          find promoted-artifact -type f -maxdepth 6 -print

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ inputs.target_repository }}
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          body: ${{ inputs.release_notes }}
          draft: false
          prerelease: ${{ inputs.prerelease == 'true' }}
          make_latest: ${{ inputs.mark_latest }}
          files: |
            promoted-artifact/**/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ env.RELEASE_TOKEN }}
