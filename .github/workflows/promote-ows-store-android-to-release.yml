name: Promote OWS Store Android Artifact To Release

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: "GitHub Actions run ID que contiene el artifact Android"
        required: true
        type: string
      artifact_id:
        description: "Artifact ID (opcional si usas artifact_name)"
        required: false
        type: string
      artifact_name:
        description: "Artifact name (recomendado: ows-store-apk-release-signed)"
        required: false
        default: "ows-store-apk-release-signed"
        type: string
      allow_non_production_artifacts:
        description: "Permitir artifact debug/unsigned (no recomendado)"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      release_tag:
        description: "Tag unico del release (ej. ows-store-android-v2026.02.24-001)"
        required: true
        type: string
      release_name:
        description: "Nombre del release"
        required: true
        type: string
      release_notes:
        description: "Notas/changelog"
        required: false
        type: string
      prerelease:
        description: "Publicar como prerelease"
        required: true
        default: "true"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  actions: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        shell: bash
        run: |
          if [ -z "${{ inputs.artifact_id }}" ] && [ -z "${{ inputs.artifact_name }}" ]; then
            echo "Debes indicar artifact_id o artifact_name."
            exit 1
          fi

          name_lc="$(echo '${{ inputs.artifact_name }}' | tr '[:upper:]' '[:lower:]')"
          if [ "${{ inputs.allow_non_production_artifacts }}" != "true" ] && [ -n "$name_lc" ]; then
            if [[ "$name_lc" == *"debug"* ]] || [[ "$name_lc" == *"unsigned"* ]]; then
              echo "Artifact no-productivo detectado: $name_lc"
              echo "Usa ows-store-apk-release-signed o habilita allow_non_production_artifacts=true."
              exit 1
            fi
          fi

      - name: Download artifact by ID
        if: ${{ inputs.artifact_id != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          artifact-ids: ${{ inputs.artifact_id }}
          github-token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          path: promoted-android

      - name: Download artifact by name
        if: ${{ inputs.artifact_id == '' && inputs.artifact_name != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.source_run_id }}
          name: ${{ inputs.artifact_name }}
          github-token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          path: promoted-android

      - name: List files
        shell: bash
        run: |
          echo "Files to release:"
          find promoted-android -type f -maxdepth 6 -print

      - name: Sanitize promoted files
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ inputs.allow_non_production_artifacts }}" != "true" ]; then
            find promoted-android -type f \( -iname "*unsigned*.apk" -o -iname "*debug*.apk" \) -print -delete || true
          fi
          echo "Files after sanitize:"
          find promoted-android -type f -maxdepth 6 -print

      - name: Publish to owsdatabase releases
        uses: softprops/action-gh-release@v2
        with:
          repository: OceanandWild/owsdatabase
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          body: ${{ inputs.release_notes }}
          draft: false
          prerelease: true
          make_latest: false
          files: |
            promoted-android/**/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}

      - name: Sync Android release metadata to OWS API
        continue-on-error: true
        shell: bash
        run: |
          set -u
          APK_FILE="$(find promoted-android -type f -name '*.apk' | grep -Evi 'unsigned' | grep -Ei 'signed' | head -n1 || true)"
          if [ -z "$APK_FILE" ] && [ "${{ inputs.allow_non_production_artifacts }}" = "true" ]; then
            APK_FILE="$(find promoted-android -type f -name '*.apk' | head -n1 || true)"
          fi
          if [ -z "$APK_FILE" ]; then
            echo "No se encontro APK firmado para sincronizar metadata."
            exit 0
          fi

          META_FILE="$(find promoted-android -type f -name 'android-release-metadata.json' | head -n1 || true)"
          PROJECT_SLUG="ows-store"
          PACKAGE_ID="com.oceanandwild.owsstore"
          VERSION_NAME="${{ inputs.release_tag }}"
          VERSION_CODE="0"

          if [ -n "$META_FILE" ]; then
            mapfile -t META_FIELDS < <(python - "$META_FILE" <<'PY'
import json,sys
p=sys.argv[1]
data=json.load(open(p,'r',encoding='utf-8'))
print(data.get('project_slug',''))
print(data.get('package_id',''))
print(data.get('version_name',''))
print(data.get('version_code',''))
PY
            )
            [ -n "${META_FIELDS[0]:-}" ] && PROJECT_SLUG="${META_FIELDS[0]}"
            [ -n "${META_FIELDS[1]:-}" ] && PACKAGE_ID="${META_FIELDS[1]}"
            [ -n "${META_FIELDS[2]:-}" ] && VERSION_NAME="${META_FIELDS[2]}"
            [ -n "${META_FIELDS[3]:-}" ] && VERSION_CODE="${META_FIELDS[3]}"
          fi

          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            VERSION_CODE="0"
          fi
          if [ "$VERSION_CODE" -le 0 ]; then
            VERSION_CODE="$(python - <<'PY'
import re
tag=r"${{ inputs.release_tag }}"
m=re.search(r'(\d{4})\.(\d{2})\.(\d{2})-(\d{3,4})', tag)
if not m:
    print("0")
else:
    y,mn,d,hhmm=m.groups()
    print(f"{y[-2:]}{mn}{d}{hhmm}")
PY
            )"
          fi

          APK_NAME="$(basename "$APK_FILE")"
          APK_URL="https://github.com/OceanandWild/owsdatabase/releases/download/${{ inputs.release_tag }}/${APK_NAME}"
          SIZE_BYTES="$(stat -c%s "$APK_FILE" 2>/dev/null || wc -c < "$APK_FILE")"
          SHA256="$(sha256sum "$APK_FILE" | awk '{print $1}')"
          PUBLISHED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          PAYLOAD="$(python - <<PY
import json
payload={
  "project_slug": "${PROJECT_SLUG}",
  "package_id": "${PACKAGE_ID}",
  "version_name": "${VERSION_NAME}",
  "version_code": int("${VERSION_CODE}" or 0),
  "apk_url": "${APK_URL}",
  "sha256": "${SHA256}",
  "size_bytes": int("${SIZE_BYTES}" or 0),
  "release_notes": """${{ inputs.release_notes }}""".strip(),
  "status": "published",
  "is_mandatory": False,
  "published_at": "${PUBLISHED_AT}"
}
print(json.dumps(payload))
PY
          )"

          echo "Sincronizando metadata Android para ${PROJECT_SLUG}..."
          curl -fsS -X POST "https://owsdatabase.onrender.com/ows-store/android/releases" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD"

