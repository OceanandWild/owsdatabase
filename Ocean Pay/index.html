<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Ocean Pay ‚Äì Tu billetera universal</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
:root{
  --bg:#0b1020;
  --card:#0b1930;
  --accent:#22d3ee;
  --text:#cbe8ff;
  --ok:#10b981;
  --err:#ef4444;
  --glass:rgba(255,255,255,.05);
  --purple:#a855f7;
  --orange:#f97316;
}
*{box-sizing:border-box;margin:0;font-family:system-ui,Arial,Helvetica,sans-serif;}
body{
  background:radial-gradient(circle at 50% 50%,#0b1f3a 0%,#030b18 100%);
  color:var(--text);
  display:flex;align-items:center;justify-content:center;min-height:100vh;padding:1rem;
}
.ocean-card{
  width:100%;max-width:520px;background:var(--glass);
  backdrop-filter:blur(12px);border:1px solid var(--accent);
  border-radius:1.5rem;padding:2.5rem;
  box-shadow:0 0 30px rgba(34,211,238,.35);
}
h1{
  text-align:center;margin-bottom:2rem;font-size:2rem;
  background:linear-gradient(90deg,var(--accent),#a6e1ff);
  -webkit-background-clip:text;background-clip:text;color:transparent;
}
label{font-size:.9rem;margin-bottom:.5rem;display:block;font-weight:500;}
input{
  width:100%;padding:.875rem;border-radius:.5rem;
  border:1px solid var(--accent);background:#061124;color:var(--text);
  margin-bottom:1rem;font-size:.95rem;transition:border-color .2s;
}
input:focus{outline:none;border-color:#67e8f9;}
button{
  cursor:pointer;width:100%;padding:.875rem;border:none;
  border-radius:.5rem;font-weight:700;background:var(--accent);
  color:#0b1020;transition:background .2s,transform .1s;font-size:1rem;
}
button:hover{background:#67e8f9;}
button:active{transform:scale(.98);}
button.secondary{
  background:transparent;border:1px solid var(--accent);color:var(--accent);
}
button.secondary:hover{background:rgba(34,211,238,.1);}
.msg{font-size:.85rem;margin-top:.5rem;}
.error{color:var(--err);}
.success{color:var(--ok);}
.hidden{display:none !important;}

/* Formularios con fade */
.form-box{
  display:flex;flex-direction:column;
  animation:fadeIn .4s ease;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(-10px);}
  to{opacity:1;transform:translateY(0);}
}

/* Wallet - Mejoras */
.section-title{
  font-size:.9rem;color:#9bb0c2;text-transform:uppercase;letter-spacing:.05em;
  margin:1.5rem 0 .75rem 0;font-weight:600;
}
.balance-grid{
  display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1.5rem;
}
.currency-card{
  background:var(--glass);border:1px solid var(--accent);
  border-radius:1rem;padding:1.25rem;
  display:flex;flex-direction:column;gap:.5rem;position:relative;
  transition:all .3s;cursor:pointer;
}
.currency-card:hover{transform:translateY(-3px);box-shadow:0 4px 20px rgba(34,211,238,.25);}
.currency-card.active{border-color:var(--ok);border-width:2px;}
.currency-card.soon{opacity:.6;cursor:not-allowed;}
.currency-card-header{display:flex;justify-content:space-between;align-items:flex-start;}
.currency-card .label{font-size:.85rem;color:#9bb0c2;text-transform:uppercase;letter-spacing:.05em;font-weight:600;}
.currency-card .amount{font-size:1.75rem;font-weight:700;color:var(--accent);margin:.25rem 0;}
.currency-card .badge{
  position:absolute;top:1rem;right:1rem;font-size:.7rem;
  background:var(--accent);color:#0b1020;padding:.25rem .5rem;border-radius:.4rem;
  font-weight:600;
}
.currency-card .app-info{
  margin-top:.75rem;padding-top:.75rem;border-top:1px solid rgba(255,255,255,.1);
  font-size:.8rem;color:#9bb0c2;
}
.currency-card .app-info strong{color:var(--text);font-weight:600;}
.currency-card .app-info .sub-divisa{
  margin-top:.5rem;padding:.5rem;background:rgba(255,255,255,.03);
  border-radius:.5rem;font-size:.75rem;
}
.sub-divisas-section{
  margin-top:1.5rem;padding:1rem;background:rgba(255,255,255,.02);
  border-radius:.75rem;border:1px solid rgba(255,255,255,.05);
}
.sub-divisas-title{
  font-size:.85rem;color:var(--accent);font-weight:600;margin-bottom:.75rem;
  display:flex;align-items:center;gap:.5rem;
}
.sub-divisa-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:.75rem;background:rgba(255,255,255,.03);border-radius:.5rem;
  margin-bottom:.5rem;
}
.sub-divisa-item:last-child{margin-bottom:0;}
.sub-divisa-label{font-size:.85rem;color:#9bb0c2;}
.sub-divisa-amount{font-size:1.1rem;font-weight:700;color:var(--purple);}

.tx-details{margin-top:1.5rem;}
.tx-details summary{
  cursor:pointer;list-style:none;color:var(--accent);font-weight:600;
  padding:.75rem;background:rgba(255,255,255,.03);border-radius:.5rem;
  transition:background .2s;
}
.tx-details summary:hover{background:rgba(255,255,255,.06);}
.tx-details[open] summary{margin-bottom:.75rem;}
.tx-list{
  max-height:300px;overflow-y:auto;margin-top:.5rem;
  display:flex;flex-direction:column;gap:.5rem;
}
.tx-list::-webkit-scrollbar{width:6px;}
.tx-list::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:3px;}
.tx-list::-webkit-scrollbar-thumb{background:var(--accent);border-radius:3px;}
.tx-item{
  padding:.875rem;background:rgba(255,255,255,.03);
  border-radius:.6rem;border:1px solid rgba(255,255,255,.05);
  display:flex;justify-content:space-between;align-items:center;
  transition:all .2s;
}
.tx-item:hover{
  background:rgba(255,255,255,.06);
  border-color:var(--accent);
  transform:translateX(4px);
}
.tx-item-content{flex:1;display:flex;flex-direction:column;gap:.25rem;}
.tx-item-concept{font-size:.9rem;color:var(--text);font-weight:500;}
.tx-item-meta{
  font-size:.75rem;color:#9bb0c2;
  display:flex;align-items:center;gap:.5rem;
}
.tx-item-origin{
  padding:.15rem .4rem;background:rgba(34,211,238,.15);
  border-radius:.25rem;font-size:.7rem;
}
.tx-item-amount{
  font-size:1.1rem;font-weight:700;text-align:right;
  min-width:80px;
}
.tx-item-amount.positive{color:var(--ok);}
.tx-item-amount.negative{color:var(--err);}
.tx-empty{
  text-align:center;padding:2rem;color:#9bb0c2;font-style:italic;
}
.divider{margin:2rem 0;border:none;border-top:1px solid rgba(34,211,238,.2);}
.toggle-p{text-align:center;margin-top:1.5rem;font-size:.85rem;color:#9bb0c2;}
.toggle-p a{color:var(--accent);text-decoration:none;font-weight:600;}
.toggle-p a:hover{text-decoration:underline;}

.loading{
  opacity:.6;pointer-events:none;position:relative;
}
.loading::after{
  content:'';position:absolute;top:50%;left:50%;
  width:20px;height:20px;margin:-10px 0 0 -10px;
  border:2px solid var(--accent);border-top-color:transparent;
  border-radius:50%;animation:spin .6s linear infinite;
}
@keyframes spin{
  to{transform:rotate(360deg);}
}
</style>
</head>
<body>
  <div class="ocean-card">
    <h1>üåä Ocean Pay</h1>

    <!-- LOGIN -->
    <form id="loginForm" class="form-box">
      <label>Usuario</label>
      <input type="text" id="logUser" required placeholder="Tu usuario" />
      <label>Contrase√±a</label>
      <input type="password" id="logPass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button type="submit">Ingresar</button>
      <p id="logMsg" class="msg hidden"></p>
    </form>

    <!-- REGISTER -->
    <form id="regForm" class="form-box hidden">
      <label>Usuario</label>
      <input type="text" id="regUser" required placeholder="Nuevo usuario" />
      <label>Contrase√±a</label>
      <input type="password" id="regPass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button type="submit">Crear cuenta</button>
      <p id="regMsg" class="msg hidden"></p>
    </form>

    <!-- WALLET -->
    <div id="wallet" class="hidden">
      <div class="section-title">Divisas Principales</div>
      <div class="balance-grid">
        <div class="currency-card active">
          <div class="currency-card-header">
            <div>
              <span class="label">AquaBux</span>
              <span class="amount" id="bux">0</span>
            </div>
          </div>
          <div class="app-info">
            <strong>App Perteneciente:</strong> Ocean Cinemas üé¨
          </div>
        </div>

        <div class="currency-card" id="ecoxionums-card">
          <div class="currency-card-header">
            <div>
              <span class="label">Ecoxionums</span>
              <span class="amount" id="ecoxionums">0</span>
            </div>
          </div>
          <div class="app-info">
            <strong>App Perteneciente:</strong> Ecoxion üåç
          </div>
        </div>

        <div class="currency-card">
          <div class="currency-card-header">
            <div>
              <span class="label">EcoCoreBits</span>
              <span class="amount" id="ecobits">0</span>
            </div>
          </div>
          <div class="app-info">
            <strong>App Perteneciente:</strong> EcoConsole üíª
          </div>
        </div>

        <div class="currency-card soon">
          <div class="currency-card-header">
            <div>
              <span class="label">AppBux</span>
              <span class="amount">‚Äî</span>
            </div>
            <span class="badge">Pr√≥ximamente</span>
          </div>
          <div class="app-info">
            <strong>App Perteneciente:</strong> AllApp (Pr√≥ximamente) üì±
          </div>
        </div>
      </div>

      <!-- Sub-Divisas -->
      <div class="sub-divisas-section">
        <div class="sub-divisas-title">
          <span>üíé</span>
          <span>Sub-Divisas</span>
        </div>
        <div class="sub-divisa-item">
          <span class="sub-divisa-label">Cr√©ditos (EcoConsole)</span>
          <span class="sub-divisa-amount" id="credits">0</span>
        </div>
      </div>

      <p id="walletMsg" class="msg hidden"></p>

      <!-- Transacciones -->
      <details class="tx-details">
        <summary>üìã Historial de Transacciones</summary>
        <div id="txList" class="tx-list"></div>
      </details>

      <hr class="divider" />
      <button id="logoutBtn" class="secondary">Cerrar sesi√≥n</button>
    </div>

    <!-- Toggle link -->
    <p class="toggle-p">
      ¬øYa tienes cuenta? <a href="#" id="toggleLink">Inicia sesi√≥n</a>
    </p>
  </div>


<script>
  const API='https://owsdatabase.onrender.com'; // same origin
  let token='', userId=0;

  /* ----------  HELPERS  ---------- */
  const qs=x=>document.querySelector(x);
const show = (sel, on = true) => {
  const el = typeof sel === 'string' ? qs(sel) : sel;
  if (el) el.classList.toggle('hidden', !on);
};

  /* ----------  UI TOGGLE  ---------- */
  qs('#toggleLink').onclick=e=>{
    e.preventDefault();
    const login=qs('#loginForm').classList.contains('hidden');
    show('#regForm',!login);
    show('#loginForm',login);
    qs('#toggleLink').textContent=login?'Crear cuenta':'Iniciar sesi√≥n';
  };

  /* ----------  REGISTER  ---------- */
  qs('#regForm').onsubmit=async e=>{
    e.preventDefault();
    const body={username:qs('#regUser').value, password:qs('#regPass').value};
    const res=await fetch(API+'/ocean-pay/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await res.json();
    if(!res.ok) return qs('#regMsg').textContent=data.error;
    qs('#regMsg').className='success'; qs('#regMsg').textContent='¬°Cuenta creada! Bienvenido.';
    setTimeout(()=>autoLogin(body.username,body.password),1000);
  };

  /* ----------  LOGIN  ---------- */
  qs('#loginForm').onsubmit=async e=>{
    e.preventDefault();
    await autoLogin(qs('#logUser').value,qs('#logPass').value);
  };

async function loadEcoxionumsBalance() {
  const user = JSON.parse(localStorage.getItem('opUser') || '{}');
  if (!user.id) { qs('#ecoxionums').textContent = '0'; return; }

  const res = await fetch(`${API}/ocean-pay/ecoxionums/${user.id}`);
  const { ecoxionums } = await res.json();
  qs('#ecoxionums').textContent = Math.round(ecoxionums || 0).toLocaleString();
}

async function loadEcoCoreBitsBalance() {
    const user = JSON.parse(localStorage.getItem('opUser') || '{}');
    if (!user.id) { qs('#ecobits').textContent = '0'; return; }

    try {
        // Intentar primero con el token de opUser
        let token = user.token;
        
        // Si no hay token, intentar obtenerlo del localStorage de EcoConsole
        if (!token) {
            const ecToken = localStorage.getItem('token');
            if (ecToken) token = ecToken;
        }
        
        if (!token) {
            console.warn('No token available for EcoCoreBits');
            qs('#ecobits').textContent = '0';
            return;
        }

        const res = await fetch(`${API}/api/ecorebits/user`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
            console.warn('Failed to load EcoCoreBits:', res.status);
            qs('#ecobits').textContent = '0';
            return;
        }
        
        const data = await res.json();
        if (data.success) {
            const balance = Math.round(data.user?.ecorebits?.balance || 0);
            qs('#ecobits').textContent = balance.toLocaleString();
            
            // Actualizar tambi√©n el token en opUser si lo tenemos
            if (token && !user.token) {
                user.token = token;
                localStorage.setItem('opUser', JSON.stringify(user));
            }
        }
    } catch (e) { 
        console.error("Error fetching ecocorebits", e);
        qs('#ecobits').textContent = '0';
    }
}

async function loadCreditsBalance() {
    const user = JSON.parse(localStorage.getItem('opUser') || '{}');
    if (!user.id) { qs('#credits').textContent = '0'; return; }

    try {
        let token = user.token;
        if (!token) {
            const ecToken = localStorage.getItem('token');
            if (ecToken) token = ecToken;
        }
        
        if (!token) {
            qs('#credits').textContent = '0';
            return;
        }

        const res = await fetch(`${API}/ecocore/credits/${user.id}`, {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (res.ok) {
            const data = await res.json();
            const credits = Math.round(data.credits || 0);
            qs('#credits').textContent = credits.toLocaleString();
        } else {
            qs('#credits').textContent = '0';
        }
    } catch (e) {
        console.error("Error fetching credits", e);
        qs('#credits').textContent = '0';
    }
}

async function changeEcoxionums(sign) {
  const user = JSON.parse(localStorage.getItem('opUser') || '{}');
  const amt = +qs('#ecoAmount').value * sign;
  const concept = qs('#ecoConcept').value;

  const res = await fetch(`${API}/ocean-pay/ecoxionums/change`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: user.id, amount: amt, concept })
  });
  const data = await res.json();
  if (res.ok) {
    qs('#ecoxionums').textContent = data.newBalance.toLocaleString();
    showAlert('success', 'Ecoxionums actualizados');
    closeEcoModal();
    /* reflejo inmediato en Ecoxion (ver punto 5) */
    window.parent?.postMessage({ type: 'eco-balance-update', balance: data.newBalance }, '*');
  } else {
    showAlert('error', data.error);
  }
}
/* ----------  LOGIN (√∫nico fetch) ---------- */
async function autoLogin(username, password) {
  console.log('[LOGIN] Enviando:', { username, password });

  const res = await fetch(API + '/ocean-pay/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();
  if (!res.ok) {
    qs('#logMsg').textContent = data.error;
    return;
  }

  // ‚úÖ Guardamos todo
  token = data.token;
  userId = data.user.id;
  localStorage.setItem('opToken', token);
localStorage.setItem('opUser', JSON.stringify(data.user));


  // ‚úÖ Guardamos el token tambi√©n en el user object para EcoCoreBits
  if (data.user && !data.user.token) {
    data.user.token = data.token;
  }
  localStorage.setItem('opUser', JSON.stringify(data.user));

  // ‚úÖ Mostramos wallet
  show('#loginForm', false);
  show('#regForm', false);
  show('#wallet', true);
  
  // ‚úÖ Cargar todos los balances
  qs('#bux').textContent = (data.user.aquabux || 0).toLocaleString();
  
  // Cargar balances en paralelo
  await Promise.all([
    loadEcoxionumsBalance(),
    loadEcoCoreBitsBalance(),
    loadCreditsBalance()
  ]);

  // Iniciar refresh autom√°tico de balances
  startBalanceRefresh();

  /* ‚¨ÖÔ∏è  Cargar historial */
  await renderTransacciones();

  /* ‚¨ÖÔ∏è  DEBUG: imprimimos lo que vamos a enviar */
  console.log('[Ocean-Pay] Enviando al padre:', {
    type: 'ocean-pay-token',
    token: data.token,
    user: data.user
  });

/* ‚úÖ Solo si fue abierta desde otra ventana */
if (window.opener) {
  window.opener.postMessage(
    JSON.parse(JSON.stringify({
      type: 'ocean-pay-token',
      token: data.token,
      user: data.user,
      ecoxionums: data.user.ecoxionums,
      ecorebits: { balance: data.user.ecorebits }
    })),
    '*'
  );
  setTimeout(() => window.close(), 6000);
} else {
  /* üîì Modo standalone: quedarse en la wallet */
  console.log('[Ocean-Pay] Sin ventana padre ‚Üí modo independiente');
}
}


  /* ----------  REFRESH BALANCES  ---------- */
  async function refreshAllBalances() {
    await Promise.all([
      loadEcoxionumsBalance(),
      loadEcoCoreBitsBalance(),
      loadCreditsBalance()
    ]);
  }

  // Refrescar balances cada 30 segundos
  let balanceRefreshInterval = null;
  function startBalanceRefresh() {
    if (balanceRefreshInterval) clearInterval(balanceRefreshInterval);
    balanceRefreshInterval = setInterval(refreshAllBalances, 30000);
  }
  function stopBalanceRefresh() {
    if (balanceRefreshInterval) {
      clearInterval(balanceRefreshInterval);
      balanceRefreshInterval = null;
    }
  }

  /* ----------  LOGOUT  ---------- */
  qs('#logoutBtn').onclick=()=>{
    stopBalanceRefresh();
    localStorage.removeItem('opToken'); localStorage.removeItem('opUser');
    token=''; userId=0;
    show('#wallet',false); show('#regForm',true); show('#loginForm',false);
    qs('#toggleLink').textContent='Iniciar sesi√≥n';
  };

  /* ----------  INIT SEGURO  ---------- */
window.addEventListener('DOMContentLoaded', async () => {
  const t = localStorage.getItem('opToken');
  if (!t) return; // sin token ‚Üí mostrar login

  token = t;
  const user = JSON.parse(localStorage.getItem('opUser') || '{}');
  userId = user.id;

  // Si el usuario tiene token de EcoConsole, guardarlo en opUser
  if (!user.token) {
    const ecToken = localStorage.getItem('token');
    if (ecToken) {
      user.token = ecToken;
      localStorage.setItem('opUser', JSON.stringify(user));
    }
  }

  // pinta wallet y saldo
  show('#wallet', true);
  show('#regForm', false);
  show('#loginForm', false);
  qs('#toggleLink').textContent = 'Crear cuenta';

  const buxEl = qs('#bux');
  if (buxEl) buxEl.textContent = (user.aquabux || 0).toLocaleString();

  // Cargar todos los balances en paralelo
  await Promise.all([
    loadEcoxionumsBalance(),
    loadEcoCoreBitsBalance(),
    loadCreditsBalance()
  ]);

  // Iniciar refresh autom√°tico de balances
  startBalanceRefresh();

  // ‚¨ÖÔ∏è  carga historial
  await renderTransacciones();
});

async function renderTransacciones() {
  const container = qs('#txList');
  if (!container) return;

  const token = localStorage.getItem('opToken');
  if (!token) {
    container.innerHTML = '<div class="tx-empty">Sin cuenta vinculada</div>';
    return;
  }

  // Mostrar estado de carga
  container.innerHTML = '<div class="tx-empty">Cargando transacciones...</div>';

  try {
    // 1. Ping suave para despertar el dyno
    const wake = await fetch(API + '/status', { method: 'HEAD' });
    if (!wake.ok) throw new Error('Servidor durmiendo');

    // 2. Datos del usuario
    const me = await (await fetch(API + '/ocean-pay/me', {
      headers: { Authorization: 'Bearer ' + token }
    })).json();

    // 3. Transacciones
    const txs = await (await fetch(`${API}/ocean-pay/txs/${me.id}`, {
      headers: { Authorization: 'Bearer ' + token }
    })).json();

    if (txs.length === 0) {
      container.innerHTML = '<div class="tx-empty">No hay movimientos registrados</div>';
      return;
    }

    // Renderizar transacciones con nuevo dise√±o
    container.innerHTML = txs.map(tx => {
      const fecha = new Date(tx.created_at);
      const fechaFormateada = fecha.toLocaleDateString('es-ES', { 
        day: '2-digit', 
        month: 'short', 
        year: 'numeric' 
      });
      const horaFormateada = fecha.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      const esPositivo = tx.monto > 0;
      const simboloMoneda = tx.moneda === 'AB' ? 'AquaBux' : tx.moneda === 'ECB' ? 'EcoCoreBits' : tx.moneda === 'EX' ? 'Ecoxionums' : tx.moneda;
      
      return `
        <div class="tx-item">
          <div class="tx-item-content">
            <div class="tx-item-concept">${tx.concepto || 'Transacci√≥n'}</div>
            <div class="tx-item-meta">
              <span>${fechaFormateada} ${horaFormateada}</span>
              ${tx.origen ? `<span class="tx-item-origin">${tx.origen}</span>` : ''}
            </div>
          </div>
          <div class="tx-item-amount ${esPositivo ? 'positive' : 'negative'}">
            ${esPositivo ? '+' : ''}${tx.monto.toLocaleString()} ${simboloMoneda}
          </div>
        </div>
      `;
    }).join('');

  } catch (err) {
    console.warn('[Ocean-Pay] renderTransacciones:', err);

    // Token inv√°lido / expirado ‚Üí limpiamos
    if (err.message.includes('401') || err.message.includes('Token') || err.message.includes('403')) {
      localStorage.removeItem('opToken');
      localStorage.removeItem('opUser');
      container.innerHTML = '<div class="tx-empty" style="color:var(--err)">Sesi√≥n cerrada. Por favor, inicia sesi√≥n nuevamente.</div>';
      return;
    }

    // Cualquier otro error (500, network, etc.)
    container.innerHTML = '<div class="tx-empty" style="color:var(--err)">Servidor no disponible. Re-intenta en 30 segundos.</div>';
  }
}



// Store the original notifyParent function if it exists
const originalNotifyParent = window.notifyParent || function() {};

window.notifyParent = function() {
    console.log('notifyParent called');
    
    // Call the original function first (if it exists)
    originalNotifyParent();
    
    // Check if we were opened from EcoConsole
    const urlParams = new URLSearchParams(window.location.search);
    const source = urlParams.get('source');
    
    if (source === 'ecoconsole' && window.opener) {
        try {
            console.log('Notifying parent window...');
            
            // Get the token and user data from localStorage
            const token = localStorage.getItem('token');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            console.log('User data from localStorage:', { token, userData });
            
            // If we have the required data, send it back to the parent
            if (token && (userData._id || userData.id)) {
// In the message object that gets sent to the parent window:
const message = {
    type: 'ocean-pay-auth',
    token: token,
    user: {
        id: userData._id || userData.id,
        username: userData.username || userData.un,
        token: token,
        ecorebits: {
            balance: userData.ecorebits?.balance || 0
        }
    }
};

// Send the message
try {
    // Try with target origin first
    const targetOrigin = window.location.origin;
    console.log('Sending message to origin:', targetOrigin);
    window.opener.postMessage(message, targetOrigin);
    
    // Also try with wildcard as fallback
    setTimeout(() => {
        if (!messageReceived) {
            console.log('Sending message with wildcard origin');
            window.opener.postMessage(message, '*');
        }
    }, 100);
} catch (e) {
    console.error('Error sending message:', e);
}
                
                // Close the window after a short delay
                setTimeout(() => {
                    try {
                        window.close();
                    } catch (e) {
                        console.error('Error closing window:', e);
                    }
                }, 1000);
            }
        } catch (error) {
            console.error('Error in notifyParent:', error);
        }
    }
};

// Add message listener for when the page loads to check if we should close
document.addEventListener('DOMContentLoaded', () => {
    console.log('Ocean Pay page loaded');
    
    const urlParams = new URLSearchParams(window.location.search);
    const source = urlParams.get('source');
    const token = localStorage.getItem('token');
    
    console.log('Page loaded with params:', { source, hasToken: !!token });
    
    // If we're opened from EcoConsole and already logged in, notify and close
    if (source === 'ecoconsole' && token && window.opener) {
        console.log('Already logged in, notifying parent...');
        setTimeout(() => {
            window.notifyParent();
        }, 500); // Small delay to ensure the page is fully loaded
    }
});

// Make sure notifyParent is called after login/registration
if (typeof originalNotifyParent === 'function') {
    console.log('Original notifyParent function preserved');
}
/* despu√©s de guardar token en localStorage ‚Üí */
notifyParent();

</script>
</body>
</html>
